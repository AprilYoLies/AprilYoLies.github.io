<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Java åç«¯">
    <meta name="description" content="å°æ©˜å­ğŸŠçš„ä¸ªäººä¸»é¡µï¼Œæ¬¢è¿è®¿é—®~~">
    <meta name="author" content="å°æ©˜å­ğŸŠ">
    
    <title>
        
            åˆ†å¸ƒå¼ç»Ÿä¸€idç”Ÿæˆå™¨snowflakeä»‹ç» |
        
        AprilYoLies
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://img.aprilyolies.top/img/typora/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"aprilyolies.top","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"https://img.aprilyolies.top/img/typora/avatar.jpg","favicon":"https://img.aprilyolies.top/img/typora/avatar.jpg","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"å¹²ç‡¥çš„ç©ºæ°”ï¼Œå°˜åŸƒçš„å‘³é“ï¼Œæˆ‘åœ¨å…¶ä¸­â€¦è¸ä¸Šæ—…é€”ï¼"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </a>
            
            <a class="logo-title" href="/">
                AprilYoLies
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">åˆ†å¸ƒå¼ç»Ÿä¸€idç”Ÿæˆå™¨snowflakeä»‹ç»</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">å°æ©˜å­ğŸŠ</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2019-07-17 14:56:34</span>
        <span class="mobile">2019-07-17 14:56</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/">åå°å¼€å‘</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">åˆ†å¸ƒå¼</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/snowflake" >é¡¹ç›®åœ°å€<i class="fas fa-external-link-alt"></i></a><br>å¥½ä¹…æ²¡æœ‰å†™æŠ€æœ¯åšå®¢äº†ï¼Œå®åœ¨æ˜¯å› ä¸ºè‡ªå·±æ¯”è¾ƒå¿™ï¼ŒèŠ±äº†å°†è¿‘ä¸¤ä¸ªæœˆçš„æ—¶é—´å®Œæˆäº†ä¸¤ä¸ªå¼€æºå°é¡¹ç›®ï¼Œè¿™ç¯‡æ–‡ç« è¦ä»‹ç»çš„å°±æ˜¯å…¶ä¸­ä¸€ä¸ªï¼Œæˆ‘å°†å®ƒçš„åå­—å«åš <a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/snowflake" >snowflake<i class="fas fa-external-link-alt"></i></a>ï¼Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ç»Ÿä¸€ id ç”Ÿæˆå™¨ï¼Œèƒ½å¤Ÿç”Ÿæˆ segment å’Œ snowflake ä¸¤ç§ç±»å‹çš„ idã€‚å¦å¤–ä¸€ä¸ªå°±æ˜¯ä¸€ä¸ªç±»ä¼¼äº dubbo çš„ rpc æ¡†æ¶ <a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/beehive" >beehive<i class="fas fa-external-link-alt"></i></a>ï¼Œåœ¨æˆ‘çš„ snowflake é¡¹ç›®ä¸­æä¾›äº†å†…åµŒæ¨¡å¼çš„æµ‹è¯•ç¨‹åºï¼Œå®ƒæ‰€ä½¿ç”¨çš„ rpc æ¡†æ¶å°±æ˜¯æˆ‘è‡ªå·±å¼€å‘çš„ beehiveï¼Œå…³äº beehive æˆ‘å‡†å¤‡åœ¨æˆ‘åè¾¹çš„æ–‡ç« ä¸­å†ä½œä»‹ç»ï¼Œæœ¬ç¯‡å°±å…ˆè¯¦ç»†ä»‹ç»ä¸€ä¸‹ snowflake è¿™ä¸ª id ç”Ÿæˆå™¨ã€‚</p>
<h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><p>snowflake æ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼çš„ç»Ÿä¸€ ID ç”Ÿæˆå™¨ï¼Œæä¾›äº†ä¸¤ç§ id ç”Ÿæˆçš„æ–¹å¼ï¼Œåˆ†æ®µ id å’Œé€šè¿‡ snowflake ç®—æ³•è®¡ç®—å¾—åˆ° idã€‚åœ¨åˆ†æ®µ id çš„ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œä¸åŒçš„æœåŠ¡å™¨ä»æ•°æ®åº“è·å–è‡ªå·±ä¸“å±çš„ id å·æ®µï¼Œå†ä»è¯¥å·æ®µä¸­æ¥äº§ç”Ÿå”¯ä¸€ idï¼Œåœ¨ä»æ•°æ®åº“ä¸­è·å–å·æ®µçš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡æ•°æ®åº“çš„äº‹åŠ¡æœºåˆ¶ï¼Œä¿è¯äº†ä¸åŒçš„ id æœåŠ¡å™¨è·å–çš„å·æ®µæ˜¯ä¸é‡å¤çš„ï¼Œæ‰€ä»¥èƒ½å¤Ÿä¿è¯å…¨å±€çš„ id å”¯ä¸€æ€§ã€‚è€Œ snowflake ç®—æ³•è®¡ç®— id çš„æ–¹å¼ç¨å¾®å¤æ‚ï¼Œé¦–å…ˆå®ƒå¹¶ä¸æ˜¯é€šè¿‡ id éš”æ®µçš„æ–¹å¼æ¥ä¿è¯ id çš„å”¯ä¸€æ€§ï¼Œè€Œæ˜¯é€šè¿‡å„ä¸ª id æœåŠ¡å™¨çš„ machine id æ¥ä¿è¯ä¸åŒçš„æœåŠ¡å™¨ä¹‹é—´äº§ç”Ÿçš„ id å”¯ä¸€æ€§ï¼Œæ­¤å¤–ï¼Œåœ¨å•å° id æœåŠ¡å™¨ä¹‹ä¸Šï¼Œmachine id æ˜¯å”¯ä¸€ä¸”ä¸å˜çš„ï¼Œè¦æƒ³äº§ç”Ÿå”¯ä¸€ idï¼Œå°±è¿˜éœ€è¦å…¶ä»–çš„é¡¹æ¥è¿›è¡Œä¿è¯ï¼Œsnowflake ç®—æ³•é‡‡ç”¨çš„æ˜¯åŠ ä¸Šæ—¶é—´æˆ³çš„æ–¹å¼ï¼Œåœ¨æœ¬é¡¹ç›®çš„å®ç°ä¸­ï¼Œæä¾›äº†ä¸¤ç§æ—¶é—´é¢—ç²’åº¦çš„é€‰æ‹©ï¼ˆç§’å’Œæ¯«ç§’ï¼‰ï¼Œå¯¹äºè®¡ç®—æœºä¸–ç•Œè€Œè¨€ä¸€ç§’å’Œä¸€æ¯«ç§’è€Œè¨€ï¼Œæ˜¯å¾ˆæ¼«é•¿çš„ï¼Œåœ¨è¿™æ ·çš„æ—¶é—´é¢—ç²’åº¦ä¸‹å¾ˆæœ‰å¯èƒ½ä¼šåœ¨åŒä¸€ä¸ªæœ€å°æ—¶é—´å•å…ƒå†…ç”Ÿæˆå¤šä¸ª idï¼Œå› ä¸ºæ—¶é—´æˆ³å’Œ machine id ä¸€è‡´ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬ç”Ÿæˆçš„ id ä¸­ï¼Œè¿˜éœ€è¦ä¸€ä¸ªé¢å¤–çš„å­—æ®µæ¥ä¿è¯åœ¨å•ä½æ—¶é—´ç²’åº¦ä¸­ç”Ÿæˆçš„ id çš„å”¯ä¸€æ€§ï¼Œè¿™å°±æ˜¯åºåˆ—å·ã€‚snowflake ç®—æ³•ç”Ÿæˆ id ç›¸å…³çš„ä¸‰ä¸ªå­—æ®µå¦‚ä¸Šæ‰€è¿°ï¼Œæ›´åŠ è¯¦ç»†çš„ id æ¨¡å‹è¯·çœ‹ä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th align="left">é¢—ç²’åº¦</th>
<th align="left">æ—¶é—´æˆ³</th>
<th align="left">åºåˆ—å·</th>
<th align="left">machine id</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ç§’</td>
<td align="left">å ç”¨ 31 ä½</td>
<td align="left">å ç”¨ 22 ä½</td>
<td align="left">å ç”¨ 10 ä½</td>
</tr>
<tr>
<td align="left">æ¯«ç§’</td>
<td align="left">å ç”¨ 41 ä½</td>
<td align="left">å ç”¨ 12 ä½</td>
<td align="left">å ç”¨ 10 ä½</td>
</tr>
</tbody></table>
<p>ä»ä¸Šè¡¨å¯ä»¥çœ‹å‡ºæ¥ä¸¤ç§é¢—ç²’åº¦çš„ id å ç”¨çš„é•¿åº¦éƒ½æ˜¯ 63 ä½æ•°ï¼Œåˆšå¥½å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé•¿æ•´å‹æ•°æ®æ¥è¿›è¡Œå­˜å‚¨ï¼Œå‰©ä½™ä¸€ä½æ²¡æœ‰ä½¿ç”¨ï¼Œæ–¹ä¾¿ä»¥åæ‹“å±•ä½¿ç”¨ã€‚å¯¹äºç§’é¢—ç²’åº¦è€Œè¨€ï¼Œä¸€å¹´ 31536000 ç§’å ç”¨ 25 ä½ï¼Œæ—¶é—´æˆ³å‰©ä½™ 6 ä½ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ç§æ–¹å¼äº§ç”Ÿçš„ id èƒ½ç”¨ 64 å¹´ï¼ˆéç²¾ç¡®è®¡ç®—ï¼‰ï¼Œè€Œåºåˆ—å·å ç”¨ 22 ä½ï¼ŒæŠ˜ç®—åå¯ä»¥çŸ¥é“ç†è®ºæƒ…å†µä¸‹ï¼Œä¸€ç§’å†…å•å° id æœåŠ¡å™¨æœ€å¤šèƒ½ç”Ÿæˆ 4194303 ä¸ª idã€‚å¯¹äºæ¯«ç§’é¢—ç²’åº¦è€Œè¨€ï¼Œä¸€å¹´ 31536000000 æ¯«ç§’å ç”¨ 35 ä½ï¼Œå‰©ä½™ 6 ä½ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨ 64 å¹´ï¼ˆéç²¾ç¡®è®¡ç®—ï¼‰ï¼Œç”±äºæ—¶é—´æˆ³é•¿åº¦çš„å¢åŠ å¯¼è‡´åºåˆ—å·çš„é•¿åº¦è¢«å‹ç¼©ä¸º 12 ä½ï¼Œè¿™æ ·ç†è®ºæƒ…å†µä¸‹ï¼Œå•å° id æœåŠ¡å™¨ä¸€æ¯«ç§’å†…æœ€å¤šèƒ½äº§ç”Ÿ 4096 ä¸ª idã€‚</p>
<h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><h3 id="å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼"><a href="#å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼" class="headerlink" title="å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼"></a>å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼</h3><p>å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼éœ€è¦ä½¿ç”¨åˆ° rpc æ¡†æ¶ï¼Œåœ¨ snowflake ä¸­ç”¨äºäº§ç”Ÿ id çš„æœåŠ¡æ¥å£ä¸º <code>top.aprilyolies.snowflake.idservice.IdService</code>ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼ŒSegmentIdService å’Œ SnowflakeIdServiceï¼Œåˆ†åˆ«å¯¹åº”ä¸¤ç§ id çš„ç”Ÿæˆæ–¹å¼ï¼Œä»–ä»¬çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/3028ad529899a66477d7b1c26bcba6d8.jpeg" width=500 /></div>

<p>äº†è§£è¿™ä¸ªä»¥åï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“åœ¨ rpc æ¡†æ¶ä¸­ï¼Œéœ€è¦æš´éœ²çš„æœåŠ¡åç§°å°±æ˜¯è¿™ä¸ªæ¥å£çš„å…¨é™å®šåã€‚åœ¨æœåŠ¡ç«¯ï¼Œé™¤äº†è¦æš´éœ²æœåŠ¡å¤–ï¼Œè¿˜è¦æŒ‡å®šå¯¹åº”çš„æœåŠ¡å®ç°ï¼Œè¿™æ˜¯æˆ‘æ˜¯é€šè¿‡ spring çš„ FactoryBean æœºåˆ¶æ¥é¿å…ç›´æ¥æ„å»º IdService å®ç°ç±»ï¼Œç®€å•æ¥è¯´æˆ‘ä»¬åœ¨ä½¿ç”¨ rpc æ¡†æ¶æŒ‡å®šæœåŠ¡å®ç°ç±»æ—¶ï¼Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„ IdService å®ç°ç±»ï¼Œè€Œæ˜¯é€šè¿‡ FactoryBean æ¥æ„å»ºå¯¹åº”çš„ IdService å®ç°ç±»ï¼Œè¿™ä¹ˆè¯´å¯èƒ½æœ‰ç‚¹ç»•ï¼Œè¿˜æ˜¯ç›´æ¥çœ‹ç¤ºä¾‹ç¨‹åºæ¯”è¾ƒåˆé€‚ï¼Œé¡¹ç›®çš„å·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/cb74453427824b8b49bcfa40553967a4.jpeg" width=250 /></div>

<p>å†…åµŒæœåŠ¡å‘å¸ƒçš„å®ä¾‹ç¨‹åºå°±åœ¨ snowflake-demo æ¨¡å—ä¹‹ä¸‹ï¼Œå†æ¬¡è¯´æ˜è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯è‡ªå·±å¼€å‘çš„ rpc æ¡†æ¶ beehiveï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯å…¶ä»–ç±»å‹çš„ rpc æ¡†æ¶ï¼Œæ–¹å¼ä¹ŸåŸºæœ¬ä¸€è‡´ã€‚å…ˆçœ‹æœåŠ¡å‘å¸ƒç«¯çš„ spring é…ç½®æ–‡ä»¶ï¼š</p>
<blockquote>
<p>embed-server.xml</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:beehive=<span class="string">&quot;https://www.aprilyolies.top/schema/beehive&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd https://www.aprilyolies.top/schema/beehive https://www.aprilyolies.top/schema/beehive.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean class=<span class="string">&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;locations&quot;</span> value=<span class="string">&quot;classpath:snowflake.properties&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;serviceFactory&quot;</span> class=<span class="string">&quot;top.aprilyolies.snowflake.idservice.IdServiceFactory&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;machineIdProvider&quot;</span> value=<span class="string">&quot;ZOOKEEPER&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;idType&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;zkHost&quot;</span> value=<span class="string">&quot;119.23.247.86&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;dbUrl&quot;</span> value=<span class="string">&quot;jdbc:mysql://localhost:3306/snowflake&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;root&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;kuaile1..&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;serviceType&quot;</span> value=<span class="string">&quot;snowflake&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:service id=<span class="string">&quot;idService&quot;</span> service=<span class="string">&quot;top.aprilyolies.snowflake.idservice.IdService&quot;</span></span><br><span class="line">                     ref=<span class="string">&quot;serviceFactory&quot;</span> proxy-factory=<span class="string">&quot;jdk&quot;</span> serializer=<span class="string">&quot;hessian&quot;</span> server-port=<span class="string">&quot;7442&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:registry id=<span class="string">&quot;registry&quot;</span> address=<span class="string">&quot;zookeeper://119.23.247.86:2181&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ &lt;beehive:service&#x2F;&gt; æ ‡ç­¾æ˜¯ beehive ç”¨äºå‘å¸ƒæœåŠ¡çš„ï¼Œå®ƒæš´éœ²çš„æœåŠ¡æ¥å£æ˜¯ <code>top.aprilyolies.snowflake.idservice.IdService</code> è¿™é‡Œå’Œæˆ‘ä¸Šè¾¹çš„è¯´æ˜ä¸€è‡´ã€‚ç„¶åå°±æ˜¯è¯¥æœåŠ¡çš„å®ç°ç±»æŒ‡å®šï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯è®¾ç½®çš„ <code>ref=&quot;serviceFactory&quot;</code>ï¼Œå®ƒæ‰€å¯¹åº”çš„å°±æ˜¯é‚£ä¸ª IdService å·¥å‚ç±»ï¼Œå› ä¸ºåœ¨æ„å»º IdService å®ç°ç±»æ—¶éœ€è¦æŒ‡å®šéƒ¨åˆ†å‚æ•°ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿˜æŒ‡å®šäº†ä¸€ç³»åˆ—å‚æ•°ï¼Œå…·ä½“çš„ä½œç”¨å¦‚ä¸‹ï¼š</p>
<p>æ ¹æ®ç”Ÿæˆçš„ id çš„ç±»å‹ä¸åŒï¼Œå‚æ•°çš„æŒ‡å®šä¹Ÿä¸ä¸€æ ·ï¼Œå¦‚æœä½ æ˜¯è¦ç”Ÿæˆ segment ç±»å‹çš„ idï¼Œé‚£ä¹ˆä½ åªéœ€è¦æŒ‡å®šç”¨äºè·å– id æ®µä¿¡æ¯çš„æ•°æ®åº“ä¿¡æ¯å³å¯ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸‰ä¸ªã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=<span class="string">&quot;dbUrl&quot;</span> value=<span class="string">&quot;jdbc:mysql://localhost:3306/snowflake&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;root&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;kuaile1..&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦åœ¨å¯¹åº”çš„æ•°æ®åº“ä¸­æå‰åˆ›å»º id åˆ†æ®µä¿¡æ¯è¡¨ï¼Œåœ¨é¡¹ç›®çš„ scripts ç›®å½•ä¸‹å·²æä¾› SEGMENT_ID_TABLE.sql æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `SEGMENT_ID_TABLE`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `SEGMENT_ID_TABLE` (</span><br><span class="line">  `business` <span class="type">varchar</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸šåŠ¡ç±»å‹&#x27;</span>,</span><br><span class="line">  `<span class="keyword">begin</span>` <span class="type">bigint</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;èµ·å§‹ID&#x27;</span>,</span><br><span class="line">  `<span class="keyword">end</span>` <span class="type">bigint</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;æœ€å¤§ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`business`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>latin1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `SEGMENT_ID_TABLE` <span class="keyword">VALUES</span> (<span class="string">&#x27;order&#x27;</span>, <span class="number">519349</span>, <span class="number">524349</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `SEGMENT_ID_TABLE` <span class="keyword">VALUES</span> (<span class="string">&#x27;payment&#x27;</span>, <span class="number">51</span>, <span class="number">5051</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>


<p>å¦‚æœä½ è¦è·å–çš„æ˜¯ snowflake ç®—æ³•ç”Ÿæˆçš„ idï¼Œé‚£ä¹ˆæƒ…å†µç¨å¾®å¤æ‚ä¸€ç‚¹ç‚¹ï¼Œæ ¹æ® snowflake id çš„æ„æˆæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å”¯ä¸€ä¸èƒ½ç›´æ¥ç¡®å®šçš„å°±æ˜¯ machine idï¼Œå®ƒéœ€è¦å€ŸåŠ©äºå¤–éƒ¨çš„æ¡ä»¶æ¥ä¿è¯å”¯ä¸€æ€§ã€‚æ ¹æ® snowflake machine id çš„è·å–æ–¹å¼ä¸åŒå¯ä»¥å°†å…¶é…ç½®åˆ†ä¸ºä¸‰ç§ã€‚</p>
<ul>
<li>ä»æ•°æ®åº“ä¸­è·å– machine id<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=<span class="string">&quot;idType&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;dbUrl&quot;</span> value=<span class="string">&quot;jdbc:mysql://localhost:3306/snowflake&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;root&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;kuaile1..&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;machineIdProvider&quot;</span> value=<span class="string">&quot;MYSQL&quot;</span>/&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ä»æ•°æ®åº“ä¸­è·å– machine id éœ€è¦æå‰åœ¨å¯¹åº”æ•°æ®åº“ä¸­åˆ›å»ºå¯¹åº”çš„ machine id æ˜ å°„è¡¨ï¼Œåœ¨é¡¹ç›®çš„ scripts ç›®å½•ä¸‹å·²æä¾› SNOWFLAKE-MYSQL-MACHINE-ID.sql æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE snowflake;</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> MYSQL_MACHINE_ID_PROVIDER;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> MYSQL_MACHINE_ID_PROVIDER</span><br><span class="line">(</span><br><span class="line">    ID <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    IP <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (ID),</span><br><span class="line">    <span class="keyword">unique</span> key UK_IP (IP)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> if <span class="keyword">exists</span> initMysqlMachineIdProvider;</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> initMysqlMachineIdProvider()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> count <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">set</span> count <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    LOOP_LABLE:</span><br><span class="line">        loop</span><br><span class="line">            <span class="keyword">insert</span> <span class="keyword">into</span> MYSQL_MACHINE_ID_PROVIDER(ID) <span class="keyword">values</span> (count);</span><br><span class="line">            <span class="keyword">set</span> count <span class="operator">=</span> count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">            if count <span class="operator">&gt;=</span> <span class="number">1024</span> <span class="keyword">then</span></span><br><span class="line">                leave LOOP_LABLE;</span><br><span class="line">            <span class="keyword">end</span> if;</span><br><span class="line">        <span class="keyword">end</span> loop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">commit</span>;</span><br><span class="line">    <span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> initMysqlMachineIdProvider;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ä» zookeeper è·å– machine id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=<span class="string">&quot;idType&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;zkHost&quot;</span> value=<span class="string">&quot;119.23.247.86&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;machineIdProvider&quot;</span> value=<span class="string">&quot;ZOOKEEPER&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä»æœ¬åœ°é…ç½®æ–‡ä»¶è·å– machine idï¼ˆä¸å»ºè®®ï¼Œéœ€è¦åœ¨ classpath ä¸‹åˆ›å»º snowflake.properties é…ç½®æ–‡ä»¶å¹¶æŒ‡å®š snowflake.machine.id&#x3D;1023 å±æ€§å€¼ï¼Œå®ƒå°†ä½œä¸º machine idï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œéœ€è¦ä¿è¯è¿™ä¸ªå€¼å”¯ä¸€ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=<span class="string">&quot;idType&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;property name=<span class="string">&quot;machineIdProvider&quot;</span> value=<span class="string">&quot;PROPERTY&quot;</span>/&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>è¿™é‡Œçš„ idType å°±æ˜¯æŒ‡çš„ snowflake ç®—æ³•ç”Ÿæˆçš„ id çš„é¢—ç²’åº¦ï¼ˆå³åœ¨æ€æ ·çš„å•ä½æ—¶é•¿å†…ï¼Œç”Ÿæˆçš„ id æ˜¯å•è°ƒæœ‰åºçš„ï¼‰ï¼Œ0 ä»£è¡¨åœ¨ä¸€ç§’å†…ï¼Œç”Ÿæˆçš„ id æ˜¯å•è°ƒæœ‰åºé€’å¢çš„ï¼Œè€Œ 1 åˆ™ä»£è¡¨åœ¨ä¸€æ¯«ç§’çš„æ—¶é—´å†…ï¼Œç”Ÿæˆçš„ id æ˜¯å•è°ƒæœ‰åºé€’å¢çš„ã€‚</p>
<p>åœ¨æœåŠ¡ç«¯çš„é…ç½®å®Œæˆåï¼Œå‰©ä¸‹çš„å°±æ˜¯ç›´æ¥å¼•ç”¨å‘å¸ƒçš„æœåŠ¡äº†ï¼Œé…ç½®å¾ˆç®€å•ï¼Œæˆ‘è¿™é‡Œåªæ˜¯è´´å‡ºæ¥ï¼Œä¸åšè¯´æ˜ã€‚</p>
<blockquote>
<p>embed-client.xml</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:beehive=<span class="string">&quot;https://www.aprilyolies.top/schema/beehive&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd https://www.aprilyolies.top/schema/beehive https://www.aprilyolies.top/schema/beehive.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:registry id=<span class="string">&quot;registry&quot;</span> address=<span class="string">&quot;zookeeper://119.23.247.86:2181&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:reference id=<span class="string">&quot;idService&quot;</span> service=<span class="string">&quot;top.aprilyolies.snowflake.idservice.IdService&quot;</span> load-balance=<span class="string">&quot;poll&quot;</span></span><br><span class="line">                       serializer=<span class="string">&quot;hessian&quot;</span> read-timeout=<span class="string">&quot;1000&quot;</span> retry-times=<span class="string">&quot;2&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>åœ¨å®ä¾‹ç¨‹åºä¸­ï¼Œæˆ‘å·²ç»æŒ‡å®šäº† IdService ç±»å‹ä¸º snowflakeï¼Œä¸” machine id çš„è·å–æ–¹å¼ä¸º ZOOKEEPERï¼Œæ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨åˆ°æ•°æ®åº“ï¼Œè€Œä¸”æˆ‘æŒ‡å®šçš„ zookeeper åœ°å€ä¸ºæˆ‘çš„é˜¿é‡Œäº‘åœ°å€ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä¼šå¼€å¯ zookeeper æœåŠ¡ï¼Œè¿™æ ·ä½ ç›´æ¥è¿è¡Œ server ç«¯å’Œ client ç«¯ç¨‹åºå°±èƒ½çœ‹åˆ°ç»“æœã€‚</p>
<h3 id="ç‹¬ç«‹è¿è¡Œæ¨¡å¼"><a href="#ç‹¬ç«‹è¿è¡Œæ¨¡å¼" class="headerlink" title="ç‹¬ç«‹è¿è¡Œæ¨¡å¼"></a>ç‹¬ç«‹è¿è¡Œæ¨¡å¼</h3><p>ç‹¬ç«‹è¿è¡Œæ¨¡å¼é‡‡ç”¨æ‰‹åŠ¨ç›´æ¥æ„å»º IdService çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æ›´åŠ çµæ´»ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‡å®šå‡ ä¸ªå’Œ id service ç›¸å…³çš„å‚æ•°ï¼Œç„¶åå°±èƒ½é€šè¿‡ IdServiceFactory ç±»æ¥æ‹¿åˆ° IdService å®ä¾‹ï¼Œè‡³äºæ€ä¹ˆä½¿ç”¨è¿™ä¸ª IdServiceï¼Œå®Œå…¨ç”±ä½ å†³å®šï¼Œå°±åƒæˆ‘åœ¨é¡¹ç›®ä¸­ç»™å‡ºçš„ä¸¤ä¸ª restful é£æ ¼çš„ id ç”Ÿæˆæ–¹å¼ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡ Springboot æ„å»ºçš„ web åº”ç”¨æ¥è¿›è¡Œè®¿é—®ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯é€šè¿‡ Netty æœåŠ¡å™¨æ¥æä¾›è®¿é—®æ”¯æŒã€‚å‚æ•°çš„é…ç½®æ–¹å¼å’Œå†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼å®Œå…¨ä¸€è‡´ï¼Œåªä¸è¿‡æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶æ˜¯ xmlï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶æ˜¯ propertiesã€‚</p>
<p>å°±ç›´æ¥é‚£ netty çš„å®ä¾‹ç¨‹åºæ¥è¯´æ˜å§ï¼Œæˆ‘ä»¬æ ¹æœ¬å°±æ˜¯è¦å¾—åˆ° IdService çš„å®ä¾‹ï¼Œåœ¨ IdServiceFactory ç±»ä¸­æä¾›äº†ä¸€ä¸ªå…¬æœ‰é™æ€æ–¹æ³• <code>public static IdService buildIdService(ClassLoader classLoader, String serviceType, String confPath) </code>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡è¯¥æ–¹æ³•æ¥è·å– IdService å®ä¾‹ï¼Œä¸‰ä¸ªå‚æ•°éœ€è¦æŒ‡å®šï¼Œclassloader ç±»åŠ è½½å™¨ï¼Œéœ€è¦ä¿è¯è¿™ä¸ªç±»åŠ è½½å™¨èƒ½å¤ŸåŠ è½½åˆ°ä½ çš„é…ç½®æ–‡ä»¶ï¼ŒserviceType æœåŠ¡ç±»å‹ï¼Œå›ºå®šä¸º segment æˆ–è€… snowflakeï¼ŒæŒ‡å®šå…¶å®ƒå‚æ•°ä¼šæŠ¥é”™ï¼Œæœ€åä¸€ä¸ªå°±æ˜¯ä½ çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé‡Œè¾¹çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">snowflake.machine.id=<span class="number">1023</span></span><br><span class="line">snowflake.machine.id.provider=ZOOKEEPER</span><br><span class="line">snowflake.id.type=<span class="number">0</span></span><br><span class="line">snowflake.zookeeper.host=<span class="number">119.23</span><span class="number">.247</span><span class="number">.86</span></span><br><span class="line">snowflake.database.url=jdbc:mysql:<span class="comment">//localhost:3306/snowflake</span></span><br><span class="line">snowflake.database.username=root</span><br><span class="line">snowflake.database.password=kuaile1..</span><br></pre></td></tr></table></figure>

<p>è·Ÿä¸Šè¾¹ä»‹ç»çš„ä¸€æ ·ï¼Œé‡Œè¾¹çš„é…ç½®ä¸æ˜¯éå¾—å…¨å†™ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æŒ‡å®šå‡ æ¡å¿…é¡»çš„å‚æ•°å³å¯ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯ IdService å®ä¾‹ï¼Œå°±åƒç¤ºä¾‹ç¨‹åºçš„ SnowflakeChannelHandler è¿”å›çš„é‚£æ ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SnowflakeIdService å®ä¾‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">IdService</span> <span class="variable">snowIdService</span> <span class="operator">=</span> IdServiceFactory.buildIdService(SnowflakeChannelHandler.class.getClassLoader(), <span class="string">&quot;snowflake&quot;</span>, <span class="string">&quot;snowflake.properties&quot;</span>);</span><br><span class="line"><span class="comment">// SegmentIdService å®ä¾‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">IdService</span> <span class="variable">segIdService</span> <span class="operator">=</span> IdServiceFactory.buildIdService(SnowflakeChannelHandler.class.getClassLoader(), <span class="string">&quot;segment&quot;</span>, <span class="string">&quot;snowflake.properties&quot;</span>);</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•è¿è¡Œ"><a href="#æµ‹è¯•è¿è¡Œ" class="headerlink" title="æµ‹è¯•è¿è¡Œ"></a>æµ‹è¯•è¿è¡Œ</h2><h3 id="å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼æµ‹è¯•"><a href="#å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼æµ‹è¯•" class="headerlink" title="å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼æµ‹è¯•"></a>å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼æµ‹è¯•</h3><p>å› ä¸ºæµ‹è¯•ç¨‹åºä¾èµ–äº†æˆ‘å¼€å‘çš„ beehive rpc æ¡†æ¶ï¼Œè¿™ä¸ªåœ¨ maven ä¸­å¤®ä»“åº“æ— æ³•ç›´æ¥ä¸‹è½½ï¼Œéœ€è¦å…ˆæ‰‹åŠ¨è¿›è¡Œå®‰è£…è¯¥ä¾èµ–ï¼Œå…·ä½“æ–¹æ³•å°±æ˜¯æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼Œè¿™æ ·åœ¨ä½ çš„æœ¬åœ° maven ä»“åº“å°±ä¼šå­˜åœ¨è¯¥ä¾èµ–äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/AprilYoLies/beehive.git</span><br><span class="line"><span class="built_in">cd</span> beehive</span><br><span class="line">mvn clean install -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯åŠ¨æœåŠ¡ç«¯ï¼Œæ‰§è¡Œ nowflake-demo&#x2F;embed-server æ¨¡å—ä¸‹ <code>top.aprilyolies.snowflake.EmbedServer</code> ç±»çš„ main æ–¹æ³•ï¼Œå¦‚æœå¯åŠ¨æˆåŠŸï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºæœåŠ¡å·²å‘å¸ƒã€‚</p>
<p>æ¥ç€å¯åŠ¨å®¢æˆ·ç«¯ï¼Œæ‰§è¡Œ snowflake-demo&#x2F;embed-client æ¨¡å—ä¸‹ <code>top.aprilyolies.snowflake.EmbedClient</code> ç±»çš„ main æ–¹æ³•ï¼Œå¦‚æœå‡ºç°å¦‚ä¸‹ç»“æœï¼Œå°±è¡¨ç¤ºæœåŠ¡è°ƒç”¨æˆåŠŸã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14108116920565761</span></span><br><span class="line"><span class="number">14108116970897409</span></span><br><span class="line"><span class="number">14108116979286017</span></span><br><span class="line"><span class="number">14108116983480321</span></span><br><span class="line"><span class="number">14108116991868929</span></span><br><span class="line"><span class="number">14108116996063233</span></span><br><span class="line"><span class="number">14108117004451841</span></span><br><span class="line"><span class="number">14108117008646145</span></span><br><span class="line"><span class="number">14108117017034753</span></span><br><span class="line"><span class="number">14108117021229057</span></span><br></pre></td></tr></table></figure>

<h3 id="ç‹¬ç«‹è¿è¡Œæ¨¡å¼æµ‹è¯•"><a href="#ç‹¬ç«‹è¿è¡Œæ¨¡å¼æµ‹è¯•" class="headerlink" title="ç‹¬ç«‹è¿è¡Œæ¨¡å¼æµ‹è¯•"></a>ç‹¬ç«‹è¿è¡Œæ¨¡å¼æµ‹è¯•</h3><p>ç‹¬ç«‹è¿è¡Œæ¨¡å¼æä¾›äº†ä¸¤ä¸ª Server ç«¯ï¼Œéšä¾¿å¯åŠ¨ä¸€ä¸ªå°±è¡Œï¼Œä»¥ NettyServer ä¸ºä¾‹ï¼Œæ‰§è¡Œ snowflake-server&#x2F;snowflake-netty æ¨¡å—ä¸‹ <code>top.aprilyolies.snowflake.SnowflakeServer</code> ç±»çš„ main æ–¹æ³•ï¼Œå¦‚æœå¯åŠ¨æˆåŠŸï¼Œå°±ä¼šæ—¥å¿—æ‰“å°è¯·æ±‚çš„è·¯å¾„å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">210</span> [main] INFO top.aprilyolies.snowflake.SnowflakeServer - Snowflake netty server started on port <span class="number">6707.</span></span><br><span class="line"><span class="number">210</span> [main] INFO top.aprilyolies.snowflake.SnowflakeServer - Get segment id by http:<span class="comment">//localhost:6707/snowflake/seg/business-name</span></span><br><span class="line"><span class="number">210</span> [main] INFO top.aprilyolies.snowflake.SnowflakeServer - Get snowflake id by http:<span class="comment">//localhost:6707/snowflake/snow</span></span><br></pre></td></tr></table></figure>

<p>è®¿é—®ä¸¤ä¸ªé“¾æ¥ä¸­çš„ä»»æ„ä¸€æ¡å°±ä¼šå¾—åˆ°å¯¹åº”çš„ idã€‚</p>
<h2 id="TODO-LIST"><a href="#TODO-LIST" class="headerlink" title="TODO-LIST"></a>TODO-LIST</h2><ul>
<li><p>åœ¨é€šè¿‡ snowflake ç®—æ³•ç”Ÿæˆ id æ—¶ï¼Œç”±äºéœ€è¦é€šè¿‡æ—¶é—´æˆ³æ¥ç”Ÿæˆ idï¼Œè¿™å°±æœ‰å¯èƒ½ä¼šå› ä¸ºæŸä¸€ä¸ªæœºå™¨çš„æ—¶é—´å‘ç”Ÿå›æ‹¨ï¼Œå¯¼è‡´è¿™å°æœºå™¨äº§ç”Ÿå‡ºé‡å¤çš„ idï¼Œæœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼Œä¸€ä¸ªæ˜¯åœ¨æ¯æ¬¡ç”Ÿæˆ id æ—¶ï¼Œéƒ½æ£€æŸ¥ä¸€æ¬¡å½“å‰æ—¶é—´æˆ³æ˜¯å¦æ¯”ä¸Šä¸€æ¬¡ç”Ÿæˆ id çš„æ—¶é—´æˆ³å°ï¼Œå¦‚æœæ¡ä»¶æˆç«‹ï¼Œå°±æ‹’ç» id ç”Ÿæˆï¼Œè¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ï¼Œåœ¨æœåŠ¡ä¸é‡å¯çš„æƒ…å†µä¸‹ä¹Ÿèƒ½æ£€æŸ¥å‡ºè¿™ç§é—®é¢˜ï¼Œç¼ºé™·æ˜¯è·å–å½“å‰æ—¶é—´æˆ³å’Œæ—¶é—´æ¯”å¯¹æ˜¯ä¸€ä¸ªè€—æ—¶æ“ä½œï¼Œä¼šå¯¼è‡´ååé‡ä¸‹é™ã€‚å¦å¤–ä¸€ç§æ–¹å¼æ˜¯æ¯éš”ä¸€å°æ®µæ—¶é—´å‘æ•°æ®åº“ä¸­å†™å…¥å½“å‰æœºå™¨ç”Ÿæˆ id çš„æ—¶é—´æˆ³ï¼Œåœ¨æœåŠ¡é‡å¯æ—¶éœ€è¦å…ˆæ£€æŸ¥å½“å‰æ—¶é—´æˆ³æ˜¯å¦æ¯”ä¸Šä¸€æ¬¡ç”Ÿæˆ id çš„æ—¶é—´æˆ³å°ï¼Œå¦‚æœæˆç«‹ï¼Œåˆ™æ‹’ç»å¯åŠ¨æœåŠ¡ï¼Œè¿™ç§åšæ³•èƒ½å¤Ÿé¿å…æœåŠ¡é‡å¯æ—¶çš„æ—¶é—´å›æ‹¨é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæœåŠ¡æ˜¯åœ¨è¿è¡Œä¸­ï¼Œå‘ç”Ÿæ—¶é—´å›æ‹¨ï¼Œè¿™ç§æ–¹å¼å°†ä¼šäº§ç”Ÿé”™è¯¯ã€‚</p>
</li>
<li><p>åœ¨ segment æ–¹å¼ç”Ÿæˆ id çš„è¿‡ç¨‹ä¸­ï¼Œä»£ç æ˜¯ä½¿ç”¨çš„ç¡¬ç¼–ç æ–¹å¼å°† step å€¼å†™æ­»ï¼Œå¯¹äºä¸åŒçš„åº”ç”¨åœºæ™¯ï¼Œå¯èƒ½è¯¥æ­¥è¿›å€¼å¹¶ä¸åˆé€‚ï¼Œæœ€å¥½æ˜¯ç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®ä¸¤æ¬¡è·å– id æ®µçš„æ—¶é—´å·®æ¥è‡ªåŠ¨è°ƒæ•´æ­¥è¿›å€¼ï¼Œè¿™æ ·èƒ½å¤ŸåŠ¨æ€çš„ç¼“è§£ id æ®µæœåŠ¡æ•°æ®åº“çš„å‹åŠ›ã€‚</p>
</li>
<li><p>å¯ä»¥å†ä¸ºç³»ç»Ÿå¢åŠ ä¸€ä¸ªå¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼Œèƒ½å¤Ÿç›´è§‚çš„çœ‹åˆ°ä¸åŒä¸šåŠ¡çš„ id æ®µä½¿ç”¨æƒ…å†µï¼Œä»¥åŠ id æ®µç¼“å­˜çš„ä½¿ç”¨æƒ…å†µã€‚</p>
</li>
</ul>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">#åˆ†å¸ƒå¼</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2019/07/18/2019-07-18-%E8%BD%BB%E9%87%8F%E7%BA%A7RPC%E6%A1%86%E6%9E%B6BEEHIVE%E4%BB%8B%E7%BB%8D/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">è½»é‡çº§RPCæ¡†æ¶BEEHIVEä»‹ç»</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2019/05/26/2019-05-26-%E7%9C%8BDubbo%E6%BA%90%E7%A0%81%E6%80%BB%E7%BB%93%E5%87%BA%E6%9D%A5%E7%9A%84%E9%82%A3%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">çœ‹Dubboæºç æ€»ç»“å‡ºæ¥çš„é‚£äº›å°æŠ€å·§</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">å°æ©˜å­ğŸŠ</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">åŸºæœ¬ä½¿ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%B5%8C%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.1.</span> <span class="nav-text">å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.2.</span> <span class="nav-text">ç‹¬ç«‹è¿è¡Œæ¨¡å¼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%90%E8%A1%8C"><span class="nav-number">4.</span> <span class="nav-text">æµ‹è¯•è¿è¡Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%B5%8C%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E6%A8%A1%E5%BC%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">4.1.</span> <span class="nav-text">å†…åµŒæœåŠ¡å‘å¸ƒæ¨¡å¼æµ‹è¯•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">4.2.</span> <span class="nav-text">ç‹¬ç«‹è¿è¡Œæ¨¡å¼æµ‹è¯•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO-LIST"><span class="nav-number">5.</span> <span class="nav-text">TODO-LIST</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
