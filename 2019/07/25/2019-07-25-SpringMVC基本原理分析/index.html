<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Java åç«¯">
    <meta name="description" content="å°æ©˜å­ğŸŠçš„ä¸ªäººä¸»é¡µï¼Œæ¬¢è¿è®¿é—®~~">
    <meta name="author" content="å°æ©˜å­ğŸŠ">
    
    <title>
        
            SpringMVCåŸºæœ¬åŸç†åˆ†æ |
        
        AprilYoLies
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://img.aprilyolies.top/img/typora/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"aprilyolies.top","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"https://img.aprilyolies.top/img/typora/avatar.jpg","favicon":"https://img.aprilyolies.top/img/typora/avatar.jpg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"å¹²ç‡¥çš„ç©ºæ°”ï¼Œå°˜åŸƒçš„å‘³é“ï¼Œæˆ‘åœ¨å…¶ä¸­â€¦è¸ä¸Šæ—…é€”ï¼"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </a>
            
            <a class="logo-title" href="/">
                AprilYoLies
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">SpringMVCåŸºæœ¬åŸç†åˆ†æ</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">å°æ©˜å­ğŸŠ</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2019-07-25 09:08:08</span>
        <span class="mobile">2019-07-25 09:08</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">æºç åˆ†æ</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Spring/">Spring</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/SpringMVC/">SpringMVC</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡æ˜¯å…³äº SpringMVC å®ç°åŸç†åˆ†æçš„æ–‡ç« ï¼Œè¿™ä¹‹å‰è¿˜å†™äº†ä¸¤ç¯‡å…³äº Spring AOP å’Œäº‹åŠ¡æœºåˆ¶å®ç°åŸç†çš„æ–‡ç« ï¼Œæ€»çš„æ¥è¯´ SpringMVC çš„æ‰§è¡Œæµç¨‹ç¨å¾®å¤æ‚äº›ï¼Œä½†æ˜¯æ ¹æœ¬çš„åˆ†ææ–¹æ³•å…¶å®è¿˜æ˜¯å’Œä¸Šä¸¤ç¯‡æ–‡ç« å·®ä¸å¤šçš„ï¼Œæ‰€ä»¥å¦‚æœä½ å¯¹ spring æºç åˆ†æä¸çŸ¥é“å¦‚ä½•å¼€å§‹çš„è¯ï¼Œé‚£ä¹ˆæˆ‘è¿˜æ˜¯å»ºè®®å…ˆå»çœ‹çœ‹ä¸Šä¸¤ç¯‡æ–‡ç« ï¼Œå› ä¸ºåˆ†æçš„æ–¹å¼åŸºæœ¬å·®ä¸å¤šï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿå°±ä»ç®€è¿›è¡Œè¯´æ˜ï¼Œç»†èŠ‚çš„éƒ¨åˆ†ä¹Ÿä¸ä¼šå»æ·±ç©¶ï¼Œå¦å¤–å¯¹äºå®ç°ä¸­çš„è§†å›¾è§£æéƒ¨åˆ†ï¼Œæˆ‘ä»¬æ˜¯ä»¥ jsp é¡µé¢ä¸ºä¾‹çš„ï¼Œæ‰€ä»¥å®ƒçš„æ¸²æŸ“æ˜¯ç”± tomcat æ‰€å®Œæˆçš„ï¼Œä¸å±äºæœ¬æ–‡åˆ†æçš„å†…å®¹ï¼Œå¦‚æœé‡‡ç”¨çš„æ˜¯å…¶å®ƒç±»å‹çš„é¡µé¢ï¼Œæ¯”å¦‚ ftlï¼Œé‚£ä¹ˆå…¶æ¸²æŸ“å°±æ˜¯äº¤ç”± FreeMarker è§†å›¾è§£æå™¨å®Œæˆçš„ï¼Œæ¸²æŸ“çš„è¿‡ç¨‹æˆ‘ä¹Ÿæ²¡æ·±ç©¶ï¼Œå°±åªæ˜¯ç‚¹åˆ°å³å¯ï¼Œå¦‚æœå¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯è‡ªè¡ŒæŸ¥æ‰¾ç›¸å…³æ–‡ç« è¿›è¡Œç†è§£ã€‚</p>
<h2 id="ç¤ºä¾‹ç¨‹åº"><a href="#ç¤ºä¾‹ç¨‹åº" class="headerlink" title="ç¤ºä¾‹ç¨‹åº"></a>ç¤ºä¾‹ç¨‹åº</h2><p>åŒæ ·çš„ç¤ºä¾‹ç¨‹åºå·²ç»æäº¤åˆ°æˆ‘çš„ <a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/spring-framework" >github<i class="fas fa-external-link-alt"></i></a>ï¼Œéœ€è¦å¯ä»¥è‡ªè¡Œè·å–ï¼Œè€Œä¸”é‡Œè¾¹æ·»åŠ äº†ä¸€äº›è‡ªå·±åœ¨åˆ†æå®ç°åŸç†æ—¶ä¾¿äºè‡ªå·±ç†è§£çš„æ³¨é‡Šã€‚</p>
<blockquote>
<p>pojo ç±» top.aprilyolies.example.mvc.User</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>controller ç±» top.aprilyolies.example.mvc.UserController</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ModelAndView <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;accessed....&quot;</span>);</span><br><span class="line">		<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">		user.setName(<span class="string">&quot;eva&quot;</span>);</span><br><span class="line">		<span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">		user1.setName(<span class="string">&quot;johnson&quot;</span>);</span><br><span class="line">		ArrayList&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		users.add(user);</span><br><span class="line">		users.add(user1);</span><br><span class="line">		<span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;userlist&quot;</span>, <span class="string">&quot;users&quot;</span>, users);</span><br><span class="line">		<span class="keyword">return</span> mv;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>spring é…ç½®æ–‡ä»¶</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:mvc=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">            http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</span></span><br><span class="line"><span class="string">            http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">            http://www.springframework.org/schema/context/spring-context-4.3.xsd</span></span><br><span class="line"><span class="string">            http://www.springframework.org/schema/mvc</span></span><br><span class="line"><span class="string">            http://www.springframework.org/schema/mvc/spring-mvc-4.3.xsd &quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="meta">@Controller</span>æ³¨è§£æ‰«æ --&gt;</span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;top.aprilyolies.example.mvc&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- æ³¨è§£é©±åŠ¨:æ›¿æˆ‘ä»¬æ˜¾ç¤ºçš„é…ç½®äº†æœ€æ–°ç‰ˆçš„æ³¨è§£çš„å¤„ç†å™¨æ˜ å°„å™¨å’Œå¤„ç†å™¨é€‚é…å™¨ --&gt;</span><br><span class="line">    &lt;mvc:annotation-driven/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;viewResolver&quot;</span> class=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;prefix&quot;</span> value=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;suffix&quot;</span> value=<span class="string">&quot;.jsp&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>web é…ç½®æ–‡ä»¶ web.xml </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="line">		 xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">		 xsi:schemaLocation=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee</span></span><br><span class="line"><span class="string">                             http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span> version=<span class="string">&quot;3.1&quot;</span>&gt;</span><br><span class="line">	&lt;display-name&gt;spring&lt;/display-name&gt;</span><br><span class="line">	&lt;welcome-file-list&gt;</span><br><span class="line">		&lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">	&lt;/welcome-file-list&gt;</span><br><span class="line"></span><br><span class="line">	&lt;context-param&gt;</span><br><span class="line">		&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">		&lt;param-value&gt;classpath:spring-mvc.xml&lt;/param-value&gt;</span><br><span class="line">	&lt;/context-param&gt;</span><br><span class="line">	&lt;listener&gt;</span><br><span class="line">		&lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;</span><br><span class="line">	&lt;/listener&gt;</span><br><span class="line"></span><br><span class="line">	&lt;servlet&gt;</span><br><span class="line">		&lt;servlet-name&gt;springMvc&lt;/servlet-name&gt;</span><br><span class="line">		&lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</span><br><span class="line">		&lt;init-param&gt;</span><br><span class="line">			&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">			&lt;param-value&gt;classpath:spring-mvc.xml&lt;/param-value&gt;</span><br><span class="line">		&lt;/init-param&gt;</span><br><span class="line">		&lt;!-- åœ¨tomcatå¯åŠ¨çš„æ—¶å€™å°±åŠ è½½è¿™ä¸ªservlet --&gt;</span><br><span class="line">		&lt;load-on-startup&gt;<span class="number">1</span>&lt;/load-on-startup&gt;</span><br><span class="line">	&lt;/servlet&gt;</span><br><span class="line">	&lt;servlet-mapping&gt;</span><br><span class="line">		&lt;servlet-name&gt;springMvc&lt;/servlet-name&gt;</span><br><span class="line">		&lt;!--</span><br><span class="line">        *.action    ä»£è¡¨æ‹¦æˆªåç¼€åä¸º.actionç»“å°¾çš„</span><br><span class="line">        / 			æ‹¦æˆªæ‰€æœ‰ä½†æ˜¯ä¸åŒ…æ‹¬.jsp</span><br><span class="line">        <span class="comment">/* 			æ‹¦æˆªæ‰€æœ‰åŒ…æ‹¬.jsp</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line"><span class="comment">		&lt;url-pattern&gt;/&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="comment">	&lt;/servlet-mapping&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;/web-app&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¾ˆç®€å•çš„ç¤ºä¾‹ç¨‹åºï¼Œä½†æ˜¯å¯¹äºåˆ†æ springMVC çš„åŸºæœ¬å®ç°åŸç†å·²ç»è¶³å¤Ÿäº†ï¼Œç¨‹åºå¯åŠ¨åï¼Œè®¿é—®å¯¹åº”çš„è¯·æ±‚é“¾æ¥å°±èƒ½åœ¨é¡µé¢è·å–éœ€è¦çš„ä¿¡æ¯äº†ã€‚</p>
<h2 id="WebApplicationContext-çš„åˆå§‹åŒ–"><a href="#WebApplicationContext-çš„åˆå§‹åŒ–" class="headerlink" title="WebApplicationContext çš„åˆå§‹åŒ–"></a>WebApplicationContext çš„åˆå§‹åŒ–</h2><p>æˆ‘ä»¬çš„ç¨‹åºæ˜¯ä» tomcat å¯åŠ¨çš„ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ª servlet ç¨‹åºå®¹å™¨ï¼Œç®¡ç†ç€ servlet çš„åˆ›å»ºã€åˆå§‹åŒ–ã€è°ƒç”¨å’Œé”€æ¯ã€‚åœ¨è¿™ä¸ª servlet å®¹å™¨çš„å£°æ˜å‘¨æœŸä¸­æœ‰ä¸€é¡¹å°±æ˜¯åœ¨å®¹å™¨çš„åˆ›å»ºå’Œé”€æ¯æ—¶å®Œæˆå¯¹åº”ç›‘å¬å™¨æ–¹æ³•çš„è°ƒç”¨ï¼Œå¦‚ä¸‹é¢è¿™ä¸ªæ¥å£æ‰€ç¤ºï¼Œæ³¨æ„è¿™ä¸ªæ¥å£ä¸æ˜¯æˆ‘ä»¬å®šä¹‰çš„ï¼Œè€Œæ˜¯å±äº servlet è§„èŒƒä¸­çš„é¡¹ã€‚æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯éµå¾ªæ­¤è§„èŒƒï¼Œå®Œæˆè‡ªå·±çš„é€»è¾‘ã€‚</p>
<blockquote>
<p>javax.servlet.ServletContextListener</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletContextListener</span> <span class="keyword">extends</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>äº†è§£è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬çœ‹ web.xml æ–‡ä»¶ï¼Œå› ä¸ºå®ƒå°±æ˜¯ç›´æ¥è·Ÿ tomcat ç›¸å…³çš„é…ç½®ã€‚é‡Œè¾¹æœ‰ä¸€ä¸ª &lt;listener&#x2F;&gt; æ ‡ç­¾ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸Šè¾¹æ‰€è¯´çš„ç›‘å¬å™¨ï¼Œæˆ‘ä»¬åœ¨é‡Œè¾¹é…ç½®äº† <code>org.springframework.web.context.ContextLoaderListener</code>ï¼Œé‚£ä¹ˆåœ¨ tomcat å¯åŠ¨åï¼Œè¯¥ç›‘å¬å™¨å¯¹åº”çš„æ¥å£æ–¹æ³•ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åˆ†æçš„å…¥å£ã€‚å®šä½åˆ°è¯¥ç±»ï¼Œå¯ä»¥çŸ¥é“å®ƒå®ç°äº† ServletContextListener æ¥å£ï¼Œæ‰€ä»¥è¯¥æ¥å£å¯¹åº”çš„æ–¹æ³•å°±æ˜¯æˆ‘ä»¬åˆ†æçš„å…¥å£ï¼Œè¯¥æ¥å£ä¸­æœ‰ä¸¤ä¸ªä¸Šè¾¹å·²ç»æŒ‡å‡ºäº†ï¼Œæˆ‘ä»¬è¿™é‡Œå…³å¿ƒ contextInitialized æ–¹æ³•çš„å®ç°å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initialize the root web application context.</span></span><br><span class="line"><span class="comment">    */</span>	<span class="comment">// è·å– context class çš„ç±»å‹ï¼Œç„¶åé€šè¿‡å®ƒæ¥æ„å»º WebApplicationContext å®ä¾‹ï¼Œè®©å…¶æŒæœ‰ ServletContextï¼Œè®¾ç½®äº† spring é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œå®Œæˆéƒ¨åˆ†å±æ€§çš„æ›¿æ¢å’Œè®¾ç½®ï¼Œç„¶ååˆ·æ–°å’Œå¯åŠ¨ ConfigurableWebApplicationContext</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent event)</span> &#123;</span><br><span class="line">    initWebApplicationContext(event.getServletContext());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‚æ•°çš„ <code>event.getServletContext()</code> å…¶å®å°±æ˜¯è·å–çš„ tomcat å®¹å™¨å¯¹åº”çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œé‡Œè¾¹æœ‰ tomcat å®¹å™¨ç›¸å…³çš„å¾ˆå¤šä¿¡æ¯ã€‚è¿›å…¥ initWebApplicationContext æ–¹æ³•ï¼Œä»æ–¹æ³•åæˆ‘ä»¬å°±çŸ¥é“æ˜¯åˆå§‹åŒ– WebApplicationContextï¼Œæ³¨æ„è¿™ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒå°±æ˜¯è·Ÿæˆ‘ä»¬çš„ spring å®¹å™¨ç›¸å…³äº†ã€‚æ–¹æ³•çš„çš„å®ç°å¦‚ä¸‹ï¼Œæ–¹æ³•çš„æ¥å£å¾ˆæ¸…æ™°ï¼Œæˆ‘åœ¨å…³é”®ä»£ç å¤„åšå‡ºäº†æ³¨é‡Šï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯è·å–æˆ‘ä»¬è¦åˆ›å»ºçš„ spring å®¹å™¨ context class çš„ç±»å‹ï¼Œç„¶åé€šè¿‡å®ƒæ¥æ„å»º ApplicationContext å®ä¾‹ï¼Œå®ƒæŒæœ‰ ServletContext å®ä¾‹ï¼Œç„¶åå°±æ˜¯è®¾ç½®äº† spring é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œå®Œæˆéƒ¨åˆ†å±æ€§çš„æ›¿æ¢å’Œè®¾ç½®ï¼Œç„¶ååˆ·æ–°å’Œå¯åŠ¨ ApplicationContextã€‚</p>
<p>æ³¨æ„æ­¤æ—¶å¯åŠ¨çš„ ApplicationContextï¼Œæˆ‘ä»¬åœ¨ <code>servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context);</code> æ­¤è¡Œä»£ç ä¸­ï¼Œè®© servlet ä¸Šä¸‹æ–‡ç¯å¢ƒæŒæœ‰äº†æœ¬ ApplicationContextï¼Œå®ƒçš„å±æ€§åæ˜¯ <code>org.springframework.web.context.WebApplicationContext.ROOT</code>ï¼Œå®ƒå°†ä¼šåœ¨åé¢ä½¿ç”¨åˆ°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"> */	<span class="comment">// è·å– context class çš„ç±»å‹ï¼Œç„¶åé€šè¿‡å®ƒæ¥æ„å»º WebApplicationContext å®ä¾‹ï¼Œè®©å…¶æŒæœ‰ ServletContextï¼Œè®¾ç½®äº† spring é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œå®Œæˆéƒ¨åˆ†å±æ€§çš„æ›¿æ¢å’Œè®¾ç½®ï¼Œç„¶ååˆ·æ–°å’Œå¯åŠ¨ ConfigurableWebApplicationContext</span></span><br><span class="line"><span class="keyword">public</span> WebApplicationContext <span class="title function_">initWebApplicationContext</span><span class="params">(ServletContext servletContext)</span> &#123;	<span class="comment">// å‚æ•°æ˜¯ tomcat ä¸­çš„å®ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(	<span class="comment">// æ£€æŸ¥å¯èƒ½çš„é‡å¤ application context</span></span><br><span class="line">                <span class="string">&quot;Cannot initialize context because there is already a root application context present - &quot;</span> +</span><br><span class="line">                <span class="string">&quot;check whether you have multiple ContextLoader* definitions in your web.xml!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    servletContext.log(<span class="string">&quot;Initializing Spring root WebApplicationContext&quot;</span>);</span><br><span class="line">    <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(ContextLoader.class);</span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Root WebApplicationContext: initialization started&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Store context in local instance variable, to guarantee that</span></span><br><span class="line">        <span class="comment">// it is available on ServletContext shutdown.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.context == <span class="literal">null</span>) &#123;	<span class="comment">// è·å– context class çš„ç±»å‹ï¼Œç„¶åé€šè¿‡å®ƒæ¥æ„å»º WebApplicationContext å®ä¾‹</span></span><br><span class="line">            <span class="built_in">this</span>.context = createWebApplicationContext(servletContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.context <span class="keyword">instanceof</span> ConfigurableWebApplicationContext) &#123;</span><br><span class="line">            <span class="type">ConfigurableWebApplicationContext</span> <span class="variable">cwac</span> <span class="operator">=</span> (ConfigurableWebApplicationContext) <span class="built_in">this</span>.context;</span><br><span class="line">            <span class="keyword">if</span> (!cwac.isActive()) &#123;</span><br><span class="line">                <span class="comment">// The context has not yet been refreshed -&gt; provide services such as</span></span><br><span class="line">                <span class="comment">// setting the parent context, setting the application context id, etc</span></span><br><span class="line">                <span class="keyword">if</span> (cwac.getParent() == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// The context instance was injected without an explicit parent -&gt;</span></span><br><span class="line">                    <span class="comment">// determine parent for root web application context, if any.</span></span><br><span class="line">                    <span class="type">ApplicationContext</span> <span class="variable">parent</span> <span class="operator">=</span> loadParentContext(servletContext);</span><br><span class="line">                    cwac.setParent(parent);</span><br><span class="line">                &#125;	<span class="comment">// ConfigurableWebApplicationContext æŒæœ‰ ServletContextï¼Œè®¾ç½®äº† spring é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œå®Œæˆéƒ¨åˆ†å±æ€§çš„æ›¿æ¢å’Œè®¾ç½®ï¼Œç„¶ååˆ·æ–°å’Œå¯åŠ¨ ConfigurableWebApplicationContext</span></span><br><span class="line">                configureAndRefreshWebApplicationContext(cwac, servletContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;	<span class="comment">// å°†å¯åŠ¨çš„ spring context å’Œ servlet context ç»‘å®šï¼Œé¿å…é‡å¤å¯åŠ¨</span></span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="built_in">this</span>.context);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">ccl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (ccl == ContextLoader.class.getClassLoader()) &#123;</span><br><span class="line">            currentContext = <span class="built_in">this</span>.context;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ccl != <span class="literal">null</span>) &#123;</span><br><span class="line">            currentContextPerThread.put(ccl, <span class="built_in">this</span>.context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">elapsedTime</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            logger.info(<span class="string">&quot;Root WebApplicationContext initialized in &quot;</span> + elapsedTime + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (RuntimeException | Error ex) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Context initialization failed&quot;</span>, ex);</span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ContextLoaderListener ç±»çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯ä¸Šæ–‡æ‰€è¯´çš„é‚£æ ·ï¼Œç»†èŠ‚éƒ¨åˆ†æˆ‘ä»¬ä¸ä½œæ·±å…¥æ¢è®¨ï¼Œä½†æ˜¯åœ¨æˆ‘ github ä¸Šçš„æºç ä¸­ï¼Œè¿˜æ˜¯æœ‰æ·»åŠ éƒ¨åˆ†æ³¨é‡Šï¼Œéœ€è¦çš„å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<h2 id="DispatcherServlet-è¯´æ˜"><a href="#DispatcherServlet-è¯´æ˜" class="headerlink" title="DispatcherServlet è¯´æ˜"></a>DispatcherServlet è¯´æ˜</h2><p>åœ¨æˆ‘ä»¬çš„ web.xml æ–‡ä»¶ä¸­ï¼Œé™¤äº†ä¸Šæ–‡æŒ‡å‡ºçš„ ContextLoaderListener å¤–ï¼Œåœ¨æˆ‘ä»¬çš„ &lt;servlet&#x2F;&gt; æ ‡ç­¾ä¸­è¿˜æŒ‡å®šäº†ä¸€ä¸ª DispatcherServlet ç±»ï¼Œå¾ˆæ˜æ˜¾å®ƒæ˜¯ä¸€ä¸ª servlet ç±»ï¼Œå®ƒçš„åˆå§‹åŒ–ã€ä½¿ç”¨å’Œé”€æ¯å°†ä¼šäº¤ç»™ servlet å®¹å™¨æ¥ç®¡ç†ã€‚æˆ‘ä»¬å®šä½åˆ°è¯¥ç±»ï¼Œæ¥çœ‹çœ‹å®ƒçš„ç»§æ‰¿ä½“ç³»ï¼Œä»¥åŠå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/e217322f7c38d77f380f457024df398a.jpg" width=600 /></div>

<center>DispatcherServlet ç»§æ‰¿ä½“ç³»</center>

<p>

<p>DispatcherServlet ç±»çš„ç»§æ‰¿ä½“ç³»å¦‚ä¸Šå›¾ï¼Œå¯ä»¥çŸ¥é“å®ƒç»§æ‰¿è‡ª HttpServletï¼Œè¿™æ˜¯ Servlet è§„èŒƒä¸­çš„ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„åˆ†æä¹Ÿå°±æ˜¯æ­¢äºæ­¤ç±»ã€‚è€Œå¯¹äºç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæˆ‘ä»¬å°±éœ€è¦é‡ç‚¹å…³æ³¨çš„ç‚¹ï¼Œè¿™é‡Œå°±æ˜¯ <code>HttpServletBean#init</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹äºæˆ‘ä»¬çš„ Servlet è€Œè¨€ï¼Œä¼˜å…ˆè°ƒç”¨çš„æ˜¯è¯¥æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span>	<span class="comment">// å°±è¿™é‡Œè€Œè¨€ï¼Œå¥½åƒå°±æ˜¯å°† web.xml ä¸­ servlet å¯¹åº”çš„å±æ€§å€¼è®¾ç½®åˆ°å½“å‰ servlet ä¸­ï¼Œåˆå§‹åŒ– ApplicationContextï¼Œä¼šè§¦å‘ç›‘å¬å™¨äº‹ä»¶ï¼Œå¯¼è‡´æ ‡ç­¾è§£æä¸­çš„ bean è¢«ä½¿ç”¨åˆ° Dispatcher Servlet ä¸­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;	<span class="comment">// æ³¨æ„ ContextLoaderListener åªæ˜¯æ„å»ºçš„ root ApplicationContext</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set bean properties from init parameters.	// è·å– ServletConfig ä¸­çš„ paramsï¼Œæ·»åŠ åˆ° propertyValueListï¼Œå¦‚æœç¼ºå°‘å¿…é¡»å‚æ•°ï¼ŒæŠ¥é”™</span></span><br><span class="line">    <span class="type">PropertyValues</span> <span class="variable">pvs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletConfigPropertyValues</span>(getServletConfig(), <span class="built_in">this</span>.requiredProperties);</span><br><span class="line">    <span class="keyword">if</span> (!pvs.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BeanWrapper</span> <span class="variable">bw</span> <span class="operator">=</span> PropertyAccessorFactory.forBeanPropertyAccess(<span class="built_in">this</span>);</span><br><span class="line">            <span class="type">ResourceLoader</span> <span class="variable">resourceLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletContextResourceLoader</span>(getServletContext());</span><br><span class="line">            bw.registerCustomEditor(Resource.class, <span class="keyword">new</span> <span class="title class_">ResourceEditor</span>(resourceLoader, getEnvironment()));</span><br><span class="line">            initBeanWrapper(bw);</span><br><span class="line">            bw.setPropertyValues(pvs, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isErrorEnabled()) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Failed to set bean properties on servlet &#x27;&quot;</span> + getServletName() + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Let subclasses do whatever initialization they like.</span></span><br><span class="line">    initServletBean();	<span class="comment">// åˆå§‹åŒ– ApplicationContextï¼Œä¼šè§¦å‘ç›‘å¬å™¨äº‹ä»¶ï¼Œå¯¼è‡´æ ‡ç­¾è§£æä¸­çš„ bean è¢«ä½¿ç”¨åˆ° Dispatcher Servlet ä¸­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¾¹æ–¹æ³•çš„ç¬¬ä¸€è¡Œæ„å»ºäº†ä¸€ä¸ª ServletConfigPropertyValues ç±»ï¼Œéœ€è¦æ³¨æ„åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šå®Œæˆç›¸å…³å±æ€§çš„æ£€æµ‹ï¼Œå¦‚æœç¼ºå°‘å¿…è¦çš„å±æ€§ï¼Œå°†ä¼šæŠ¥é”™ï¼Œå®ç°ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> */	<span class="comment">// è·å– ServletConfig ä¸­çš„ paramsï¼Œæ·»åŠ åˆ° propertyValueListï¼Œå¦‚æœç¼ºå°‘å¿…é¡»å‚æ•°ï¼ŒæŠ¥é”™</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ServletConfigPropertyValues</span><span class="params">(ServletConfig config, Set&lt;String&gt; requiredProperties)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; missingProps = (!CollectionUtils.isEmpty(requiredProperties) ?</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(requiredProperties) : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    Enumeration&lt;String&gt; paramNames = config.getInitParameterNames();</span><br><span class="line">    <span class="keyword">while</span> (paramNames.hasMoreElements()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> paramNames.nextElement();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> config.getInitParameter(property);</span><br><span class="line">        addPropertyValue(<span class="keyword">new</span> <span class="title class_">PropertyValue</span>(property, value));	<span class="comment">// å°† PropertyValue æ·»åŠ åˆ° propertyValueListï¼Œè¦†ç›–å¼</span></span><br><span class="line">        <span class="keyword">if</span> (missingProps != <span class="literal">null</span>) &#123;</span><br><span class="line">            missingProps.remove(property);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fail if we are still missing properties.</span></span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(missingProps)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(</span><br><span class="line">                <span class="string">&quot;Initialization from ServletConfig for servlet &#x27;&quot;</span> + config.getServletName() +</span><br><span class="line">                <span class="string">&quot;&#x27; failed; the following required properties were missing: &quot;</span> +</span><br><span class="line">                StringUtils.collectionToDelimitedString(missingProps, <span class="string">&quot;, &quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ <code>HttpServletBean#init</code> æ–¹æ³•ä¸­æˆ‘ä»¬éœ€è¦æ³¨æ„çš„å°±æ˜¯ <code>initServletBean();</code> è¿™è¡Œï¼Œå®ƒçš„å…·ä½“å®ç°æ˜¯ç”±å­ç±»å®ç°çš„ï¼Œä»£ç å»æ‰äº†æ—¥å¿—ç›¸å…³çš„ä¿¡æ¯å¦‚ä¸‹ï¼Œæ ¸å¿ƒå°±æ˜¯ä¸¤è¡Œï¼Œå°±æœ¬ä¾‹è€Œè¨€ <code>initFrameworkServlet();</code> æ˜¯ç©ºå®ç°ï¼Œæ‰€ä»¥å°±åªå‰©ä¸‹ä¸€è¡Œè¦åˆ†æäº†ã€‚</p>
<blockquote>
<p>FrameworkServlet#initServletBean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// åˆå§‹åŒ– ApplicationContextï¼Œä¼šè§¦å‘ç›‘å¬å™¨äº‹ä»¶ï¼Œå¯¼è‡´æ ‡ç­¾è§£æä¸­çš„ bean è¢«ä½¿ç”¨åˆ° Dispatcher Servlet ä¸­</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">initServletBean</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;	<span class="comment">// åˆå§‹åŒ– ApplicationContextï¼Œä¼šè§¦å‘ç›‘å¬å™¨äº‹ä»¶ï¼Œå¯¼è‡´æ ‡ç­¾è§£æä¸­çš„ bean è¢«ä½¿ç”¨åˆ° Dispatcher Servlet ä¸­</span></span><br><span class="line">        <span class="built_in">this</span>.webApplicationContext = initWebApplicationContext();</span><br><span class="line">        initFrameworkServlet();	<span class="comment">// ç©º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ServletException | RuntimeException ex) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Context initialization failed&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>initWebApplicationContext();</code> æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼Œç¬¬ä¸€è¡Œæ˜¯è·å– rootContextï¼Œæ³¨æ„è¿™é‡Œè·å–çš„ context å…¶å®å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡æŒ‡å‡ºçš„ç¼“å­˜åœ¨ ServletContext ä¸­çš„é‚£ä¸ª ApplicationContextï¼Œå®ƒæ˜¯åœ¨æˆ‘ä»¬çš„ ContextLoaderListener ç±»ä¸­å®Œæˆæ„å»ºå¹¶ç¼“å­˜åˆ° ServletContext ä¸­çš„ã€‚æœ¬ä¾‹ä¸­ä¸­é—´é‚£ä¸ª if åˆ¤æ–­ä¸æˆç«‹ï¼Œæ‰€ä»¥ç›´æ¥è·³è¿‡ã€‚æ¥ç€å°±æ˜¯å°è¯•ä»ç¯å¢ƒä¸­è·å– ApplicationContextï¼Œæœ¬ä¾‹ä¸­ä¹Ÿæ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥ç›´æ¥å°±ä¼šåˆ° <code>createWebApplicationContext(rootContext);</code> è¿™è¡Œä»£ç ï¼Œä»åå­—æˆ‘ä»¬å°±èƒ½çŸ¥é“æ˜¯æ‰‹åŠ¨åˆ›å»º ApplicationContextï¼Œè¯è¯´æˆ‘ä»¬ä¸æ˜¯åœ¨ ContextLoaderListener ä¸­å·²ç»åˆ›å»ºäº†ä¸€ä¸ª ContextLoaderListener å˜›ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œåˆåˆ›å»ºäº†ä¸€ä¸ªå‘¢ï¼Ÿè€Œä¸”ä»åè¾¹çš„å®ç°ä¸­å¯ä»¥çŸ¥é“ï¼Œæ„å»ºæ–¹å¼ä¹Ÿè·Ÿ ContextLoaderListener ä¸­çš„æ„å»ºæ–¹å¼å·®ä¸å¤šï¼Œæˆ‘è¿™é‡Œä¹Ÿæ²¡å¤ªçœ‹æ‡‚å®ƒçš„æ„æ€ï¼Œè¿˜æ˜¯å…ˆçœ‹ <code>createWebApplicationContext(rootContext);</code> æ–¹æ³•çš„å®ç°å§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> WebApplicationContext <span class="title function_">initWebApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">WebApplicationContext</span> <span class="variable">rootContext</span> <span class="operator">=</span>	<span class="comment">// è·å–å½“å‰ servlet context å¯¹åº”çš„é‚£ä¸ª WebApplicationContext</span></span><br><span class="line">            WebApplicationContextUtils.getWebApplicationContext(getServletContext());</span><br><span class="line">    <span class="type">WebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.webApplicationContext != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// A context instance was injected at construction time -&gt; use it</span></span><br><span class="line">        wac = <span class="built_in">this</span>.webApplicationContext;</span><br><span class="line">        <span class="keyword">if</span> (wac <span class="keyword">instanceof</span> ConfigurableWebApplicationContext) &#123;</span><br><span class="line">            <span class="type">ConfigurableWebApplicationContext</span> <span class="variable">cwac</span> <span class="operator">=</span> (ConfigurableWebApplicationContext) wac;</span><br><span class="line">            <span class="keyword">if</span> (!cwac.isActive()) &#123;</span><br><span class="line">                <span class="comment">// The context has not yet been refreshed -&gt; provide services such as</span></span><br><span class="line">                <span class="comment">// setting the parent context, setting the application context id, etc</span></span><br><span class="line">                <span class="keyword">if</span> (cwac.getParent() == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// The context instance was injected without an explicit parent -&gt; set</span></span><br><span class="line">                    <span class="comment">// the root application context (if any; may be null) as the parent</span></span><br><span class="line">                    cwac.setParent(rootContext);</span><br><span class="line">                &#125;</span><br><span class="line">                configureAndRefreshWebApplicationContext(cwac);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wac == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No context instance was injected at construction time -&gt; see if one</span></span><br><span class="line">        <span class="comment">// has been registered in the servlet context. If one exists, it is assumed</span></span><br><span class="line">        <span class="comment">// that the parent context (if any) has already been set and that the</span></span><br><span class="line">        <span class="comment">// user has performed any initialization such as setting the context id</span></span><br><span class="line">        wac = findWebApplicationContext();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wac == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No context instance is defined for this servlet -&gt; create a local one</span></span><br><span class="line">        wac = createWebApplicationContext(rootContext);	<span class="comment">// æ ¹æ® rootContext åˆ›å»º WebApplicationContext</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.refreshEventReceived) &#123;</span><br><span class="line">        <span class="comment">// Either the context is not a ConfigurableApplicationContext with refresh</span></span><br><span class="line">        <span class="comment">// support or the context injected at construction time had already been</span></span><br><span class="line">        <span class="comment">// refreshed -&gt; trigger initial onRefresh manually here.</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.onRefreshMonitor) &#123;</span><br><span class="line">            onRefresh(wac);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.publishContext) &#123;</span><br><span class="line">        <span class="comment">// Publish the context as a servlet context attribute.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> getServletContextAttributeName();</span><br><span class="line">        getServletContext().setAttribute(attrName, wac);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createWebApplicationContext(rootContext);</code> æ–¹æ³•å®ç°æ ¹æœ¬æ˜¯è°ƒç”¨çš„å¦‚ä¸‹æ–¹æ³•ï¼Œå…ˆæ˜¯è·å– ApplicationContext å¯¹åº”çš„ç±»ï¼Œç„¶åç”±è¯¥ class æ¥åˆ›å»º ApplicationContext å®ä¾‹ã€‚æ³¨æ„æ–°åˆ›å»ºå‡ºæ¥çš„ ApplicationContext å®ƒæŒæœ‰äº† ServletEnviroment å®ä¾‹ï¼Œå°† ContextLoaderListener ç±»ä¸­åˆ›å»ºçš„ ApplicationContext ä½œä¸ºäº†è‡ªå·±çš„ parent å­—æ®µï¼ŒåŒæ—¶è¿˜æŒæœ‰äº†æˆ‘ä»¬ spring é…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– ContextClassï¼Œæ®æ­¤åˆ›å»ºäº†ä¸€ä¸ª ApplicationContextï¼Œå®ƒæŒæœ‰æˆ‘ä»¬ spring é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼ŒåŒæ—¶å°†å‚æ•°çš„ ApplicationContext ä½œä¸ºçˆ¶ ApplicationContextï¼Œåˆ·æ–°é…ç½®å’Œå¯åŠ¨</span></span><br><span class="line"><span class="keyword">protected</span> WebApplicationContext <span class="title function_">createWebApplicationContext</span><span class="params">(<span class="meta">@Nullable</span> ApplicationContext parent)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; contextClass = getContextClass();</span><br><span class="line">    <span class="keyword">if</span> (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(</span><br><span class="line">                <span class="string">&quot;Fatal initialization error in servlet with name &#x27;&quot;</span> + getServletName() +</span><br><span class="line">                <span class="string">&quot;&#x27;: custom WebApplicationContext class [&quot;</span> + contextClass.getName() +</span><br><span class="line">                <span class="string">&quot;] is not of type ConfigurableWebApplicationContext&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ConfigurableWebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span></span><br><span class="line">            (ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line"></span><br><span class="line">    wac.setEnvironment(getEnvironment());</span><br><span class="line">    wac.setParent(parent);</span><br><span class="line">    <span class="type">String</span> <span class="variable">configLocation</span> <span class="operator">=</span> getContextConfigLocation();</span><br><span class="line">    <span class="keyword">if</span> (configLocation != <span class="literal">null</span>) &#123;</span><br><span class="line">        wac.setConfigLocation(configLocation);	<span class="comment">// æŒæœ‰ spring é…ç½®æ–‡ä»¶</span></span><br><span class="line">    &#125;	<span class="comment">// åˆ·æ–°é…ç½®å’Œå¯åŠ¨</span></span><br><span class="line">    configureAndRefreshWebApplicationContext(wac);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å°±æ˜¯è°ƒç”¨äº† <code>configureAndRefreshWebApplicationContext(wac);</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯¹æ–°æ„å»ºçš„ ApplicationContext è¿›è¡Œäº†ä¸€å®šçš„é…ç½®ï¼Œæœ€åå°±æ˜¯è°ƒç”¨äº† ApplicationContext çš„åˆ·æ–°æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬éœ€è¦çš„ spring å®¹å™¨å°±ç®—æ˜¯æ­£å¼å¯åŠ¨äº†ã€‚åœ¨å¯¹ ApplicationContext è¿›è¡Œé…ç½®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç‚¹å°±æ˜¯ <code>wac.addApplicationListener(new SourceFilteringListener(wac, new ContextRefreshListener()));</code> è¿™è¡Œä»£ç å‘ ApplicationContext æ³¨å†Œäº†ä¸€ä¸ªç›‘å¬å™¨ï¼Œé‚£ä¹ˆåœ¨ ApplicationContext çš„åˆ·æ–°å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå°†ä¼šè§¦å‘è¯¥ç›‘å¬å™¨çš„é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configureAndRefreshWebApplicationContext</span><span class="params">(ConfigurableWebApplicationContext wac)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123;</span><br><span class="line">        <span class="comment">// The application context id is still set to its original default value</span></span><br><span class="line">        <span class="comment">// -&gt; assign a more useful id based on available information</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.contextId != <span class="literal">null</span>) &#123;</span><br><span class="line">            wac.setId(<span class="built_in">this</span>.contextId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Generate default id...</span></span><br><span class="line">            wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX +</span><br><span class="line">                    ObjectUtils.getDisplayString(getServletContext().getContextPath()) + <span class="string">&#x27;/&#x27;</span> + getServletName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wac.setServletContext(getServletContext());</span><br><span class="line">    wac.setServletConfig(getServletConfig());</span><br><span class="line">    wac.setNamespace(getNamespace());</span><br><span class="line">    wac.addApplicationListener(<span class="keyword">new</span> <span class="title class_">SourceFilteringListener</span>(wac, <span class="keyword">new</span> <span class="title class_">ContextRefreshListener</span>()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The wac environment&#x27;s #initPropertySources will be called in any case when the context</span></span><br><span class="line">    <span class="comment">// is refreshed; do it eagerly here to ensure servlet property sources are in place for</span></span><br><span class="line">    <span class="comment">// use in any post-processing or initialization that occurs below prior to #refresh</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> wac.getEnvironment();</span><br><span class="line">    <span class="keyword">if</span> (env <span class="keyword">instanceof</span> ConfigurableWebEnvironment) &#123;</span><br><span class="line">        ((ConfigurableWebEnvironment) env).initPropertySources(getServletContext(), getServletConfig());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    postProcessWebApplicationContext(wac);</span><br><span class="line">    applyInitializers(wac);</span><br><span class="line">    wac.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä½åˆ°ä¸Šè¾¹ä»£ç ä¸­æ‰€è¯´çš„æ³¨å†Œçš„é‚£ä¸ªç›‘å¬å™¨ï¼Œä»£ç å¦‚ä¸‹ï¼Œå†…å®¹å¾ˆç®€å•ï¼Œå®ƒæ ¹æœ¬æ˜¯è°ƒç”¨çš„ <code>DispatcherServlet#initStrategies</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­å°±æ˜¯å°† spring å®¹å™¨ä¸­æ ‡ç­¾è§£æå‡ºæ¥çš„é‚£äº› bean é€ä¸ªçš„æ·»åŠ åˆ°å½“å‰ç±»ï¼Œä¹Ÿå°±æ˜¯ DispatcherServlet ä¸­ã€‚è¿™æ ·åœ¨æ‹¦æˆªåˆ°è¯·æ±‚åå°±èƒ½å¤Ÿæ ¹æ®è¿™äº› bean æ¥å®Œæˆç›¸åº”çš„æ“ä½œäº†ï¼Œè‡³æ­¤ springMVC çš„å¯åŠ¨æµç¨‹åˆ†æå°±ç®—å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ContextRefreshListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ContextRefreshedEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> &#123;</span><br><span class="line">        FrameworkServlet.<span class="built_in">this</span>.onApplicationEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæˆä¸€äº› bean çš„å¡«å……ï¼Œä¸»è¦å°±æ˜¯åœ¨æˆ‘ä»¬çš„æ ‡ç­¾è§£æä¸­å¾—åˆ°çš„é‚£äº› beanï¼Œè¿˜æœ‰è§†å›¾è§£æå™¨</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initStrategies</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    initMultipartResolver(context);</span><br><span class="line">    initLocaleResolver(context);</span><br><span class="line">    initThemeResolver(context);</span><br><span class="line">    initHandlerMappings(context);</span><br><span class="line">    initHandlerAdapters(context);</span><br><span class="line">    initHandlerExceptionResolvers(context);</span><br><span class="line">    initRequestToViewNameTranslator(context);</span><br><span class="line">    initViewResolvers(context);</span><br><span class="line">    initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äº DispatcherServlet ç±»ï¼Œæˆ‘ä»¬è¿˜è¦å…³æ³¨æœ‰å“ªäº›æ–¹æ³•æ˜¯å®ç°æˆ–è€…é‡å†™çš„ sevlet è§„èŒƒä¸­çš„æ–¹æ³•ï¼Œæˆ‘å°†å®ƒä»¬åˆ—å‡ºæ¥ã€‚<br><code>FrameworkServlet#service</code>ã€<code>FrameworkServlet#doTrace</code>ã€<code>FrameworkServlet#doOptions</code>ã€<code>FrameworkServlet#doDelete</code>ã€<code>FrameworkServlet#doPut</code>ã€<code>FrameworkServlet#doPost</code>ã€<code>FrameworkServlet#doGet</code> è¿™ä¸ƒä¸ªæ–¹æ³•éƒ½æ˜¯å®Œæˆäº†å¯¹äºçˆ¶ç±»æ–¹æ³•çš„é‡å†™ï¼Œå¦‚æœå¯¹äº servlet çš„æ‰§è¡Œæµç¨‹æ¯”è¾ƒæ¸…æ¥šçš„è¯ï¼Œé‚£ä¹ˆä¸éš¾çŸ¥é“å½“æœ‰è¯·æ±‚æ¥è®¿é—®æ—¶ï¼Œå°†ä¼šé¦–å…ˆäº¤ç»™ service æ–¹æ³•å¤„ç†ï¼Œè¿™æ˜¯åè¾¹å°†è¦åˆ†æçš„å†…å®¹ï¼Œå¯¹äº DispatcherServlet ç±»ï¼Œæˆ‘ä»¬æš‚æ—¶çŸ¥é“è¿™äº›å°±è¡Œã€‚</p>
<h2 id="lt-mvc-annotation-driven-x2F-gt-æ ‡ç­¾è§£æ"><a href="#lt-mvc-annotation-driven-x2F-gt-æ ‡ç­¾è§£æ" class="headerlink" title="&lt;mvc:annotation-driven&#x2F;&gt; æ ‡ç­¾è§£æ"></a>&lt;mvc:annotation-driven&#x2F;&gt; æ ‡ç­¾è§£æ</h2><p>åœ¨æˆ‘ä»¬çš„ spring é…ç½®æ–‡ä»¶ä¸­ï¼ŒæŒ‡å®šäº† &lt;mvc:annotation-driven&#x2F;&gt; æ ‡ç­¾ï¼Œè™½ç„¶æ ‡ç­¾åå¥½åƒæœ‰æ³¨è§£è¿™ä¸ªå•è¯ï¼Œä½†å…¶å®å°±æºç åˆ†æçš„å±‚é¢æ¥çœ‹ï¼Œè·Ÿæ³¨è§£æ—¶æ²¡æœ‰åŠç‚¹å…³ç³»çš„ã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ ‡ç­¾ &lt;context:component-scan&#x2F;&gt;ï¼Œå®ƒè·Ÿ ioc çš„å®ç°æœ‰å…³ï¼Œå…¶å®å°±æ˜¯è®© spring å®¹å™¨è‡ªåŠ¨æ‰«é¢æŒ‡å®šåŒ…ä¸‹çš„ç»„ä»¶ï¼Œå®Œæˆç»„ä»¶çš„æ³¨å†Œï¼Œè¿™é‡Œå°±ä¸åšåˆ†æäº†ï¼Œä»…ä»…å…³æ³¨ &lt;mvc:annotation-driven&#x2F;&gt; æ ‡ç­¾ã€‚</p>
<p>æ ¹æ®ä¸Šä¸¤ç¯‡æ–‡ç« çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„çŸ¥é“è¯¥æ ‡ç­¾çš„è§£ææ˜¯åœ¨ <code>AnnotationDrivenBeanDefinitionParser#parse</code> æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œå…³äºæ ‡ç­¾è§£æå·²ç»è¯´å¾—å¤ªå¤šäº†ï¼Œæ‰€åšçš„äº‹æƒ…éƒ½å·®ä¸å¤šï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ï¼Œåªæ˜¯æ³¨å†Œçš„ bean ç¨å¤šï¼Œæ‰€ä»¥ä»£ç é‡ä¹Ÿéå¸¸å¤šï¼Œæ²¡æœ‰å¤ªå¤šåˆ†æä»·å€¼ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚åªæ˜¯å°†æ³¨å†Œçš„ bean åˆ—å‡ºæ¥ï¼Œä¸å†ä¸€è¡Œè¡Œçœ‹ï¼Œåªè¦å¿ƒé‡Œæ˜ç™½åšäº†å•¥äº‹æƒ…å°±è¡Œï¼Œè¿™äº› bean ä¸­çš„å¾ˆå¤§ä¸€éƒ¨åˆ†éƒ½æ˜¯åœ¨ä¸Šæ–‡æŒ‡å‡ºçš„é‚£ä¸ª ContextRefreshListener ç›‘å¬å™¨ä¸­è¢« DispatcherServlet æ‰€æŒæœ‰ï¼Œç”¨æ¥å®Œæˆå¯¹äºè¯·æ±‚çš„å¤„ç†ã€‚å°±æœ¬ä¾‹è€Œè¨€ï¼Œæ³¨å…¥è¿™ä¹ˆå¤š beanï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨ä½¿ç”¨åˆ°ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ä½¿ç”¨åˆ°å•¥å°±çœ‹å•¥ã€‚</p>
<ul>
<li><p>CompositeComponentDefinition</p>
</li>
<li><p>RequestMappingHandlerMapping	(ç”¨æ¥è·å– HandlerExecutionChainï¼ŒController çš„è¯·æ±‚è·¯å¾„å’Œæ–¹æ³•çš„æ˜ å°„å…³ç³»ä¿å­˜åœ¨å…¶ä¸­)</p>
</li>
<li><p>ConfigurableWebBindingInitializer</p>
</li>
<li><p>RequestMappingHandlerAdapter ï¼ˆç”¨æ¥éªŒè¯ handler æ˜¯å¦å¯ç”¨ï¼‰</p>
</li>
<li><p>ResponseStatusExceptionResolver</p>
</li>
<li><p>CompositeUriComponentsContributorFactoryBean</p>
</li>
<li><p>ConversionServiceExposingInterceptor</p>
</li>
<li><p>DefaultHandlerExceptionResolver</p>
</li>
<li><p>MappedInterceptor</p>
</li>
<li><p>ExceptionHandlerExceptionResolver</p>
</li>
<li><p>BeanNameUrlHandlerMapping</p>
</li>
<li><p>RequestHandlerAdapter	ï¼ˆç”¨æ¥éªŒè¯ handler æ˜¯å¦å¯ç”¨ï¼‰</p>
</li>
<li><p>SimpleControllerHandlerAdapter	ï¼ˆç”¨æ¥éªŒè¯ handler æ˜¯å¦å¯ç”¨ï¼‰</p>
</li>
<li><p>HandlerMappingIntrospector</p>
</li>
</ul>
<h2 id="è¯·æ±‚å¤„ç†æµç¨‹"><a href="#è¯·æ±‚å¤„ç†æµç¨‹" class="headerlink" title="è¯·æ±‚å¤„ç†æµç¨‹"></a>è¯·æ±‚å¤„ç†æµç¨‹</h2><p>ä¸Šæ–‡ä¸­å·²ç»æŒ‡å‡ºäº† DispatcherServlet ç±»ä¸­ï¼Œæœ‰ä¸ƒä¸ªæ–¹æ³•é‡å†™äº† servlet è§„èŒƒç±»çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰è¯·æ±‚æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸ƒä¸ªæ–¹æ³•ä¸­çš„ <code>FrameworkServlet#service</code> å°†ä¼šé¦–å…ˆè¢«è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨å…¶ä¸­æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œé€šè¿‡ debug çš„æ–¹å¼æ¥å¯¹è¯·æ±‚çš„æµç¨‹è¿›è¡Œè·Ÿè¸ªã€‚è°ƒç”¨æ ˆä¿¡æ¯å¦‚ä¸‹ï¼Œå¯ä»¥çŸ¥é“ç°åœ¨ç¨‹åºæ—¶åœåœ¨äº†æˆ‘ä»¬çš„ <code>FrameworkServlet#service</code> æ–¹æ³•ä¸Šï¼Œè€Œå®ƒçš„ä¸Šä¸€ä¸ªè°ƒç”¨å°±æ˜¯ <code>HttpServlet#service</code> æ–¹æ³•ï¼Œè¿™æ˜¯ servlet è§„èŒƒç±»ä¸­çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥çŸ¥é“å®ƒæœ€åè°ƒç”¨äº†å®ƒçš„ä¸€ä¸ªé‡è½½æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çš„ DispatcherServlet ç±»å¯¹å…¶è¿›è¡Œäº†é‡å†™ï¼Œæ‰€ä»¥ç°åœ¨æ‰§è¡Œçš„å°±æ˜¯ <code>FrameworkServlet#service</code> æ–¹æ³•ã€‚</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/6935e114f7b29d9929cdff263b29e7d8.jpg" width=600 /></div>

<center>Servlet è°ƒç”¨æ ˆä¿¡æ¯</center>

<p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span><br><span class="line">    <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    HttpServletRequest  request;</span><br><span class="line">    HttpServletResponse response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        request = (HttpServletRequest) req;</span><br><span class="line">        response = (HttpServletResponse) res;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(lStrings.getString(<span class="string">&quot;http.non_http&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    service(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FrameworkServlet#service</code> æ–¹æ³•ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼Œå®ƒä¼˜å…ˆå¯¹æ–¹æ³•çš„è¯·æ±‚ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ <code>HttpMethod.PATCH</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ if åˆ†æ”¯ï¼Œå¦åˆ™æ‰§è¡Œ else åˆ†æ”¯ã€‚æœ¬ä¾‹ä¸­èµ° else åˆ†æ”¯ï¼Œå¯ä»¥çœ‹åˆ°å®ƒåˆè°ƒç”¨äº†è¢«é‡å†™çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">HttpMethod</span> <span class="variable">httpMethod</span> <span class="operator">=</span> HttpMethod.resolve(request.getMethod());</span><br><span class="line">    <span class="keyword">if</span> (httpMethod == HttpMethod.PATCH || httpMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">        processRequest(request, response);	<span class="comment">// é’ˆå¯¹ PATCH è¯·æ±‚çš„å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¤§è‡´çœ‹çœ‹è¿™ä¸ªè¢«é‡å†™çš„æ–¹æ³•çš„å®ç°ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯ä¸ƒä¸ªåˆ†æ”¯ï¼Œå¯¹åº”ä¸ƒç§è¯·æ±‚ï¼Œè€Œæˆ‘ä»¬çš„ DispatcherServlet å®Œæˆäº†å¯¹å…¶ä¸­å…­ç§æ–¹æ³•çš„é‡å†™ï¼Œå¯¹åº”æœ¬ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬çš„è¯·æ±‚æ˜¯ GET æ–¹å¼ï¼Œæ‰€ä»¥å°±ä¼šèµ° METHOD_GET åˆ†æ”¯ï¼Œå¯ä»¥çœ‹åˆ°å…¶æ ¹æœ¬è¿˜æ˜¯è°ƒç”¨äº† doGet æ–¹æ³•ï¼Œæˆ‘ä»¬å¯¹å…¶å®Œæˆäº†é‡å†™ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±ä¼šæ‰§è¡Œåˆ°æˆ‘ä»¬çš„ <code>FrameworkServlet#doGet</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> getLastModified(req);</span><br><span class="line">        <span class="keyword">if</span> (lastModified == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// servlet doesn&#x27;t support if-modified-since, no reason</span></span><br><span class="line">            <span class="comment">// to go through further expensive logic</span></span><br><span class="line">            doGet(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">ifModifiedSince</span> <span class="operator">=</span> req.getDateHeader(HEADER_IFMODSINCE);</span><br><span class="line">            <span class="keyword">if</span> (ifModifiedSince &lt; lastModified) &#123;</span><br><span class="line">                <span class="comment">// If the servlet mod time is later, call doGet()</span></span><br><span class="line">                <span class="comment">// Round down to the nearest second for a proper compare</span></span><br><span class="line">                <span class="comment">// A ifModifiedSince of -1 will always be less</span></span><br><span class="line">                maybeSetLastModified(resp, lastModified);</span><br><span class="line">                doGet(req, resp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> getLastModified(req);</span><br><span class="line">        maybeSetLastModified(resp, lastModified);</span><br><span class="line">        doHead(req, resp);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</span><br><span class="line">        doPut(req, resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</span><br><span class="line">        doDelete(req, resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</span><br><span class="line">        doOptions(req,resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</span><br><span class="line">        doTrace(req,resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Note that this means NO servlet supports whatever</span></span><br><span class="line">        <span class="comment">// method was requested, anywhere on this server.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">errMsg</span> <span class="operator">=</span> lStrings.getString(<span class="string">&quot;http.method_not_implemented&quot;</span>);</span><br><span class="line">        Object[] errArgs = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">1</span>];</span><br><span class="line">        errArgs[<span class="number">0</span>] = method;</span><br><span class="line">        errMsg = MessageFormat.format(errMsg, errArgs);</span><br><span class="line">        </span><br><span class="line">        resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FrameworkServlet#doGet</code> æ–¹æ³•æ ¹æœ¬åˆæ˜¯è°ƒç”¨çš„ <code>FrameworkServlet#processRequest</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å‰åŠéƒ¨åˆ†éƒ½æ˜¯ä¸€äº›å‡†å¤‡æ“ä½œï¼Œæˆ‘æ²¡æœ‰å»ç»†çœ‹éƒ½å‡†å¤‡äº†å“ªäº›å†…å®¹ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œåˆ†æã€‚å®Œæˆç›¸å…³ä¿¡æ¯çš„å‡†å¤‡åï¼Œå°±æ˜¯æ‰§è¡Œ <code>doService(request, response);</code> è¿™å¥ä»£ç ã€‚é‡Œè¾¹å¤§éƒ¨åˆ†éƒ½æ˜¯å‡†å¤‡å·¥ä½œï¼Œå°±æ˜¯å‘å‚æ•° HttpServletRequest ä¸­æ·»åŠ äº†ä¸€äº›å±æ€§ï¼Œè€Œå±æ€§å€¼å°±æ˜¯æ¥è‡ªäº DispatcherServletï¼ŒçŸ¥é“è¿™ç‚¹åæˆ‘ä»¬ç»§ç»­è·Ÿè¿›ï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯è°ƒç”¨äº† <code>DispatcherServlet#doDispatch</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">failureCause</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">LocaleContext</span> <span class="variable">previousLocaleContext</span> <span class="operator">=</span> LocaleContextHolder.getLocaleContext();</span><br><span class="line">    <span class="type">LocaleContext</span> <span class="variable">localeContext</span> <span class="operator">=</span> buildLocaleContext(request);	<span class="comment">// æ ¹æ® request æ„å»º LocaleContextï¼Œé‡Œè¾¹åŒ…å«äº†ä¸€äº›è¯·æ±‚ç›¸å…³çš„ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="type">RequestAttributes</span> <span class="variable">previousAttributes</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line">    <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> buildRequestAttributes(request, response, previousAttributes);	<span class="comment">// å…¶å®å°±æ˜¯å°è£…äº† request å’Œ response</span></span><br><span class="line"></span><br><span class="line">    <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">    asyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), <span class="keyword">new</span> <span class="title class_">RequestBindingInterceptor</span>());	<span class="comment">// æ³¨å†Œäº†ä¸€ä¸ªç»‘å®šæ‹¦æˆªå™¨</span></span><br><span class="line">    <span class="comment">// å°† LocaleContext å’Œ RequestAttributes åˆ†åˆ«ä¿å­˜åˆ° LocaleContextHolder å’Œ RequestContextHolder</span></span><br><span class="line">    initContextHolders(request, localeContext, requestAttributes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doService(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ServletException | IOException ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Request processing failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        resetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class="line">        <span class="keyword">if</span> (requestAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">            requestAttributes.requestCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">        logResult(request, response, failureCause, asyncManager);</span><br><span class="line">        publishRequestHandledEvent(request, response, startTime, failureCause);	<span class="comment">// å®Œæˆäº‹ä»¶çš„é€šçŸ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DispatcherServlet#doDispatch</code> æ–¹æ³•çš„å†…å®¹å¦‚ä¸‹ï¼Œå®ƒå¯ä»¥ç®—æ˜¯ springMVC çš„æ ¸å¿ƒé€»è¾‘å®ç°ã€‚ä¸ºäº†èŠ‚çœç¯‡å¹…æˆ‘å°†å¼‚å¸¸æ•è·å’Œ finally ä»£ç å—å»æ‰äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œåˆ†æï¼Œä¸å½±å“æˆ‘ä»¬åˆ†æ spirngMVC çš„å®ç°é€»è¾‘ã€‚ç¬¬ä¸€ä¸ªè¦æ³¨æ„çš„ä»£ç å°±æ˜¯ <code>checkMultipart(request);</code> æ ¹æ®æˆ‘çš„ç†è§£ï¼Œå®ƒåº”è¯¥æ˜¯è·Ÿæ–‡ä»¶ä¸Šä¼ æ—¶çš„å¤„ç†æœ‰å…³ï¼Œæœ¬ä¾‹ä¸ä¼šæ¶‰åŠï¼Œåªéœ€è¦çŸ¥é“è¿™ä¸ªç‚¹å°±è¡Œï¼Œç”¨åˆ°äº†å¯ä»¥å†æ·±å…¥å»çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">processedRequest</span> <span class="operator">=</span> request;</span><br><span class="line">    <span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">multipartRequestParsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è·å– request ä¸­çš„ WebAsyncManager</span></span><br><span class="line">    <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">dispatchException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processedRequest = checkMultipart(request);	<span class="comment">// å¦‚æœæŒ‡å®šäº† Multipart å¤„ç†å™¨ï¼Œè¿›è¡Œå¤„ç†</span></span><br><span class="line">            multipartRequestParsed = (processedRequest != request);	<span class="comment">// æ˜¯å¦è¢« multipart å¤„ç†çš„æ ‡å¿—</span></span><br><span class="line">            <span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethodï¼Œå†æ„å»º execution chain è¿”å›</span></span><br><span class="line">            <span class="comment">// Determine handler for the current request.</span></span><br><span class="line">            mappedHandler = getHandler(processedRequest);</span><br><span class="line">            <span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">                noHandlerFound(processedRequest, response);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">            <span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isGet</span> <span class="operator">=</span> <span class="string">&quot;GET&quot;</span>.equals(method);</span><br><span class="line">            <span class="keyword">if</span> (isGet || <span class="string">&quot;HEAD&quot;</span>.equals(method)) &#123;	<span class="comment">// Get æˆ–è€… HEAD æ–¹æ³•</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è°ƒç”¨æ‹¦æˆªå™¨çš„å‰ç½®å¤„ç†å™¨</span></span><br><span class="line">            <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ ¸å¿ƒå°±æ˜¯è·å– ModelAndViewï¼Œæ¨¡å‹æ¥è‡ªç”¨æˆ·æ‰§è¡Œé€»è¾‘çš„ä»£ç ï¼Œè§†å›¾ä¹Ÿæ˜¯</span></span><br><span class="line">            <span class="comment">// Actually invoke the handler.</span></span><br><span class="line">            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            applyDefaultViewName(processedRequest, mv);</span><br><span class="line">            mappedHandler.applyPostHandle(processedRequest, response, mv);	<span class="comment">// åº”ç”¨åç½®å¤„ç†å™¨</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            dispatchException = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">            <span class="comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span></span><br><span class="line">            <span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">            dispatchException = <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler dispatch failed&quot;</span>, err);</span><br><span class="line">        &#125;	<span class="comment">// å¤„ç†åˆ†å‘ç»“æœ</span></span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒä¸ªè¦ç•™æ„çš„ç‚¹å°±æ˜¯ <code>getHandler(processedRequest);</code> æ–¹æ³•çš„æ‰§è¡Œï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼Œä»æ–¹æ³•çš„ä¸»å¹²æ¥çœ‹å°±æ˜¯ä» handlerMappings ä¸­è·å– HandlerExecutionChainï¼Œå¦‚æœç»“æœä¸ä¸º nullï¼Œå°±ç›´æ¥è¿”å›ã€‚é‚£ä¹ˆ handlerMappings ä¸­éƒ½æ˜¯å•¥å‘¢ï¼Ÿé€šè¿‡ debugï¼Œæˆ‘å°†é‡Œè¾¹çš„å†…å®¹å±•ç¤ºå‡ºæ¥ï¼Œå¯ä»¥çœ‹åˆ°å®ƒå°±æ˜¯æˆ‘ä»¬åœ¨æ ‡ç­¾è§£æä¸­æ³¨å†Œåˆ° spring å®¹å™¨ä¸­çš„ beanï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¹Ÿå°±èƒ½çŸ¥é“ä»–ä»¬æ˜¯ç”¨æ¥è·å–å¯¹åº”çš„ HandlerExecutionChainã€‚ç»§ç»­è·Ÿè¿›å»ï¼Œçœ‹æ˜¯å¦‚ä½•å¾—åˆ° HandlerExecutionChain çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethodï¼Œå†æ„å»º execution chain è¿”å›</span></span><br><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">            <span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;	<span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethodï¼Œå†æ„å»º execution chain è¿”å›</span></span><br><span class="line">                <span class="keyword">return</span> handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/9ca253fa3a764ca5246e9ff74e8e8727.jpg" width=600 /></div>

<center>handlerMappings é›†åˆçš„å†…å®¹</center>

<p>

<p>ä¸Šè¾¹çš„ handlerMappings é›†åˆä¸­æœ‰ä¸¤ä¸ªå®ä¾‹ï¼Œé¦–å…ˆå¤„ç†ç¬¬ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ RequestMappingHandlerMapping å®ä¾‹ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethodï¼Œå†æ„å»º execution chain è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> getHandlerInternal(request);	<span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethod</span></span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">        handler = getDefaultHandler();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Bean name or resolved handler?</span></span><br><span class="line">    <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">handlerName</span> <span class="operator">=</span> (String) handler;</span><br><span class="line">        handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°† handler æ„å»ºä¸º chainï¼ŒåŒæ—¶åŠ å…¥äº†æ ‡ç­¾è§£ææ—¶æ³¨å†Œçš„ MappedInterceptor ä¸­çš„ interceptor</span></span><br><span class="line">    <span class="type">HandlerExecutionChain</span> <span class="variable">executionChain</span> <span class="operator">=</span> getHandlerExecutionChain(handler, request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Mapped to &quot;</span> + handler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (logger.isDebugEnabled() &amp;&amp; !request.getDispatcherType().equals(DispatcherType.ASYNC)) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Mapped to &quot;</span> + executionChain.getHandler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasCorsConfigurationSource(handler)) &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> (<span class="built_in">this</span>.corsConfigurationSource != <span class="literal">null</span> ? <span class="built_in">this</span>.corsConfigurationSource.getCorsConfiguration(request) : <span class="literal">null</span>);</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">handlerConfig</span> <span class="operator">=</span> getCorsConfiguration(handler, request);</span><br><span class="line">        config = (config != <span class="literal">null</span> ? config.combine(handlerConfig) : handlerConfig);</span><br><span class="line">        executionChain = getCorsHandlerExecutionChain(request, executionChain, config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> executionChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€å¥å°±æ˜¯è·å– handler å¯¹å§ï¼Œå®ƒæ ¹æœ¬æ˜¯è°ƒç”¨çš„ <code>AbstractHandlerMethodMapping#getHandlerInternal</code> æ–¹æ³•ï¼Œæˆ‘å°†ä»£ç è´´åœ¨ä¸‹è¾¹äº†ã€‚ç¬¬ä¸€å¥æ˜¯å¾—åˆ°äº† lookupPathï¼Œæ ¹æ®æ–¹æ³•åå¯ä»¥çŸ¥é“å°±æ˜¯ä¸€ä¸ªé€šè¿‡ UrlPathHelper è·å– HttpServletRequest å¯¹åº”çš„ LookupPath çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸å¿…æ·±ç©¶ï¼Œåªéœ€è¦çœ‹å…¶ç»“æœå¦‚ä¸‹å›¾ï¼Œå¯ä»¥çŸ¥é“å°±æ˜¯æˆ‘ä»¬è¯·æ±‚çš„é“¾æ¥è·¯å¾„ä¿¡æ¯å¯¹å—ï¼Ÿå¥½ï¼Œæ‹¿åˆ°è¿™ä¸ªè·¯å¾„ä¿¡æ¯åï¼Œç¬¬äºŒè¡Œä»£ç å°†å…¶å¡«å……åˆ°äº† HttpServletRequest çš„å±æ€§ä¸­äº†ã€‚å†æ¥ç€å°±æ˜¯æ‰§è¡Œ <code>lookupHandlerMethod(lookupPath, request);</code> è¿™è¡Œä»£ç ã€‚</p>
<blockquote>
<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#getHandlerInternal</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethod</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> getUrlPathHelper().getLookupPathForRequest(request);</span><br><span class="line">    request.setAttribute(LOOKUP_PATH, lookupPath);</span><br><span class="line">    <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;	<span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethod</span></span><br><span class="line">        <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/0847e8214b4d6dd8a0ff413121e7c210.jpg" width=600 /></div>

<center>lookupPath çš„å†…å®¹</center>

<p>

<p><code>lookupHandlerMethod(lookupPath, request);</code> æ–¹æ³•åˆæœ‰ç‚¹é•¿ï¼Œä½†é€»è¾‘è¿˜ç®—æ¸…æ™°ï¼Œé¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª List<Match> é›†åˆï¼Œå…ƒç´ æ˜¯ Match ç±»ã€‚æ¥ç€æ‰§è¡Œ <code>addMatchingMappings(directPathMatches, matches, request);</code> è¿™è¡Œä»£ç ï¼Œé‡Œè¾¹çš„ä»£ç å†…å®¹ä¸å†è´´äº†ï¼Œæ ¸å¿ƒé€»è¾‘å°±æ˜¯ä» directPathMatches ä¸­è·å–å’Œ request åŒ¹é…çš„é¡¹ï¼Œç„¶åå°†å¾—åˆ°çš„åŒ¹é…é¡¹å°è£…ä¸º Match å®ä¾‹ï¼Œå†è¿½åŠ åˆ° List<Match> é›†åˆä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªé›†åˆä¸­å­˜æ”¾çš„ä¿¡æ¯æ˜¯å•¥å‘¢ï¼Ÿï¼Ÿæˆ‘æŠŠå†…å®¹è´´å‡ºæ¥ï¼Œå¯ä»¥çœ‹å‡ºæ¥å…¶å®é‡Œè¾¹å­˜æ”¾çš„ä¸å°±æ˜¯å½“å‰è¯·æ±‚å¯¹åº”çš„ controller ç±»çš„å¯¹åº”æ–¹æ³•å—ï¼Ÿï¼ŸçŸ¥é“è¿™ç‚¹åï¼Œé‚£ä¹ˆåè¾¹çš„ä»£ç åˆæ˜¯å¹²å•¥å‘¢ï¼Ÿï¼Ÿå…¶å®åªéœ€è¦æ ¹æ® <code>Match bestMatch = matches.get(0);</code> è¿™å¥ä»£ç å°±èƒ½çŒœå‡ºæ„æ€æ¥äº†ï¼Œä¹Ÿå°±æ˜¯è¯´è·å–çš„ matches é›†åˆå¯èƒ½ä¸æ­¢ä¸€ä¸ª Match å…ƒç´ ï¼Œé‚£ä¹ˆåœ¨å¯¹å…¶æŒ‰ç…§ä¸€å®šè§„åˆ™å®Œæˆæ’åºåï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ€åŒ¹é…é¡¹é¡¹ï¼Œæˆ‘ä»¬æ ¹æœ¬ä¹Ÿå°±æ˜¯è¦æ‹¿åˆ°è¿™ä¸ª Match å®ä¾‹ï¼Œæœ€åå†é€šè¿‡ <code>return bestMatch.handlerMethod;</code> è¿™å¥ä»£ç è¿”å›æœ€ä½³åŒ¹é…é¡¹çš„ handlerMethodï¼Œé‡Œè¾¹æœ‰å½“å‰è¯·æ±‚å¯¹åº”çš„ controller çš„æ–¹æ³•ä¿¡æ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆï¼Œå¯¹å…¶æŒ‰ç…§åŒ¹é…åº¦æ’åºï¼Œæ‹¿åˆ°æœ€åŒ¹é…çš„é¡¹ï¼Œè·å–å…¶ä¸­çš„ HandlerMethod</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    List&lt;Match&gt; matches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;T&gt; directPathMatches = <span class="built_in">this</span>.mappingRegistry.getMappingsByUrl(lookupPath);	<span class="comment">// æ ¹æ® lookupPath è·å– matches é›†åˆ</span></span><br><span class="line">    <span class="keyword">if</span> (directPathMatches != <span class="literal">null</span>) &#123;</span><br><span class="line">        addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (matches.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// No choice but to go through all mappings...</span></span><br><span class="line">        addMatchingMappings(<span class="built_in">this</span>.mappingRegistry.getMappings().keySet(), matches, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">        Comparator&lt;Match&gt; comparator = <span class="keyword">new</span> <span class="title class_">MatchComparator</span>(getMappingComparator(request));</span><br><span class="line">        matches.sort(comparator);	<span class="comment">// å¯¹ matches é›†åˆè¿›è¡Œæ’åº</span></span><br><span class="line">        <span class="type">Match</span> <span class="variable">bestMatch</span> <span class="operator">=</span> matches.get(<span class="number">0</span>);	<span class="comment">// è·å–æœ€åŒ¹é…çš„é¡¹</span></span><br><span class="line">        <span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(matches.size() + <span class="string">&quot; matching mappings: &quot;</span> + matches);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Match</span> <span class="variable">secondBestMatch</span> <span class="operator">=</span> matches.get(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> bestMatch.handlerMethod.getMethod();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m2</span> <span class="operator">=</span> secondBestMatch.handlerMethod.getMethod();</span><br><span class="line">                <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                        <span class="string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="string">&quot;, &quot;</span> + m2 + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);</span><br><span class="line">        handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> bestMatch.handlerMethod;	<span class="comment">// æ‹¿åˆ°æœ€åŒ¹é…é¡¹çš„ HandlerMethod</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handleNoMatch(<span class="built_in">this</span>.mappingRegistry.getMappings().keySet(), lookupPath, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/43f97bb2c603efbdefd505a90dc043ea.jpg" width=600 /></div>

<center>matches é›†åˆçš„å†…å®¹</center>

<p>

<p>æ‹¿åˆ°è¿™ä¸ª handler åï¼Œæˆ‘ä»¬é€€å›åˆ°æ„å»º HandlerExecutionChain çš„æ–¹æ³•ï¼Œå³ <code>AbstractHandlerMapping#getHandler</code> ä¸­ã€‚æ—¢ç„¶æ˜¯æ„å»º ExecutionChainï¼Œé‚£è‡ªç„¶ä¸ä¼šåªæœ‰ä¸€ä¸ª handler å§ï¼Œè¿™ä¸€æ­¥å°±æ˜¯é€šè¿‡è¯¥æ–¹æ³•ä¸­çš„ <code>getHandlerExecutionChain(handler, request);</code> è¿™è¡Œä»£ç å®Œæˆçš„ã€‚é‡Œè¾¹å°±æ˜¯å°†è·å–çš„ handler æ„å»ºä¸º chainï¼ŒåŒæ—¶åŠ å…¥äº†æ ‡ç­¾è§£ææ—¶æ³¨å†Œçš„ MappedInterceptor ä¸­çš„ interceptorã€‚ä»£ç å°±ä¸å†è´´äº†ï¼Œè‡ªè¡ŒæŸ¥çœ‹å³å¯ã€‚å¾—åˆ°è¿™ä¸ª HandlerExecutionChainï¼Œåè¾¹çš„å†…å®¹åŸºæœ¬æ²¡æœ‰å•¥ç´§è¦çš„æ“ä½œï¼Œç„¶åå°±æ˜¯è¿”å›è¿™ä¸ª HandlerExecutionChainã€‚</p>
<p>å†å›åˆ°æˆ‘ä»¬è·å– HandlerExecutionChain çš„å…¥å£å¤„ï¼Œå³ <code>DispatcherServlet#doDispatch</code> æ–¹æ³•çš„ <code>getHandler(processedRequest);</code> è¿™è¡Œä»£ç ï¼Œè¿”å›ç»“æœå°±æ˜¯æˆ‘ä»¬çš„ HandlerExecutionChainï¼Œç´§æ¥ç€åˆè°ƒç”¨äº† <code>getHandlerAdapter(mappedHandler.getHandler());</code> è¿™è¡Œä»£ç ï¼Œé‡Œè¾¹çš„å®ç°å¦‚ä¸‹ï¼Œæ ¸å¿ƒé€»è¾‘å°±æ˜¯éå† handlerAdapters é›†åˆï¼Œä»ä¸­è·å–å‡ºèƒ½å¤Ÿå’Œå‚æ•° handler åŒ¹é…çš„å¤„ç†å™¨é€‚é…å™¨ï¼Œé‚£ä¹ˆè¿™ä¸ª handlerAdapters ä¸­éƒ½æœ‰å“ªäº›é€‚é…å™¨å‘¢ï¼Ÿæˆ‘å°†å†…å®¹é€šè¿‡ä¸‹å›¾å±•ç¤ºå‡ºæ¥ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­çš„ä¸¤é¡¹éƒ½æ˜¯æˆ‘ä»¬åœ¨æ ‡ç­¾è§£æä¸­æ³¨å†Œçš„ beanã€‚å…·ä½“çš„åŒ¹é…é€»è¾‘ä¹Ÿå°±ä¸æ·±å…¥çœ‹äº†ï¼Œç›´æ¥è¿”å›ï¼Œå¯ä»¥çŸ¥é“æœ¬ä¾‹ä¸­ï¼Œå¾—åˆ°çš„æ˜¯ RequestMappingHandlerAdapter å®ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerAdapter <span class="title function_">getHandlerAdapter</span><span class="params">(Object handler)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.handlerAdapters != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (HandlerAdapter adapter : <span class="built_in">this</span>.handlerAdapters) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adapter.supports(handler)) &#123;</span><br><span class="line">                <span class="keyword">return</span> adapter;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;No adapter for handler [&quot;</span> + handler +</span><br><span class="line">            <span class="string">&quot;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/cd5b6f38b65c820b1bc736f44967442d.jpg" width=600 /></div>

<center>handlerAdapters é›†åˆçš„å†…å®¹</center>

<p>

<p>å†å¾€ä¸‹èµ°å°±æ˜¯ <code>applyPreHandle(processedRequest, response)</code> è¿™è¡Œä»£ç ï¼Œè¿™é‡Œå°±æ˜¯å¯¹äºå¾—åˆ°çš„ HandlerExecutionChain è°ƒç”¨å‰ç½®å¤„ç†æ–¹æ³•ï¼Œå±äºåŠŸèƒ½æ‹“å±•éƒ¨åˆ†ï¼Œå¤§è‡´ç†è§£å°±å¥½ã€‚ç„¶åå°±æ˜¯ <code>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</code> è¿™å¥ï¼Œmv ä»£è¡¨å°±æ˜¯ springMVC æ¦‚å¿µä¸­çš„ model å’Œ viewã€‚</p>
<p>è¯¥æ–¹æ³•æ ¹æœ¬è¿˜æ˜¯è°ƒç”¨çš„ä¸‹è¾¹è¿™ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¤§éƒ¨åˆ†å†…å®¹éƒ½æ˜¯è¿›è¡Œçš„ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œè¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬åº”è¯¥å…³æ³¨çš„å†…å®¹ï¼Œåªéœ€è¦æ³¨æ„å…¶ä¸­çš„ä¸¤ä¸ªæ ¸å¿ƒé€»è¾‘ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ <code>invokeAndHandle(webRequest, mavContainer);</code> è¿™å¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// æ ¸å¿ƒå°±æ˜¯è·å– ModelAndViewï¼Œæ¨¡å‹æ¥è‡ªç”¨æˆ·æ‰§è¡Œé€»è¾‘çš„ä»£ç ï¼Œè§†å›¾ä¹Ÿæ˜¯</span></span><br><span class="line"><span class="keyword">protected</span> ModelAndView <span class="title function_">invokeHandlerMethod</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">        HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletWebRequest</span> <span class="variable">webRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response);</span><br><span class="line">    <span class="keyword">try</span> &#123;	<span class="comment">// æ•°æ®ç»‘å®šå·¥å‚</span></span><br><span class="line">        <span class="type">WebDataBinderFactory</span> <span class="variable">binderFactory</span> <span class="operator">=</span> getDataBinderFactory(handlerMethod);</span><br><span class="line">        <span class="type">ModelFactory</span> <span class="variable">modelFactory</span> <span class="operator">=</span> getModelFactory(handlerMethod, binderFactory);	<span class="comment">// æ¨¡å‹å·¥å‚</span></span><br><span class="line">        <span class="comment">// æ ¹æ® HandlerMethod æ„å»º ServletInvocableHandlerMethod</span></span><br><span class="line">        <span class="type">ServletInvocableHandlerMethod</span> <span class="variable">invocableMethod</span> <span class="operator">=</span> createInvocableHandlerMethod(handlerMethod);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.argumentResolvers != <span class="literal">null</span>) &#123;	<span class="comment">// å‚æ•°æ–¹æ³•è§£æå™¨å¡«å……åˆ° ServletInvocableHandlerMethod</span></span><br><span class="line">            invocableMethod.setHandlerMethodArgumentResolvers(<span class="built_in">this</span>.argumentResolvers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>) &#123;	<span class="comment">// è¿”å›å€¼å¤„ç†å™¨æ·»åŠ åˆ° ServletInvocableHandlerMethod</span></span><br><span class="line">            invocableMethod.setHandlerMethodReturnValueHandlers(<span class="built_in">this</span>.returnValueHandlers);</span><br><span class="line">        &#125;</span><br><span class="line">        invocableMethod.setDataBinderFactory(binderFactory);	<span class="comment">// è®¾ç½®æ•°æ®ç»‘å®šå·¥å‚</span></span><br><span class="line">        invocableMethod.setParameterNameDiscoverer(<span class="built_in">this</span>.parameterNameDiscoverer);	<span class="comment">// å‚æ•°åå‘ç°å™¨</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ModelAndViewContainer</span> <span class="variable">mavContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>();	<span class="comment">// æ¨¡å‹è§†å›¾å®¹å™¨</span></span><br><span class="line">        mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">        modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br><span class="line">        mavContainer.setIgnoreDefaultModelOnRedirect(<span class="built_in">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class="line">        <span class="comment">// å¼‚æ­¥ web è¯·æ±‚</span></span><br><span class="line">        <span class="type">AsyncWebRequest</span> <span class="variable">asyncWebRequest</span> <span class="operator">=</span> WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">        asyncWebRequest.setTimeout(<span class="built_in">this</span>.asyncRequestTimeout);</span><br><span class="line">        <span class="comment">// web å¼‚æ­¥ç®¡ç†å™¨</span></span><br><span class="line">        <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">        asyncManager.setTaskExecutor(<span class="built_in">this</span>.taskExecutor);</span><br><span class="line">        asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">        asyncManager.registerCallableInterceptors(<span class="built_in">this</span>.callableInterceptors);</span><br><span class="line">        asyncManager.registerDeferredResultInterceptors(<span class="built_in">this</span>.deferredResultInterceptors);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> asyncManager.getConcurrentResult();</span><br><span class="line">            mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">            asyncManager.clearConcurrentResult();</span><br><span class="line">            LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">formatted</span> <span class="operator">=</span> LogFormatUtils.formatValue(result, !traceOn);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Resume with async result [&quot;</span> + formatted + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è§¦å‘ç”¨æˆ· bean çš„å¯¹åº”æ–¹æ³•ï¼Œå®Œæˆå¯¹äºè¿”å›ç»“æœçš„å¤„ç†</span></span><br><span class="line">        invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">        <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›æ¨¡å‹å’Œè§†å›¾</span></span><br><span class="line">        <span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        webRequest.requestCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>invokeAndHandle(webRequest, mavContainer);</code> å®ç°å¦‚ä¸‹ï¼Œæ€»çš„æ¥è¯´ä¹Ÿåªæœ‰ä¸¤ä¸ªæ ¸å¿ƒé€»è¾‘ï¼Œé¦–å…ˆæ˜¯ <code>invokeForRequest(webRequest, mavContainer, providedArgs);</code> è¿™å¥ä»£ç ï¼Œå®ƒæ ¹æœ¬æ˜¯è°ƒç”¨äº†ç”¨æˆ·çš„é€»è¾‘ä»£ç ï¼Œè¿”å›çš„å°±æ˜¯å¯¹åº”æ–¹æ³•çš„è¿”å›å€¼ï¼Œå°±æœ¬ä¾‹è€Œè¨€ï¼Œæˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ª ModelAndView å®ä¾‹ï¼Œè°ƒç”¨çš„è¿‡ç¨‹å¾ˆç®€å•ï¼Œæ˜¯é€šè¿‡åå°„æ–¹å¼è¿›è¡Œçš„ï¼Œä¸å†ç»™å‡ºä»£ç ï¼Œè‡ªè¡Œè·Ÿè¸ªå³å¯ï¼Œç„¶åå°±æ˜¯å¯¹äºè¿™ä¸ªè¿”å›ç»“æœæ¥è¿›è¡Œå¤„ç†ï¼Œå®ƒä½“ç°åœ¨ <code>returnValueHandlers.handleReturnValue</code> è¿™å¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è§¦å‘ç”¨æˆ· bean çš„å¯¹åº”æ–¹æ³•ï¼Œå®Œæˆå¯¹äºè¿”å›ç»“æœçš„å¤„ç†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">        Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// è§¦å‘ç”¨æˆ· bean çš„å¯¹åº”æ–¹æ³•</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line">    setResponseStatus(webRequest);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (returnValue == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="literal">null</span> || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">            disableContentCachingIfNecessary(webRequest);</span><br><span class="line">            mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(<span class="literal">false</span>);</span><br><span class="line">    Assert.state(<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>, <span class="string">&quot;No return value handlers&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line">                returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(formatErrorForReturnValue(returnValue), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>returnValueHandlers.handleReturnValue</code> æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼Œé‡Œè¾¹æ‰§è¡Œäº† selectHandler æ–¹æ³•ï¼Œé€‰æ‹©çš„æ˜¯å•¥å‘¢ï¼Ÿï¼Ÿæ³¨æ„æˆ‘ä»¬ç°åœ¨æ˜¯è°ƒç”¨çš„ returnValueHandlers çš„æ–¹æ³•ï¼Œæ‰€ä»¥é€šè¿‡æŸ¥çœ‹ returnValueHandlers å®ä¾‹çš„å†…å®¹å°±èƒ½çŸ¥é“æ˜¯å¯¹ä»€ä¹ˆè¿›è¡Œé€‰æ‹©ã€‚ä»ä¸‹å›¾æˆ‘ä»¬çŸ¥é“ï¼Œè¯¥å®ä¾‹æŒæœ‰äº† 15 ä¸ª handlerï¼Œé‚£ä¹ˆå¯ä»¥æƒ³åˆ° selectHandler æ–¹æ³•å°±æ˜¯ä»è¿™ä¸ª 15 ä¸ª handler ä¸­é€‰æ‹©èƒ½å¤Ÿå¯¹å‚æ•° returnValue è¿›è¡Œå¤„ç†çš„åˆé€‚çš„ handler äº†ã€‚æ¢å¥è¯æ¥è¯´ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·ä»£ç è¿™é‡Œè¿”å›çš„æ˜¯ ModelAndView å®ä¾‹ï¼Œé‚£ä¹ˆ selectHandler æ–¹æ³•å°±æ˜¯ä» 15 ä¸ª handler ä¸­é€‰æ‹©ä¸€ä¸ªèƒ½å¤Ÿå¯¹ ModelAndView å®ä¾‹è¿›è¡Œå¤„ç† handlerã€‚æ‹¿åˆ°è¿™ä¸ª handler åï¼Œå°±æ˜¯å¯¹ç”¨æˆ·ä»£ç çš„ç»“æœè¿›è¡Œå¤„ç†ï¼Œæœ¬ä¾‹ä¸­æ‹¿åˆ°çš„ handler æ˜¯ ModelAndViewMethodReturnValueHandler å®ä¾‹ï¼Œæ¥ç€çœ‹å®ƒçš„ handleReturnValue æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// æ ¹æ® MethodParameter ä» returnValueHandlers ä¸­é€‰æ‹©åˆé€‚çš„ handlerï¼Œä½¿ç”¨è·å¾—çš„ handler å¤„ç†å“åº”ç»“æœ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ® MethodParameter ä» returnValueHandlers ä¸­é€‰æ‹©åˆé€‚çš„ handler</span></span><br><span class="line">    <span class="type">HandlerMethodReturnValueHandler</span> <span class="variable">handler</span> <span class="operator">=</span> selectHandler(returnValue, returnType);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());</span><br><span class="line">    &#125;	<span class="comment">// ä½¿ç”¨è·å¾—çš„ handler å¤„ç†å“åº”ç»“æœ</span></span><br><span class="line">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/3db2dc8433ed956fcab8a8c7bd9da1dc.jpg" width=600 /></div>

<center>returnValueHandlers é›†åˆçš„å†…å®¹</center>

<p>

<p><code>ModelAndViewMethodReturnValueHandler#handleReturnValue</code> æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯å¯¹å‚æ•° mavContainer è¿›è¡Œäº†å„é¡¹å±æ€§çš„è®¾ç½®ï¼Œæ‹¿æœ¬ä¾‹æ¥è¯´ï¼Œé‡è¦çš„å±æ€§å°±ä¸¤ä¸ªï¼Œ<code>setViewName(viewName)</code> æ–¹æ³•æ˜¯è®¾ç½®çš„è§†å›¾åå­— â€œuserlistâ€ï¼Œ<code>addAllAttributes(mav.getModel())</code> æ–¹æ³•è®¾ç½®çš„æ˜¯æ¨¡å‹ä¿¡æ¯ï¼Œæœ¬ä¾‹çš„å†…å®¹è§ä¸‹å›¾ï¼Œè¿™æ ·é€šè¿‡ Handler å¯¹ç”¨æˆ·ä»£ç è¿”å›ç»“æœè¿›è¡Œå¤„ç†çš„é€»è¾‘å°±å¾ˆæ¸…æ¥šäº†ã€‚è®°ä½ä¸€ç‚¹ï¼Œæ¨¡å‹å’Œè§†å›¾ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†å‚æ•°çš„ ModelAndViewContainer ä¸­ï¼Œå¥½äº†æˆ‘ä»¬é€æ­¥è¿”å›ï¼Œçœ‹çœ‹è¿™ä¸ª ModelAndViewContainer å“ªé‡Œè¢«ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (returnValue == <span class="literal">null</span>) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">mav</span> <span class="operator">=</span> (ModelAndView) returnValue;</span><br><span class="line">    <span class="keyword">if</span> (mav.isReference()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">viewName</span> <span class="operator">=</span> mav.getViewName();</span><br><span class="line">        mavContainer.setViewName(viewName);</span><br><span class="line">        <span class="keyword">if</span> (viewName != <span class="literal">null</span> &amp;&amp; isRedirectViewName(viewName)) &#123;</span><br><span class="line">            mavContainer.setRedirectModelScenario(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> mav.getView();</span><br><span class="line">        mavContainer.setView(view);</span><br><span class="line">        <span class="keyword">if</span> (view <span class="keyword">instanceof</span> SmartView &amp;&amp; ((SmartView) view).isRedirectView()) &#123;</span><br><span class="line">            mavContainer.setRedirectModelScenario(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mavContainer.setStatus(mav.getStatus());</span><br><span class="line">    mavContainer.addAllAttributes(mav.getModel());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/ce17ba9785d15aa37a1c0e50c06401ca.jpg" width=600 /></div>

<center>æ¨¡å‹çš„å†…å®¹</center>

<p>

<p>å›é€€çš„ä½ç½®å°±æ˜¯ <code>RequestMappingHandlerAdapter#invokeHandlerMethod</code> æ–¹æ³•çš„ <code>invokeAndHandle(webRequest, mavContainer);</code> è¿™è¡Œä»£ç å¤„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¾¹å®Œæˆäº†ç”¨æˆ·ä»£ç é€»è¾‘çš„è°ƒç”¨ï¼ŒåŒæ—¶åˆé€šè¿‡ handler å®Œæˆäº†å¯¹äºè¿”å›ç»“æœçš„å¤„ç†ï¼Œæœ€ç»ˆå°±æ˜¯å°†æ¨¡å‹å’Œè§†å›¾ä¿¡æ¯ä¿å­˜åˆ°äº† ModelAndViewContainerã€‚å†å¾€ä¸‹èµ°å°±æ˜¯ <code>getModelAndView(mavContainer, modelFactory, webRequest);</code> è¿™å¥ï¼Œå‚æ•° mavContainer ä¸­æ­¤æ—¶å·²ç»æŒæœ‰äº†æˆ‘ä»¬çš„æ¨¡å‹å’Œè§†å›¾ä¿¡æ¯ï¼Œè·Ÿè¿›å»çœ‹çœ‹åšäº†å•¥æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼Œç»†èŠ‚ä¹Ÿä¸ç®¡äº†ï¼Œå¯ä»¥çŸ¥é“æ ¸å¿ƒå°±æ˜¯æ„å»ºäº†ä¸€ä¸ª ModelAndView å®ä¾‹ï¼Œç„¶åå°† ModelAndViewContainer ä¸­çš„æ¨¡å‹å’Œè§†å›¾ä¿¡æ¯éƒ½å¡«å……åˆ°äº†æ–°æ„å»ºçš„ ModelAndView ä¸­è¿”å›ã€‚æ—¢ç„¶è¿”å›ï¼Œæˆ‘ä»¬å°±åªéœ€è¦ä¸æ–­åœ°åé€€ï¼Œçœ‹åœ¨å“ªé‡Œä¼šä½¿ç”¨æˆ‘ä»¬ç°åœ¨å¾—åˆ°çš„è¿™ä¸ª ModelAndViewï¼Œå…¶ç»“æœæ˜¯ <code>DispatcherServlet#doDispatch</code> æ–¹æ³•çš„ <code>ha.handle(processedRequest, response, mappedHandler.getHandler());</code> è¿™è¡Œä»£ç å¤„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ˜¯é€šè¿‡æœ€åˆå¾—åˆ°çš„å¤„ç†å™¨é€‚é…å™¨æ¥å¾—åˆ° ModelAndView å®ä¾‹çš„ã€‚ç´§æ¥ç€å†è°ƒç”¨ HandlerExecutionChain çš„åç½®å¤„ç†æ–¹æ³•ï¼Œæ€æƒ³è·Ÿå‰ç½®å¤„ç†æ–¹æ³•å·®ä¸å¤šï¼Œäº†è§£å°±å¥½ã€‚æ¥ç€å°±æ˜¯ä½¿ç”¨è¿™ä¸ªæˆ‘ä»¬å¥½ä¸å®¹æ˜“å¾—åˆ°çš„ ModelAndView å®ä¾‹äº†ï¼Œå®ƒåœ¨ <code>DispatcherServlet#processDispatchResult</code> æ–¹æ³•ä¸­å®Œæˆï¼Œè¯¥æ–¹æ³•åšäº†å¾ˆå¤šé™„åŠ æ“ä½œï¼Œä½†æ ¸å¿ƒå…¶å®å°±åªæœ‰ <code>render(mv, request, response);</code> è¿™ä¸€å¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> ModelAndView <span class="title function_">getModelAndView</span><span class="params">(ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">        ModelFactory modelFactory, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    modelFactory.updateModel(webRequest, mavContainer);</span><br><span class="line">    <span class="keyword">if</span> (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ModelMap</span> <span class="variable">model</span> <span class="operator">=</span> mavContainer.getModel();	<span class="comment">// æ¨¡å‹ mapï¼Œé‡Œè¾¹å­˜æ”¾çš„æ˜¯ï¼Œæ•°æ® key å’Œæ•°æ® value</span></span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">mav</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(mavContainer.getViewName(), model, mavContainer.getStatus());	<span class="comment">// ModelAndView é‡Œè¾¹åŒ…å«äº†æ¨¡å‹å’Œè§†å›¾ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (!mavContainer.isViewReference()) &#123;</span><br><span class="line">        mav.setView((View) mavContainer.getView());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (model <span class="keyword">instanceof</span> RedirectAttributes) &#123;</span><br><span class="line">        Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">        <span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">            RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>render æ–¹æ³•å…·ä½“çš„å®ç°å¦‚ä¸‹ï¼Œæ ¸å¿ƒé€»è¾‘å°±åªæœ‰ä¸¤ä¸ªï¼Œè·å–è§†å›¾å®ä¾‹ï¼Œç„¶åä½¿ç”¨è¯¥å®ä¾‹è¿›è¡Œæ¸²æŸ“ã€‚å…ˆçœ‹è§†å›¾å®ä¾‹å¦‚ä½•è·å–å§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> */	<span class="comment">// å°è¯•æ ¹æ®ç¯å¢ƒä¸­çš„è§†å›¾è§£æå™¨æ¥åˆ›å»ºè§†å›¾ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–è§†å›¾ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¿›è¡Œåˆ›å»ºï¼ˆåˆ¤æ–­è§†å›¾åå­—ï¼Œredirect: å’Œ forward: å•ç‹¬å¤„ç†ï¼Œå¦åˆ™è·å–è®¾ç½®çš„ view class å¯¹åº”çš„è§†å›¾å®ä¾‹ï¼Œå®Œæˆç›¸å…³ä¿¡æ¯çš„è®¾ç½®ï¼Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è¿”å›ï¼‰å¹¶è¿”å›ã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;	<span class="comment">// è·å–å…¨éƒ¨çš„æ¨¡å‹ï¼Œå°†æ¨¡å‹ä»¥å‚æ•°çš„å½¢å¼æ·»åŠ åˆ° request ä¸­ï¼Œæ‹¿åˆ°è·³è½¬çš„è·¯å¾„ï¼Œè·å– RequestDispatcherï¼Œè¿›è¡Œè¯·æ±‚è½¬å‘</span></span><br><span class="line">    <span class="comment">// Determine locale for request and apply it to the response.</span></span><br><span class="line">    <span class="type">Locale</span> <span class="variable">locale</span> <span class="operator">=</span>	<span class="comment">// åœ°åŒºä¿¡æ¯</span></span><br><span class="line">            (<span class="built_in">this</span>.localeResolver != <span class="literal">null</span> ? <span class="built_in">this</span>.localeResolver.resolveLocale(request) : request.getLocale());</span><br><span class="line">    response.setLocale(locale);</span><br><span class="line"></span><br><span class="line">    View view;</span><br><span class="line">    <span class="type">String</span> <span class="variable">viewName</span> <span class="operator">=</span> mv.getViewName();	<span class="comment">// è§†å›¾åå­—</span></span><br><span class="line">    <span class="keyword">if</span> (viewName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We need to resolve the view name.</span></span><br><span class="line">        view = resolveViewName(viewName, mv.getModelInternal(), locale, request);</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;	<span class="comment">// å°è¯•æ ¹æ®ç¯å¢ƒä¸­çš„è§†å›¾è§£æå™¨æ¥åˆ›å»ºè§†å›¾ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–è§†å›¾ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¿›è¡Œåˆ›å»ºï¼ˆåˆ¤æ–­è§†å›¾åå­—ï¼Œredirect: å’Œ forward: å•ç‹¬å¤„ç†ï¼Œå¦åˆ™è·å–è®¾ç½®çš„ view class å¯¹åº”çš„è§†å›¾å®ä¾‹ï¼Œå®Œæˆç›¸å…³ä¿¡æ¯çš„è®¾ç½®ï¼Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è¿”å›ï¼‰å¹¶è¿”å›ã€‚</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Could not resolve view with name &#x27;&quot;</span> + mv.getViewName() +</span><br><span class="line">                    <span class="string">&quot;&#x27; in servlet with name &#x27;&quot;</span> + getServletName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No need to lookup: the ModelAndView object contains the actual View object.</span></span><br><span class="line">        view = mv.getView();</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;ModelAndView [&quot;</span> + mv + <span class="string">&quot;] neither contains a view name nor a &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;View object in servlet with name &#x27;&quot;</span> + getServletName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delegate to the View object for rendering.</span></span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Rendering view [&quot;</span> + view + <span class="string">&quot;] &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mv.getStatus() != <span class="literal">null</span>) &#123;</span><br><span class="line">            response.setStatus(mv.getStatus().value());</span><br><span class="line">        &#125;	<span class="comment">// è·å–å…¨éƒ¨çš„æ¨¡å‹ï¼Œå°†æ¨¡å‹ä»¥å‚æ•°çš„å½¢å¼æ·»åŠ åˆ° request ä¸­ï¼Œæ‹¿åˆ°è·³è½¬çš„è·¯å¾„ï¼Œè·å– RequestDispatcherï¼Œè¿›è¡Œè¯·æ±‚è½¬å‘</span></span><br><span class="line">        view.render(mv.getModelInternal(), request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Error rendering view [&quot;</span> + view + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§†å›¾å®ä¾‹è·å–æ˜¯åœ¨ <code>DispatcherServlet#resolveViewName</code> æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œå·®ä¸å¤šå°±æ˜¯é€šè¿‡è§†å›¾è§£æå™¨å®Œæˆçš„ï¼Œæœ¬ä¾‹ä¸­è§†å›¾è§£æå™¨åªæœ‰ä¸€ä¸ªå°±æ˜¯ spring é…ç½®æ–‡ä»¶ä¸­ç»™å‡ºçš„é‚£ä¸ª InternalResourceViewResolverã€‚å®ƒæ˜¯å¦‚ä½•è·å–æˆ‘ä»¬éœ€è¦çš„è§†å›¾å®ä¾‹çš„ä»£ç ï¼Œæœ¬æ–‡å°±ä¸åœ¨æ·±ç©¶äº†ï¼Œä½†æ˜¯åœ¨æˆ‘çš„æºç ä¸­ï¼Œè¿˜æ˜¯æœ‰æ·»åŠ ä¸€äº›æ³¨é‡Šï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±äº†è§£ï¼Œè¿™é‡Œåªç»™å‡ºæˆ‘ä»¬è·å–çš„è§†å›¾å®ä¾‹ç±»å‹ä¸º JstlViewã€‚</p>
<p>è·å–è§†å›¾å®ä¾‹åªæ˜¯ä¸Šè¾¹ <code>DispatcherServlet#render</code> æ–¹æ³•çš„ç¬¬ä¸€ä¸ªæ ¸å¿ƒé€»è¾‘ï¼Œç¬¬äºŒä¸ªå°±æ˜¯é€šè¿‡ç°åœ¨è·å–çš„è¿™ä¸ª JstlView è§†å›¾å®ä¾‹æ¥å®Œæˆæ¸²æŸ“æ“ä½œï¼Œå®ƒæ ¹æœ¬æ˜¯è°ƒç”¨çš„ <code>InternalResourceView#renderMergedOutputModel</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// å°è¯•æ ¹æ®ç¯å¢ƒä¸­çš„è§†å›¾è§£æå™¨æ¥åˆ›å»ºè§†å›¾ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–è§†å›¾ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¿›è¡Œåˆ›å»ºï¼ˆåˆ¤æ–­è§†å›¾åå­—ï¼Œredirect: å’Œ forward: å•ç‹¬å¤„ç†ï¼Œå¦åˆ™è·å–è®¾ç½®çš„ view class å¯¹åº”çš„è§†å›¾å®ä¾‹ï¼Œå®Œæˆç›¸å…³ä¿¡æ¯çš„è®¾ç½®ï¼Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è¿”å›ï¼‰å¹¶è¿”å›ã€‚</span></span><br><span class="line"><span class="keyword">protected</span> View <span class="title function_">resolveViewName</span><span class="params">(String viewName, <span class="meta">@Nullable</span> Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">        Locale locale, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.viewResolvers != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (ViewResolver viewResolver : <span class="built_in">this</span>.viewResolvers) &#123;</span><br><span class="line">            <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">            <span class="keyword">if</span> (view != <span class="literal">null</span>) &#123;	<span class="comment">// å°è¯•ä»ç¼“å­˜ä¸­è·å–è§†å›¾ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¿›è¡Œåˆ›å»ºï¼ˆåˆ¤æ–­è§†å›¾åå­—ï¼Œredirect: å’Œ forward: å•ç‹¬å¤„ç†ï¼Œå¦åˆ™è·å–è®¾ç½®çš„ view class å¯¹åº”çš„è§†å›¾å®ä¾‹ï¼Œå®Œæˆç›¸å…³ä¿¡æ¯çš„è®¾ç½®ï¼Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è¿”å›ï¼‰å¹¶è¿”å›ã€‚</span></span><br><span class="line">                <span class="keyword">return</span> view;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>InternalResourceView#renderMergedOutputModel</code> æ–¹æ³•ä»£ç å®ç°å¦‚ä¸‹ï¼Œæ ¹æ®æˆ‘ä»¬ä½¿ç”¨åŸç”Ÿ servlet çš„ç»éªŒï¼Œè¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å…³æ³¨çš„å°±ä¸‰ä¸ªï¼Œç¬¬ä¸€å°±æ˜¯ <code>exposeModelAsRequestAttributes(model, request);</code> è¿™å¥ä»£ç æ˜¯å°†æ¨¡å‹ä¿¡æ¯å¡«å……åˆ° HttpServletRequest çš„å±æ€§ä¸­ï¼Œè¿™æ · jsp é¡µé¢èƒ½å¤Ÿé€šè¿‡ç›¸åº”çš„è¯­æ³•æ¥å®Œæˆå€¼çš„è·å–ã€‚ç¬¬äºŒä¸ªå°±æ˜¯ <code>RequestDispatcher rd = getRequestDispatcher(request, dispatcherPath);</code> è¿™å¥ä»£ç ï¼Œæ³¨æ„è¿™é‡Œçš„ dispatcherPathï¼Œå®ƒçš„å€¼æ˜¯ <code>/WEB-INF/jsp/userlist.jsp</code> è¿™ä¸ªæ­£å¥½å°±æ˜¯ controller ä¸­æŒ‡å®šçš„è§†å›¾åç§°å¯¹åº”çš„ jsp é¡µé¢ï¼Œæˆ‘ä»¬çš„åŸç”Ÿ servlet ä½¿ç”¨è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯è®© RequestDispatcher æŒæœ‰äº† jsp çš„è·¯å¾„ä¿¡æ¯ã€‚æœ€åå°±æ˜¯ <code>rd.forward(request, response);</code> è¿™è¡Œä»£ç çš„è°ƒç”¨ï¼Œå†…éƒ¨çš„é€»è¾‘å·²ç»ä¸å±äºæˆ‘ä»¬åˆ†æçš„èŒƒç•´äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™å¥æ‰§è¡Œå®Œæˆåå°±ä¼šé€šè¿‡ jsp ç”Ÿæˆ servletï¼Œç„¶åå®Œæˆå“åº”ä¿¡æ¯åˆ°å®¢æˆ·ç«¯çš„å‘é€ã€‚è¿™æ ·æ•´ä¸ª springMVC çš„æ‰§è¡Œæµç¨‹å°±ç®—åˆ†æå®Œæ¯•äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// å°†æ¨¡å‹ä»¥å‚æ•°çš„å½¢å¼æ·»åŠ åˆ° request ä¸­ï¼Œæ‹¿åˆ°è·³è½¬çš„è·¯å¾„ï¼Œè·å– RequestDispatcherï¼Œè¿›è¡Œè¯·æ±‚è½¬å‘</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">renderMergedOutputModel</span><span class="params">(</span></span><br><span class="line"><span class="params">        Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Expose the model object as request attributes.</span></span><br><span class="line">    exposeModelAsRequestAttributes(model, request);	<span class="comment">// å°†æ¨¡å‹å…¨éƒ¨æ·»åŠ åˆ° request å±æ€§ä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Expose helpers as request attributes, if any.</span></span><br><span class="line">    exposeHelpers(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine the path for the request dispatcher.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">dispatcherPath</span> <span class="operator">=</span> prepareForRendering(request, response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Obtain a RequestDispatcher for the target resource (typically a JSP).</span></span><br><span class="line">    <span class="type">RequestDispatcher</span> <span class="variable">rd</span> <span class="operator">=</span> getRequestDispatcher(request, dispatcherPath);</span><br><span class="line">    <span class="keyword">if</span> (rd == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Could not get RequestDispatcher for [&quot;</span> + getUrl() +</span><br><span class="line">                <span class="string">&quot;]: Check that the corresponding file exists within your web application archive!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If already included or response already committed, perform include, else forward.</span></span><br><span class="line">    <span class="keyword">if</span> (useInclude(request, response)) &#123;</span><br><span class="line">        response.setContentType(getContentType());</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Including [&quot;</span> + getUrl() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        rd.include(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note: The forwarded resource is supposed to determine the content type itself.</span></span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Forwarding to [&quot;</span> + getUrl() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        rd.forward(request, response);	<span class="comment">// è¿™é‡Œå°±æ˜¯è¿›è¡Œè¯·æ±‚è½¬å‘äº†ï¼Œä¹Ÿå°±æ˜¯è·³è½¬åˆ°æˆ‘ä»¬æŒ‡å®šçš„é‚£ä¸ªè§†å›¾</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªçš„ springMVC è¯·æ±‚å¤„ç†è¿‡ç¨‹è¿˜ç®—æ˜¯å¾ˆé•¿çš„ï¼Œè¿™é‡Œè¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼Œé¦–å…ˆæˆ‘ä»¬çš„ DispatcherServlet é‡å†™äº† HttpServlet çš„ service æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•å®é™…åˆæ˜¯è°ƒç”¨äº†çˆ¶ç±» HttpServlet ä¸­çš„ service æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå®ƒä¼šæ ¹æ®è¯·æ±‚çš„ç±»å‹æ¥åˆ¤æ–­è°ƒç”¨é‚£ä¸ª doXXX æ–¹æ³•ã€‚æˆ‘ä»¬çš„ DispatcherServlet å®Œæˆäº†å¯¹ doXXX æ–¹æ³•çš„é‡å†™ï¼Œæ‰€ä»¥æ ¹æœ¬è¿˜æ˜¯ä¼šè°ƒç”¨ DispatcherServlet çš„ doXXX é‡å†™æ–¹æ³•ã€‚å°±æœ¬ä¾‹è€Œè¨€ï¼Œæˆ‘ä»¬æ˜¯è°ƒç”¨çš„ doGet æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ ¹æœ¬æ˜¯è°ƒç”¨çš„ DispatcherServlet#doDispatch æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šé¦–å…ˆæ ¹æ® request ä¿¡æ¯ä»å¤„ç†å™¨æ˜ å°„é›†åˆä¸­å¾—åˆ°åˆé€‚çš„å¤„ç†å™¨æ˜ å°„å™¨ï¼Œå†ä»å¤„ç†å™¨æ˜ å°„å™¨ä¿å­˜çš„å¤„ç†å™¨ä¿¡æ¯ä¸­è·å–æœ€ä½³çš„å¤„ç†å™¨ã€‚æ¥ç€å°±æ˜¯æ ¹æ®è·å¾—çš„å¤„ç†å™¨æ¥å¾—åˆ°åŒ¹é…çš„å¤„ç†å™¨é€‚é…å™¨ï¼Œåˆ©ç”¨è¿™ä¸ªå¤„ç†å™¨é€‚é…å™¨ï¼Œæˆ‘ä»¬å®Œæˆäº†ç”¨æˆ·ä»£ç çš„è°ƒç”¨ï¼Œå¯¹äºè°ƒç”¨è¿”å›çš„ç»“æœï¼Œæˆ‘ä»¬é€‰æ‹©äº†åˆé€‚çš„è¿”å›å€¼å¤„ç†å™¨å®Œæˆäº†å¯¹äºç»“æœçš„å¤„ç†ï¼Œå°±æœ¬ä¾‹è€Œè¨€ï¼Œæˆ‘ä»¬çš„ç»“æœå¤„ç†å™¨å°±æ˜¯å°†ç»“æœçš„æ¨¡å‹å’Œè§†å›¾ä¿¡æ¯å¡«å……åˆ°äº† ModelAndViewContainer ä¸­ã€‚æ¥ç€å°±æ˜¯æ ¹æ® ModelAndViewContainer æ„å»º ModelAndView å®ä¾‹ï¼Œæ‹¿åˆ°è¿™ä¸ª ModelAndView å®ä¾‹åè¿›è¡Œæ¸²æŸ“æ“ä½œï¼Œæ ¸å¿ƒé€»è¾‘å°±ä¸¤ä¸ªï¼Œå¾—åˆ°åˆé€‚çš„è§†å›¾å®ä¾‹ï¼Œç„¶åé€šè¿‡è¯¥å®ä¾‹å®Œæˆæ¸²æŸ“æ“ä½œï¼Œä»¥ä¸Šå°±æ˜¯æ•´ä¸ª springMVC çš„æ‰§è¡Œæµç¨‹ã€‚</p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Spring/">#Spring</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/SpringMVC/">#SpringMVC</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2019/08/01/2019-08-01-HashMap%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">HashMapå®ç°åŸç†åˆ†æ</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2019/07/22/2019-07-22-Spring%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Springäº‹åŠ¡æœºåˆ¶å®ç°åŸç†</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">å°æ©˜å­ğŸŠ</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F"><span class="nav-number">2.</span> <span class="nav-text">ç¤ºä¾‹ç¨‹åº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebApplicationContext-%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">WebApplicationContext çš„åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DispatcherServlet-%E8%AF%B4%E6%98%8E"><span class="nav-number">4.</span> <span class="nav-text">DispatcherServlet è¯´æ˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lt-mvc-annotation-driven-x2F-gt-%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">&lt;mvc:annotation-driven&#x2F;&gt; æ ‡ç­¾è§£æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">6.</span> <span class="nav-text">è¯·æ±‚å¤„ç†æµç¨‹</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
