<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Java åç«¯">
    <meta name="description" content="å°æ©˜å­ğŸŠçš„ä¸ªäººä¸»é¡µï¼Œæ¬¢è¿è®¿é—®~~">
    <meta name="author" content="å°æ©˜å­ğŸŠ">
    
    <title>
        
            Spring AOP å®ç°åŸç†åˆ†æ |
        
        AprilYoLies
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://img.aprilyolies.top/img/typora/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"aprilyolies.top","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"https://img.aprilyolies.top/img/typora/avatar.jpg","favicon":"https://img.aprilyolies.top/img/typora/avatar.jpg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"å¹²ç‡¥çš„ç©ºæ°”ï¼Œå°˜åŸƒçš„å‘³é“ï¼Œæˆ‘åœ¨å…¶ä¸­â€¦è¸ä¸Šæ—…é€”ï¼"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </a>
            
            <a class="logo-title" href="/">
                AprilYoLies
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Spring AOP å®ç°åŸç†åˆ†æ</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">å°æ©˜å­ğŸŠ</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2019-07-21 11:16:21</span>
        <span class="mobile">2019-07-21 11:16</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">æºç åˆ†æ</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Spring/">Spring</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/AOP/">AOP</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡æ˜¯å…³äº spring aop å®ç°åŸç†çš„åˆ†ææ–‡ç« ï¼Œå› ä¸º spring æºç åšå¤§ç²¾æ·±ï¼Œå¯¹äº aop å®ç°çš„ç»†èŠ‚éƒ¨åˆ†ä¸å¯èƒ½é€šè¿‡æ­¤ä¸€ç¯‡æ–‡ç« è®²è§£æ¸…æ¥šï¼Œæ‰€ä»¥æœ¬æ–‡åªæ˜¯ä»æ•´ä½“çš„è§’åº¦æ¥çœ‹ aop çš„å®ç°ï¼Œè™½ç„¶ç»†èŠ‚éƒ¨åˆ†ä¸ä¼šç»†è¯´ï¼Œä½†æ˜¯å¯¹äºç†è§£å…¶å®ç°åŠåˆ†æå…¶æ‰§è¡Œè¿‡ç¨‹è€Œè¨€è¶³ä»¥ã€‚å¦å¤–æœ¬æ–‡æ˜¯å»ºç«‹åœ¨ä½ å·²ç»å¯¹ spring çš„ ioc å®ç°åŸç†æœ‰ä¸€å®šçš„ç†è§£åŸºç¡€ä¹‹ä¸Šï¼Œç‰¹åˆ«æ˜¯æ¸…æ¥š spring çš„æ ‡ç­¾è§£æä»¥åŠ spring ç®¡ç†çš„ bean çš„å£°æ˜å‘¨æœŸã€‚åœ¨å†™è¿™ç¯‡æ–‡ç« ä¹‹å‰æˆ‘å…ˆå¤§è‡´çœ‹è¿‡äº† spring-framework æºç çš„ aop éƒ¨åˆ†ï¼Œåœ¨çœ‹çš„è¿‡ç¨‹ä¸­è¿˜å†™äº†ä¸€å°éƒ¨åˆ†æ³¨é‡Šæ¥å¸®åŠ©è‡ªå·±ç†è§£ï¼Œè¿™éƒ¨åˆ†å†…å®¹æˆ‘å·²ç»å°†å…¶æ”¾åˆ°äº†æˆ‘çš„ github ä¹‹ä¸Šï¼Œæ¬¢è¿<a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/spring-framework" >æ¬¢è¿è‡ªå–<i class="fas fa-external-link-alt"></i></a>ã€‚ æ•´ä¸ªæºç æ˜¯æˆ‘ä»å®˜æ–¹ fork ä¸‹æ¥çš„ï¼Œé™¤äº†æ³¨é‡Šéƒ¨åˆ†æˆ‘æ²¡åšä»»ä½•æ”¹åŠ¨ï¼Œå¦å¤–åœ¨å…¶ä¸­åŠ äº†ä¸€ä¸ª spring-example æ¨¡å—ï¼Œç”¨æ¥å†™æµ‹è¯•æ ·ä¾‹ï¼Œæ–¹ä¾¿æºç åˆ†æã€‚åŸé¡¹ç›®æ˜¯ç”¨ gradle æ„å»ºçš„ï¼Œå¯¹äºä¸ç†Ÿæ‚‰ gradle é¡¹ç›®çš„åŒå­¦å¯ä»¥å‚è€ƒé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ <code>import-into-xxx.md</code> æ–‡æ¡£æ¥å°†é¡¹ç›®å¯¼å…¥åˆ°è‡ªå·±ç†Ÿæ‚‰çš„ ide ä¸­ï¼ˆå…¶å®æˆ‘ fork ä¸‹æ¥ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦ gradel å·¥ç¨‹ï¼‰ï¼ŒåŸé¡¹ç›® build.gradle æ–‡ä»¶ä¸­æœ‰å¾ˆå¤šä¸å¿…è¦çš„ taskï¼Œæˆ‘å·²ç»å°†å…¶æ³¨é‡Šæ‰ï¼Œç”±æ­¤æ¥æé«˜ build çš„é€Ÿåº¦ã€‚</p>
<h2 id="aop-æµ‹è¯•æ ·ä¾‹"><a href="#aop-æµ‹è¯•æ ·ä¾‹" class="headerlink" title="aop æµ‹è¯•æ ·ä¾‹"></a>aop æµ‹è¯•æ ·ä¾‹</h2><p>åœ¨åˆ†æ aop å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸¤ä¸ª aop æµ‹è¯•ä»£ç ï¼Œå…·ä½“çš„æºç åˆ†æè¿‡ç¨‹å°±æ˜¯åŸºäºè¿™ä¸¤ä¸ªæµ‹è¯•ä»£ç çš„ï¼Œ<a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/spring-framework" >æºç <i class="fas fa-external-link-alt"></i></a>æ¬¢è¿è‡ªå–ã€‚</p>
<h3 id="æµ‹è¯•ä»£ç ä¸€"><a href="#æµ‹è¯•ä»£ç ä¸€" class="headerlink" title="æµ‹è¯•ä»£ç ä¸€"></a>æµ‹è¯•ä»£ç ä¸€</h3><blockquote>
<p>ä¸»å‡½æ•° top.aprilyolies.example.aop.AopApp</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopApp</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-aop.xml&quot;</span>);</span><br><span class="line">		<span class="type">TestBean</span> <span class="variable">bean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">		bean.test();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ‡é¢å®šä¹‰ top.aprilyolies.example.aop.AspectJBean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AspectJBean</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* *.test*(..))&quot;)</span>	<span class="comment">// è¿™ä¸ªå¯èƒ½å°±æ˜¯å¼•ä»‹å¢å¼ºæ–¹æ³•ï¼Œè¿™é‡Œå¯èƒ½å°±æ˜¯åˆ‡ç‚¹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;test()&quot;)</span>	<span class="comment">// è¿™ä¸ªå¯èƒ½å°±æ˜¯åˆ‡ç‚¹å¢å¼ºæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeTest</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;beforeTest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;test()&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterTest</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;afterTest&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Around(&quot;test()&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">aroundTest</span><span class="params">(ProceedingJoinPoint p)</span> &#123;</span><br><span class="line">		<span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		System.out.println(<span class="string">&quot;aroundBefore&quot;</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			o = p.proceed();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">			throwable.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">&quot;aroundAfter&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> o;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯• bean top.aprilyolies.example.aop.TestBean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">TestBean</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;TestBean constructor&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;test method....&quot;</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;----------&quot;</span>);</span><br><span class="line">		test1();</span><br><span class="line">		System.out.println(<span class="string">&quot;----------&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;test1 method....&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>spring-aop.xml</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">	   xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">	   xmlns:aop=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="line">	   xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">	&lt;aop:aspectj-autoproxy/&gt;</span><br><span class="line"></span><br><span class="line">	&lt;bean id=<span class="string">&quot;test&quot;</span> class=<span class="string">&quot;top.aprilyolies.example.aop.TestBean&quot;</span>/&gt;</span><br><span class="line">	&lt;bean id=<span class="string">&quot;aspectJBean&quot;</span> class=<span class="string">&quot;top.aprilyolies.example.aop.AspectJBean&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ‰§è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TestBean constructor    <span class="comment">// æ„é€ å‡½æ•°æ‰§è¡Œ</span></span><br><span class="line">aroundBefore    <span class="comment">// around å¢å¼º</span></span><br><span class="line">beforeTest  <span class="comment">// before å¢å¼º</span></span><br><span class="line">test method.... <span class="comment">// test* æ–¹æ³•</span></span><br><span class="line">----------</span><br><span class="line">test1 method....</span><br><span class="line">----------</span><br><span class="line">aroundAfter <span class="comment">// around å¢å¼º</span></span><br><span class="line">afterTest   <span class="comment">// after å¢å¼º</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•æ ·ä¾‹å¾ˆç®€å•ï¼Œå…¶å®å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªåˆ‡é¢ç±»ï¼Œé‡Œè¾¹æè¿°äº†ä¸€äº›åˆ‡é¢ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™é‡Œå°±æ˜¯å¯¹ä»»æ„åŒ…ä¸‹çš„ä»»æ„ç±»ï¼Œè¿”å›å€¼ä¸é™çš„ä»»æ„ test* æ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œåˆ†ä¸ºä¸‰ç§ç±»å‹çš„å¢å¼ºï¼Œafterã€beforeã€aroundã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘åœ¨è°ƒç”¨ test* æ–¹æ³•æ—¶ï¼Œä¸Šè¿°çš„ä¸‰ä¸ªæ–¹æ³•ä¼šåœ¨ä½•æ—¶çš„ä½ç½®è°ƒç”¨ï¼Œç†è§£è¿™ä¸ªåå†çœ‹ä¸Šè¾¹çš„æ‰§è¡Œç»“æœåº”è¯¥å°±å¾ˆæ¸…æ¥šäº†ï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šè¿›è¡Œè¿™æ ·çš„è°ƒç”¨ï¼Œå°±æ˜¯æœ¬æ–‡åˆ†æçš„é‡ç‚¹äº†ï¼Œç¨åå†è¯´ï¼Œå†çœ‹ç¬¬äºŒä¸ªç¤ºä¾‹ç¨‹åºã€‚</p>
<h3 id="æµ‹è¯•ä»£ç äºŒ"><a href="#æµ‹è¯•ä»£ç äºŒ" class="headerlink" title="æµ‹è¯•ä»£ç äºŒ"></a>æµ‹è¯•ä»£ç äºŒ</h3><blockquote>
<p>ä¸»å‡½æ•°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopApp</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-aop-expose.xml&quot;</span>);</span><br><span class="line">		<span class="type">TestBean</span> <span class="variable">bean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">		bean.test();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯• bean top.aprilyolies.example.aop.TestBean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">TestBean</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;TestBean constructor&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;test method....&quot;</span>);</span><br><span class="line">		<span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) AopContext.currentProxy();</span><br><span class="line">		System.out.println(<span class="string">&quot;----------&quot;</span>);</span><br><span class="line">		testBean.test1();</span><br><span class="line">		test1();</span><br><span class="line">		System.out.println(<span class="string">&quot;----------&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;test1 method....&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>spring-aop-expose.xml</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">	   xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">	   xmlns:aop=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="line">	   xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">	&lt;aop:aspectj-autoproxy expose-proxy=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">	&lt;bean id=<span class="string">&quot;test&quot;</span> class=<span class="string">&quot;top.aprilyolies.example.aop.TestBean&quot;</span>/&gt;</span><br><span class="line">	&lt;bean id=<span class="string">&quot;aspectJBean&quot;</span> class=<span class="string">&quot;top.aprilyolies.example.aop.AspectJBean&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>åˆ‡é¢å®šä¹‰ç±»ä¸å˜ï¼Œçœ‹æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TestBean constructor</span><br><span class="line">aroundBefore</span><br><span class="line">beforeTest</span><br><span class="line">test method....</span><br><span class="line">----------</span><br><span class="line">aroundBefore</span><br><span class="line">beforeTest</span><br><span class="line">test1 method....</span><br><span class="line">aroundAfter</span><br><span class="line">afterTest</span><br><span class="line">----------</span><br><span class="line">aroundAfter</span><br><span class="line">afterTest</span><br></pre></td></tr></table></figure>

<p>å…¶å®å’Œæµ‹è¯•ä»£ç ä¸€çš„é€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯åœ¨ spring çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œ<code>&lt;aop:aspectj-autoproxy expose-proxy=&quot;true&quot;/&gt;</code> æ ‡ç­¾å¤šäº†ä¸€ä¸ª expose-proxy&#x3D;â€trueâ€ å±æ€§ï¼Œç„¶å <code>TestBean#test</code> æ–¹æ³•ä¸­å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨ <code>TestBean#test1</code> æ–¹æ³•ï¼Œè€Œæ˜¯ä» AopContext ä¸­æ‹¿åˆ°å½“å‰çš„ä»£ç†ç±»ï¼Œå†è°ƒç”¨å®ƒçš„ test1 æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°çš„ä¸‰ä¸ªå¢å¼ºæ–¹æ³•ä¹Ÿéƒ½æ‰§è¡Œäº†ï¼Œè€Œç›´æ¥é€šè¿‡ç”¨æˆ·ä»£ç è°ƒç”¨ test1 æ–¹æ³•ï¼Œä»¥ä¸Šçš„å¢å¼ºæ–¹æ³•å°±ä¸ä¼šå‘ç”Ÿè°ƒç”¨ã€‚è¿™é‡Œè¯´æ˜ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå·±çš„ç”¨æˆ·ä»£ç åœ¨å†…éƒ¨è°ƒç”¨å…¶ä»–æ–¹æ³•æ—¶ï¼Œéœ€è¦è¢«è°ƒç”¨çš„æ–¹æ³•åŒæ ·å¾—åˆ°å¢å¼ºï¼Œé‚£ä¹ˆå°±éœ€è¦é‡‡ç”¨æµ‹è¯•ä»£ç äºŒé‚£æ ·çš„æ–¹å¼è·å–åˆ°å½“å‰çš„ä»£ç†ç±»ï¼Œç„¶åè¿›è¡Œå¯¹åº”æ–¹æ³•çš„è°ƒç”¨ï¼Œç›´æ¥è¿›è¡Œè°ƒç”¨çš„æ–¹å¼æ˜¯ä¸å¯¹å¾—åˆ°å¢å¼ºçš„ã€‚</p>
<h2 id="lt-aop-aspectj-autoproxy-x2F-gt-æ ‡ç­¾è§£æ"><a href="#lt-aop-aspectj-autoproxy-x2F-gt-æ ‡ç­¾è§£æ" class="headerlink" title="&lt;aop:aspectj-autoproxy&#x2F;&gt; æ ‡ç­¾è§£æ"></a>&lt;aop:aspectj-autoproxy&#x2F;&gt; æ ‡ç­¾è§£æ</h2><p>å¦‚æœå¯¹ spring çš„æ ‡ç­¾è§£æåŸç†ç†Ÿæ‚‰ï¼Œé‚£ä¹ˆä½ åœ¨åˆ†æ aop å®ç°åŸç†æ—¶ï¼Œå°±ä¸€å®šä¼šæƒ³åˆ°ä» &lt;aop:aspectj-autoproxy&#x2F;&gt; æ ‡ç­¾çš„è§£æå¼€å§‹ï¼Œå®ƒæ˜¯å¯åŠ¨ spring aop çš„æ ¹æœ¬ã€‚spring æœ¬èº«å¯¹äºæ ‡ç­¾çš„è§£æå®ç°å¾ˆæœ‰è§„åˆ™ï¼Œæ€»çš„å°±æ˜¯å°†æ ‡ç­¾åˆ†ä¸ºé»˜è®¤æ ‡ç­¾å’Œè‡ªå®šä¹‰æ ‡ç­¾ã€‚ä» <code>DefaultBeanDefinitionDocumentReader#parseBeanDefinitions</code> æ–¹æ³•å°±å¯ä»¥çœ‹å‡ºè¿™ä¸ªåŒºåˆ«ã€‚</p>
<blockquote>
<p>org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader#parseBeanDefinitions</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Parse the elements at the root level in the document:</span></span><br><span class="line"><span class="comment">    * &quot;import&quot;, &quot;alias&quot;, &quot;bean&quot;.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> root the DOM root element of the document</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;	<span class="comment">// è¿™ä¸ªåˆ†æ”¯æ˜¯è§£æé»˜è®¤çš„ Namespace æ ‡ç­¾</span></span><br><span class="line">        <span class="type">NodeList</span> <span class="variable">nl</span> <span class="operator">=</span> root.getChildNodes();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nl.item(i);</span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">                <span class="type">Element</span> <span class="variable">ele</span> <span class="operator">=</span> (Element) node;</span><br><span class="line">                <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">                    parseDefaultElement(ele, delegate);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    delegate.parseCustomElement(ele);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        delegate.parseCustomElement(root);	<span class="comment">// è¿™ä¸ªåˆ†æ”¯å°±æ˜¯è§£æç”¨æˆ·è‡ªå®šä¹‰çš„ Namespace æ ‡ç­¾</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºé»˜è®¤æ ‡ç­¾è€Œè¨€ï¼Œä»ä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹å‡ºä¸»è¦æ˜¯åŒ…å« importã€aliasã€beanã€beans å››ç§æ ‡ç­¾ã€‚</p>
<blockquote>
<p>org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader#parseDefaultElement</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è§£æé»˜è®¤çš„æ ‡ç­¾ï¼Œå¯ä»¥çœ‹å‡ºæ¥æœ‰ importã€aliasã€beanã€beans</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">        importBeanDefinitionResource(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">        processAliasRegistration(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">        processBeanDefinition(ele, delegate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// recurse</span></span><br><span class="line">        doRegisterBeanDefinitions(ele);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œå¯¹äºéé»˜è®¤çš„æ ‡ç­¾ï¼Œspring åˆ™æ˜¯é€šè¿‡å¯¹åº”æ ‡ç­¾å‘½åç©ºé—´çš„ NamespaceHandler æ¥æ³¨å†Œå¯¹åº”ç©ºé—´ä¸‹ä¸åŒæ ‡ç­¾çš„è§£æå™¨æ¥å®Œæˆè§£æçš„ï¼Œè¿™ç§ NamespaceHandler çš„å‘½åå¾ˆè§„èŒƒï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨æ˜¯åˆ†æ aop å®ç°ï¼Œæ ¸å¿ƒæ ‡ç­¾å°±æ˜¯ &lt;aop:aspectj-autoproxy&#x2F;&gt;ï¼Œå…¶å¯¹åº”çš„å‘½åç©ºé—´å°±æ˜¯ aopï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ‰“å¼€å…¶å¯¹åº”çš„ AopNamespaceHandler å°±å¯ä»¥åˆ†æ spring å¯¹äºç›¸åº”çš„æ ‡ç­¾åšäº†å•¥å¤„ç†ã€‚</p>
<blockquote>
<p>org.springframework.aop.config.AopNamespaceHandler</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopNamespaceHandler</span> <span class="keyword">extends</span> <span class="title class_">NamespaceHandlerSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Register the &#123;<span class="doctag">@link</span> BeanDefinitionParser BeanDefinitionParsers&#125; for the</span></span><br><span class="line"><span class="comment">	 * &#x27;&#123;<span class="doctag">@code</span> config&#125;&#x27;, &#x27;&#123;<span class="doctag">@code</span> spring-configured&#125;&#x27;, &#x27;&#123;<span class="doctag">@code</span> aspectj-autoproxy&#125;&#x27;</span></span><br><span class="line"><span class="comment">	 * and &#x27;&#123;<span class="doctag">@code</span> scoped-proxy&#125;&#x27; tags.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// In 2.0 XSD as well as in 2.1 XSD.</span></span><br><span class="line">		registerBeanDefinitionParser(<span class="string">&quot;config&quot;</span>, <span class="keyword">new</span> <span class="title class_">ConfigBeanDefinitionParser</span>());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">&quot;aspectj-autoproxy&quot;</span>, <span class="keyword">new</span> <span class="title class_">AspectJAutoProxyBeanDefinitionParser</span>());</span><br><span class="line">		registerBeanDefinitionDecorator(<span class="string">&quot;scoped-proxy&quot;</span>, <span class="keyword">new</span> <span class="title class_">ScopedProxyBeanDefinitionDecorator</span>());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Only in 2.0 XSD: moved to context namespace as of 2.1</span></span><br><span class="line">		registerBeanDefinitionParser(<span class="string">&quot;spring-configured&quot;</span>, <span class="keyword">new</span> <span class="title class_">SpringConfiguredBeanDefinitionParser</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¥½äº†ï¼Œçœ‹åˆ°è¿™ä¸ªåæˆ‘ä»¬å°±æ¸…æ¥šäº†ï¼Œå¯¹äº aop å‘½åç©ºé—´ï¼Œå®ƒä¸‹è¾¹æ˜¯æœ‰å››ç§ç±»å‹çš„æ ‡ç­¾çš„ï¼Œæˆ‘ä»¬è¿™é‡Œåªç”¨åˆ°äº† aspectj-autoproxyï¼Œå°±åªåˆ†æè¿™ä¸€ä¸ªã€‚é€šè¿‡çœ‹ç±»åå°±çŸ¥é“ï¼Œä¸åŒçš„æ ‡ç­¾å¯¹åº”ç€ä¸€ä¸ª BeanDefinitionParserï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œè¾¹åªæœ‰ä¸€ä¸ª <code>BeanDefinitionParser#parse</code> æ–¹æ³•ï¼Œé‚£å°±ç›´æ¥çœ‹ <code>AspectJAutoProxyBeanDefinitionParser#parse</code> æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> BeanDefinition <span class="title function_">parse</span><span class="params">(Element element, ParserContext parserContext)</span> &#123;</span><br><span class="line">    AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);	<span class="comment">// ä¸»è¦å°±æ˜¯æ³¨å†Œäº†ä¸€ä¸ª AnnotationAwareAspectJAutoProxyCreatorï¼Œå¹¶å¯¹ &lt;aop:aspectj-autoproxy/&gt; æ ‡ç­¾çš„ proxy-target-class å’Œ expose-proxy å±æ€§çš„å¤„ç†</span></span><br><span class="line">    extendBeanDefinition(element, parserContext);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯ä¸¤è¡Œä»£ç ï¼Œå¯¹äºç¬¬äºŒè¡Œä»£ç ï¼Œæ˜¯ä¸€ä¸ªå¯¹äºå½“å‰æ ‡ç­¾çš„å­æ ‡ç­¾çš„å¤„ç†ï¼Œå› ä¸ºè¿™é‡Œæ²¡ç”¨åˆ°ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥å°±å¿½ç•¥äº†ã€‚é‡ç‚¹å…³æ³¨ç¬¬ä¸€è¡Œä»£ç ï¼Œä»åå­—å°±çŸ¥é“ï¼Œæ ¸å¿ƒå°±æ˜¯å‘ spring å®¹å™¨æ³¨å†Œä¸€ä¸ª AspectJAnnotationAutoProxyCreator å®ä¾‹ï¼Œè¿›å»åçœ‹å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»è¦å°±æ˜¯æ³¨å†Œäº†ä¸€ä¸ª AnnotationAwareAspectJAutoProxyCreatorï¼Œå¹¶å¯¹ &lt;aop:aspectj-autoproxy/&gt; æ ‡ç­¾çš„ proxy-target-class å’Œ expose-proxy å±æ€§çš„å¤„ç†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="params">(</span></span><br><span class="line"><span class="params">        ParserContext parserContext, Element sourceElement)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•å‘ DefaultListableBeanFactory ä¸­æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreator å¯¹åº”çš„ beanï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æ³¨å†Œä¼˜å…ˆçº§è¾ƒé«˜çš„é‚£ä¸ª</span></span><br><span class="line">    <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(</span><br><span class="line">            parserContext.getRegistry(), parserContext.extractSource(sourceElement));</span><br><span class="line">    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);	<span class="comment">// å¯¹äº &lt;aop:aspectj-autoproxy/&gt; æ ‡ç­¾ proxy-target-class å’Œ expose-proxy å±æ€§çš„å¤„ç†</span></span><br><span class="line">    registerComponentIfNecessary(beanDefinition, parserContext);	<span class="comment">// æ ¸å¿ƒå°±æ˜¯æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreator å¯¹åº”çš„ beanDefinitionï¼ˆå°è£…ä¸º BeanComponentDefinitionï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€å…±å°±ä¸‰è¡Œä»£ç ï¼Œå…ˆçœ‹ç¬¬ä¸€è¡Œï¼Œç›´æ¥ç‚¹è¿›å»å¯ä»¥çœ‹åˆ°ä»£ç æ˜¯è¿™æ ·çš„ï¼Œå…³äºå…¶ä½œç”¨æˆ‘å·²ç»é€šè¿‡æ³¨é‡Šçš„æ–¹å¼è¿›è¡Œæ ‡æ³¨äº†ï¼Œæ ¹æœ¬çš„å®ç°å°±æ˜¯ä¸€ä¸ªç±»ä¼¼æ ‡ç­¾è§£æç”Ÿæˆ BeanDefinition çš„è¿‡ç¨‹ï¼Œå¦‚æœä½ çœ‹è¿‡æ ‡ç­¾è§£æçš„è¯ï¼Œé‚£ä¹ˆä½ å¯¹è¿™ä¸²ä»£ç ä¸€å®šä¸ä¼šé™Œç”Ÿï¼Œè€Œä¸” BeanDefinition è¿™ä¸ªå®ä¾‹ä½ ä¹Ÿä¸€å®šå¾ˆè€³ç†Ÿã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// å°è¯•å‘ DefaultListableBeanFactory ä¸­æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreator å¯¹åº”çš„ beanï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æ³¨å†Œä¼˜å…ˆçº§è¾ƒé«˜çš„é‚£ä¸ª</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BeanDefinition <span class="title function_">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="params">(</span></span><br><span class="line"><span class="params">        BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•å‘ DefaultListableBeanFactory ä¸­æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreator å¯¹åº”çš„ beanï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æ³¨å†Œä¼˜å…ˆçº§è¾ƒé«˜çš„é‚£ä¸ª</span></span><br><span class="line">    <span class="keyword">return</span> registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// å°è¯•å‘ DefaultListableBeanFactory ä¸­æ³¨å†Œ cls å¯¹åº”çš„ beanï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æ³¨å†Œä¼˜å…ˆçº§è¾ƒé«˜çš„é‚£ä¸ª</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BeanDefinition <span class="title function_">registerOrEscalateApcAsRequired</span><span class="params">(</span></span><br><span class="line"><span class="params">        Class&lt;?&gt; cls, BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;	<span class="comment">// è¿™é‡Œæ˜¯æŒ‡å·²å­˜åœ¨å¯¹åº”çš„ beanï¼Œé‚£ä¹ˆå°±çœ‹è°çš„ä¼˜å…ˆçº§é«˜</span></span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">apcDefinition</span> <span class="operator">=</span> registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        <span class="keyword">if</span> (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">currentPriority</span> <span class="operator">=</span> findPriorityForClass(apcDefinition.getBeanClassName());</span><br><span class="line">            <span class="type">int</span> <span class="variable">requiredPriority</span> <span class="operator">=</span> findPriorityForClass(cls);</span><br><span class="line">            <span class="keyword">if</span> (currentPriority &lt; requiredPriority) &#123;</span><br><span class="line">                apcDefinition.setBeanClassName(cls.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">RootBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(cls);</span><br><span class="line">    beanDefinition.setSource(source);</span><br><span class="line">    beanDefinition.getPropertyValues().add(<span class="string">&quot;order&quot;</span>, Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);	<span class="comment">// æŒ‡æ˜è¯¥ bean åœ¨ spring å®¹å™¨ä¸­çš„èº«ä»½</span></span><br><span class="line">    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br><span class="line">    <span class="keyword">return</span> beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»†èŠ‚å°±ä¸åœ¨æ·±ç©¶äº†ï¼Œå› ä¸ºç‰µæ‰¯çš„ä»£ç éå¸¸å¤šï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦æ¸…æ¥šç¬¬ä¸€è¡Œä»£ç å°±æ˜¯å‘ spring å®¹å™¨æ³¨å†Œäº†ä¸€ä¸ª AnnotationAwareAspectJAutoProxyCreator ç±»å‹çš„ç±»ï¼Œåœ¨ spring å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šæ ¹æ®æ—¢å®šçš„æ¡ä»¶å®Œæˆè¯¥ç±»çš„åˆå§‹åŒ–åŠç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„è°ƒç”¨ï¼Œå¯¹äº†éœ€è¦æ³¨æ„ï¼Œè¯¥ç±»å¯¹åº”çš„å®ä¾‹åœ¨ spring å®¹å™¨ä¸­çš„å”¯ä¸€æ ‡å¿—ç¬¦å°±æ˜¯ <code>AUTO_PROXY_CREATOR_BEAN_NAME = &quot;org.springframework.aop.config.internalAutoProxyCreator&quot;;</code>ã€‚</p>
<p>å†çœ‹ç¬¬äºŒè¡Œä»£ç ï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯çœ‹å½“å‰æ ‡ç­¾çš„å±æ€§ï¼Œå¦‚æœæœ‰ proxy-target-class æˆ–è€… expose-proxy å±æ€§ï¼Œé‚£ä¹ˆå°±å°†è¯¥å±æ€§çš„å€¼è®¾ç½®åˆ°ç¬¬ä¸€è¡Œä»£ç æ³¨å†Œçš„ AnnotationAwareAspectJAutoProxyCreator ç±»å¯¹åº”çš„ BeanDefinition ä¸­å»ã€‚è¿™æ ·åœ¨é€šè¿‡ BeanDefinition æ„å»º bean å®ä¾‹æ—¶ï¼Œé€šè¿‡æ ‡ç­¾è®¾ç½®çš„å±æ€§å€¼å°±ä¼šè¢«æ³¨å…¥åˆ°è¯¥ bean ä¸­äº†ã€‚å…·ä½“å®ç°å°±æ˜¯é€šè¿‡ä¸‹è¾¹çš„ä»£ç ï¼Œæ¯ä¸ªæ–¹æ³•çš„ä½œç”¨æˆ‘ä¹Ÿè¿›è¡Œäº†æ³¨é‡Šï¼Œå¾ˆå®¹æ˜“ç†è§£ã€‚è¿˜è®°å¾—æˆ‘ä»¬å¼€ç¯‡çš„ç¬¬äºŒä¸ªæµ‹è¯•ä»£ç å˜›ï¼Ÿæ ‡ç­¾ä¸­çš„ <code>expose-proxy=&quot;true&quot;</code> å±æ€§å€¼å°±æ˜¯åœ¨è¿™é‡Œè¢«è§£æçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹äº &lt;aop:aspectj-autoproxy/&gt; æ ‡ç­¾ proxy-target-class å’Œ expose-proxy å±æ€§çš„å¤„ç†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">useClassProxyingIfNecessary</span><span class="params">(BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Element sourceElement)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sourceElement != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">proxyTargetClass</span> <span class="operator">=</span> Boolean.parseBoolean(sourceElement.getAttribute(PROXY_TARGET_CLASS_ATTRIBUTE));</span><br><span class="line">        <span class="keyword">if</span> (proxyTargetClass) &#123;</span><br><span class="line">            AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">exposeProxy</span> <span class="operator">=</span> Boolean.parseBoolean(sourceElement.getAttribute(EXPOSE_PROXY_ATTRIBUTE));</span><br><span class="line">        <span class="keyword">if</span> (exposeProxy) &#123;</span><br><span class="line">            AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸º AUTO_PROXY_CREATOR_BEAN_NAME å¯¹åº”çš„ BeanDefinition æ·»åŠ ä¸€ä¸ª proxyTargetClass å±æ€§ï¼Œå€¼ä¸º true</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">forceAutoProxyCreatorToUseClassProxying</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">definition</span> <span class="operator">=</span> registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">&quot;proxyTargetClass&quot;</span>, Boolean.TRUE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¸º AUTO_PROXY_CREATOR_BEAN_NAME å¯¹åº”çš„ BeanDefinition æ·»åŠ ä¸€ä¸ª exposeProxy å±æ€§ï¼Œå€¼ä¸º true</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">forceAutoProxyCreatorToExposeProxy</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">definition</span> <span class="operator">=</span> registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">&quot;exposeProxy&quot;</span>, Boolean.TRUE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹ç¬¬ä¸‰è¡Œä»£ç ï¼Œæ²¡å•¥å…¶ä»–å†…å®¹ï¼Œå°±ä»…ä»…æ˜¯ä¸€ä¸ªæ³¨å†Œ BeanDefinition çš„è¿‡ç¨‹ï¼Œå¯¹äºæˆ‘ä»¬çš„ aop åŸç†åˆ†æè€Œè¨€ï¼Œä¸æ˜¯å¾ˆç´§è¦ï¼Œä»…è´´å‡ºæ¥å®ç°å°±è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¸å¿ƒå°±æ˜¯æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreator å¯¹åº”çš„ beanDefinitionï¼ˆå°è£…ä¸º BeanComponentDefinitionï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerComponentIfNecessary</span><span class="params">(<span class="meta">@Nullable</span> BeanDefinition beanDefinition, ParserContext parserContext)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (beanDefinition != <span class="literal">null</span>) &#123;</span><br><span class="line">        parserContext.registerComponent(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(beanDefinition, AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå…³äº &lt;aop:aspectj-autoproxy&#x2F;&gt; æ ‡ç­¾çš„è§£æè¿‡ç¨‹å°±ç®—å®Œæˆäº†ï¼Œè¿›è¡Œæ€»ç»“ä¸€ä¸‹è¯¥è¿‡ç¨‹ï¼Œæ ¸å¿ƒå°±æ˜¯æ ¹æ® AnnotationAwareAspectJAutoProxyCreator ç±»åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ BeanDefinitionï¼Œç„¶åçœ‹è¯¥æ ‡ç­¾æ˜¯å¦æœ‰ä¸Šè¿°çš„ä¸¤ä¸ªå±æ€§å€¼ï¼Œå¦‚æœå°±çš„è¯ï¼Œå°±å°†å¯¹åº”çš„å±æ€§å€¼å¡«å……åˆ°å½“å‰ BeanDefinition ä¸­ï¼Œæœ€åå°±æ˜¯å°†è¯¥ BeanDefinition å°è£…ä¸º BeanComponentDefinition æ³¨å†Œåˆ° parserContext ä¸­ã€‚</p>
<h2 id="ä»£ç†ç±»çš„ç”Ÿæˆ"><a href="#ä»£ç†ç±»çš„ç”Ÿæˆ" class="headerlink" title="ä»£ç†ç±»çš„ç”Ÿæˆ"></a>ä»£ç†ç±»çš„ç”Ÿæˆ</h2><p>ä¸Šè¾¹å·²ç»è¯´å®Œäº†æ ‡ç­¾è§£æçš„è¿‡ç¨‹ï¼ŒçŸ¥é“äº†ç°åœ¨ spring å®¹å™¨ä¸­å­˜åœ¨ä¸€ä¸ª AnnotationAwareAspectJAutoProxyCreator ç±»å¯¹åº”çš„ BeanDefinitionï¼Œåœ¨æ¥ä¸‹æ¥çš„è¿‡ç¨‹ï¼Œspring ä¼šæ ¹æ® BeanDefinition å®ç°çš„ä¸åŒå£°æ˜å‘¨æœŸæ¥å£ï¼Œåœ¨ä¸åŒçš„åˆå§‹åŒ–é˜¶æ®µæ¥å®Œæˆå¯¹åº”æ–¹æ³•çš„è°ƒç”¨ã€‚æ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬ç°åœ¨å°±å…³æ³¨ä¸€ä¸‹ AnnotationAwareAspectJAutoProxyCreator å®ç°äº†ä»€ä¹ˆæ¥å£ã€‚ç›´æ¥æŸ¥çœ‹å®ƒçš„ç»§æ‰¿å…³ç³»å›¾ã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/7a4b9194e2d3522ffe627b3c9ccdbd7d.jpg" width=600 /></div>

<center>AnnotationAwareAspectJAutoProxyCreator ç»§æ‰¿å›¾</center>

<p>

<p>ç›´æ¥çœ‹å¥½åƒæ²¡æœ‰ä»€ä¹ˆç†Ÿæ‚‰çš„å£°æ˜å‘¨æœŸæ¥å£å¯¹å§ï¼Œä½†æ˜¯å¦‚æœä½ é¡ºç€ç»§æ‰¿å…³ç³»é€ä¸ªå¾€ä¸Šæ‰¾ï¼Œå°±ä¼šçœ‹åˆ°åœ¨å…¶çˆ¶ç±» AbstractAutoProxyCreator ä¸­å®ç°äº†ä¸€ä¸ª SmartInstantiationAwareBeanPostProcessor æ¥å£ï¼Œçœ‹è¿‡ spring ioc å®ç°åŸç†çš„å°ä¼™ä¼´åº”è¯¥å¯¹ BeanPostProcessor è¿™æ ·çš„æ¥å£ååˆ†æ•æ„Ÿï¼Œå®ƒæ„å‘³ç€åœ¨ bean çš„åˆå§‹åŒ–ä¸åŒé˜¶æ®µï¼Œspring ä¼šå®Œæˆå¯¹å®ç°è¯¥ç±»æ¥å£çš„ bean çš„å¯¹åº”æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ã€‚å½“ç„¶ç›´æ¥é€šè¿‡ idea çš„ diagram ç»˜åˆ¶èƒ½æ›´æ¸…æ¥šçš„çœ‹å‡º AnnotationAwareAspectJAutoProxyCreator å®ç°çš„å…¶å®ƒæ¥å£ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒ SmartInstantiationAwareBeanPostProcessorã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/9d6f9b28cd7e445bbcd9194cc47334c6.jpg" width=800 /></div>

<center>AnnotationAwareAspectJAutoProxyCreator ç»§æ‰¿ä½“ç³»</center>

<p>

<p>è¿™é‡Œçš„ SmartInstantiationAwareBeanPostProcessor æ¥å£åˆç»§æ‰¿è‡ª InstantiationAwareBeanPostProcessorï¼Œè¿™æ · AnnotationAwareAspectJAutoProxyCreator è¦å®ç°çš„æ–¹æ³•å°±å¤šäº†ï¼Œåº”è¯¥é‡ç‚¹å…³æ³¨å“ªä¸ªå‘¢ï¼Ÿå…¶å®æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ debug çš„æ–¹å¼æ¥è·Ÿè¸ªï¼Œä¸‹å¤§è‡´çœ‹ä¸€ä¸‹å…¨éƒ¨çš„å®ç°æ–¹æ³•ï¼Œå‘ç°æ‰€æœ‰çš„å®ç°æ–¹æ³•ä¸­ï¼Œåªæœ‰ä¸¤ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ç¨å¾®å¤æ‚ä¸”åœ¨ bean çš„æ„å»ºè¿‡ç¨‹ä¸­è¢«è°ƒç”¨åˆ°ï¼Œä»–ä»¬å°±æ˜¯ <code>AbstractAutoProxyCreator#postProcessBeforeInstantiation</code> å’Œ <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code>ï¼Œæˆ‘åœ¨è¿™ä¸ªä¸¤ä¸ªæ–¹æ³•ç¬¬ä¸€è¡Œä»£ç å¤„å„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œé€šè¿‡ debug çš„æ–¹å¼ï¼Œå¯ä»¥çŸ¥é“ç¬¬ä¸€ä¸ªæ–¹æ³•çš„å‡ºå£æ˜¯è¿”å›çš„ nullï¼Œè·Ÿæˆ‘ä»¬æœŸæœ›çš„ä»£ç†ç±»ç”Ÿæˆæ²¡æœ‰å…³ç³»ï¼Œç›´æ¥æ’é™¤ï¼Œé‚£ä¹ˆå¯ä»¥æš‚æ—¶è®¤å®šä»£ç†ç±»çš„ç”Ÿæˆæ˜¯é€šè¿‡ <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code> æ–¹æ³•å®ç°çš„ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±çœ‹åœ¨è¯¥æ–¹æ³•ä¸­åšäº†ä»€ä¹ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// å°è¯•ä»ç¼“å­˜ä¸­è·å–ä»£ç† beanï¼Œæ²¡æœ‰çš„è¯è¿›è¡Œæ„å»ºï¼Œæ ¸å¿ƒå°±æ˜¯æ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(<span class="meta">@Nullable</span> Object bean, String beanName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">cacheKey</span> <span class="operator">=</span> getCacheKey(bean.getClass(), beanName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;</span><br><span class="line">            <span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);	<span class="comment">// æ ¸å¿ƒå°±æ˜¯æ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªä»ç¼“å­˜ä¸­è·å–ä»£ç†ç±»ï¼Œå¦‚æœè·å–çš„ç»“æœå’Œå‚æ•°ä¼ å…¥çš„ bean ä¸ä¸€è‡´ï¼Œå°±å¯¹ä¼ å…¥çš„ bean è¿›è¡Œå°è¯•ä»£ç†çš„è¿‡ç¨‹ã€‚é‚£ä¹ˆè¿™ä¸ªå‚æ•°ä¼ å…¥çš„ bean ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿæˆ‘é€šè¿‡ debug çš„æ–¹å¼è¿›è¡ŒæŸ¥çœ‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/0eda531a550a219c9be9ec3c69c05f73.jpg" width=600 /></div>

<center>è¢«å¤„ç†çš„ bean ç±»å‹</center>

<p>

<p>åŸæ¥å°±æ˜¯æˆ‘ä»¬æ ·ä¾‹ä»£ç ä¸­çš„ TestBeanï¼Œæ‰€ä»¥åˆ°è¿™é‡Œä¸€ä¸ªå¤§è‡´çš„è¿‡ç¨‹å°±éœ€è¦æ˜ç™½äº†ï¼Œåœ¨ spring é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº† TestBean æ¥äº¤ç»™ spring å®¹å™¨ç®¡ç†ï¼Œåœ¨ spring å¯¹è¯¥ bean è¿›è¡Œåˆ›å»ºæ—¶ï¼Œspring ä¼šç”¨å„ç§ BeanPostProcessor æ¥å£å®ç°ç±»å¯¹åº”çš„æ–¹æ³•æ¥å¯¹æ­£åœ¨æ„å»ºçš„ bean è¿›è¡Œå¤„ç†ï¼Œæ‹¿æˆ‘ä»¬çš„æ ·ä¾‹ç¨‹åºæ¥è¯´å°±æ˜¯ï¼šå®ç°äº† BeanPostProcessor æ¥å£çš„ AnnotationAwareAspectJAutoProxyCreator å®ä¾‹çš„ <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code> æ–¹æ³•æ¥å¯¹ TestBean è¿›è¡Œå¤„ç†ï¼Œå…·ä½“çš„å¤„ç†è¿‡ç¨‹æ˜¯å•¥æ ·å‘¢ï¼Ÿå°±æ˜¯ä¸Šè¾¹ä»£ç æ¡†ä¸­é‚£æ ·ï¼Œä»æ³¨é‡Šå¯ä»¥çŸ¥é“å°±æ˜¯ä¸€ä¸ªå¯¹åŸ beanï¼ˆTestBeanï¼‰è¿›è¡Œä»£ç†çš„è¿‡ç¨‹ã€‚ä¸‹è¾¹ç»§ç»­çœ‹è¿™ä¸ªä»£ç† bean å¦‚ä½•æ„å»ºçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Wrap the given bean if necessary, i.e. if it is eligible for being proxied.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> bean the raw bean instance</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> beanName the name of the bean</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> cacheKey the cache key for metadata access</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a proxy wrapping the bean, or the raw bean instance as-is</span></span><br><span class="line"><span class="comment">    */</span>	<span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦ä»£ç†ï¼Œå¦‚æœæ˜¯ï¼Œè·å–æ»¡è¶³ beanClass çš„ advisorï¼Œç„¶åæ„å»ºä»£ç†ç±»ï¼šéªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Boolean.FALSE.equals(<span class="built_in">this</span>.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;	<span class="comment">// æ— éœ€ä»£ç†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        <span class="keyword">return</span> bean;	<span class="comment">// åŸºç¡€ç±»å’Œåº”è·³è¿‡çš„ç±»ç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create proxy if we have advice.	// è·å–æ»¡è¶³ beanClass çš„ advisorï¼Œè¿›è¡Œè¿‡æ’åº</span></span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        <span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);	<span class="comment">// æ‰€ä»¥è¿™ä¸ªé›†åˆå­˜æ”¾çš„æ˜¯å¯¹åº”çš„ bean æ˜¯å¦å¢å¼ºçš„ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> createProxy(	<span class="comment">// éªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line">                bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> <span class="title class_">SingletonTargetSource</span>(bean));</span><br><span class="line">        <span class="built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿™ä¸ªé›†åˆå­˜æ”¾çš„æ˜¯å¯¹åº”çš„ bean æ˜¯å¦å¢å¼ºçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¾¹çš„ä»£ç å¾ˆå¥½ç†è§£ï¼Œå‰åŠéƒ¨åˆ†å°±æ˜¯ä¸€äº›éªŒè¯ï¼Œçœ‹è¢«å¤„ç†çš„ bean æ˜¯å¦æ»¡è¶³è¢«ä»£ç†éœ€æ±‚ã€‚å¦‚æœä¸æ»¡è¶³å°±ä¼šç›´æ¥è¿”å› beanï¼Œå¦åˆ™å°±ä¼šè·å– specificInterceptors é›†åˆï¼Œè¿™ä¸ª specificInterceptors é›†åˆçš„è·å–è¿‡ç¨‹å¾ˆéº»çƒ¦ï¼Œåæ­£æˆ‘æ˜¯æ²¡æœ‰å»é€è¡Œçš„çœ‹æºç ã€‚ä»…ä»…æ˜¯ä»æ–¹æ³•åæ¥åˆ¤æ–­å„ä¸ªæ­¥éª¤åšäº†å•¥äº‹æƒ…ï¼Œæˆ‘å°†èƒ½å¤Ÿå±•ç¤ºç¨‹åºæ‰§è¡Œè„‰ç»œçš„ä»£ç è´´å‡ºæ¥ï¼Œç„¶åç»™å‡ºæ‰§è¡Œçš„ç»“æœï¼Œè¿™æ ·å°±ç®—ä¸é€šè¯»æºç ï¼Œä¹Ÿèƒ½å¤Ÿç†è§£å…¶åŸç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// è·å–æ»¡è¶³ beanClass çš„ advisorï¼Œè¿›è¡Œè¿‡æ’åº</span></span><br><span class="line"><span class="keyword">protected</span> Object[] getAdvicesAndAdvisorsForBean(</span><br><span class="line">        Class&lt;?&gt; beanClass, String beanName, <span class="meta">@Nullable</span> TargetSource targetSource) &#123;</span><br><span class="line">    <span class="comment">// è·å–æ»¡è¶³ beanClass çš„ advisorï¼Œè¿›è¡Œè¿‡æ’åº</span></span><br><span class="line">    List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName);</span><br><span class="line">    <span class="keyword">if</span> (advisors.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> DO_NOT_PROXY;	<span class="comment">// å¦‚æœæ²¡æœ‰å¢å¼ºå™¨ï¼Œå°±ä¸éœ€è¦è¿›è¡Œä»£ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> advisors.toArray();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> List&lt;Advisor&gt; <span class="title function_">findEligibleAdvisors</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> &#123;</span><br><span class="line">    List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();	<span class="comment">// è·å–å€™é€‰çš„å¢å¼ºå™¨</span></span><br><span class="line">    List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);	<span class="comment">// è·å–èƒ½å¤Ÿä½¿ç”¨çš„å¢å¼ºå™¨</span></span><br><span class="line">    extendAdvisors(eligibleAdvisors);	<span class="comment">// çœ‹ advisors æ˜¯å¦æœ‰åˆ‡é¢å¢å¼ºå™¨ï¼Œæœ‰çš„è¯å°±åœ¨é¦–ä½æ·»åŠ ä¸€ä¸ª DefaultPointcutAdvisorï¼ˆExposeInvocationInterceptor.ADVISORï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (!eligibleAdvisors.isEmpty()) &#123;</span><br><span class="line">        eligibleAdvisors = sortAdvisors(eligibleAdvisors);	<span class="comment">// å¯¹ advisors è¿›è¡Œæ’åº</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç çš„ä¸»å¹²å°±ä¸Šè¾¹é‚£äº›ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªè·å–æœ‰æ•ˆå¢å¼ºçš„è¿‡ç¨‹ï¼Œä»€ä¹ˆæ˜¯æœ‰æ•ˆå¢å¼ºå—¯ï¼Ÿé€šè¿‡ debug çš„æ–¹å¼ç›´æ¥æŸ¥çœ‹å…¶å†…å®¹å¦‚ä¸‹ï¼Œä¸éš¾çœ‹å‡ºæ‰€è°“çš„å¢åŠ å°±æ˜¯æˆ‘ä»¬åœ¨åˆ‡é¢ç±»ä¸­å®šä¹‰çš„é‚£äº›åˆ‡é¢æ–¹æ³•ï¼Œå³é€šè¿‡ @Beforeã€@Afterã€@Around æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/fedf896ae5cc881623a58426333ed31e.jpg" width=600 /></div>

<center>å€™é€‰çš„å¢å¼ºé›†åˆ</center>

<p>

<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/ab18fa415ee03d8127064c1978cd18a6.jpg" width=600 /></div>

<center>å¢å¼ºå¯¹åº”çš„æ–¹æ³•</center>

<p>

<p>æˆ‘ä»¬å·²ç»çŸ¥é“è·å–çš„ç»“æœäº†ï¼Œé‚£ä¹ˆè¯¥ç»“æœæ€ä¹ˆæ¥çš„å‘¢ï¼Ÿè¿˜æ˜¯ä¸Šè¾¹çš„ä»£ç ï¼Œä¸€å…±å°±å››æ¡é€»è¾‘ï¼Œç¬¬ä¸€æ¡é€»è¾‘ findCandidateAdvisorsï¼Œçœ‹æ–¹æ³•åå°±çŸ¥é“æ˜¯è·å–å€™é€‰çš„å¢å¼ºã€‚é‡Œè¾¹çš„ä»£ç æ¯”è¾ƒå†—é•¿ï¼Œä½†æ ¸å¿ƒå°±æ˜¯è·å–æ‰€æœ‰åˆ‡é¢ç±»ä¸­æ‰€æœ‰å®šä¹‰çš„å¢å¼ºã€‚è‡³äºæˆ‘ä»¬çš„  @Beforeã€@Afterã€@Around æ³¨è§£å¼å¦‚ä½•è¢«è§£æä¸º Advisor å‘¢ï¼Ÿæˆ‘æ²¡ç ”ç©¶è¿‡ï¼Œä½†å°±ç®—æ˜¯çŒœä¹Ÿèƒ½çŒœå‡ºå¤§æ¦‚äº†ï¼Œåˆ‡é¢ç±»ä¸æ˜¯æœ‰ @Aspect æ³¨è§£å—ï¼Ÿå®ƒä¹Ÿæ˜¯äº¤ç”± spring ç®¡ç†çš„ï¼Œé‚£ä¹ˆ spring è‡ªç„¶æ˜¯ä¼šå…³æ³¨è¿™ä¸ªæ³¨è§£çš„ï¼Œå½“å¯¹ bean è¿›è¡Œæ„å»ºæ—¶ï¼Œå¦‚æœå‘ç°è¯¥ bean æœ‰ @Aspect æ³¨è§£ï¼Œå°±éå†è¯¥ bean çš„æ‰€æœ‰æ–¹æ³•ï¼Œçœ‹æ–¹æ³•ä¸Šæ˜¯å¦æœ‰ä¸Šè¿°çš„ä¸‰ç§å¢å¼ºæ³¨è§£ï¼ˆæˆ–è®¸å…¶ä»–æ³¨è§£ä¹Ÿæ˜¯è¢«è§£é‡Šä¸ºå¢å¼ºå“ˆï¼‰ï¼Œå¦‚æœæœ‰å°±å°†å½“å‰åˆ‡é¢ bean å’Œå¯¹åº”çš„å¢å¼ºç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿åè¾¹è·å–ã€‚å½“ç„¶è¿™åªæ˜¯æˆ‘çš„ä¸ªäººçŒœæƒ³ï¼Œæ²¡å»çœ‹æºç ï¼Œå¦‚æœæˆ‘çŒœçš„ä¸å¯¹ï¼Œè¿˜è¯·æŒ‡å‡ºã€‚æ€»ä¹‹ç¬¬ä¸€æ¡é€»è¾‘å°±æ˜¯è·å–å…¨éƒ¨åˆ‡é¢ç±»çš„å¢å¼ºå°±å¯¹äº†ã€‚</p>
<p>ç¬¬äºŒæ¡é€»è¾‘ç”± findAdvisorsThatCanApply æ¥å®ç°ï¼Œçœ‹æ–¹æ³•åå°±çŸ¥é“æ˜¯ä»å…¨éƒ¨çš„å¢å¼ºä¸­è·å–å½“å‰è¢«å¤„ç†çš„ bean èƒ½å¤Ÿä½¿ç”¨çš„å¢å¼ºã€‚æ€ä¹ˆå®ç°å‘¢ï¼Ÿæˆ‘ä¹Ÿä¸æƒ³çœ‹æºç ï¼Œç›´æ¥çŒœå§ï¼ŒçŒœé”™ä¹Ÿæ²¡äº‹ï¼Œæ–¹æ³•åç¡®å®å°±æ˜¯è¿™ä¸ªæ„æ€ï¼ˆå…¶å®è¿˜æ˜¯å¤§è‡´çœ‹äº†ä¸€ä¸‹æºç çš„ï¼‰ã€‚æˆ‘ä»¬åœ¨åˆ‡é¢ç±»ä¸­ä¸æ˜¯æŒ‡å®šäº†åˆ‡ç‚¹ä¿¡æ¯å—ï¼Ÿï¼Ÿå°±æ˜¯è¿™ä¸ª <code> @Pointcut(&quot;execution(* *.test*(..))&quot;)</code> æ„æ€å°±æ˜¯å½“å‰åˆ‡é¢ç±»çš„å¢å¼ºé€‚ç”¨äºæŒ‡å®šçš„å…¨éƒ¨åˆ‡ç‚¹ã€‚é‚£ä¹ˆ findAdvisorsThatCanApply æ–¹æ³•å°±ä¸€å®šæ˜¯æ ¹æ®åˆ‡ç‚¹è¡¨è¾¾å¼æ¥åˆ†ææˆ‘ä»¬å½“å‰æ­£åœ¨å¤„ç†çš„ bean æ˜¯å¦æ»¡è¶³åˆ‡ç‚¹è§„åˆ™ã€‚å¦‚æœæ»¡è¶³çš„è¯ï¼Œé‚£ä¹ˆè¯¥å¢å¼ºå°±ä¼šè¢«æ·»åŠ åˆ°è¿”å›é›†åˆï¼Œå¦åˆ™ç›´æ¥ä¸¢å¼ƒã€‚æœ€ç»ˆ findAdvisorsThatCanApply è¿”å›çš„å°±æ˜¯èƒ½å¤Ÿåº”ç”¨åœ¨å½“å‰ bean çš„å¢å¼ºäº†ã€‚</p>
<p>ç¬¬ä¸‰æ¡é€»è¾‘ç”± extendAdvisors å®ç°ï¼Œæ²¡é”™çš„è¯æˆ‘ä»¬åœ¨åˆ‡é¢ç±»ä¸­å®šä¹‰çš„å¢å¼ºåªæœ‰ä¸‰ä¸ªå¯¹å—ï¼Ÿï¼Ÿä¸ºä»€ä¹ˆæœ€ç»ˆè¿”å›ç»“æœæœ‰å››ä¸ªå‘¢ï¼Ÿï¼Ÿå…¶å®å°±æ˜¯åœ¨è¿™æ¡é€»è¾‘ä¸­æ·»åŠ çš„ï¼Œæ ¹æœ¬æ˜¯æ‰§è¡Œçš„ä¸‹è¾¹çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬è·å–çš„å¯ç”¨å¢å¼ºä¸­ï¼Œå¦‚æœæœ‰åˆ‡é¢å¢å¼ºç±»ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šåœ¨å¢å¼ºé“¾è¡¨çš„ç¬¬ä¸€ä¸ªä½ç½®åŠ å…¥ä¸€ä¸ª ExposeInvocationInterceptor.ADVISORï¼Œè‡³äºä½œç”¨å˜›ï¼Œæš‚æ—¶æ²¡ç ”ç©¶ï¼Œè¿™ä¸ªä¸å½±å“åè¾¹çš„åˆ†æã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çœ‹ advisors æ˜¯å¦æœ‰åˆ‡é¢å¢å¼ºå™¨ï¼Œæœ‰çš„è¯å°±åœ¨é¦–ä½æ·»åŠ ä¸€ä¸ª DefaultPointcutAdvisorï¼ˆExposeInvocationInterceptor.ADVISORï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">makeAdvisorChainAspectJCapableIfNecessary</span><span class="params">(List&lt;Advisor&gt; advisors)</span> &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t add advisors to an empty list; may indicate that proxying is just not required</span></span><br><span class="line">    <span class="keyword">if</span> (!advisors.isEmpty()) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">foundAspectJAdvice</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Advisor advisor : advisors) &#123;</span><br><span class="line">            <span class="comment">// Be careful not to get the Advice without a guard, as this might eagerly</span></span><br><span class="line">            <span class="comment">// instantiate a non-singleton AspectJ aspect...</span></span><br><span class="line">            <span class="keyword">if</span> (isAspectJAdvice(advisor)) &#123;	<span class="comment">// çœ‹æ˜¯å¦æ˜¯åˆ‡é¢å¢å¼ºå™¨</span></span><br><span class="line">                foundAspectJAdvice = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;	<span class="comment">// (ExposeInvocationInterceptor.ADVISOR æ˜¯æ”¾åœ¨é¦–ä½çš„</span></span><br><span class="line">        <span class="keyword">if</span> (foundAspectJAdvice &amp;&amp; !advisors.contains(ExposeInvocationInterceptor.ADVISOR)) &#123;</span><br><span class="line">            advisors.add(<span class="number">0</span>, ExposeInvocationInterceptor.ADVISOR);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€ä¸ªé€»è¾‘å°±æ˜¯å¯¹æ‰€æœ‰çš„å¢å¼ºè¿›è¡Œæ’åºï¼Œæ ¹æœ¬å°±æ˜¯é“¾è¡¨çš„æ’åºï¼Œé‡‡ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„æ’åºæ¯”è¾ƒå™¨ï¼Œè¯¦ç»†çš„å¯ä»¥è‡ªè¡Œåˆ†ææºç ï¼Œæ‰€ä»¥ä¸Šè¾¹å±•ç¤ºçš„æœ€ç»ˆè¿”å›çš„å››ä¸ª eligibleAdvisorï¼Œå°±æ˜¯é€šè¿‡ä¸Šè¾¹å››ä¸ªé€»è¾‘æ¥å¾—åˆ°ã€‚å›åˆ°æˆ‘ä»¬çš„å‡ºå‘ç‚¹ï¼Œå³<code>AbstractAutoProxyCreator#wrapIfNecessary</code> æ–¹æ³•çš„çš„ getAdvicesAndAdvisorsForBean è¿™ä¸€è¡Œï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†å››ä¸ªå¢å¼ºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯æ ¹æ®è¿™ä¸ªå¢å¼ºæ•°ç»„æ¥æ„å»ºä»£ç†ç±»ã€‚</p>
<p>ä»£ç†ç±»çš„æ„å»ºè¿‡ç¨‹ä¹Ÿå¾ˆéº»çƒ¦ï¼Œå¦‚æœè¦é€è¡Œçœ‹ä»£ç é‚£åˆæ˜¯ä¸ªå¤§å·¥ç¨‹ï¼Œè¿™é‡Œå®è´¨æ˜¯ä»å®è§‚çš„è§’åº¦æ¥çœ‹ä»£ç é€»è¾‘ï¼Œèƒ½å¤Ÿç†è§£ aop å®ç°åŸç†å³å¯ï¼Œç›´æ¥è¿›å…¥åˆ° <code>AbstractAutoProxyCreator#createProxy</code> æ–¹æ³•ä¸­ï¼Œæˆ‘å·²ç»å†™äº†è›®å¤šæ³¨é‡Šäº†ï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯æ€»ç»“æ€§çš„è¯´ä¸€ä¸‹é€»è¾‘ï¼Œå…¶å®æ ¸å¿ƒå°±æ˜¯æ„å»º proxyFactoryï¼Œæœ€åé€šè¿‡å®ƒæ¥æ„å»ºä»£ç†ç±»ï¼Œå‡†å¤‡çš„å·¥ä½œåŒ…æ‹¬è®¾ç½®ä»£ç†ç±»å‹ï¼Œæ˜¯é‡‡ç”¨ jdk åŸç”Ÿä»£ç†å‘¢è¿˜æ˜¯é‡‡ç”¨ cglib è¿›è¡Œä»£ç†ã€‚å°†å¢å¼ºå¡«å……åˆ°è¿™é‡Œæ„å»ºçš„ proxyFactory ä¸­ï¼ŒåŒ…æ‹¬ä¹‹å‰è·å–åˆ°çš„å¢å¼ºï¼ˆæœ¬ä¾‹æ˜¯å››ä¸ªï¼‰å’Œ spring å®¹å™¨ä¸­å­˜åœ¨çš„å…±ç”¨å¢å¼ºã€‚å°†å½“å‰å®ä¾‹çš„å¿…è¦å­—æ®µå¡«å……åˆ° proxyFactory ä»£ç†å·¥å‚ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createProxy</span><span class="params">(Class&lt;?&gt; beanClass, <span class="meta">@Nullable</span> String beanName,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> Object[] specificInterceptors, TargetSource targetSource)</span> &#123;	<span class="comment">// TargetSource å°è£…äº†æˆ‘ä»¬çš„ç›®æ ‡å®ä¾‹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;</span><br><span class="line">        AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) <span class="built_in">this</span>.beanFactory, beanName, beanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ProxyFactory</span> <span class="variable">proxyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyFactory</span>();</span><br><span class="line">    proxyFactory.copyFrom(<span class="built_in">this</span>);	<span class="comment">// å½“å‰ç±»çš„å±æ€§å¤åˆ¶åˆ° ProxyFactory ä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!proxyFactory.isProxyTargetClass()) &#123;	<span class="comment">// è¿™é‡Œå°±æ˜¯åˆ¤æ–­ä»£ç†ç›®æ ‡ç±»è¿˜æ˜¯æ¥å£åˆ†åˆ«å¯¹åº” cglib å’Œ jdk ä»£ç†æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (shouldProxyTargetClass(beanClass, beanName)) &#123;	<span class="comment">// çœ‹æ˜¯å¦å±æ€§å€¼æŒ‡å®šäº† org.springframework.aop.framework.autoproxy.AutoProxyUtils.preserveTargetClassï¼Œè¿™ç§æƒ…å†µé‡‡ç”¨ç›®æ ‡ç±»ä»£ç†æ–¹å¼ cglib</span></span><br><span class="line">            proxyFactory.setProxyTargetClass(<span class="literal">true</span>);	<span class="comment">// è¿™é‡Œè®¾ç½®ä»£ç†æ–¹å¼ä¸º cglib</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;	<span class="comment">// çœ‹ç›®æ ‡ class æ˜¯å¦æœ‰å¯ä»¥ä»£ç†çš„æ¥å£ï¼Œæœ‰çš„è¯å°†æ¥å£ class æ·»åŠ åˆ° proxyFactory ä¸­ï¼Œå¦åˆ™è®¾ç½®ä»£ç†æ–¹å¼ä¸ºä»£ç†ç›®æ ‡ç±»</span></span><br><span class="line">            evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å…¬æœ‰çš„ interceptorsï¼Œç„¶åå’Œ specificInterceptors ä¸€èµ·æ„å»ºä¸º advisors è¿”å›</span></span><br><span class="line">    Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">    proxyFactory.addAdvisors(advisors);</span><br><span class="line">    proxyFactory.setTargetSource(targetSource);	<span class="comment">// è¿™ä¸ªå‚æ•°æŒæœ‰äº†ä»£ç†ç›®æ ‡</span></span><br><span class="line">    customizeProxyFactory(proxyFactory);</span><br><span class="line"></span><br><span class="line">    proxyFactory.setFrozen(<span class="built_in">this</span>.freezeProxy);</span><br><span class="line">    <span class="keyword">if</span> (advisorsPreFiltered()) &#123;	<span class="comment">// advisors é¢„è¿‡æ»¤</span></span><br><span class="line">        proxyFactory.setPreFiltered(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line">    <span class="keyword">return</span> proxyFactory.getProxy(getProxyClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·é€šè¿‡ä¸Šè¾¹çš„ä»£ç ï¼Œæˆ‘ä»¬æ„å»ºå‡ºäº† proxyFactory ä»£ç†å·¥å‚ï¼Œå‘å…¶ä¸­å¡«å……äº†å¢å¼ºé›†åˆï¼ŒåŒæ—¶è®¾ç½®äº†ä»£ç†ç±»å‹ï¼Œè¿˜å°†å½“å‰å®ä¾‹çš„ä¸€äº›å­—æ®µå€¼æ‹·è´åˆ°äº† proxyFactory ä»£ç†å·¥å‚ï¼Œæœ€åå°±æ˜¯æ ¹æ®è¯¥ä»£ç†å·¥å‚æ¥æ„å»ºä»£ç†ç±»ã€‚æ ¸å¿ƒå°±æ˜¯ <code>ProxyFactory#getProxy(java.lang.ClassLoader)</code> æ–¹æ³•ï¼Œå®ƒå°±ä¸€è¡Œä»£ç  <code>return createAopProxy().getProxy(classLoader);</code>ï¼Œå…ˆçœ‹ç¬¬ä¸€æ®µå…¶æ ¹æœ¬æ‰§è¡Œçš„æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AopProxy <span class="title function_">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException &#123;</span><br><span class="line">    <span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">        Class&lt;?&gt; targetClass = config.getTargetClass();	<span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜é‡‡ç”¨ cglib ä»£ç†æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (targetClass == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AopConfigException</span>(<span class="string">&quot;TargetSource cannot determine target class: &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;Either an interface or a target is required for proxy creation.&quot;</span>);</span><br><span class="line">        &#125;	<span class="comment">// ç›®æ ‡ç±»æ˜¯æ¥å£æˆ–è€…æ˜¯ Proxy æ¥å£å®ç°ç±»ï¼Œé‚£ä¹ˆè¿›è¡Œ jdk ä»£ç†</span></span><br><span class="line">        <span class="keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdkDynamicAopProxy</span>(config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjenesisCglibAopProxy</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdkDynamicAopProxy</span>(config);	<span class="comment">// è¿™é‡Œå°±æ˜¯è¿›è¡Œ jdk ä»£ç†æ–¹å¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯ä¸€ä¸ªåˆ›å»º AopProxy çš„è¿‡ç¨‹ï¼Œåˆ›å»ºå‡ºæ¥çš„æ„Ÿè§‰å°±åƒæ˜¯ä¸€ä¸ªå·¥å‚ç±»å§ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†å®ƒçš„ getProxy æ–¹æ³•ã€‚æˆ‘ä»¬çš„æ­£åœ¨å¤„ç†çš„ç›®æ ‡ bean ä¸º TestBeanï¼Œåœ¨ç»è¿‡ä¸Šè¾¹ä»£ç çš„æ¡ä»¶åˆ¤æ–­åä¼šè¿”å› ObjenesisCglibAopProxy å®ä¾‹ï¼Œ ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ä»£ç†ç±»åº”è¯¥æ˜¯é‡‡ç”¨çš„ cglib ä»£ç†æ–¹å¼ï¼Œè‡³äºä¸ºä»€ä¹ˆé‚£å°±çœ‹ä¸Šè¾¹ä»£ç é€»è¾‘å–½ã€‚æœ¬æ–‡åªä¼šå¯¹ cglib çš„ä»£ç†æ–¹å¼è¿›è¡Œè¯´æ˜ï¼Œjdk çš„ä»£ç†æ–¹å¼åº”è¯¥æ•´ä½“çš„é€»è¾‘å·®ä¸å¤šï¼Œè‡ªè¡Œåˆ†æå³å¯ã€‚</p>
<p><code>return createAopProxy().getProxy(classLoader);</code>ï¼Œå…ˆçœ‹ç¬¬ä¸€æ®µå°±æ˜¯è·å–äº† ObjenesisCglibAopProxy å®ä¾‹ï¼Œæˆ‘ä»¬è°ƒç”¨å®ƒçš„ getProxy æ–¹æ³•ï¼Œå®ƒçš„æ ¹æœ¬å®ç°å°±æ˜¯è°ƒç”¨çš„ä¸‹è¾¹çš„ä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†ç”¨äºåˆ›å»ºä»£ç†ç±»çš„ Enhancer å®ä¾‹ï¼Œæ‰€ä»¥åè¾¹çš„ä»£ç ä¹Ÿå°±ä¸ç”¨å†æ·±ç©¶äº†ï¼Œåªéœ€è¦çŸ¥é“è¿™é‡Œæœ€ç»ˆè¿”å›çš„å°±æ˜¯ä¸€ä¸ªæ­£åœ¨è¢«å¤„ç†çš„ bean çš„ä»£ç†ç±»å°±è¡Œäº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// éªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Creating CGLIB proxy: &quot;</span> + <span class="built_in">this</span>.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;	<span class="comment">// advised å°±æ˜¯ä»£ç†å·¥å‚å®ä¾‹</span></span><br><span class="line">        Class&lt;?&gt; rootClass = <span class="built_in">this</span>.advised.getTargetClass();</span><br><span class="line">        Assert.state(rootClass != <span class="literal">null</span>, <span class="string">&quot;Target class must be available for creating a CGLIB proxy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; proxySuperClass = rootClass;</span><br><span class="line">        <span class="keyword">if</span> (rootClass.getName().contains(ClassUtils.CGLIB_CLASS_SEPARATOR)) &#123;	<span class="comment">// è¿™é‡Œç›®æ ‡ç±»æœ¬èº«å°±æ˜¯ cglib ä»£ç†ç±»</span></span><br><span class="line">            proxySuperClass = rootClass.getSuperclass();</span><br><span class="line">            Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces();</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123;</span><br><span class="line">                <span class="built_in">this</span>.advised.addInterface(additionalInterface);	<span class="comment">// è·å–çœŸå®ç±»çš„æ¥å£ä¿¡æ¯å­˜å…¥ä»£ç†å·¥å‚å®ä¾‹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate the class, writing log messages as necessary.</span></span><br><span class="line">        validateClassIfNecessary(proxySuperClass, classLoader);	<span class="comment">// éªŒè¯è¢«ä»£ç†ç±»çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–¹æ³•çš„ä¿®é¥°ç¬¦</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure CGLIB Enhancer...</span></span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> createEnhancer();	<span class="comment">// cglib ä»£ç†å¢å¼ºå™¨</span></span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">            enhancer.setClassLoader(classLoader);</span><br><span class="line">            <span class="keyword">if</span> (classLoader <span class="keyword">instanceof</span> SmartClassLoader &amp;&amp;</span><br><span class="line">                    ((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">                enhancer.setUseCache(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        enhancer.setSuperclass(proxySuperClass);</span><br><span class="line">        enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(<span class="built_in">this</span>.advised));</span><br><span class="line">        enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);	<span class="comment">// å‘½åè§„åˆ™</span></span><br><span class="line">        enhancer.setStrategy(<span class="keyword">new</span> <span class="title class_">ClassLoaderAwareUndeclaredThrowableStrategy</span>(classLoader));</span><br><span class="line">        <span class="comment">// è·å– Callback æ•°ç»„ï¼ŒåŒ…æ‹¬ mainCallbacks å’Œ fixedCallbacks ä¸¤ä¸ªéƒ¨åˆ†</span></span><br><span class="line">        Callback[] callbacks = getCallbacks(rootClass);</span><br><span class="line">        Class&lt;?&gt;[] types = <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[callbacks.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; types.length; x++) &#123;</span><br><span class="line">            types[x] = callbacks[x].getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// fixedInterceptorMap only populated at this point, after getCallbacks call above</span></span><br><span class="line">        enhancer.setCallbackFilter(<span class="keyword">new</span> <span class="title class_">ProxyCallbackFilter</span>(</span><br><span class="line">                <span class="built_in">this</span>.advised.getConfigurationOnlyCopy(), <span class="built_in">this</span>.fixedInterceptorMap, <span class="built_in">this</span>.fixedInterceptorOffset));</span><br><span class="line">        enhancer.setCallbackTypes(types);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the proxy class and create a proxy instance.</span></span><br><span class="line">        <span class="keyword">return</span> createProxyClassAndInstance(enhancer, callbacks);</span><br><span class="line">    &#125;	<span class="comment">// æ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line">    <span class="keyword">catch</span> (CodeGenerationException | IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AopConfigException</span>(<span class="string">&quot;Could not generate CGLIB subclass of &quot;</span> + <span class="built_in">this</span>.advised.getTargetClass() +</span><br><span class="line">                <span class="string">&quot;: Common causes of this problem include using a final class or a non-visible class&quot;</span>,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="comment">// TargetSource.getTarget() failed</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AopConfigException</span>(<span class="string">&quot;Unexpected AOP exception&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¾¹çš„ä»£ç å°±æ˜¯é€šè¿‡ Enhancer å®ä¾‹æ„å»ºä»£ç†ç±»çš„è¿‡ç¨‹ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯ <code>Callback[] callbacks = getCallbacks(rootClass);</code> è¿™è¡Œä»£ç ï¼Œæ€ä¹ˆå®ç°çš„æˆ‘æ²¡ç®¡ï¼Œä½†æ˜¯å®ƒçš„è¿”å›ç»“æœè¦æ³¨æ„ï¼Œå¦‚ä¸‹å›¾ï¼Œå¯ä»¥çœ‹åˆ°æœ¬ä¾‹ä¸­å®ƒçš„é•¿åº¦ä¸º 7ï¼Œä¸”æŒæœ‰äº†ä»£ç†å·¥å‚å’Œç›®æ ‡ç±»å¼•ç”¨ï¼Œç›®æ ‡ç±»å°±æ˜¯æˆ‘ä»¬å½“å‰æ­£åœ¨å¤„ç†çš„ TestBean å®ä¾‹ã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/e04049c5f2c59788976a478d77732a96.jpg" width=600 /></div>

<center>callbacks æ•°ç»„å†…å®¹</center>

<p>

<p>ä»£ç†å·¥å‚ä¸­çš„å†…å®¹å°±æ›´åŠ é‡è¦äº†ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯æŒæœ‰äº†æˆ‘ä»¬ä¹‹å‰åˆ†æå¾—åˆ°çš„å…¨éƒ¨å››ä¸ªå¢å¼ºä¿¡æ¯çš„ã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/23b814243ee8ebbd729d50b928f7cef9.jpg" width=600 /></div>

<center>ä»£ç†å·¥å‚ä¸­æŒæœ‰çš„å¢å¼ºä¿¡æ¯</center>

<p>

<p>æ‰§è¡Œåˆ°è¿™é‡Œæˆ‘ä»¬çš„ä»£ç†ç±»åˆ›å»ºå°±å®Œæˆäº†ï¼Œç›´æ¥å›åˆ° <code>AbstractAutoProxyCreator#wrapIfNecessary</code> æ–¹æ³•çš„ createProxy è¿™è¡Œä»£ç å¤„ï¼Œæ¥ä¸‹æ¥å®ƒå°±æ˜¯ç¼“å­˜äº†åˆ›å»ºçš„ä»£ç†ç±»ï¼Œè¿™æ ·ä¸‹æ¬¡è·å–æ—¶å°±èƒ½ä»ç¼“å­˜ä¸­æ‹¿ï¼Œä¸å¿…é‡æ–°æ„å»ºï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æœ€ç»ˆå¾—åˆ°çš„ä»£ç†ç±»å†…éƒ¨éƒ½æœ‰å•¥ä¿¡æ¯å§ï¼Œè®°ä¸‹è¿™äº›ä¿¡æ¯ï¼Œåè¾¹çš„ä»£ç†ç±»æ–¹æ³•è°ƒç”¨è¦ç”¨ä¸Šã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/12d752a02872d88716e7a7f819742ef0.jpg" width=600 /></div>

<center>æ„å»ºçš„ä»£ç†ç±»å†…éƒ¨å­—æ®µä¿¡æ¯</center>

<p>


<p>å†æ€»ç»“ä¸€ä¸‹ä»£ç†ç±»çš„æ„å»ºè¿‡ç¨‹ï¼Œåœ¨æ„å»ºæˆ‘ä»¬åœ¨ spring é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ TestBean æ—¶ï¼Œå®ç°äº† BeanPostProcessor æ¥å£çš„ AspectJAwareAdvisorAutoProxyCreator å®ä¾‹ä¼šå¯¹å½“å‰æ„å»ºçš„ TestBean è¿›è¡Œå¤„ç†ï¼Œå…¶è§„åˆ™å°±æ˜¯çœ‹å®ƒæ˜¯å¦èƒ½å¤Ÿè¢«ä»£ç†ï¼Œå¦‚æœèƒ½ï¼Œå°±è·å–åŒ¹é…å½“å‰å®ä¾‹çš„å…¨éƒ¨å¢å¼ºï¼Œç„¶åæ ¹æ®è¿™äº›å¢å¼ºåŠç›¸å…³ä¿¡æ¯æ„å»ºä»£ç†ç±»ï¼ŒåŒ…æ‹¬ jdk å’Œ cglib ä¸¤ç§æ–¹å¼ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨åˆ°çš„æ˜¯ cglib æ–¹å¼ï¼Œä»–æ ¹æœ¬æ˜¯é€šè¿‡ Enhancer æ¥æ„å»ºä»£ç†ç±»ï¼Œæœ€ç»ˆçš„ä»£ç†ç±»æ˜¯æŒæœ‰äº†æˆ‘ä»¬è·å–çš„å…¨éƒ¨å¢å¼ºçš„ï¼Œåœ¨è°ƒç”¨ä»£ç†çš„çš„å¯¹åº”æ–¹æ³•æ—¶ï¼Œç›¸åº”çš„å¢å¼ºä¼šæŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸‹ä¸€éƒ¨åˆ†è¦è¯´çš„å†…å®¹ã€‚</p>
<h2 id="ä»£ç†ç±»æ–¹æ³•çš„æ‰§è¡Œ"><a href="#ä»£ç†ç±»æ–¹æ³•çš„æ‰§è¡Œ" class="headerlink" title="ä»£ç†ç±»æ–¹æ³•çš„æ‰§è¡Œ"></a>ä»£ç†ç±»æ–¹æ³•çš„æ‰§è¡Œ</h2><p>ç»è¿‡ä¸Šæ–‡çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ä¸»å‡½æ•°ä¸­è·å–åˆ°çš„ TestBean å…¶å®æ˜¯é€šè¿‡ cglib æ„å»ºå‡ºæ¥çš„ä»£ç†ç±»ï¼Œè¿™ä¸ªç±»çš„å†…éƒ¨å¦‚ä¸Šå›¾æ‰€ç¤ºæœ‰ 7 ä¸ª CALLBACK å­—æ®µï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨è¯¥ä»£ç†ç±»çš„ç”¨æˆ·æ–¹æ³•ï¼Œå°±åƒæµ‹è¯•ä»£ç ä¸­è°ƒç”¨çš„ test æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ç¬¬ä¸€ä¸ªå­—æ®µå¯¹åº”çš„ interceptor å®ä¾‹çš„ intercept æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ debug å°±æ˜¯è¿›å…¥äº†è¯¥å®ä¾‹çš„ intercept æ–¹æ³•ï¼Œæ‰€ä»¥ä»£ç†ç±»æ–¹æ³•çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ä»è¯¥æ–¹æ³•å¼€å§‹çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">oldProxy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">setProxyContext</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">TargetSource</span> <span class="variable">targetSource</span> <span class="operator">=</span> <span class="built_in">this</span>.advised.getTargetSource();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.advised.exposeProxy) &#123;</span><br><span class="line">            <span class="comment">// Make invocation available if necessary.</span></span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);	<span class="comment">// å¦‚æœè¦æš´éœ²ä»£ç†ç±»ï¼Œé‚£ä¹ˆå°±å°†ä»£ç†ç±»ä¿å­˜åˆ° AopContext</span></span><br><span class="line">            setProxyContext = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Get as late as possible to minimize the time we &quot;own&quot; the target, in case it comes from a pool...</span></span><br><span class="line">        target = targetSource.getTarget();</span><br><span class="line">        Class&lt;?&gt; targetClass = (target != <span class="literal">null</span> ? target.getClass() : <span class="literal">null</span>);</span><br><span class="line">        List&lt;Object&gt; chain = <span class="built_in">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">        Object retVal;	<span class="comment">// å°è¯•ä»ç¼“å­˜ä¸­è·å– interceptorListï¼Œæ²¡æœ‰çš„è¯å°±ä»å½“å‰å®ä¾‹ä¸­è·å–ï¼ˆè·å– Advised çš„å…¨éƒ¨ advisorsï¼Œçœ‹ advisor æ˜¯å¦é€‚é…å½“å‰æ–¹æ³•ï¼Œé€‚é…çš„è¯ä» advisor ä¸­è·å–åˆ° Adviceï¼Œç„¶åå°†å…¶æ·»åŠ åˆ° interceptorList é›†åˆè¿”å›ï¼‰</span></span><br><span class="line">        <span class="comment">// Check whether we only have one InvokerInterceptor: that is,</span></span><br><span class="line">        <span class="comment">// no real advice, but just reflective invocation of the target.</span></span><br><span class="line">        <span class="keyword">if</span> (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">            <span class="comment">// We can skip creating a MethodInvocation: just invoke the target directly.</span></span><br><span class="line">            <span class="comment">// Note that the final invoker must be an InvokerInterceptor, so we know</span></span><br><span class="line">            <span class="comment">// it does nothing but a reflective operation on the target, and no hot</span></span><br><span class="line">            <span class="comment">// swapping or fancy proxying.</span></span><br><span class="line">            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">            retVal = methodProxy.invoke(target, argsToUse);	<span class="comment">// è¿™é‡Œæ˜¯æ²¡æœ‰æ‹¦æˆªå™¨çš„æ–¹æ³•è°ƒç”¨æ–¹å¼</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// We need to create a method invocation...	// å°†ä»£ç†ç›¸å…³çš„å‚æ•°æ„å»ºä¸º CglibMethodInvocationï¼Œè¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡ CglibMethodInvocation æ¥è§¦å‘ advice çš„è°ƒç”¨</span></span><br><span class="line">            retVal = <span class="keyword">new</span> <span class="title class_">CglibMethodInvocation</span>(proxy, target, method, args, targetClass, chain, methodProxy).proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        retVal = processReturnType(proxy, target, method, retVal);</span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">            targetSource.releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">            <span class="comment">// Restore old proxy.</span></span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¥å£æ–¹æ³•å¦‚ä¸Šï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„å°±ä¸¤ç‚¹ï¼Œé¦–å…ˆä¼šæœ‰ä¸€ä¸ª <code>if (this.advised.exposeProxy)</code> çš„åˆ¤æ–­ï¼Œå°±æ‹¿æˆ‘ä»¬çš„ç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬é…ç½®äº† <code>expose-proxy=&quot;true&quot;</code> å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ¤æ–­æ¡ä»¶å°±ä¼šä¸ºçœŸï¼Œé‚£ä¹ˆç¨‹åºå°±ä¼šå°† proxy ä»£ç†ç±»ä¿å­˜åˆ° AopContext ä¸­ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨æµ‹è¯•ä»£ç ä¸­ä» AopContext æ‹¿åˆ°ä»£ç†ç±»çš„åŸå› ã€‚å…¶æ¬¡æ˜¯ <code>List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</code> è¿™ä¸€è¡Œä»£ç ï¼Œå®ƒä¼šå°è¯•ä»ç¼“å­˜ä¸­è·å– interceptorListï¼Œæ²¡æœ‰çš„è¯å°±ä»ä»£ç†å·¥å‚å³ advised ä¸­è·å–ï¼Œè¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œä¸ç”¨å»ç»†ç©¶ï¼Œåªç»™å‡ºè·å–çš„ç»“æœå¦‚ä¸‹å›¾å°±è¡Œï¼Œä¸€å…±æ˜¯å››ä¸ªï¼Œæ­£å¥½å’Œä¸Šæ–‡ä¸­åˆ†æå‡ºæ¥çš„å››ä¸ªå¢å¼ºç›¸å¯¹åº”ã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/35bab8baa01163525fb60e2e90c365b0.jpg" width=600 /></div>

<center>advice é“¾å›¾</center>

<p>

<p>æ¥ä¸‹æ¥å°±æ˜¯æ„å»º CglibMethodInvocation å®ä¾‹ï¼Œå®ƒæŒæœ‰äº†å¾ˆå¤šå…³é”®çš„ä¿¡æ¯ï¼Œä»æ„é€ å‡½æ•°çš„å‚æ•°å°±å¯ä»¥çŸ¥é“æœ‰ä»£ç†ç±»ã€ç›®æ ‡ beanã€ç›®æ ‡æ–¹æ³•ã€ç›®æ ‡ç±»å‹ã€ä¸Šè¾¹å¾—åˆ°çš„å››ä¸ª adviceã€ä»¥åŠä»£ç†æ–¹æ³•ã€‚æ„å»ºçš„è¿™ä¸ª CglibMethodInvocation å®ƒæœ‰ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½å°±æ˜¯æ§åˆ¶ advice çš„è°ƒç”¨ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹æ¥ä¸‹æ¥çš„ proceed æ–¹æ³•å°±çŸ¥é“äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">//	We start with an index of -1 and increment early.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.currentInterceptorIndex == <span class="built_in">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokeJoinpoint();	<span class="comment">// è¿™é‡Œå°±æ˜¯è§¦å‘è¿æ¥ç‚¹æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">interceptorOrInterceptionAdvice</span> <span class="operator">=</span>	<span class="comment">// é€ä¸ªè·å– interceptorOrInterceptionAdvice</span></span><br><span class="line">            <span class="built_in">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="built_in">this</span>.currentInterceptorIndex);</span><br><span class="line">    <span class="keyword">if</span> (interceptorOrInterceptionAdvice <span class="keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">        <span class="comment">// Evaluate dynamic method matcher here: static part will already have</span></span><br><span class="line">        <span class="comment">// been evaluated and found to match.</span></span><br><span class="line">        <span class="type">InterceptorAndDynamicMethodMatcher</span> <span class="variable">dm</span> <span class="operator">=</span></span><br><span class="line">                (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">        Class&lt;?&gt; targetClass = (<span class="built_in">this</span>.targetClass != <span class="literal">null</span> ? <span class="built_in">this</span>.targetClass : <span class="built_in">this</span>.method.getDeclaringClass());</span><br><span class="line">        <span class="keyword">if</span> (dm.methodMatcher.matches(<span class="built_in">this</span>.method, targetClass, <span class="built_in">this</span>.arguments)) &#123;</span><br><span class="line">            <span class="keyword">return</span> dm.interceptor.invoke(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Dynamic matching failed.</span></span><br><span class="line">            <span class="comment">// Skip this interceptor and invoke the next in the chain.</span></span><br><span class="line">            <span class="keyword">return</span> proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s an interceptor, so we just invoke it: The pointcut will have</span></span><br><span class="line">        <span class="comment">// been evaluated statically before this object was constructed.	// å¯¹é€ä¸ªè·å–çš„ interceptorOrInterceptionAdvice è¿›è¡Œ invoke è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span class="built_in">this</span>);	<span class="comment">// å‚æ•°ä¸ºé€šè¿‡ä»£ç†å„é¡¹å‚æ•°æ„å»ºçš„ CglibMethodInvocation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•ä¸­çš„ interceptorsAndDynamicMethodMatchers å°±æ˜¯æ„é€ å‡½æ•°ä¸­ä¼ è¿›å»çš„å››ä¸ª adviceï¼Œè¿™ä¸ªæ–¹æ³•é€šè¿‡ currentInterceptorIndex æ¥å†³å®šè¿›è¡Œå“ªä¸ª advice çš„è°ƒç”¨ã€‚é»˜è®¤æ˜¯ä»ç¬¬ä¸€ä¸ª advice å¼€å§‹çš„ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è°ƒç”¨å®ƒçš„ invoke æ–¹æ³•ï¼Œä»ä¸Šæ–‡çŸ¥é“ï¼Œç¬¬ä¸€ä¸ª advice æ˜¯ ExposeInvocationInterceptor å®ä¾‹ï¼Œå®ƒçš„æ ¸å¿ƒå°±åªæ˜¯å°† CglibMethodInvocation å®ä¾‹ä¿å­˜åˆ°çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­ï¼Œæ‰§è¡Œå®Œè¿™æ­¥å°±æ˜¯ç»§ç»­è°ƒç”¨ CglibMethodInvocation çš„ proceed æ–¹æ³•ï¼Œä¸‹è¾¹å°±æ˜¯ <code>ExposeInvocationInterceptor#invoke</code> æ–¹æ³•çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">MethodInvocation</span> <span class="variable">oldInvocation</span> <span class="operator">=</span> invocation.get();</span><br><span class="line">    invocation.set(mi);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mi.proceed();	<span class="comment">// ç»§ç»­ä¸‹ä¸€ä¸ª advice çš„è°ƒç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        invocation.set(oldInvocation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ CglibMethodInvocation çš„ proceed æ–¹æ³•åï¼Œå°±ä¼šç»§ç»­ä¸‹ä¸€ä¸ª advice çš„æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™æ—¶ currentInterceptorIndex å·²ç»å˜ä¸º 1 äº†ï¼Œæ ¹æ®ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ç°åœ¨æ‹¿åˆ°çš„å°±æ˜¯ AspectJAfterAdvice å®ä¾‹ï¼Œçœ‹ä»–çš„ invoke æ–¹æ³•å®ç°å¦‚ä¸‹ï¼Œå…¶å®ç°åœ¨å·²ç»å¯ä»¥çŒœæƒ³å‡ºæ¥ AspectJAfterAdvice ä»£è¡¨çš„å¢å¼ºæ˜¯åœ¨æœ€åæ‰§è¡Œçš„ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨ finally ä¸­æ‰§è¡Œçš„è°ƒç”¨é€»è¾‘ï¼Œè€Œè°ƒç”¨ finally ä»£ç å—ä¹‹å‰åªæ˜¯äº¤ç”± CglibMethodInvocation çš„ proceed æ–¹æ³•ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª advice çš„è°ƒç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mi.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        invokeAdviceMethod(getJoinPointMatch(), <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶ currentInterceptorIndex å˜ä¸º 2ï¼Œæ ¹æ®ä¸Šå›¾çš„ä¿¡æ¯çŸ¥é“ç°åœ¨å°†ä¼šè¿›è¡Œ AspectJAroundAdvice çš„ invoke è°ƒç”¨ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼Œå…³é”®å°±æ˜¯æœ€åä¸€è¡Œä»£ç ï¼Œå®ƒçš„å®ç°æˆ‘ä¹Ÿè´´åœ¨äº†ä¸‹è¾¹ï¼Œæ ¹æœ¬è¿˜æ˜¯è°ƒç”¨äº† invokeAdviceMethodWithGivenArgs æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼ŒargBinding æ–¹æ³•å¯¹å‚æ•°è¿›è¡Œäº†ä¸€ç³»åˆ—å¤„ç†ï¼Œè¿™ä¹Ÿä¸æ˜¯å…³æ³¨çš„é‡ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨åªæ˜¯æƒ³çŸ¥é“æ–¹æ³•å…·ä½“æ˜¯æ€æ ·è°ƒç”¨çš„ï¼Œé‚£å°±ç›´æ¥çœ‹<br>invokeAdviceMethodWithGivenArgs æ–¹æ³•å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(mi <span class="keyword">instanceof</span> ProxyMethodInvocation)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;MethodInvocation is not a Spring ProxyMethodInvocation: &quot;</span> + mi);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ProxyMethodInvocation</span> <span class="variable">pmi</span> <span class="operator">=</span> (ProxyMethodInvocation) mi;</span><br><span class="line">    <span class="type">ProceedingJoinPoint</span> <span class="variable">pjp</span> <span class="operator">=</span> lazyGetProceedingJoinPoint(pmi);</span><br><span class="line">    <span class="type">JoinPointMatch</span> <span class="variable">jpm</span> <span class="operator">=</span> getJoinPointMatch(pmi);</span><br><span class="line">    <span class="keyword">return</span> invokeAdviceMethod(pjp, jpm, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// As above, but in this case we are given the join point.</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">invokeAdviceMethod</span><span class="params">(JoinPoint jp, <span class="meta">@Nullable</span> JoinPointMatch jpMatch,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> Object returnValue, <span class="meta">@Nullable</span> Throwable t)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> invokeAdviceMethodWithGivenArgs(argBinding(jp, jpMatch, returnValue, t));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹è¾¹å°±æ˜¯ invokeAdviceMethodWithGivenArgs æ–¹æ³•çš„å®ç°ï¼Œæ³¨æ„æ ¹æ®è°ƒç”¨é“¾çš„å…³ç³»ï¼Œæˆ‘ä»¬çŸ¥é“ç°åœ¨æ˜¯åœ¨è°ƒç”¨ AspectJAroundAdvice å®ä¾‹çš„æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ ï¼Œæˆ‘ä»¬æ ¹æœ¬æ˜¯è°ƒç”¨äº† aspectJAdviceMethod çš„ invoke æ–¹æ³•ï¼Œæ­¤ aspectJAdviceMethod æ˜¯ jdk åŸç”Ÿ Method ç±»çš„å®ä¾‹ï¼Œæˆ‘ä»¬è°ƒç”¨å®ƒçš„ invoke æ–¹æ³•ï¼Œå°±ä¼šè§¦å‘å®ƒæ‰€å¯¹åº”å®ä¾‹æ–¹æ³•çš„è°ƒç”¨ï¼Œé‚£ä¹ˆå®ƒä»£è¡¨çš„ä»€ä¹ˆå®ä¾‹æ–¹æ³•å‘¢ï¼Ÿé€šè¿‡ä¸‹å›¾çš„ debug ç»“æœä¾¿å¾ˆæ¸…æ¥šäº†ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬åˆ‡é¢ç±»çš„ @Around å¢å¼ºå¯¹åº”çš„é‚£ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">invokeAdviceMethodWithGivenArgs</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    Object[] actualArgs = args;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.aspectJAdviceMethod.getParameterCount() == <span class="number">0</span>) &#123;</span><br><span class="line">        actualArgs = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(<span class="built_in">this</span>.aspectJAdviceMethod);</span><br><span class="line">        <span class="comment">// TODO AopUtils.invokeJoinpointUsingReflection</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.aspectJAdviceMethod.invoke(<span class="built_in">this</span>.aspectInstanceFactory.getAspectInstance(), actualArgs);	<span class="comment">// è¿™é‡Œå°±æ˜¯è§¦å‘çœŸæ­£çš„å¢å¼ºæ–¹æ³•çš„è°ƒç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AopInvocationException</span>(<span class="string">&quot;Mismatch on arguments to advice method [&quot;</span> +</span><br><span class="line">                <span class="built_in">this</span>.aspectJAdviceMethod + <span class="string">&quot;]; pointcut expression [&quot;</span> +</span><br><span class="line">                <span class="built_in">this</span>.pointcut.getPointcutExpression() + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex.getTargetException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/ab5abf8d2322e3d9b046988c5bff391e.jpg" width=800 /></div>

<p>å¦å¤–è¦æ³¨æ„è¿™é‡Œçš„è°ƒç”¨ä¼ å…¥äº†å‚æ•° actualArgsï¼Œä»–å°±æ˜¯ä¸Šè¾¹ argBinding æ–¹æ³•æ‹¼å‡‘å‡ºæ¥çš„ç»“æœï¼Œé‡Œè¾¹çš„å†…å®¹ä¸»è¦çš„å°±æ˜¯ä¸€ä¸ª CglibMethodInvocation å®ä¾‹ï¼Œå®ƒæŒæœ‰äº†æˆ‘ä»¬ä»£ç†ç›¸å…³çš„å¤§éƒ¨åˆ†ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/69f2913f3ff99d67349111a977964d68.jpg" width=600 /></div>

<center>CglibMethodInvocation å®ä¾‹ä¿¡æ¯</center>

<p>

<p>çŸ¥é“è¿™äº›åï¼Œæˆ‘ä»¬å°±ç›´æ¥è½¬åˆ°åˆ‡é¢ç±»çš„ AspectJBean#aroundTest æ–¹æ³•ä¸­ï¼Œä¸ç”¨å¤šè¯´æ§åˆ¶å°å°±ä¼šé¦–å…ˆæ‰“å°æˆ‘ä»¬å¼€ç¯‡æµ‹è¯•ä»£ç çš„ç¬¬äºŒæ¡è¯­å¥äº†ã€‚æ¥ç€è°ƒç”¨å‚æ•°çš„ proceed æ–¹æ³•å¦‚ä¸‹ï¼Œè¿™é‡Œçš„ methodInvocation åˆšå¥½å°±æ˜¯æˆ‘ä¸Šè¾¹è¯´çš„ CglibMethodInvocation å®ä¾‹ï¼Œå®ƒæŒæœ‰äº†æˆ‘ä»¬ä»£ç†ç›¸å…³çš„å¤§éƒ¨åˆ†ä¿¡æ¯ï¼ŒåŒæ—¶ advice çš„é¡ºåºè°ƒç”¨ä¹Ÿæ˜¯ç”±ä»–æ§åˆ¶çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.methodInvocation.invocableClone().proceed();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å‰è¾¹çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ç°åœ¨çš„ currentInterceptorIndex å°†ä¼šå˜ä¸º 3ï¼Œè¿™æ ·æˆ‘ä»¬è·å–åˆ°çš„å°±æ˜¯æœ€åä¸€ä¸ª advice äº†ï¼Œä¹Ÿå°±æ˜¯ MethodBeforeAdviceInterceptor å®ä¾‹ï¼Œè¿™ä¸€ç‚¹é€šè¿‡ä¸Šè¾¹çš„ advice é“¾å›¾å°±èƒ½çŸ¥é“äº†ï¼Œå®ƒå°±æŒæœ‰äº†ä¸€ä¸ª AspectJMethodBeforeAdvice å®ä¾‹ï¼Œåœ¨ MethodBeforeAdviceInterceptor çš„ invoke æ–¹æ³•ä¸­å°±æ˜¯è°ƒç”¨äº† AspectJMethodBeforeAdvice çš„ before æ–¹æ³•å¦‚ä¸‹ï¼Œè€Œè¿™ä¸ª before æ–¹æ³•æœ€ç»ˆå°±æ˜¯è°ƒç”¨çš„ AspectJMethodBeforeAdvice å®ä¾‹æŒæœ‰çš„ä¸€ä¸ª jdk åŸç”Ÿ Method å®ä¾‹çš„ invoke æ–¹æ³•ï¼Œè¯¥å®ä¾‹å¯¹åº”çš„å°±æ˜¯åˆ‡é¢ç±»ä¸­ @Before æ³¨è§£å¯¹åº”çš„é‚£ä¸ªå®ä¾‹æ–¹æ³•ï¼Œæ‰€ä»¥å¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼Œå°±ä¼šè§¦å‘åˆ‡é¢ç±»ä¸­ <code>AspectJBean#beforeTest</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™æ ·æˆ‘ä»¬æ§åˆ¶å°å°±ä¼šæ‰“å° â€œbeforeTestâ€ å­—ç¬¦ä¸²äº†ã€‚</p>
<blockquote>
<p>org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor#invoke</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="built_in">this</span>.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis());</span><br><span class="line">    <span class="keyword">return</span> mi.proceed();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¾¹çš„ before æ–¹æ³•æ‰§è¡Œå®Œæˆåå°±ä¼šç»§ç»­è°ƒç”¨ <code>mi.proceed();</code> æ–¹æ³•ï¼Œè¿™æ—¶ currentInterceptorIndex å€¼æ»¡è¶³ <code>ReflectiveMethodInvocation#proceed</code> æ–¹æ³•çš„ç¬¬ä¸€ä¸ª if æ¡ä»¶ï¼Œå°±ä¼šæ‰§è¡Œ <code>ReflectiveMethodInvocation#invokeJoinpoint</code> æ–¹æ³•ï¼Œå®ƒä¼šè§¦å‘ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œï¼Œè¿™ä¸ªçš„æ‰§è¡Œè¿‡ç¨‹æ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘æ²¡å¤ªçœ‹æ‡‚ï¼Œä½†æ˜¯ debug æ‰§è¡Œçš„ç»“æœå°±æ˜¯ä¼šè·³è½¬åˆ° <code>TestBean#test</code> æ–¹æ³•ä¸­å»ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç›®æ ‡æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåï¼Œæ§åˆ¶å°æ‰“å°å‡ºæˆ‘ä»¬é¢„æœŸçš„å‡ è¡Œå­—ç¬¦ã€‚</p>
<p>å¥½äº†å†å›åˆ°ä¸Šä¸€ä¸ªè°ƒç”¨ç‚¹å³ <code>AspectJBean#aroundTest</code> æ–¹æ³•çš„ <code>o = p.proceed();</code> å¤„ï¼Œç»§ç»­å¾€ä¸‹èµ°å¾ˆæ¸…æ¥šæ§åˆ¶å°å°†ä¼šæ‰“å° â€œaroundAfterâ€ å­—ç¬¦ä¸²äº†ï¼Œè¿™ä¸€ç‚¹å¾ˆæ¸…æ¥šï¼Œé‚£ä¹ˆç»§ç»­å›é€€ï¼Œä¹Ÿå°±æ˜¯é€€åˆ° <code>AspectJAfterAdvice#invoke</code> æ–¹æ³•å¤„ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ª finally æ–¹æ³•æ²¡æœ‰æ‰§è¡Œå‘¢ï¼Œè¯¥æ–¹æ³•å°±å’Œ before æ–¹æ³•çš„æ‰§è¡Œä¸€æ ·ï¼Œæ ¹æœ¬å°±æ˜¯è°ƒç”¨ jdk åŸç”Ÿ Method å®ä¾‹çš„  invoke æ–¹æ³•ï¼Œè€Œå®ƒå¯¹åº”çš„å°±æ˜¯åˆ‡é¢ç±»çš„ <code>AspectJBean#afterTest</code> æ–¹æ³•ï¼Œè¿™æ ·æ§åˆ¶å°å°±ä¼šæ‰“å° â€œafterTestâ€ å­—ç¬¦ä¸²ã€‚</p>
<p>æ‰§è¡Œåˆ°è¿™é‡Œï¼Œæ•´ä¸ªçš„ä»£ç†æ–¹æ³•è°ƒç”¨è¿‡ç¨‹ç®—æ˜¯å®Œæˆäº†ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œä»£ç†ç±»æœ‰ä¸ƒä¸ª CALLBACK å­—æ®µï¼Œå½“æˆ‘ä»¬è¿›è¡Œç›®æ ‡æ–¹æ³•çš„è°ƒç”¨æ—¶ï¼Œä»£ç†ç±»å®é™…æ˜¯è°ƒç”¨çš„ç¬¬ä¸€ä¸ª CALLBACK å­—æ®µçš„æ–¹æ³•ï¼Œå®ƒå¯¹åº”çš„æ˜¯ <code>DynamicAdvisedInterceptor#intercept</code> æ–¹æ³•ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ <code>DynamicAdvisedInterceptor#intercept</code> æ–¹æ³•ä¸­æ„å»º CglibMethodInvocation å®ä¾‹æ¥æ§åˆ¶ advice é“¾çš„è°ƒç”¨ï¼Œè¿™æ ·æ„å»ºä»£ç†ç±»æ—¶å¡«å……è¿›å»çš„å¢å¼ºå°±ä¼šæŒ‰ç…§ä¸€å®šçš„é¡ºåºåœ¨ç›®æ ‡æ–¹æ³•çš„å‰åå…ˆåæ‰§è¡Œã€‚è¿™å°±æ˜¯ aop çš„å®ç°åŸç†ï¼Œå½“ç„¶è¿™é‡Œæ˜¯ä»¥ cglib ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œjdk ä»£ç†çš„æ–¹å¼è¿˜è¯·è‡ªè¡Œåˆ†æã€‚</p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Spring/">#Spring</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/AOP/">#AOP</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2019/07/22/2019-07-22-Spring%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Springäº‹åŠ¡æœºåˆ¶å®ç°åŸç†</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2019/07/18/2019-07-18-%E8%BD%BB%E9%87%8F%E7%BA%A7RPC%E6%A1%86%E6%9E%B6BEEHIVE%E4%BB%8B%E7%BB%8D/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">è½»é‡çº§RPCæ¡†æ¶BEEHIVEä»‹ç»</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">å°æ©˜å­ğŸŠ</a>
        </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#aop-%E6%B5%8B%E8%AF%95%E6%A0%B7%E4%BE%8B"><span class="nav-text">aop æµ‹è¯•æ ·ä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%E4%B8%80"><span class="nav-text">æµ‹è¯•ä»£ç ä¸€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%E4%BA%8C"><span class="nav-text">æµ‹è¯•ä»£ç äºŒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lt-aop-aspectj-autoproxy-x2F-gt-%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90"><span class="nav-text">&lt;aop:aspectj-autoproxy&#x2F;&gt; æ ‡ç­¾è§£æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%90%86%E7%B1%BB%E7%9A%84%E7%94%9F%E6%88%90"><span class="nav-text">ä»£ç†ç±»çš„ç”Ÿæˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%90%86%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="nav-text">ä»£ç†ç±»æ–¹æ³•çš„æ‰§è¡Œ</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
