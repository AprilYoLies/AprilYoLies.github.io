<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Java åç«¯">
    <meta name="description" content="å°æ©˜å­ğŸŠçš„ä¸ªäººä¸»é¡µï¼Œæ¬¢è¿è®¿é—®~~">
    <meta name="author" content="å°æ©˜å­ğŸŠ">
    
    <title>
        
            è½»é‡çº§RPCæ¡†æ¶BEEHIVEä»‹ç» |
        
        AprilYoLies
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://img.aprilyolies.top/img/typora/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"aprilyolies.top","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"https://img.aprilyolies.top/img/typora/avatar.jpg","favicon":"https://img.aprilyolies.top/img/typora/avatar.jpg","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"å¹²ç‡¥çš„ç©ºæ°”ï¼Œå°˜åŸƒçš„å‘³é“ï¼Œæˆ‘åœ¨å…¶ä¸­â€¦è¸ä¸Šæ—…é€”ï¼"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </a>
            
            <a class="logo-title" href="/">
                AprilYoLies
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">è½»é‡çº§RPCæ¡†æ¶BEEHIVEä»‹ç»</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">å°æ©˜å­ğŸŠ</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2019-07-18 09:19:47</span>
        <span class="mobile">2019-07-18 09:19</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/">åå°å¼€å‘</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/RPC/">RPC</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/beehive" >é¡¹ç›®åœ°å€<i class="fas fa-external-link-alt"></i></a></p>
<p>beehive æ˜¯ä¸€æ¬¾è½»é‡çº§çš„ RPC æ¡†æ¶ï¼Œé€šè¿‡ spring å®¹å™¨æ¥ç®¡ç† beanï¼Œåšåˆ°äº†å¯¹ç”¨æˆ·ä»£ç çš„é›¶å…¥ä¾µï¼ŒåŒæ—¶é€šè¿‡ spi æ‹“å±•æœºåˆ¶ï¼Œå®ç°äº†è‡ªå·±çš„ ioc å®¹å™¨ï¼Œä½¿å¾— beehive èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„å¯¹ç»„ä»¶è¿›è¡Œæ‹“å±•ã€‚</p>
<h2 id="åŠŸèƒ½ç‰¹æ€§"><a href="#åŠŸèƒ½ç‰¹æ€§" class="headerlink" title="åŠŸèƒ½ç‰¹æ€§"></a>åŠŸèƒ½ç‰¹æ€§</h2><ul>
<li><p>å®ç°äº† SPI æ‹“å±•æœºåˆ¶ï¼Œèƒ½å¤Ÿæ–¹ä¾¿çš„è¿›è¡Œç»„ä»¶çš„è‡ªå®šä¹‰å’Œæ›¿æ¢</p>
</li>
<li><p>æä¾›äº†ä¸¤ç§ä»£ç†æ–¹å¼çš„æ”¯æŒï¼ˆJDK åŸç”Ÿã€Javassistï¼‰</p>
</li>
<li><p>åº•å±‚é€šä¿¡é‡‡ç”¨ Netty æ¡†æ¶ï¼Œä¿è¯ç¨³å®šæ€§å’Œé«˜æ•ˆæ€§</p>
</li>
<li><p>å¯¹ Zookeeper æ³¨å†Œä¸­å¿ƒçš„æ”¯æŒï¼Œèƒ½å¤Ÿè‡ªåŠ¨çš„ä¾¦æµ‹æœåŠ¡çš„çŠ¶æ€ï¼ŒåŒæ­¥è¿›è¡Œæ›´æ–°</p>
</li>
<li><p>å®Œæˆäº†å¯¹ä¸ fastjson å’Œ hessian ä¸¤ç§åºåˆ—åŒ–å™¨çš„æ”¯æŒ</p>
</li>
<li><p>æ•´åˆ spring å®¹å™¨ï¼Œå¯¹ç”¨æˆ·ä»£ç é›¶å…¥ä¾µï¼Œä½¿ç”¨æ–¹ä¾¿</p>
</li>
<li><p>åœ¨å®¢æˆ·ç«¯å®ç°äº†ä¸¤ç§è´Ÿè½½å‡è¡¡ç­–ç•¥çš„æ”¯æŒï¼ˆéšæœºé€‰å–ï¼Œè½®è¯¢é€‰å–ï¼‰</p>
</li>
</ul>
<h2 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h2><p>beehive åŠ å…¥äº†å¯¹äº spring å®¹å™¨çš„æ”¯æŒï¼Œä½¿å¾—å®ƒåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯ä»¥åšåˆ°å¯¹ç”¨æˆ·ä»£ç çš„é›¶å…¥ä¾µï¼Œä½¿ç”¨æ–¹å¼å’Œ dubbo å¾ˆç±»ä¼¼ï¼Œåœ¨æœåŠ¡ç«¯ï¼Œåªéœ€è¦å®šä¹‰è¦å‘å¸ƒçš„æœåŠ¡çš„æ¥å£ç±»å‹ï¼ŒæœåŠ¡çš„å®ç°ç±»ï¼Œä»¥åŠæ³¨å†Œä¸­å¿ƒçš„åœ°å€å³å¯å®Œæˆå¯åŠ¨ï¼Œå…¶ä»–çš„ä¸€äº›ç›¸å…³å‚æ•°å¯ä»¥ä½œä¸ºå¤‡é€‰é¡¹ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªä½¿ç”¨æ ·ä¾‹ã€‚</p>
<blockquote>
<p>provider.xml</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:beehive=<span class="string">&quot;https://www.aprilyolies.top/schema/beehive&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        https://www.aprilyolies.top/schema/beehive https://www.aprilyolies.top/schema/beehive.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;demoServiceImpl&quot;</span> class=<span class="string">&quot;top.aprilyolies.service.BeehiveServiceImpl&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;userServiceImpl&quot;</span> class=<span class="string">&quot;top.aprilyolies.service.UserServiceImpl&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:service id=<span class="string">&quot;demoService&quot;</span> service=<span class="string">&quot;top.aprilyolies.service.BeehiveService&quot;</span></span><br><span class="line">                     ref=<span class="string">&quot;demoServiceImpl&quot;</span> proxy-factory=<span class="string">&quot;jdk&quot;</span> serializer=<span class="string">&quot;hessian&quot;</span> server-port=<span class="string">&quot;7442&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:service id=<span class="string">&quot;userService&quot;</span> service=<span class="string">&quot;top.aprilyolies.service.UserService&quot;</span></span><br><span class="line">                     ref=<span class="string">&quot;userServiceImpl&quot;</span> proxy-factory=<span class="string">&quot;javassist&quot;</span> serializer=<span class="string">&quot;hessian&quot;</span> server-port=<span class="string">&quot;7442&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:registry id=<span class="string">&quot;registry&quot;</span> address=<span class="string">&quot;zookeeper://119.23.247.86:2181&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯æœåŠ¡ç«¯çš„ spring é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­ id&#x3D;â€demoServiceImplâ€ å’Œ id&#x3D;â€userServiceImplâ€ çš„ bean å°±æ˜¯æœåŠ¡çš„å®ç°ç±»ï¼Œè€Œ &lt;beehive:service&#x2F;&gt; æ ‡ç­¾ä¸­çš„ service&#x3D;â€top.aprilyolies.service.BeehiveServiceâ€ å°±æ˜¯å¾…å‘å¸ƒæœåŠ¡çš„æ¥å£ç±»å‹ï¼Œå¦å¤–ä¸€ä¸ª &lt;beehive:service&#x2F;&gt; ç±»ä¼¼ï¼Œæœ€å &lt;beehive:registry&#x2F;&gt; æ ‡ç­¾ä¸­å®šä¹‰çš„å°±æ˜¯æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œç›®å‰ä»…æ”¯æŒ zookeeerã€‚</p>
<p>è¯´å®Œäº†é…ç½®æ–‡ä»¶ï¼Œå†çœ‹çœ‹å¯åŠ¨ç¨‹åºï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ spring å®¹å™¨å¯åŠ¨ç¨‹åºå¦‚ä¸‹ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;provider.xml&quot;</span>);</span><br><span class="line">    context.start();</span><br><span class="line">    System.out.println(<span class="string">&quot;Provider started on thread &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;..&quot;</span>);</span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨æœåŠ¡ç«¯ç¨‹åºåå°±æ˜¯å®¢æˆ·ç«¯ç¨‹åºäº†ï¼Œè¦åšçš„é…ç½®ä¹Ÿéå¸¸ç®€å•ï¼Œä»…ä»…æ˜¯é€šè¿‡ beehive å¼•å…¥æœåŠ¡å³å¯ï¼Œå…·ä½“çš„ rpc è¿‡ç¨‹å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯ç»å¯¹é€æ˜çš„ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:beehive=<span class="string">&quot;https://www.aprilyolies.top/schema/beehive&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        https://www.aprilyolies.top/schema/beehive https://www.aprilyolies.top/schema/beehive.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:registry id=<span class="string">&quot;registry&quot;</span> address=<span class="string">&quot;zookeeper://119.23.247.86:2181&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:reference id=<span class="string">&quot;demoService&quot;</span> service=<span class="string">&quot;top.aprilyolies.service.BeehiveService&quot;</span> load-balance=<span class="string">&quot;poll&quot;</span></span><br><span class="line">                       serializer=<span class="string">&quot;hessian&quot;</span> read-timeout=<span class="string">&quot;1000&quot;</span> retry-times=<span class="string">&quot;2&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;beehive:reference id=<span class="string">&quot;userService&quot;</span> service=<span class="string">&quot;top.aprilyolies.service.UserService&quot;</span> load-balance=<span class="string">&quot;poll&quot;</span></span><br><span class="line">                       serializer=<span class="string">&quot;hessian&quot;</span> read-timeout=<span class="string">&quot;1000&quot;</span> retry-times=<span class="string">&quot;2&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>åŸºæœ¬è·ŸæœåŠ¡ç«¯çš„é…ç½®ç›¸ä¼¼ï¼Œæ³¨å†Œä¸­å¿ƒçš„é…ç½®æ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰å¼•ç”¨æœåŠ¡çš„æ ‡ç­¾å˜æˆä¸º &lt;beehive:reference&#x2F;&gt;ï¼Œè¯¥æ ‡ç­¾çš„å±æ€§è®¾ç½®ä¹Ÿè·ŸæœåŠ¡ç«¯çš„æœåŠ¡å‘å¸ƒæ ‡ç­¾æœ‰æ‰€ä¸åŒï¼Œå…³äºè¯¦ç»†çš„å±æ€§è¯´æ˜è¯·çœ‹ä¸‹æ–‡ã€‚</p>
<p>å®¢æˆ·ç«¯å¯åŠ¨ç¨‹åºæœåŠ¡ç«¯ä¸€æ ·ç®€å•ï¼Œç›´æ¥å¯åŠ¨ç¨‹åºï¼ŒæŸ¥çœ‹è¾“å‡ºç»“æœå³å¯ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;consumer.xml&quot;</span>);</span><br><span class="line">        context.start();</span><br><span class="line">        <span class="type">BeehiveService</span> <span class="variable">demoService</span> <span class="operator">=</span> context.getBean(<span class="string">&quot;demoService&quot;</span>, BeehiveService.class);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50000</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> demoService.say(<span class="string">&quot;world - &quot;</span> + i);</span><br><span class="line">            System.out.println(<span class="string">&quot;result: &quot;</span> + hello);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(System.currentTimeMillis() - start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å‚æ•°è®¾ç½®è¯´æ˜"><a href="#å‚æ•°è®¾ç½®è¯´æ˜" class="headerlink" title="å‚æ•°è®¾ç½®è¯´æ˜"></a>å‚æ•°è®¾ç½®è¯´æ˜</h2><h3 id="lt-beehive-service-x2F-gt-æ ‡ç­¾"><a href="#lt-beehive-service-x2F-gt-æ ‡ç­¾" class="headerlink" title="&lt;beehive:service&#x2F;&gt; æ ‡ç­¾"></a>&lt;beehive:service&#x2F;&gt; æ ‡ç­¾</h3><ul>
<li><p>idï¼šä¸º bean åœ¨ spring å®¹å™¨ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦</p>
</li>
<li><p>serviceï¼šå°†è¦å‘å¸ƒçš„æœåŠ¡ï¼Œå€¼ä¸ºä½ æƒ³è¦å‘å¸ƒçš„æœåŠ¡çš„å…¨é™å®šå</p>
</li>
<li><p>refï¼šä½ æ‰€å‘å¸ƒæœåŠ¡çš„å®ç°ç±»ï¼Œå®ƒçš„å€¼ä¸º spring &lt;bean&#x2F;&gt; æ ‡ç­¾çš„ id å€¼</p>
</li>
<li><p>proxy-factoryï¼šæœåŠ¡æä¾›ç«¯ä»£ç†ç±»åˆ›å»ºçš„æ–¹å¼ï¼Œç›®å‰æ”¯æŒ javassist å’Œ jdk å¯é€‰</p>
</li>
<li><p>serializerï¼šåºåˆ—åŒ–å™¨ï¼Œé»˜è®¤ä¸º fastjsonï¼Œå¯é€‰ hessian</p>
</li>
<li><p>server-portï¼šæœåŠ¡å¯åŠ¨çš„ç«¯å£å·ï¼Œé»˜è®¤ä½¿ç”¨ 7440ï¼Œä½ ä¹Ÿå¯ä»¥å†å¯åŠ¨ç¨‹åºæ—¶é€šè¿‡ -Dport&#x3D;ç«¯å£å· æ¥æŒ‡å®šï¼Œä¼˜å…ˆçº§æœ€é«˜</p>
</li>
</ul>
<h3 id="lt-beehive-reference-x2F-gt-æ ‡ç­¾"><a href="#lt-beehive-reference-x2F-gt-æ ‡ç­¾" class="headerlink" title="&lt;beehive:reference&#x2F;&gt; æ ‡ç­¾"></a>&lt;beehive:reference&#x2F;&gt; æ ‡ç­¾</h3><ul>
<li><p>idï¼šä¸º bean åœ¨ spring å®¹å™¨ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦</p>
</li>
<li><p>serviceï¼šå°†è¦å‘å¸ƒçš„æœåŠ¡ï¼Œå€¼ä¸ºä½ æƒ³è¦å‘å¸ƒçš„æœåŠ¡çš„å…¨é™å®šå</p>
</li>
<li><p>load-balanceï¼šè´Ÿè½½å‡è¡¡è®¾ç½®ï¼Œç”±å®¢æˆ·ç«¯å®ç°ï¼Œç›®å‰åªæ”¯æŒ random å’Œ poll ä¸¤ç§æ–¹å¼</p>
</li>
<li><p>proxy-factoryï¼šæœåŠ¡æä¾›ç«¯ä»£ç†ç±»åˆ›å»ºçš„æ–¹å¼ï¼Œç›®å‰æ”¯æŒ javassist å’Œ jdk å¯é€‰</p>
</li>
<li><p>serializerï¼šåºåˆ—åŒ–å™¨ï¼Œé»˜è®¤ä¸º fastjsonï¼Œå¯é€‰ hessian</p>
</li>
<li><p>read-timeoutï¼šæŒ‡å®š rpc ç»“æœè¯»å–è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœæœ¬æ¬¡ç»“æœè·å–å¤±è´¥ï¼Œå°†ä¼šé‡è¯•</p>
</li>
<li><p>retry-timesï¼šæŒ‡å®šé‡è¯•æ¬¡æ•°ï¼Œå³ rpc ç»“æœè·å–è¶…æ—¶é‡è¯•æ¬¡æ•°</p>
</li>
</ul>
<h3 id="lt-beehive-registry-x2F-gt-æ ‡ç­¾"><a href="#lt-beehive-registry-x2F-gt-æ ‡ç­¾" class="headerlink" title="&lt;beehive:registry&#x2F;&gt; æ ‡ç­¾"></a>&lt;beehive:registry&#x2F;&gt; æ ‡ç­¾</h3><ul>
<li><p>idï¼šä¸º bean åœ¨ spring å®¹å™¨ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦</p>
</li>
<li><p>addressï¼šæ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼Œç›®å‰åªæ”¯æŒ zookeeperï¼Œæ ¼å¼å¦‚ â€œzookeeper:&#x2F;&#x2F;host:portâ€</p>
</li>
</ul>
<h2 id="æ ·ä¾‹æµ‹è¯•"><a href="#æ ·ä¾‹æµ‹è¯•" class="headerlink" title="æ ·ä¾‹æµ‹è¯•"></a>æ ·ä¾‹æµ‹è¯•</h2><h3 id="åŸºæœ¬æµ‹è¯•"><a href="#åŸºæœ¬æµ‹è¯•" class="headerlink" title="åŸºæœ¬æµ‹è¯•"></a>åŸºæœ¬æµ‹è¯•</h3><p>é¡¹ç›®ä¸­æä¾›äº†å®ä¾‹ç¨‹åºï¼ˆä½äº beehive-demoï¼‰æ¨¡å—ä¸‹ï¼Œé€šè¿‡ git clone å°†å·¥ç¨‹æ‹‰å–ä¸‹æ¥åï¼Œåœ¨æ ¹ç›®å½•ä¸‹è¾“å…¥å¦‚ä¸‹æŒ‡ä»¤è¿›è¡Œå®‰è£…ã€‚</p>
<blockquote>
<p>mvn clean install -Dmaven.test.skip&#x3D;true</p>
</blockquote>
<p>å› ä¸ºéœ€è¦ç”¨åˆ°æ³¨å†Œä¸­å¿ƒï¼Œæ‰€ä»¥å®ä¾‹ç¨‹åºä¸­æ³¨å†Œä¸­å¿ƒçš„åœ°å€æ˜¯æˆ‘çš„é˜¿é‡Œäº‘æœåŠ¡å™¨åœ°å€ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä¼šå¯åŠ¨ zookeeper æœåŠ¡ï¼Œé‚£ä¹ˆç¤ºä¾‹ç¨‹åºå°±ä¼šå°†æœåŠ¡æ³¨å†Œåˆ°æˆ‘çš„é˜¿é‡Œäº‘æœåŠ¡å™¨çš„ zookeeper ä¸Šï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨æœ¬æœºå¯åŠ¨ä¸€ä¸ª zookeeperï¼Œç„¶åä¿®æ”¹ spring é…ç½®æ–‡ä»¶ä¸­çš„æ³¨å†Œä¸­å¿ƒåœ°å€ã€‚</p>
<p>å¯åŠ¨æœåŠ¡å™¨ï¼Œå¦‚æœä½ æ²¡æœ‰ä¿®æ”¹å®ä¾‹ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨æˆ‘é˜¿é‡Œäº‘çš„ zookeeperï¼Œè¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<blockquote>
<p>java -jar beehive-demo&#x2F;provider&#x2F;target&#x2F;provider-1.0-SNAPSHOT-jar-with-dependencies.jar</p>
</blockquote>
<p>å¯åŠ¨å®¢æˆ·ç«¯ï¼Œæ²¡æœ‰ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œä¼šä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡ä¿¡æ¯ï¼Œè¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<blockquote>
<p>java -jar beehive-demo&#x2F;consumer&#x2F;target&#x2F;consumer-1.0-SNAPSHOT-jar-with-dependencies.jar</p>
</blockquote>
<p>å¦‚æœè¿‡ç¨‹æ²¡æœ‰é”™è¯¯çš„è¯ï¼Œåœ¨æ§åˆ¶å°å°†ä¼šæ‰“å° rpc çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">result: Jim say world - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">2</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">3</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">4</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">5</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">6</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">7</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">8</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">9</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…å¯åŠ¨å¤šçº¿ç¨‹çš„ consumerï¼Œè¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<blockquote>
<p>java -cp beehive-demo&#x2F;consumer&#x2F;target&#x2F;consumer-1.0-SNAPSHOT-jar-with-dependencies.jar top.aprilyolies.consumer.MultiThreadConsumer</p>
</blockquote>
<p>æˆ‘è¿™é‡Œæ˜¯å¯åŠ¨äº† 5 ä¸ªçº¿ç¨‹æ¥è¿›è¡Œçš„ rpc è¯·æ±‚ï¼Œå‚æ•°é™„å¸¦äº†å½“å‰çº¿ç¨‹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ rpc çš„ç»“æœä¹ŸåŒ…å«äº†çº¿ç¨‹ä¿¡æ¯ï¼Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">3</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">3</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">1</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">4</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">5</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">2</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">3</span> - <span class="number">2</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">1</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">2</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">5</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="æœåŠ¡åˆ‡æ¢çš„æµ‹è¯•"><a href="#æœåŠ¡åˆ‡æ¢çš„æµ‹è¯•" class="headerlink" title="æœåŠ¡åˆ‡æ¢çš„æµ‹è¯•"></a>æœåŠ¡åˆ‡æ¢çš„æµ‹è¯•</h3><p>ç¤ºä¾‹ç¨‹åºä¸­æä¾›äº†ä¸¤ä¸ªæœåŠ¡ç«¯ç¨‹åºï¼Œè¡¨ç¤ºä¸¤ä¸ªæœåŠ¡æä¾›è€…ï¼Œæµ‹è¯•æœåŠ¡åˆ‡æ¢éœ€è¦åŒæ—¶å¯åŠ¨è¿™ä¸¤ä¸ªç¨‹åºï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>java -cp beehive-demo&#x2F;provider&#x2F;target&#x2F;provider-1.0-SNAPSHOT-jar-with-dependencies.jar top.aprilyolies.provider.Provider</p>
</blockquote>
<blockquote>
<p>java -cp beehive-demo&#x2F;provider&#x2F;target&#x2F;provider-1.0-SNAPSHOT-jar-with-dependencies.jar top.aprilyolies.provider.AnotherProvider</p>
</blockquote>
<p>å¯åŠ¨å®¢æˆ·ç«¯ï¼Œæ²¡æœ‰ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œä¼šä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡ä¿¡æ¯ï¼Œè¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<blockquote>
<p>java -jar beehive-demo&#x2F;consumer&#x2F;target&#x2F;consumer-1.0-SNAPSHOT-jar-with-dependencies.jar</p>
</blockquote>
<p>å› ä¸ºæµ‹è¯•ç¨‹åºä¸­é»˜è®¤ä½¿ç”¨çš„æ˜¯è½®è¯¢è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä¼šä»æ‰€æœ‰çš„æœåŠ¡æä¾›è€…ä¸­é€ä¸ªè°ƒç”¨ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼Œæ ¹æ®æœ€åçš„ server<br>id å°±èƒ½å¤Ÿåˆ†è¾¨å‡ºæ¥å½“å‰æ˜¯è¯·æ±‚çš„å“ªä¸ªæœåŠ¡æä¾›è€…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">result: Jim say world - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say world - <span class="number">2</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">3</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say world - <span class="number">4</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">5</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say world - <span class="number">6</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">7</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say world - <span class="number">8</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say world - <span class="number">9</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…å¯åŠ¨å¤šçº¿ç¨‹çš„ consumerï¼Œè¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<blockquote>
<p>java -cp beehive-demo&#x2F;consumer&#x2F;target&#x2F;consumer-1.0-SNAPSHOT-jar-with-dependencies.jar top.aprilyolies.consumer.MultiThreadConsumer</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">2</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">2</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">4</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">1</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">5</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">3</span> - <span class="number">0</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">2</span> - <span class="number">2</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.1</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">3</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">5</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">1</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br><span class="line">result: Jim say MultiThreadConsumer-pool-thread-<span class="number">4</span> - <span class="number">1</span> from <span class="number">192.168</span><span class="number">.1</span><span class="number">.105</span>, [ server id is No<span class="number">.2</span>]</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œrpc çš„è°ƒç”¨é€»è¾‘å’Œå•çº¿ç¨‹æ˜¯ä¿æŒä¸€è‡´çš„ã€‚</p>
<p>å®ä¾‹ç¨‹åºé»˜è®¤æ˜¯ä½¿ç”¨çš„è½®è¯¢è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œå¦‚æœè¿‡ç¨‹æ²¡é”™çš„è¯ï¼Œé‚£ä¹ˆä½ å°†ä¼šçœ‹åˆ°å®¢æˆ·ç«¯ä¼šäº¤æ›¿çš„ä»ä¸¤ä¸ª provider è¿›è¡Œ rpc è°ƒç”¨ã€‚</p>
<p>å°è¯•å…³æ‰å…¶ä¸­ä¸€ä¸ª providerï¼Œå®¢æˆ·ç«¯ä¼šä¾¦æµ‹åˆ°è¿™ä¸ªå˜åŒ–ï¼Œéšå³å°†è¿™ä¸ªä¸‹çº¿çš„ provider å‰”é™¤ï¼Œä»…ä»…ä»å‰©ä¸‹çš„ provider ä¸­è¿›è¡Œ rpc è°ƒç”¨ã€‚</p>
<p>å†å°è¯•é‡å¯è¿™ä¸ª providerï¼Œå®¢æˆ·ç«¯ä¹Ÿä¼šä¾¦æµ‹åˆ°è¿™ä¸ªå˜åŒ–ï¼Œéšå³å°†è¿™ä¸ª provider åŠ å…¥åˆ°å¯è°ƒç”¨çš„ providers åˆ—è¡¨ä¸­ï¼Œè¿›è€Œè¿›è¡Œ rpc è°ƒç”¨ã€‚</p>
<h2 id="åº•å±‚å®ç°åŸç†"><a href="#åº•å±‚å®ç°åŸç†" class="headerlink" title="åº•å±‚å®ç°åŸç†"></a>åº•å±‚å®ç°åŸç†</h2><h3 id="æ ‡ç­¾è§£æ"><a href="#æ ‡ç­¾è§£æ" class="headerlink" title="æ ‡ç­¾è§£æ"></a>æ ‡ç­¾è§£æ</h3><p>beehive å®ç°äº†è‡ªå·±çš„æ ‡ç­¾è§£æå™¨ï¼Œspring å®¹å™¨èƒ½å¤Ÿå¯¹è¿™äº›æ ‡ç­¾å¯¹åº”çš„ bean çš„åˆ›å»ºåŠåˆå§‹åŒ–è¿›è¡Œç®¡ç†ï¼Œbeehive è‡ªå®šä¹‰çš„æ ‡ç­¾åªæœ‰ &lt;beehive:registry&#x2F;&gt;ã€&lt;beehive:service&#x2F;&gt;ã€&lt;beehive:reference&#x2F;&gt; ä¸‰ä¸ªï¼Œåˆ†åˆ«å¯¹åº”æ³¨å†Œä¸­å¿ƒã€æœåŠ¡å‘å¸ƒã€æœåŠ¡è°ƒç”¨ä¸‰ä¸ªé€»è¾‘ï¼Œç›¸åº”çš„ BeanDefinitionParser æ˜¯ç”± <code>top.aprilyolies.beehive.spring.namespace.BeehiveNamespaceHandler</code> å®Œæˆæ³¨å†Œçš„ï¼Œå®ƒçš„ä»£ç å†…å®¹å¦‚ä¸‹ï¼Œå°±æ˜¯ä¸ºæ¯ä¸ª beehive å¯¹åº”çš„æ ‡ç­¾æ³¨å†Œäº†ä¸€ä¸ª BeanDefinitionParserï¼Œç”¨äºè§£æ spring é…ç½®æ–‡ä»¶ä¸­çš„ beehive æ ‡ç­¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeehiveNamespaceHandler</span> <span class="keyword">extends</span> <span class="title class_">NamespaceHandlerSupport</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// beehive:registry æ ‡ç­¾è§£æå™¨</span></span><br><span class="line">        registerBeanDefinitionParser(<span class="string">&quot;registry&quot;</span>, <span class="keyword">new</span> <span class="title class_">RegistryBeanDefinitionParser</span>());</span><br><span class="line">        <span class="comment">// beehive:service æ ‡ç­¾è§£æå™¨</span></span><br><span class="line">        registerBeanDefinitionParser(<span class="string">&quot;service&quot;</span>, <span class="keyword">new</span> <span class="title class_">ServiceBeanDefinitionParser</span>());</span><br><span class="line">        <span class="comment">// beehive:reference æ ‡ç­¾è§£æå™¨</span></span><br><span class="line">        registerBeanDefinitionParser(<span class="string">&quot;reference&quot;</span>, <span class="keyword">new</span> <span class="title class_">ReferenceBeanDefinitionParser</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºä¸‰ä¸ª BeanDefinitionParser çš„åŸºæœ¬é€»è¾‘ä¸€æ ·ï¼Œæˆ‘è¿™é‡Œä»…ä»¥ ServiceBeanDefinitionParser è¿›è¡Œå¤§è‡´è¯´æ˜ï¼Œå…ˆè´´å‡º ServiceBeanDefinitionParser çš„æºä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title class_">AbstractBeanDefinitionParser</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BeanDefinition <span class="title function_">parse</span><span class="params">(Element element, ParserContext parserContext)</span> &#123;</span><br><span class="line">        <span class="comment">// æ„å»º RootBeanDefinitionï¼Œç”¨äºæ‰¿è½½è§£æå‡ºæ¥çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>();</span><br><span class="line">        <span class="comment">// æŒ‡å®šè§£æçš„ bean çš„ç±»å‹</span></span><br><span class="line">        beanDefinition.setBeanClass(ServiceProvider.class);</span><br><span class="line">        <span class="comment">// ä¸ä½¿ç”¨æ‡’åŠ è½½</span></span><br><span class="line">        beanDefinition.setLazyInit(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> element.getAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">service</span> <span class="operator">=</span> element.getAttribute(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">        beanDefinition.getPropertyValues().addPropertyValue(<span class="string">&quot;service&quot;</span>, service);</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æŒ‡å®š id å±æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(id)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> element.getAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            beanDefinition.getPropertyValues().addPropertyValue(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">            <span class="comment">// å°è¯•ä½¿ç”¨ name æ¥ç¡®å®š id ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">if</span> (!isExisted(parserContext, name)) &#123;</span><br><span class="line">                id = name;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// name ä¸è¡Œçš„è¯ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ service æ¥ç¡®å®š id ä¿¡æ¯</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> getBeanName(service);</span><br><span class="line">                id = beanName;</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> (isExisted(parserContext, id)) &#123;</span><br><span class="line">                    id = beanName + count;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(id)) &#123;</span><br><span class="line">            <span class="comment">// ç›¸åŒ id åªèƒ½å­˜åœ¨ä¸€ä¸ª</span></span><br><span class="line">            <span class="keyword">if</span> (isExisted(parserContext, id)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String.format(<span class="string">&quot;Bean of id %s has existed&quot;</span>, id));</span><br><span class="line">            &#125;</span><br><span class="line">            beanDefinition.getPropertyValues().addPropertyValue(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">            <span class="comment">// è¿›è¡Œæ³¨å†Œä¿¡æ¯ï¼Œè¿™ä¸€æ­¥ä¸€å®šä¸èƒ½è½ä¸‹</span></span><br><span class="line">            parserContext.getRegistry().registerBeanDefinition(id, beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è§£æ protocol å±æ€§</span></span><br><span class="line">        parseAttribute(element, beanDefinition, <span class="string">&quot;protocol&quot;</span>, <span class="string">&quot;beehive&quot;</span>);</span><br><span class="line">        <span class="comment">// è§£æ proxy å±æ€§</span></span><br><span class="line">        parseAttribute(element, beanDefinition, <span class="string">&quot;proxy-factory&quot;</span>, <span class="string">&quot;javassist&quot;</span>);</span><br><span class="line">        <span class="comment">// è§£æ serializer å±æ€§</span></span><br><span class="line">        parseAttribute(element, beanDefinition, <span class="string">&quot;serializer&quot;</span>, <span class="string">&quot;fastjson&quot;</span>);</span><br><span class="line">        <span class="comment">// è§£æ serializer å±æ€§</span></span><br><span class="line">        parseAttribute(element, beanDefinition, <span class="string">&quot;server-port&quot;</span>, <span class="string">&quot;7440&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">ref</span> <span class="operator">=</span> element.getAttribute(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">        <span class="comment">// å¦‚æœ setter æ–¹æ³•å¯¹åº”çš„å±æ€§ä¸º refï¼Œå¹¶ä¸” spring å®¹å™¨ä¸­å·²ç»æ³¨å†Œè¿‡è¿™ä¸ª ref æ‰€å¼•ç”¨çš„ bean çš„ beanDefinition</span></span><br><span class="line">        <span class="keyword">if</span> (parserContext.getRegistry().containsBeanDefinition(ref)) &#123;</span><br><span class="line">            <span class="comment">// é‚£å°±æ‹¿åˆ°è¿™ä¸ª beanDefinition</span></span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">refBean</span> <span class="operator">=</span> parserContext.getRegistry().getBeanDefinition(ref);</span><br><span class="line">            <span class="comment">// è¿™ä¸ª beanDefinition å¿…é¡»æ˜¯å•ä¾‹çš„</span></span><br><span class="line">            <span class="keyword">if</span> (!refBean.isSingleton()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The exported service ref &quot;</span> + ref + <span class="string">&quot; must be singleton! Please set the &quot;</span> + ref + <span class="string">&quot; bean scope to singleton, eg: &lt;bean id=\&quot;&quot;</span> + ref + <span class="string">&quot;\&quot; scope=\&quot;singleton\&quot; ...&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">RuntimeBeanReference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeBeanReference</span>(ref);</span><br><span class="line">        beanDefinition.getPropertyValues().addPropertyValue(<span class="string">&quot;ref&quot;</span>, reference);</span><br><span class="line">        <span class="keyword">return</span> beanDefinition;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç±»å®ç°äº† <code>org.springframework.beans.factory.xml.BeanDefinitionParser</code> æ¥å£ï¼Œä»–åªæœ‰ä¸€ä¸ª <code>BeanDefinition parse(Element element, ParserContext parserContext);</code> æ–¹æ³•ï¼Œå‚æ•° element å°±æ˜¯ spring é…ç½®æ–‡ä»¶ä¸­ beehive å¯¹åº”çš„é‚£ä¸ªæ ‡ç­¾å…ƒç´ ï¼Œå‚æ•° parserContext å°±æ˜¯ä¸€ä¸ªæ ‡ç­¾è§£æçš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¯ä»¥ä»ä¸­è·å–åˆ°å·²ç»è§£æçš„æ ‡ç­¾çš„ä¿¡æ¯ã€‚åœ¨ parse æ–¹æ³•ä¸­æˆ‘ä»¬å°±éœ€è¦å®ç°è‡ªå·±çš„æ ‡ç­¾è§£æé€»è¾‘ï¼Œä¸»è¦å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª RootBeanDefinition å®ä¾‹ï¼Œç„¶åå°†å…¶å’Œæ­£åœ¨è§£æçš„æ ‡ç­¾æ‰€å¯¹åº”çš„ç±»è¿›è¡Œç»‘å®šï¼Œä¹Ÿå°±æ˜¯ <code>beanDefinition.setBeanClass(ServiceProvider.class);</code> è¿™ä¸ªæ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†æ ‡ç­¾ä¸­è§£æå‡ºæ¥çš„å±æ€§é€ä¸ªçš„æ·»åŠ åˆ°åˆšåˆšåˆ›å»ºçš„ RootBeanDefinition å®ä¾‹ä¸­ï¼Œè¿™æ · RootBeanDefinition å°±åŒ…å«äº†ç±»ä¿¡æ¯åŠç›¸å…³çš„å‚æ•°ä¿¡æ¯ï¼Œæœ€åå°±æ˜¯å°† RootBeanDefinition å®ä¾‹è¿”å›ï¼Œäº¤ç”± spring å®¹å™¨è¿›è¡Œç®¡ç†ï¼Œè¿™åŒ…æ‹¬ bean æ˜¯å¦æ˜¯å•ä¾‹ï¼Œä¸åŒçš„åˆå§‹åŒ–é˜¶æ®µçš„å£°æ˜å‘¨æœŸæ–¹æ³•çš„è°ƒç”¨ï¼Œå­—æ®µçš„è‡ªåŠ¨è£…é…ç­‰ç­‰ã€‚</p>
<h3 id="æœåŠ¡ç«¯å¯åŠ¨"><a href="#æœåŠ¡ç«¯å¯åŠ¨" class="headerlink" title="æœåŠ¡ç«¯å¯åŠ¨"></a>æœåŠ¡ç«¯å¯åŠ¨</h3><p>æœåŠ¡ç«¯å¯åŠ¨ä¸»è¦æ˜¯å®Œæˆäº†ä¸‰ä»¶äº‹ï¼Œæ‰“å¼€æ•°æ®é€šä¿¡æœåŠ¡å™¨ã€åˆ›å»ºæœåŠ¡æ¥å£æœåŠ¡ç«¯ä»£ç†ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘å¸ƒæœåŠ¡ï¼Œæ‰§è¡Œçš„å…ˆåé¡ºåºå¦‚ä¸‹å›¾ï¼š</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/6bf986c768b463921ee0e5d01d9992ed.jpeg" width=600 /></div>

<center>æœåŠ¡ç«¯å¯åŠ¨æ ¸å¿ƒé€»è¾‘</center>


<p>åœ¨å®Œæˆæ ‡ç­¾çš„è§£æåï¼Œæ ‡ç­¾å¯¹åº”çš„ bean å°±ä¼šäº¤ç”± spring å®¹å™¨ç®¡ç†ï¼Œæ ¹æ® bean çš„å®ç°æ¥å£çš„ç±»å‹ï¼Œspring å®¹å™¨ä¼šåœ¨ä¸åŒçš„é˜¶æ®µå®Œæˆ bean å¯¹åº”æ¥å£æ–¹æ³•çš„è°ƒç”¨ï¼ŒæœåŠ¡ç«¯çš„å¯åŠ¨å°±æ˜¯å¦‚æ­¤ã€‚å…ˆçœ‹çœ‹æœåŠ¡å‘å¸ƒæ ‡ç­¾å¯¹åº” beanï¼ˆServiceProviderï¼‰çš„å®ç°æ¥å£ <code>public class ServiceProvider extends ServiceConfigBean implements ApplicationListener&lt;ContextRefreshedEvent&gt;, InitializingBean, ApplicationContextAware</code>ï¼Œå¯¹äº ApplicationListener æ¥å£çš„å®ç°ç±»ï¼Œspring å®¹å™¨åœ¨åˆå§‹åŒ–å®Œæˆåè¿›è¡Œè¯¥æ¥å£å¯¹åº”æ–¹æ³•çš„è°ƒç”¨ï¼ŒInitializingBean æ¥å£åˆ™æ˜¯åœ¨è¿›è¡Œ bean çš„åˆå§‹åŒ–æ—¶è¿›è¡Œè°ƒç”¨ï¼Œè€Œ ApplicationContextAware æ˜¯ä¸€ä¸ªæ„ŸçŸ¥æ¥å£ï¼Œå°±æ˜¯è¯¥æ¥å£çš„å®ç°ç±»èƒ½å¤Ÿæ‹¿åˆ° spring ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œåœ¨ beehive ä¸­ï¼Œåˆ™æ˜¯åˆ©ç”¨è¯¥æ¥å£æ‹¿åˆ°äº† spring ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œé€šè¿‡å®ƒæ³¨å†Œäº†ä¸€ä¸ªå…³é—­é’©å­å‡½æ•°ï¼Œç”¨äºå…³é—­é€šä¿¡ç«¯ç¨‹åºã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">    <span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">    <span class="comment">// æ³¨å†Œå…³é—­ç›‘å¬å™¨</span></span><br><span class="line">    <span class="comment">// å¦‚æœ context æ˜¯ ConfigurableApplicationContext æ¥å£çš„å®ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (applicationContext <span class="keyword">instanceof</span> ConfigurableApplicationContext) &#123;</span><br><span class="line">        <span class="comment">// spring æ¡†æ¶çš„æ–¹æ³•ï¼Œå‘ jvm æ³¨å†Œä¸€ä¸ªå…³é—­é’©å­å‡½æ•°ï¼Œåœ¨ jvm å…³é—­æ—¶ä¼šè°ƒç”¨è¿™ä¸ªé’©å­å‡½æ•°æ¥å…³é—­ applicationContext</span></span><br><span class="line">        ((ConfigurableApplicationContext) applicationContext).registerShutdownHook();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ³¨å†Œå…³é—­ç›‘å¬å™¨</span></span><br><span class="line">    addApplicationListener(<span class="keyword">new</span> <span class="title class_">ShutdownHookListener</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * beehive çš„å…³é—­ç›‘å¬å™¨ï¼Œå®ƒä¼šç›‘å¬ context å…³é—­äº‹ä»¶ï¼ŒåŒæ—¶å…³é—­ç›¸å…³çš„ç»„ä»¶</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShutdownHookListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// æ­¤ç›‘å¬å™¨åªä¼šç›‘å¬ context å…³é—­äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ContextClosedEvent) &#123;</span><br><span class="line">            BeehiveShutdownHook.closeAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­æ³¨å†Œçš„ Registry</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">closeAll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Registry registry : registries) &#123;</span><br><span class="line">        registry.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (EndPoint endPoint : endPoints) &#123;</span><br><span class="line">        endPoint.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œå®ç° InitializingBean æ¥å£ä¸»è¦æ˜¯ä¸ºäº†æ³¨å…¥ registry å¯¹åº”çš„ bean å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ç”¨äºä¸ºå½“å‰ bean å¡«å……ä¸€äº›å¿…è¦å±æ€§</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    checkRegistry();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ£€æŸ¥å½“å‰ bean çš„ registry å±æ€§æ˜¯å¦ä¸ºç©ºï¼Œå¦åˆ™ä» spring å®¹å™¨ä¸­è·å–å¯¹åº”çš„å€¼è¿›è¡Œå¡«å……</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RegistryConfigBean</span> <span class="variable">registry</span> <span class="operator">=</span> getRegistry();</span><br><span class="line">    <span class="keyword">if</span> (registry == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (applicationContext != <span class="literal">null</span>) &#123;</span><br><span class="line">            Map&lt;String, RegistryConfigBean&gt; registryMap = BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext,</span><br><span class="line">                    RegistryConfigBean.class, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (registryMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ spring å®¹å™¨ä¸­æœ‰å¤šä¸ª registry beanï¼Œé‚£ä¹ˆä¼˜å…ˆè·å–ç¬¬ä¸€ä¸ª</span></span><br><span class="line">                Collection&lt;RegistryConfigBean&gt; registries = registryMap.values();</span><br><span class="line">                <span class="keyword">for</span> (RegistryConfigBean reg : registries) &#123;</span><br><span class="line">                    setRegistry(reg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡ç«¯å¯åŠ¨çš„ä¸»è¦é€»è¾‘æ˜¯åœ¨ ApplicationListener æ¥å£å¯¹åº”çš„æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œè¯¥æ–¹æ³•ä¸­ç›´æ¥æ˜¯è°ƒç”¨äº† <code>exportService();</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ä¸»è¦æ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå‡†å¤‡ registryUrls å’Œè¿›è¡ŒçœŸæ­£çš„æœåŠ¡æ³¨å†Œï¼Œå‡†å¤‡ registryUrls å°±åªæ˜¯ä¸€ä¸ªä¿¡æ¯æ‹¼å‡‘çš„è¿‡ç¨‹ï¼Œé€»è¾‘ç®€å•ï¼Œåªæ˜¯è¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œå»çœ‹<a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/beehive" >æºç <i class="fas fa-external-link-alt"></i></a>ï¼Œæœ€ç»ˆçš„æ‹¼å‡‘ç»“æœæˆ‘é€šè¿‡ debug çš„æ–¹å¼æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œè¯·çœ‹ä¸‹å›¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> &#123;</span><br><span class="line">    exportService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!published) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (publishMonitor) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!published) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">&quot;Export service via thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å°†å½“å‰å®ä¾‹ä»¥ provider_model çš„å½¢å¼ä¿å­˜åˆ° BeehiveContext ä¸­</span></span><br><span class="line">                BeehiveContext.unsafePut(UrlConstants.PROVIDER_MODEL, <span class="built_in">this</span>);</span><br><span class="line">                <span class="comment">// æ ¹æ® registry å±æ€§æ„å»º registry urls</span></span><br><span class="line">                List&lt;URL&gt; registryUrls = getRegistryUrl(getRegistry());</span><br><span class="line">                <span class="comment">// å°†å½“å‰å®ä¾‹ä¸­çš„å±æ€§å¡«å……åˆ° url çš„å‚æ•°ä¸­</span></span><br><span class="line">                fillParameters(registryUrls, <span class="built_in">this</span>);</span><br><span class="line">                <span class="comment">// æ£€æŸ¥ registry url æ˜¯å¦åŒ…å«å¿…è¦çš„å±æ€§</span></span><br><span class="line">                checkRegistryUrls(registryUrls);</span><br><span class="line">                <span class="comment">// è¿›è¡ŒçœŸæ­£çš„æœåŠ¡æ³¨å†Œ</span></span><br><span class="line">                registryService(registryUrls);</span><br><span class="line">            &#125;</span><br><span class="line">            published = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/77fcba48c4ee4aaf1678c0ba52d90d63.jpeg" width=700 /></div>

<center>registryUrlsçš„å†…å®¹</center>

<p>è¿™é‡Œé‡ç‚¹å…³æ³¨ç¬¬äºŒéƒ¨åˆ†è¿›è¡ŒçœŸæ­£çš„æœåŠ¡æ³¨å†Œæ–¹æ³• <code>registryService(registryUrls);</code>ï¼Œå®ƒæ ¹æœ¬æ˜¯è°ƒç”¨çš„ <code>AbstractRegistry#registry</code> æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¸»è¦å°±æ˜¯å®Œæˆäº†æœåŠ¡ç«¯å¯åŠ¨çš„ä¸‰ä¸ªæ ¸å¿ƒé€»è¾‘ï¼Œä»å…¶æ–¹æ³•åå°±å¯ä»¥çŸ¥é“äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registry</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Can&#x27;t publish a service for null url&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        openServer(url);</span><br><span class="line">        createInvoker(url);</span><br><span class="line">        doPublish(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;publish service failed&quot;</span>, e.getCause());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹ <code>openServer(url);</code> æ–¹æ³•ï¼Œå®ƒä¼šæ ¹æ® url ç¡®å®šå½“å‰ç»ˆç«¯æ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æ˜¯åˆ†æçš„æœåŠ¡ç«¯å¯åŠ¨ï¼Œæ‰€ä»¥èµ°çš„æ˜¯ä¸Šè¾¹é‚£æ¡é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">openServer</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> url.getOriginUrl().getParameterElseDefault(UrlConstants.SERVICE_PROTOCOL, UrlConstants.DEFAULT_SERVICE_PROTOCOL);</span><br><span class="line">    <span class="type">URL</span> <span class="variable">serviceUrl</span> <span class="operator">=</span> URL.copyFromUrl(url.getOriginUrl());</span><br><span class="line">    serviceUrl.setOriginUrl(url.getOriginUrl());</span><br><span class="line">    serviceUrl.setProtocol(protocol);</span><br><span class="line">    <span class="keyword">if</span> (url.isProvider()) &#123;</span><br><span class="line">        protocolSelector.publish(serviceUrl);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!url.isProvider()) &#123;</span><br><span class="line">        protocolSelector.subscribe(serviceUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•çš„å®ç°æ˜¯è¿™æ ·çš„ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å– server å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±æ–°å»ºä¸€ä¸ª server å®ä¾‹å¹¶è¿›è¡Œç¼“å­˜ï¼Œserver å®ä¾‹çš„åˆ›å»ºæ˜¯åœ¨ NettyTransporter#bind æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ª NettyServerï¼Œä¹Ÿå°±æ˜¯è¯´ beehive çš„åº•å±‚æ˜¯é‡‡ç”¨çš„ netty ä½œä¸ºé€šä¿¡æ¡†æ¶çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Server <span class="title function_">bind</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serverKey</span> <span class="operator">=</span> buildServerKey(url);</span><br><span class="line">    <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> serverCache.get(serverKey);</span><br><span class="line">    <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (serverCache) &#123;</span><br><span class="line">            <span class="keyword">if</span> (serverCache.get(serverKey) == <span class="literal">null</span>) &#123;</span><br><span class="line">                server = <span class="keyword">new</span> <span class="title class_">NettyServer</span>(url);</span><br><span class="line">                AbstractConfig.BeehiveShutdownHook.addEndPoint(server);</span><br><span class="line">                serverCache.putIfAbsent(serverKey, server);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> server;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çŸ¥é“ <code>openServer(url);</code> çš„å®ç°åï¼Œå†çœ‹ <code>createInvoker(url);</code> æ–¹æ³•ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªåˆ›å»ºæœåŠ¡æ¥å£ä»£ç†ç±»çš„è¿‡ç¨‹ï¼Œè€ƒè™‘åˆ°æ‹“å±•æ€§ï¼Œæ‰€ä»¥ beehive çš„å¤„ç†è¿‡ç¨‹è¿˜å°†åˆ›å»ºå‡ºæ¥çš„ä»£ç†è¿›è¡Œäº†å°è£…ï¼Œæœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ª Invoker é“¾ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹æ ¹æœ¬çš„ä»£ç†ç±»çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå®ƒçš„å®ç°æ˜¯åœ¨ <code>AbstractProxyFactory#createInvoker</code> æ–¹æ³•ä¸­ï¼Œé‡Œè¾¹æœ‰ä¸¤ä¸ªé€»è¾‘ï¼Œåˆ›å»ºåŸç”Ÿçš„ä»£ç†ç±»ï¼Œå’Œå°†ä»£ç†ç±»å°è£…æˆä¸º Invoker å®ç°ç±»ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿åè¾¹çš„ Invoker é“¾çš„æ„å»ºã€‚beehive æä¾›äº†ä¸¤ç§ä»£ç†ç±»ç”Ÿæˆçš„æ–¹å¼ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†è¯´æ˜ä»£ç†çš„é€»è¾‘ï¼Œæ‰€ä»¥é€‰æ‹©ç¨å¾®ç®€å•çš„ jdk åŸç”Ÿä»£ç†çš„æ–¹å¼è¿›è¡Œè¯´æ˜ï¼Œè€Œ javassist æ–¹å¼ç”Ÿæˆä»£ç†çš„è¿‡ç¨‹å¯ä»¥è‡ªè¡Œå‚è€ƒæºç ç†è§£ã€‚</p>
<p>jdk åŸç”Ÿä»£ç†ç±»ç”Ÿæˆçš„å…¥å£æ–¹æ³•ä¸º <code>JdkProxyFactory#createProxy</code>ï¼Œæˆ‘ä»¬æ˜¯æœåŠ¡ç«¯ä»£ç†ç±»ç”Ÿæˆï¼Œèµ°ä¸Šä¸€ä¸ªåˆ†æ”¯ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ ¹æœ¬æ˜¯è°ƒç”¨çš„ <code>ProviderProxy.getJdkProxy(target, clazz, Proxy.class);</code> æ–¹æ³•ï¼Œå…¶ä¸­ target å°±æ˜¯æˆ‘ä»¬åœ¨ spring é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æœåŠ¡æ¥å£çš„å®ç°ç±»ï¼Œclass æ˜¯æœåŠ¡æ¥å£å¯¹åº”çš„ classï¼Œè€Œ Proxy.class åˆ™æ˜¯è¿”å›çš„æ¥å£ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯å®ç°äº†ä¸¤ä¸ªæ¥å£çš„ï¼ŒæœåŠ¡æ¥å£å’Œ Proxy æ¥å£ï¼Œä¸”è¿”å›çš„è¡¨ç°å½¢å¼æ˜¯ Proxyã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Proxy <span class="title function_">createProxy</span><span class="params">(Class&lt;?&gt; clazz, URL url)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url.isProvider()) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ® url ä¿¡æ¯è·å– invoke target å®ä¾‹</span></span><br><span class="line">        <span class="type">ServiceConfigBean</span> <span class="variable">serviceConfigBean</span> <span class="operator">=</span> BeehiveContext.unsafeGet(UrlConstants.PROVIDER_MODEL, ServiceConfigBean.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> serviceConfigBean.getRef();</span><br><span class="line">        <span class="keyword">return</span> ProviderProxy.getJdkProxy(target, clazz, Proxy.class);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Invoker</span> <span class="variable">invoker</span> <span class="operator">=</span> getInvoker(url);</span><br><span class="line">        <span class="keyword">return</span> ConsumerProxy.getJdkProxy(<span class="keyword">new</span> <span class="title class_">InvokerInvocationHandler</span>(invoker, url), clazz, Proxy.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çŸ¥é“è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬å†ç›´æ¥çœ‹ jdk ä»£ç†ç±»çš„æ„å»ºç»†èŠ‚ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹ä»£ç æ‰€ç¤ºçš„é‚£æ ·ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç†çš„é€»è¾‘æ˜¯ç”± ProviderInvocationHandler æŒ‡å®šçš„ï¼Œå®ƒæŒæœ‰äº†æˆ‘ä»¬åœ¨ spring é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æœåŠ¡æ¥å£çš„å®ç°ç±»ï¼Œå½“ä»£ç†ç±»éœ€è¦æ‰§è¡ŒæŸä¸ªæ–¹æ³•æ—¶ï¼ŒçœŸæ­£è°ƒç”¨çš„å…¶å®æ˜¯æœåŠ¡æ¥å£å®ç°ç±»çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ›å»º jdk ä»£ç†ç±»</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> classes</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Proxy <span class="title function_">getJdkProxy</span><span class="params">(Object target, Class&lt;?&gt;... classes)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (classes.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Can&#x27;t create jdk proxy for none of interface has specified&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> classes[<span class="number">0</span>].getClassLoader();</span><br><span class="line">    <span class="type">ProviderInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderInvocationHandler</span>(target);</span><br><span class="line">    <span class="keyword">return</span> (Proxy) java.lang.reflect.Proxy.newProxyInstance(classLoader, classes, handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * provider çš„ jdk invocation handler</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ProviderInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProviderInvocationHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›çš„ jdk ä»£ç†æ˜¯æ˜¯è¢«å°è£…æˆäº† ProxyWrapperInvokerï¼Œbeehive æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®è¯¥ invoker æ„å»º invoker é“¾ï¼Œè‡³äº invoker é“¾çš„å…¶ä»–èŠ‚ç‚¹ï¼Œåˆ™æ˜¯é€šè¿‡ spi æ‹“å±•æœºåˆ¶æ¥æŒ‡å®šçš„ï¼Œä½†æ˜¯å…³äº invoker é€»è¾‘åŠŸèƒ½ï¼Œæˆ‘æš‚æ—¶æ˜¯åšçš„ç©ºå®ç°ï¼Œæ‰€ä»¥é‡‡ç”¨çš„æ˜¯ç¡¬ç¼–ç çš„æ–¹å¼ï¼Œå¦‚æœä»¥åæœ‰æ–°çš„éœ€æ±‚äº†ï¼Œå°±ä¼šè€ƒè™‘å°†å…¶å®ç°æ”¹ä¸ºé€‚é… spi æ‹“å±•ï¼Œå…³ä¹ invoker é“¾ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼Œå…·ä½“çš„æ„å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é€šè¿‡ filter æ„å»º invoker é“¾ï¼Œæœ€åä¸€ä¸ª invoker å°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ ProxyWrapperInvokerï¼Œå®ƒå°è£…äº†æˆ‘ä»¬çœŸæ­£çš„è°ƒç”¨é€»è¾‘</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> invoker åŸå§‹çš„ invoker</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> é€šè¿‡ filter æ„å»ºå‡ºæ¥çš„ invoker é“¾</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Invoker <span class="title function_">buildInvokerChain</span><span class="params">(Invoker&lt;?&gt; invoker)</span> &#123;</span><br><span class="line">    <span class="comment">// TODO è¿™é‡Œçš„ filter è·å–åº”è¯¥é€šè¿‡ ExtensionLoader</span></span><br><span class="line">    List&lt;Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    filters.add(<span class="keyword">new</span> <span class="title class_">AccessLogFilter</span>());</span><br><span class="line">    filters.add(<span class="keyword">new</span> <span class="title class_">MonitorFilter</span>());</span><br><span class="line">    <span class="type">Invoker</span> <span class="variable">ptr</span> <span class="operator">=</span> invoker;</span><br><span class="line">    <span class="keyword">if</span> (filters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Filter filter : filters) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Invoker</span> <span class="variable">next</span> <span class="operator">=</span> ptr;</span><br><span class="line">            <span class="type">Invoker</span> <span class="variable">pre</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AbstractInvoker</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> Object <span class="title function_">doInvoke</span><span class="params">(InvokeInfo info)</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> filter.doFilter(next, info);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            ptr = pre;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//noinspection unchecked</span></span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å°è£…æˆ‘ä»¬ä»£ç†ç±»çš„ ProxyWrapperInvoker èŠ‚ç‚¹ä½äº invoker é“¾çš„æœ«å°¾ï¼Œè€Œæœ€ç»ˆè¿”å›çš„æ˜¯ invoker é“¾çš„å¤´ç»“ç‚¹ï¼Œè¿™æ ·åœ¨è¿›è¡Œé€»è¾‘è°ƒç”¨æ—¶ï¼Œå°±ä¼šå…ˆæ‰§è¡Œæ‹“å±•é€»è¾‘ï¼Œæœ€åå†æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç†é€»è¾‘ã€‚</p>
<p>æœ€åä¸€ä¸ªå°±æ˜¯ <code>doPublish(url);</code> æ–¹æ³•ï¼Œå®ƒåšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯å‘æ³¨å†Œä¸­å¿ƒä¹Ÿå°±æ˜¯ zookeeper ä¸­å†™å…¥å½“å‰å‘å¸ƒçš„æœåŠ¡çš„ç›¸å…³ä¿¡æ¯ï¼Œè¿™é‡Œçš„ zookeeper å®¢æˆ·ç«¯ä½¿ç”¨çš„ curator æ¡†æ¶ï¼Œå…·ä½“çš„è¿‡ç¨‹å¾ˆç®€å•ï¼Œè¿™é‡Œåªç»™å‡ºå†™å…¥æœåŠ¡ä¿¡æ¯åçš„ç»“æœã€‚</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/e910e07480c308a547a32e3deb9ce2d2.jpeg" width=600 /></div>

<center>zookeeper ä¸­å†™å…¥çš„æœåŠ¡ä¿¡æ¯</center>

<p>æ‰§è¡Œåˆ°è¿™é‡Œï¼ŒæœåŠ¡ç«¯çš„å¯åŠ¨è®¡ç®—å®Œæˆäº†ï¼Œè¿™ä¸ªå¯åŠ¨è¿‡ç¨‹ä¸»è¦å°±æ˜¯åšäº†ä¸‰ä»¶äº‹æƒ…ï¼Œå¯åŠ¨æ•°æ®äº¤äº’çš„æœåŠ¡ç»ˆç«¯ï¼Œåˆ›å»ºé€»è¾‘è°ƒç”¨çš„ä»£ç†ç±»ï¼Œå°†å…¶å°è£…ä¸º Invoker é“¾ï¼Œä¹‹åå°±æ˜¯å‘æ³¨å†Œä¸­å¿ƒå‘å¸ƒæœåŠ¡ï¼Œæ¥ä¸‹æ¥ç»§ç»­è¯»å®¢æˆ·ç«¯çš„å¯åŠ¨è¿›è¡Œè¯´æ˜ã€‚</p>
<h3 id="å®¢æˆ·ç«¯å¯åŠ¨"><a href="#å®¢æˆ·ç«¯å¯åŠ¨" class="headerlink" title="å®¢æˆ·ç«¯å¯åŠ¨"></a>å®¢æˆ·ç«¯å¯åŠ¨</h3><p>åœ¨äº†è§£è¿‡æœåŠ¡ç«¯çš„å¯åŠ¨ä¹‹åï¼Œå†çœ‹å®¢æˆ·ç«¯çš„å¯åŠ¨æµç¨‹å°±ä¼šå¾ˆç®€å•ï¼Œè·Ÿå®¢æˆ·ç«¯ä¸€æ ·ï¼Œå®ƒä¸»è¦ä¹Ÿæ˜¯å®ç°äº†ä¸‰ä¸ªé€»è¾‘ï¼Œåœ¨è¿™ä¸‰ä¸ªé€»è¾‘ä¸­ï¼Œå°±åªæœ‰ä»£ç†ç±»çš„åˆ›å»ºæ¯”è¾ƒå¤æ‚ï¼Œè€Œåœ¨æ•°æ®äº¤äº’çš„ç»ˆç«¯åˆ›å»ºå’Œæ¶ˆè´¹è€…ä¿¡æ¯æ³¨å†Œæ–¹é¢ï¼Œè¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦å°±æ˜¯å¯¹ä»£ç†ç±»çš„åˆ›å»ºæ–¹å¼è¿›è¡Œè¯´æ˜ã€‚</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/1abf28803db922098c76f7502c068ada.jpeg" width=600 /></div>

<center>å®¢æˆ·ç«¯å¯åŠ¨æ ¸å¿ƒé€»è¾‘</center>

<p>é¦–å…ˆè¿˜æ˜¯çœ‹å’ŒæœåŠ¡è°ƒç”¨ç›¸å…³çš„æ ‡ç­¾ &lt;beehive:reference&#x2F;&gt; å¯¹åº”çš„ beanï¼ˆServiceConsumerï¼‰æ‰€å®ç°çš„æ¥å£ï¼Œç›¸æ¯”äºæœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯å®ç°çš„æ¥å£å°±åªæœ‰ä¸€ä¸ª FactoryBeanï¼Œå®ƒæŒ‡å®šäº†ä¸‰ä¸ªæ–¹æ³•ï¼Œæ ¹æ® spring çš„å®ç°è§„åˆ™ï¼ŒçŸ¥é“åœ¨è·å–å®ç° FactoryBean æ¥å£çš„ bean æ—¶ï¼Œå®ƒå®é™…è¿”å›çš„æ˜¯ <code>getObject()</code> æ–¹æ³•è¿”å›çš„å®ä¾‹ã€‚æ ¹æ®è¿™ä¸ªç‰¹æ€§ï¼Œæ‰€ä»¥ beehive å®¢æˆ·ç«¯çš„æœåŠ¡æ¥å£ä»£ç†ç±»å°±æ˜¯é€šè¿‡è¯¥æ–¹æ³•è¿”å›çš„ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line">	T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">	Class&lt;?&gt; getObjectType();</span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getObject()</code> æ–¹æ³•å’ŒæœåŠ¡ç«¯çš„ <code>ServiceProvider#onApplicationEvent</code> æ–¹æ³•å¾ˆç›¸ä¼¼ï¼Œåˆ†ä¸ºå‡†å¤‡ registryUrls ä¿¡æ¯å’Œè®¢é˜… registryUrl ä¸¤éƒ¨åˆ†ï¼ˆå®¢æˆ·ç«¯çš„è®¢é˜…å’ŒæœåŠ¡ç«¯çš„å‘å¸ƒç›¸å¯¹åº”ï¼‰ï¼Œå‡†å¤‡ registryUrls ä¿¡æ¯çš„è¿‡ç¨‹å°±æ˜¯ä¸ªç®€å•ä½†æ˜¯æ¯”è¾ƒç¹ççš„è¿‡ç¨‹ï¼Œå¯ä»¥è‡ªè¡Œçœ‹æºç äº†è§£ï¼Œè€Œè®¢é˜… registryUrl çš„é€»è¾‘æ ¹æœ¬å°±æ˜¯è°ƒç”¨çš„ <code>AbstractRegistry#registry</code> æ–¹æ³•ï¼Œå®ƒè·ŸæœåŠ¡ç«¯è°ƒç”¨çš„æ˜¯åŒæ ·çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registry</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Can&#x27;t publish a service for null url&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        openServer(url);</span><br><span class="line">        createInvoker(url);</span><br><span class="line">        doPublish(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;publish service failed&quot;</span>, e.getCause());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å®¢æˆ·ç«¯å¯åŠ¨åšçš„ä¸‰ä¸ªæ ¸å¿ƒé€»è¾‘å’ŒæœåŠ¡ç«¯æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å…·ä½“çš„å®ç°ä¸ä¸€æ ·ï¼Œå…ˆçœ‹ <code>openServer(url);</code>ï¼Œå®ƒæ ¹æœ¬æ˜¯è°ƒç”¨çš„ <code>NettyTransporter#connect</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬åˆ›å»ºçš„æ˜¯ NettyClientï¼Œè¿™å’ŒæœåŠ¡ç«¯çš„ NettyServer å¯¹åº”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Client <span class="title function_">connect</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    <span class="type">NettyClient</span> <span class="variable">nettyClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyClient</span>(url);</span><br><span class="line">    AbstractConfig.BeehiveShutdownHook.addEndPoint(nettyClient);</span><br><span class="line">    <span class="keyword">return</span> nettyClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹ <code>createInvoker(url);</code> æ–¹æ³•çš„å®ç°ï¼Œæˆ‘ä»¬è¿™é‡Œå¯åŠ¨å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥èµ°çš„æ˜¯ else åˆ†æ”¯ï¼Œé¦–å…ˆä»£ç æ˜¯ä» zookeeper æ³¨å†Œä¸­å¿ƒä¸­è·å–å·²ç»å‘å¸ƒçš„æœåŠ¡ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯æ‰€å‘å¸ƒçš„æœåŠ¡ä¿¡æ¯ã€‚æ¥ç€è°ƒç”¨ <code>ZookeeperRegistry#addProviderRefreshListener</code> æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ curator æ¡†æ¶å‘ zookeeper æ³¨å†Œäº†ä¸€ä¸ªç›‘å¬å™¨ï¼Œå®ƒä¼šç›‘å¬æœåŠ¡ä¸Šä¸‹çº¿çš„ä¿¡æ¯ï¼Œä»¥æ­¤æ¥è¾¾åˆ°æ›´æ–° provider åˆ—è¡¨çš„ç›®çš„ï¼Œå…³é”®çš„ä»£ç å¦‚ä¸‹ï¼Œæ·»åŠ çš„ listener ä¸º ProviderRefreshListenerï¼Œå¯ä»¥çœ‹åˆ°å®ƒç›‘å¬ CHILD_ADDEDã€CHILD_REMOVEDã€CHILD_UPDATED ä¸‰ç§äº‹ä»¶ï¼Œæ‰€ä½œå‡ºçš„åŠ¨ä½œæ˜¯ <code>BeehiveContext.unsafePut(PROVIDERS, providerUrls);</code> æ›´æ–° provider åˆ—è¡¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¸º consumer æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ï¼Œç”¨äºç›‘æµ‹ provider æ›´æ–°æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> providerPath</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addProviderRefreshListener</span><span class="params">(String providerPath)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">PathChildrenCache</span> <span class="variable">pathCache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathChildrenCache</span>(zkClient, providerPath, <span class="literal">true</span>);</span><br><span class="line">        pathCache.start();</span><br><span class="line">        pathCache.getListenable().addListener(<span class="keyword">new</span> <span class="title class_">ProviderRefreshListener</span>(pathCache));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Add provider refresh listener failed, the target path was &quot;</span> + providerPath + <span class="string">&quot;, the curator client was &quot;</span> + zkClient);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è¯¥ listener ç”¨äºåˆ·æ–° provider ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ProviderRefreshListener</span> <span class="keyword">implements</span> <span class="title class_">PathChildrenCacheListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PathChildrenCache pathCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProviderRefreshListener</span><span class="params">(PathChildrenCache pathCache)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pathCache = pathCache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">childEvent</span><span class="params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        PathChildrenCacheEvent.<span class="type">Type</span> <span class="variable">eventType</span> <span class="operator">=</span> event.getType();</span><br><span class="line">        <span class="comment">// å¦‚æœ child ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼Œè¿›è¡Œæ›´æ–°</span></span><br><span class="line">        <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">            <span class="keyword">case</span> CHILD_ADDED:</span><br><span class="line">            <span class="keyword">case</span> CHILD_REMOVED:</span><br><span class="line">            <span class="keyword">case</span> CHILD_UPDATED: &#123;</span><br><span class="line">                List&lt;ChildData&gt; currentData = pathCache.getCurrentData();</span><br><span class="line">                List&lt;String&gt; providerUrls = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(currentData.size());</span><br><span class="line">                <span class="keyword">for</span> (ChildData data : currentData) &#123;</span><br><span class="line">                    providerUrls.add(data.getPath());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è¿™é‡Œæ˜¯ä¿å­˜åˆ° concurrent hash map ä¸­ï¼Œèƒ½å¤Ÿä¿è¯å¯è§æ€§</span></span><br><span class="line">                BeehiveContext.unsafePut(PROVIDERS, providerUrls);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å°±æ˜¯åˆ›å»ºæœåŠ¡æ¥å£çš„å®¢æˆ·ç«¯ä»£ç†ï¼Œè¿™é‡Œä»¥ jdk çš„å®¢æˆ·ç«¯ä»£ç†è¿›è¡Œè¯´æ˜ï¼Œè¿˜è®°å¾—åœ¨æœåŠ¡ç«¯åˆ›å»º jdk ä»£ç†æ—¶æœ‰è·å–ä¸€ä¸ªä»£ç† target å®ä¾‹å—ï¼Ÿå®ƒå°±æ˜¯æœåŠ¡æ¥å£çš„å®ç°ç±»ï¼Œå®Œæˆäº†å…·ä½“ææœåŠ¡é€»è¾‘ã€‚ä½†ç°åœ¨æˆ‘ä»¬æ˜¯åœ¨åˆ›å»ºå®¢æˆ·ç«¯çš„ä»£ç†ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ä»£ç† target å®ä¾‹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¯ä»¥å…ˆè¯•æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬å®¢æˆ·ç«¯åœ¨è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ï¼Œä»£ç†ç±»åº”è¯¥å®Œæˆå•¥æ ·çš„é€»è¾‘å‘¢ï¼Ÿ</p>
<p>beehive è¿™é‡Œçš„å®ç°å…¶å®å°±æ˜¯å°†è¢«è°ƒç”¨çš„æ¥å£æ–¹æ³•å’Œå‚æ•°ç›¸å…³ä¿¡æ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å†æ ¹æ®æ”¶åˆ°çš„æ–¹æ³•åŠå‚æ•°ä¿¡æ¯å®ŒæˆçœŸæ­£çš„æœåŠ¡æ¥å£å®ç°ç±»çš„é€»è¾‘è°ƒç”¨ï¼Œæœ€ç»ˆå†å°†å¤„ç†çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ä»£ç†ï¼Œæœ€ç»ˆä»£ç†å°†ç»“æœè¿”å›ç»™æ–¹æ³•è°ƒç”¨è€…ï¼Œå®Œæˆè¿™ä¸ªå‘é€æ–¹æ³•åŠå‚æ•°ä¿¡æ¯ç»™æœåŠ¡ç«¯çš„ç±»å°±æ˜¯è¿™é‡Œåº”è¯¥æ‹¿åˆ°çš„ target å®ä¾‹ï¼Œé€šè¿‡ debugï¼Œå¯ä»¥çŸ¥é“è¿™ä¸ªå®ä¾‹å…¶å®å°±æ˜¯ FailoverClusterInvokerã€‚å®ƒé‡Œè¾¹çš„å®ç°é€»è¾‘ä¸æ˜¯è¿™é‡Œåº”è¯¥å…³æ³¨çš„ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œå®¢æˆ·ç«¯çš„æœåŠ¡æ¥å£ä»£ç†æ ¹æœ¬æ˜¯è°ƒç”¨çš„ FailoverClusterInvoker å®ä¾‹çš„æ–¹æ³•ã€‚çŸ¥é“è¿™ä¸ªåï¼Œjdk ä»£ç†ç±»çš„åˆ›å»ºå°±è·ŸæœåŠ¡ç«¯ä¸€æ ·äº†ï¼Œå…·ä½“åˆ°ä»£ç å°±æ˜¯ä¸‹è¾¹è¿™ä¸€æ®µï¼Œ<code>getInvoker(url)</code> æ‹¿åˆ°çš„æ˜¯ FailoverClusterInvokerï¼Œå®ƒå°†è¢«ä½œä¸º target è€Œåˆ›å»ºæœåŠ¡ç«¯æ¥å£ä»£ç†ç±»ã€‚</p>
<blockquote>
<p>top.aprilyolies.beehive.proxy.JdkProxyFactory#createProxy</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Invoker</span> <span class="variable">invoker</span> <span class="operator">=</span> getInvoker(url);</span><br><span class="line"><span class="keyword">return</span> ConsumerProxy.getJdkProxy(<span class="keyword">new</span> <span class="title class_">InvokerInvocationHandler</span>(invoker, url), clazz, Proxy.class);</span><br></pre></td></tr></table></figure>

<p>å®Œæˆå®¢æˆ·ç«¯æœåŠ¡æ¥å£ä»£ç†ç±»åˆ›å»ºçš„è¯´æ˜ï¼Œå°±åªå‰©ä¸‹ <code>doPublish(url);</code>ï¼Œè·ŸæœåŠ¡ç«¯ä¸€æ ·å°±æ˜¯å‘æ³¨å†Œä¸­å¿ƒå†™å…¥è‡ªèº«çš„ä¿¡æ¯ï¼Œä½¿ç”¨çš„æ˜¯ curator æ¡†æ¶ï¼Œè¿‡ç¨‹å¾ˆç®€å•ï¼Œä¸åšç»†è¯´ï¼Œåªç»™å‡ºå†™å…¥çš„ç»“æœã€‚</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/b9de1788fb5447654e1b20191505ba8b.jpeg" width=600 /></div>

<center>zookeeper ä¸­å†™å…¥çš„æ¶ˆè´¹è€…ä¿¡æ¯</center>

<h3 id="å®¢æˆ·ç«¯-RPC-è¯·æ±‚æµç¨‹"><a href="#å®¢æˆ·ç«¯-RPC-è¯·æ±‚æµç¨‹" class="headerlink" title="å®¢æˆ·ç«¯ RPC è¯·æ±‚æµç¨‹"></a>å®¢æˆ·ç«¯ RPC è¯·æ±‚æµç¨‹</h3><p>å½“å®Œæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å¯åŠ¨åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è¿›è¡Œ rpc è¯·æ±‚äº†ï¼Œè¿˜è®°çš„ä¸Šæ–‡æŒ‡å‡ºçš„ FailoverClusterInvoker å®ä¾‹å—ï¼Ÿå®ƒæ˜¯å®¢æˆ·ç«¯ä»£ç†ç±»çœŸæ­£é€»è¾‘çš„èµ·ç‚¹ã€‚ä»ç±»åå¯ä»¥çŸ¥é“å®ƒæ˜¯ä¸€ä¸ª Invoker ç±»ï¼Œè‡ªç„¶æ˜¯å®ç°äº† Invoker æ¥å£ï¼Œè¿™æ ·æˆ‘ä»¬å…³æ³¨çš„ä¹Ÿå°±æ˜¯è¯¥æ¥å£å¯¹åº”çš„ <code>Invoker#invoke</code> æ–¹æ³•ï¼Œå®ƒçš„å®ç°æ˜¯åœ¨çˆ¶ç±» AbstractInvoker ä¹‹ä¸­ï¼Œè¯¥æ–¹æ³•åˆæ˜¯è°ƒç”¨äº† <code>AbstractInvoker#doInvoke</code> æ–¹æ³•ï¼Œå­ç±»è´Ÿè´£å®ç°è¯¥æ–¹æ³•çš„é€»è¾‘ï¼Œè¿™é‡Œæ˜¯å…¸å‹çš„æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ã€‚</p>
<p>æˆ‘å…ˆæŠŠ <code>FailoverClusterInvoker#doInvoke</code> æ–¹æ³•è´´å‡ºæ¥ï¼Œç¬¬ä¸€ä¸ª if åˆ¤æ–­å®ç°çœ‹çœ‹ç¼“å­˜ä¸­æ˜¯å¦æœ‰ invokers ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šæ‰§è¡Œ listInvokers æ–¹æ³•æ¥åˆ—å‡ºå¯ç”¨çš„ invokersã€‚</p>
<blockquote>
<p>top.aprilyolies.beehive.invoker.FailoverClusterInvoker#doInvoke</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doInvoke</span><span class="params">(InvokeInfo info)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.invokers == <span class="literal">null</span> || registry == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (invokers == <span class="literal">null</span> || registry == <span class="literal">null</span>) &#123;</span><br><span class="line">                    invokers = listInvokers();</span><br><span class="line">                    <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> BeehiveContext.unsafeGet(REGISTRIES, Registry.class);</span><br><span class="line">                    addInvokersRefreshListener(<span class="built_in">this</span>.registry);</span><br><span class="line">                    <span class="built_in">this</span>.registry = registry;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (needUpdateInvokers) &#123;</span><br><span class="line">            updateInvokers();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">reInvokeCount</span> <span class="operator">=</span> retryCountThreadLocal.get();</span><br><span class="line">        <span class="type">LoadBalance</span> <span class="variable">loadBalance</span> <span class="operator">=</span> loadBalanceThreadLocal.get();</span><br><span class="line">        <span class="keyword">if</span> (loadBalance == <span class="literal">null</span>) &#123;</span><br><span class="line">            loadBalance = createLoadBalance(url);</span><br><span class="line">            loadBalanceThreadLocal.set(loadBalance);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€‰æ‹©åˆé€‚çš„ invoker</span></span><br><span class="line">        Invoker&lt;T&gt; invoker = selectInvoker(loadBalance, invokers);</span><br><span class="line">        <span class="keyword">if</span> (invoker != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Invoker</span> <span class="variable">chain</span> <span class="operator">=</span> buildInvokerChain(invoker);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> chain.invoke(info);</span><br><span class="line">            <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è¾…åŠ©åˆ·æ–° invokers</span></span><br><span class="line">                needUpdateInvokers = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// è¿”å›ç»“æœä¸ºç©ºè¿›è¡Œé‡è¯•</span></span><br><span class="line">                <span class="keyword">if</span> (reInvokeCount++ &lt; MAX_REINVOKE_TIMES) &#123;</span><br><span class="line">                    retryCountThreadLocal.set(reInvokeCount);</span><br><span class="line">                    <span class="keyword">return</span> doInvoke(info);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// é‡è¯•è¾¾åˆ°ä¸Šé™ï¼Œç›´æ¥è¿”å› null ç»“æœ</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Do invoke &quot;</span> + MAX_REINVOKE_TIMES + <span class="string">&quot; times, but the result was still null&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;There is none of service provider could be use, please check your &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;registry center that if there is any service has published.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        retryCountThreadLocal.set(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸‹å°±æ˜¯åˆ—å‡ºå¯ç”¨ invokers ä¿¡æ¯çš„æ–¹æ³•ï¼Œé¦–å…ˆæ˜¯æ‹¿åˆ°æ³¨å†Œä¸­å¿ƒä¸Šå‘å¸ƒçš„æœåŠ¡ä¿¡æ¯çš„é›†åˆï¼Œåœ¨æœåŠ¡ç«¯å¯åŠ¨æ—¶ï¼Œä¼šé¦–å…ˆè·å–ä¸€æ¬¡è¯¥é›†åˆå¹¶ç¼“å­˜åˆ° BeehiveContext ä¸­ï¼Œå¦‚æœåç»­å‘ç”Ÿäº†æœåŠ¡ä¿¡æ¯çš„æ›´æ–°å³æœåŠ¡çš„ä¸Šä¸‹çº¿ç­‰ï¼Œå®¢æˆ·ç«¯å¯åŠ¨æ—¶æ³¨å†Œçš„ç›‘å¬å™¨ä¼šä¾¦æµ‹è¯¥å˜åŒ–ï¼Œå¹¶åˆ·æ–°æœåŠ¡ä¿¡æ¯é›†åˆã€‚æ¥ç€å°±æ˜¯è¿‡æ»¤è¿™äº›æœåŠ¡ä¿¡æ¯ï¼Œå› ä¸ºå³ä¾¿æ˜¯ç›¸åŒçš„æœåŠ¡ï¼Œå¯èƒ½ä¼šç”±äºå‘å¸ƒæœåŠ¡æ—¶ä½¿ç”¨çš„ç¼–è§£ç æ–¹å¼ä¸å®¢æˆ·ç«¯ä½¿ç”¨çš„ç¼–è§£ç æ–¹å¼ä¸ä¸€è‡´å¯¼è‡´æœåŠ¡ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œè¿™æ ·è¯¥æœåŠ¡ä¹Ÿå°±åº”è¯¥è¢«è¿‡æ»¤æ‰ã€‚è¿‡æ»¤çš„æ¡ä»¶å¯ä»¥æ›´åŠ ç»†åŒ–ï¼Œå¦‚æœä½ æœ‰å¥½çš„å»ºè®®ä¹Ÿå¯ä»¥æäº¤ PRï¼Œæˆ‘çœ‹åˆ°åä¼šè¿›è¡Œå¤„ç†ã€‚å®ŒæˆæœåŠ¡ä¿¡æ¯çš„è¿‡æ»¤åæ¥ç€å°±æ˜¯è·å–å½“å‰æœåŠ¡å¯¹åº”çš„é€šä¿¡ç»ˆç«¯ï¼Œæœ€åå°†è·å–çš„æœåŠ¡ä¿¡æ¯å’Œé€šä¿¡ç»ˆç«¯æ„å»ºä¸º RemoteInvoker è¿”å›ã€‚</p>
<blockquote>
<p>top.aprilyolies.beehive.invoker.FailoverClusterInvoker#listInvokers</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> List&lt;Invoker&lt;T&gt;&gt; <span class="title function_">listInvokers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//noinspection unchecked</span></span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; providersMap = BeehiveContext.unsafeGet(UrlConstants.PROVIDERS, Map.class);</span><br><span class="line">    List&lt;String&gt; providers = providersMap.get(url.getParameter(UrlConstants.SERVICE));</span><br><span class="line">    providers = filterProviders(providers);</span><br><span class="line">    <span class="built_in">this</span>.providers = providers;</span><br><span class="line">    <span class="type">Client</span> <span class="variable">client</span> <span class="operator">=</span> BeehiveContext.unsafeGet(UrlConstants.CONSUMERS_TRANSPORT, Client.class);</span><br><span class="line">    <span class="keyword">assert</span> providers != <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> createRemoteInvoker(providers, client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FailoverClusterInvoker#doInvoke</code> çš„ç¬¬äºŒä¸ª if æ¡ä»¶æ˜¯åˆ¤æ–­æ˜¯å¦æœåŠ¡å‘ç”Ÿäº†æ›´æ–°ï¼Œå¦‚æœå‘ç”Ÿäº†æ›´æ–°å°±éœ€è¦åˆ·æ–° invokers åˆ—è¡¨ï¼Œåˆ·æ–°çš„è¿‡ç¨‹å’Œåˆ—å‡º invokers åˆ—è¡¨çš„é€»è¾‘ç›¸ä¼¼ï¼Œåªæ˜¯è¿™å…¶ä¸­æ¶‰åŠåˆ°ä¸€ä¸ªé›†åˆæ“ä½œï¼Œå³å‰”é™¤ä¸‹çº¿çš„æœåŠ¡ï¼Œæ–°å¢ä¸Šçº¿çš„æœåŠ¡ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªå·±çœ‹æºä»£ç ã€‚</p>
<p>æ¥ä¸‹æ¥çš„ä»£ç å°±æ˜¯ä»åˆ—å‡ºçš„ invokers åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ª invoker æ„å»º invoker é“¾ï¼Œç„¶åè¿›è¡Œ invoke è°ƒç”¨ï¼Œé€‰æ‹© invoker çš„è¿‡ç¨‹æˆ‘å°†å…¶æè¿°ä¸ºä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„è¿‡ç¨‹ï¼Œé»˜è®¤æä¾›äº†ä¸¤ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œéšæœºé€‰å–å’Œè½®è¯¢é€‰å–ï¼Œå…·ä½“çš„ç”± PollLoadBalance å’Œ RandomLoadBalance ä¸¤ä¸ªç±»æ¥è´Ÿè´£å®ç°ï¼Œä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œè´´å‡ºæ¥è‡ªè¡Œé˜…è¯»å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomLoadBalance</span> <span class="keyword">extends</span> <span class="title class_">AbstractLoadBalance</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Invoker&lt;T&gt; <span class="title function_">select</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (invokers == <span class="literal">null</span> || invokers.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> Math.abs(random.nextInt() % invokers.size());</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;There are &quot;</span> + invokers.size() + <span class="string">&quot; invokers, RandomLoadBalance choose the invoker with&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;index of &quot;</span> + idx);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> invokers.get(idx);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Got invoker failed, this may caused by some new provider was added, and the beehive&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; was refresh the invokers list&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PollLoadBalance</span> <span class="keyword">extends</span> <span class="title class_">AbstractLoadBalance</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Invoker&lt;T&gt; <span class="title function_">select</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> invokers.size();</span><br><span class="line">        <span class="keyword">if</span> (idx &gt;= size) &#123;</span><br><span class="line">            idx = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invokers.get(idx++);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FailoverClusterInvoker#selectInvoker</code> æ–¹æ³•å°±æ˜¯é€šè¿‡ä¸Šè¿°çš„ä¸¤ä¸ªè´Ÿè½½å‡è¡¡å™¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ invoker çš„æ–¹æ³•ï¼Œæ‹¿åˆ°è¿™ä¸ª invoker åå°±æ˜¯æ„å»º invoker é“¾ï¼Œè¿™ä¸ªè¿‡ç¨‹å’ŒæœåŠ¡ç«¯å¯åŠ¨çš„ invoker é“¾æ„å»ºè¿‡ç¨‹ä¸€æ ·ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚æ¥ç€å°±æ˜¯è°ƒç”¨ invoker é“¾çš„ invoke æ–¹æ³•ï¼Œæ ¹æ®ä¹‹å‰çš„åˆ†ææˆ‘ä»¬çŸ¥é“ invoker é“¾çš„å°¾èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬é€šè¿‡è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©å‡ºæ¥çš„é‚£ä¸ª invokerï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ <code>FailoverClusterInvoker#listInvokers</code> æ–¹æ³•ä¸­åˆ—å‡ºçš„ä¼—å¤š invokers ä¸­çš„ä¸€ä¸ªï¼Œä»–ä»¬éƒ½æ˜¯ RemoteInvoker å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æè¯¥ invoker çš„ invoke æ–¹æ³•ã€‚</p>
<p>åŒæ ·çš„ RemoteInvoker æ˜¯ç»§æ‰¿è‡ª AbstractInvoker çˆ¶ç±»ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯ doInvoke æ–¹æ³•çš„å®ç°ã€‚è¿™é‡Œè¿˜æ˜¯å…ˆæŠŠä»£ç è´´å‡ºæ¥ï¼Œè€ƒè™‘åˆ°ç¯‡å¹…é—®é¢˜ï¼Œæˆ‘è¿™é‡Œå‰ƒæ‰äº†éƒ¨åˆ†ç©ºæŒ‡é’ˆåˆ¤æ–­æ¡ä»¶å’Œå¤±è´¥é‡è¯•ä»£ç ï¼Œåªç•™ä¸‹äº†æ ¸å¿ƒä»£ç ã€‚ç®€åŒ–åçš„ä»£ç å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°æ ¸å¿ƒé€»è¾‘å°±ä¸‰ä¸ªï¼Œè¿æ¥æœåŠ¡ç«¯ï¼Œå‘é€ rpc è¯·æ±‚ä¿¡æ¯ï¼Œè·å–å“åº”ç»“æœã€‚è¿æ¥æœåŠ¡ç«¯å’Œå‘é€ rpc è¯·æ±‚å’Œ netty çš„ä½¿ç”¨æœ‰å…³ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ netty éœ€è¦å…ˆè‡ªè¡Œäº†è§£ netty çš„ä½¿ç”¨ï¼Œæœ¬æ–‡è¿™é‡Œä¸ç»†è¿°ã€‚è€Œè¿™é‡Œè·å–å“åº”çš„ç»“æœæ˜¯é‡‡ç”¨çš„å¼‚æ­¥çš„æ–¹å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doInvoke</span><span class="params">(InvokeInfo info)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ channelMap</span></span><br><span class="line">        Map&lt;String, Channel&gt; channelMap = addressChannel.get();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">ch</span> <span class="operator">=</span> channelMap.get(channelKey);</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="literal">null</span> || !ch.isOpen() || !ch.isActive()) &#123;</span><br><span class="line">            <span class="comment">// è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">            ch = connectServer();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ„å»º request æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> buildRequest(info);</span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">        ch.writeAndFlush(request);</span><br><span class="line">        <span class="comment">// è·å–å¼‚æ­¥çš„å“åº”ç»“æœ</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> getResponse(request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retryTimes</span> <span class="operator">=</span> <span class="built_in">this</span>.url.getParameter(UrlConstants.RETRY_TIMES);</span><br><span class="line">        <span class="type">int</span> <span class="variable">times</span> <span class="operator">=</span> RETRY_TIMES;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(retryTimes)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                times = Integer.parseInt(retryTimes);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·å– rpc ç»“æœçš„å…¥å£æ–¹æ³•æ˜¯ <code>RemoteInvoker#getResponse</code>,è¿™é‡Œéœ€è¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯æ¯ä¸€ä¸ª rpc è¯·æ±‚éƒ½æœ‰å®ƒæ‰€å”¯ä¸€å¯¹åº”çš„ id æ¥æ ‡å¿—ï¼Œrpc è¯·æ±‚ç»“æœçš„å¼‚æ­¥è·å–åˆ©ç”¨äº†è¿™ä¸ªç‰¹æ€§ã€‚è¿›è¡Œå½“å‰ rpc è¯·æ±‚çš„çº¿ç¨‹å°†æœ¬æ¬¡è¯·æ±‚çš„ id å’Œä¸€ä¸ª RpcResult å½¢æˆæ˜ å°„ç¼“å­˜åˆ° BeehiveContextï¼Œç„¶åå½“å‰çº¿ç¨‹è°ƒç”¨è¯¥ RpcResult çš„ get æ–¹æ³•æ¥è·å–ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä» BeehiveContext ä¸­è·å–å¼‚æ­¥çš„å“åº”ç»“æœ</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">getResponse</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°è¯·æ±‚çš„ idï¼Œç”¨äºå¼‚æ­¥è·å–å“åº”å†…å®¹</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sid</span> <span class="operator">=</span> String.valueOf(request.getId());</span><br><span class="line">    <span class="comment">// å­˜æ ¹è¯·æ±‚ç»“æœ</span></span><br><span class="line">    BeehiveContext.unsafePut(sid, <span class="keyword">new</span> <span class="title class_">RpcResult</span>());</span><br><span class="line">    <span class="comment">// å¼‚æ­¥è·å–ç›¸åº”ç»“æœ</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">res</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="built_in">this</span>.url.getParameter(UrlConstants.READ_TIMEOUT);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(timeout)) &#123;</span><br><span class="line">            res = BeehiveContext.unsafeGet(sid, RpcResult.class).get();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> Integer.parseInt(timeout);</span><br><span class="line">                res = BeehiveContext.unsafeGet(sid, RpcResult.class).get(time);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;The timeout parameter &quot;</span> + timeout + <span class="string">&quot; is wrong, use the default timeout 2000ms&quot;</span>);</span><br><span class="line">                res = BeehiveContext.unsafeGet(sid, RpcResult.class).get();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç§»é™¤ç¼“å­˜</span></span><br><span class="line">    BeehiveContext.unsafeRemove(sid);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹è¾¹åˆ—å‡ºäº† RpcResult çš„ get æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨äº† Condition æ¥å®Œæˆçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚å¦‚æœ rpc è¯·æ±‚è¿‡ç¨‹çš„å®Œæˆæ ‡å¿— finished ä¸º falseï¼Œè¿›è¡Œ get æ–¹æ³•çš„å½“å‰çº¿ç¨‹ä¼šè¿›è¡Œé™æ—¶é˜»å¡ã€‚å¦‚æœåœ¨é˜»å¡çš„è¿‡ç¨‹ä¸­ rpc è¿‡ç¨‹å®Œæˆï¼Œå½“å‰è¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ç»§ç»­ä¹‹å‰çš„é€»è¾‘ã€‚å¦‚æœå‘ç”Ÿè¶…æ—¶ï¼Œé‚£ä¹ˆä¹‹å‰çš„ä»£ç ä¼šæ ¹æ®æƒ…å†µè¿›è¡Œè¯·æ±‚çš„é‡è¯•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¸¦å»¶æ—¶çš„è·å–ç›¸åº”çš„ç»“æœ</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timeout å»¶æ—¶æ—¶é•¿</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> ç›¸åº”çš„ç»“æœ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (finished) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.msg;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">if</span> (!finished) &#123;</span><br><span class="line">                finishCondition.await(timeout, TimeUnit.MILLISECONDS);</span><br><span class="line">                <span class="keyword">if</span> (!finished) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Get result was timeout&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.msg;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Get result was interrupted&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Get result was interrupted&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¼‚æ­¥è·å– rpc è¯·æ±‚çš„ç»“æœçš„æ–¹å¼å°±æ˜¯è¿™æ ·ï¼Œè¿™é‡Œæœ‰ä¸ªç–‘é—®æ˜¯è°æ¥è´Ÿè´£å”¤é†’å½“å‰çš„é˜»å¡çº¿ç¨‹å‘¢ï¼Ÿè¿™ä¸ªå°±éœ€è¦ç‰µæ¶‰åˆ° netty çš„ channel handler å¯¹äº rpc ç»“æœçš„å¤„ç†äº†ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¦‚æœ rpc ç»“æœåœ¨æœ‰é™æ—¶é•¿å†…å®Œæˆï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ä¼šé¡ºåˆ©çš„è¿”å› rpc çš„ç»“æœï¼Œå¦‚æœè¶…æ—¶å°±ä¼šè¿›è¡Œé‡è¯•ï¼Œè€Œè´Ÿè´£å”¤é†’å½“å‰é˜»å¡çº¿ç¨‹çš„å…¶å®ƒçº¿ç¨‹æ˜¯è·Ÿ netty æœ‰å…³çš„ã€‚</p>
<h3 id="netty-é€šä¿¡å®¢æˆ·ç«¯"><a href="#netty-é€šä¿¡å®¢æˆ·ç«¯" class="headerlink" title="netty é€šä¿¡å®¢æˆ·ç«¯"></a>netty é€šä¿¡å®¢æˆ·ç«¯</h3><p>ä¸Šè¾¹è¯´åˆ°äº†è¿›è¡Œ rpc è¯·æ±‚çš„çº¿ç¨‹åœ¨é€šè¿‡ netty å‘é€ rpc ä¿¡æ¯åï¼Œè°ƒç”¨ get æ–¹æ³•ä¼šé˜»å¡åœ¨ rpc ç»“æœçš„è·å–æ–¹æ³•ä¸Šï¼Œè¿™éƒ¨åˆ†å³å¯¹ rpc ä¿¡æ¯çš„å‘é€ç¼–ç è¿‡ç¨‹è¿›è¡Œè¯´æ˜ï¼Œè¿™é‡Œéœ€è¦å…ˆæ˜ç¡® rpc çš„ä¿¡æ¯æ˜¯ç”± Request å®ä¾‹æ‰¿è½½çš„ï¼Œæˆ‘è¿™é‡Œé€šè¿‡ debug çš„æ–¹å¼ç»™å‡ºä¸€ä¸ª Request å®ä¾‹çš„æ ·ä¾‹ã€‚å¯ä»¥çœ‹åˆ°å…¶ä¸­å°±ä¸¤ä¸ªå­—æ®µï¼Œæ¶ˆæ¯çš„ç±»å‹å’Œ RPCINFOï¼Œé‡Œè¾¹åŒ…æ‹¬äº†è¯·æ±‚çš„æ–¹æ³•åã€å‚æ•°çš„ç±»å‹ã€å‚æ•°çš„å€¼ä»¥åŠæœåŠ¡çš„å…¨é™å®šåï¼Œé€šè¿‡è¿™å‡ é¡¹å€¼å°±å¯ä»¥å”¯ä¸€ç¡®å®šæœåŠ¡çš„å…·ä½“å®ç°äº†ã€‚</p>
<div style="text-align:center;"><img src="https://img.aprilyolies.top/img/typora/df15b2d51fdbe77b0cbc98a6b9870bd7.jpeg" width=600 /></div>

<center>Request å†…éƒ¨æ•°æ®å®ä¾‹</center>

<p>ä¸Šæ–‡åªæ˜¯è¯´äº† NettyClient çš„æ„å»ºï¼Œä½†æ˜¯å…·ä½“çš„å†…å®¹æ²¡æœ‰è¯´æ˜ï¼Œå…¶å®å…³äº netty å®¢æˆ·ç«¯çš„åˆ›å»ºï¼Œæˆ‘ä»¬éœ€è¦å…³å¿ƒçš„å°±æ˜¯ ChannelInitializer å¯¹äº NioSocketChannel çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ch.pipeline()<span class="comment">//.addLast(&quot;logging&quot;,new LoggingHandler(LogLevel.INFO))//for debug</span></span><br><span class="line">        .addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">NettyDecoderHandler</span>(getUrl()))   <span class="comment">// æŒ‡å®š decoder -&gt; InternalDecoder</span></span><br><span class="line">        .addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">NettyEncoderHandler</span>(getUrl()))   <span class="comment">// æŒ‡å®š encoder -&gt; InternalEncoder</span></span><br><span class="line">        <span class="comment">// è¯¥å¤„ç†å™¨ç”¨äºå‘æœåŠ¡å™¨å‘é€å¿ƒè·³æ¶ˆæ¯</span></span><br><span class="line">        .addLast(<span class="string">&quot;client-idle-handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(HEARTBEAT_INTERVAL, <span class="number">0</span>, <span class="number">0</span>, TimeUnit.MILLISECONDS))</span><br><span class="line">        .addLast(<span class="string">&quot;heartbeat-handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">HeartbeatHandler</span>())   <span class="comment">// è¯¥å¤„ç†å™¨ä¸»è¦æ˜¯å¯¹å¿ƒè·³æ¶ˆæ¯è¿›è¡Œå¤„ç†</span></span><br><span class="line">        .addLast(<span class="string">&quot;handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">ClientFinalChannelHandler</span>(getUrl()));    <span class="comment">// æœ€åçš„ handlerï¼Œå°±æ˜¯æ ¸å¿ƒçš„é€»è¾‘å¤„ç†å™¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ IdleStateHandler å’Œ HeartbeatHandler æ˜¯å’Œå¿ƒè·³æ¶ˆæ¯ç›¸å…³è”çš„ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œé˜…è¯»ï¼Œå¯¹äºæˆ‘ä»¬çš„ Request å®ä¾‹çš„å‘é€å’Œå“åº”çš„æ¥æ”¶è€Œè¨€ï¼Œåªè·Ÿ å¦å¤–ä¸‰ä¸ª ChannelHandler ç›¸å…³ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æ˜¯å‘é€ Request åŒ…ï¼Œç›´æ¥å®šä½åˆ° <code>NettyEncoderHandler#encode</code> æ–¹æ³•å¦‚ä¸‹ï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿™å°±å’Œ netty çš„ channel pipeline ä¸Šçš„ channel handler context ä¸ channel handler æœ‰å…³äº†ï¼Œå¦‚æœå¯¹ netty çš„æºç ä¸ç†Ÿï¼Œå°±ä¼šå¾ˆéš¾ç†è§£ï¼Œå¦‚æœæœ‰æ—¶é—´æˆ‘åè¾¹ä¼šå†™ä¸€äº›å…³äº netty æºç çš„æ–‡ç« ã€‚å¥½äº†ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯ Requestï¼Œèµ° <code>requestEncode(ctx, msg, out);</code> åˆ†æ”¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    serializer = extensionSelector.serializer(url, out);</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">        requestEncode(ctx, msg, out);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> Response) &#123;</span><br><span class="line">        responseEncode(ctx, msg, out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼Œå…¶å®æ¯ä¸€æ­¥æˆ‘åœ¨æ³¨é‡Šä¸­å·²ç»å†™å¾—å¾ˆè¯¦ç»†äº†ï¼Œæˆ‘è¿™é‡Œåªè¦ç»™å‡ºæ•°æ®åŒ…çš„æ¨¡å‹å°±èƒ½å¤Ÿå¾ˆå®¹æ˜“ç†è§£ç¼–ç çš„è¿‡ç¨‹ï¼Œå”¯ä¸€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ Request æ˜¯ RpcRequestï¼Œæ‰€ä»¥åœ¨è¿›è¡Œæ•°æ®åŒ…ä½“çš„ç¼–ç æ—¶ï¼Œæ˜¯ä» Request ä¸­è·å–åˆ° data å³ RpcInfo è¿›è¡Œç¼–ç ã€‚</p>
<table>
<thead>
<tr>
<th align="left">é­”å¹»æ•°å­—ï¼ˆ0 - 1ï¼‰</th>
<th align="left">æ ‡å¿—ä½ï¼ˆ2ï¼‰</th>
<th align="left">ä¿ç•™ä½ï¼ˆ3ï¼‰</th>
<th align="left">åºåˆ—å·ï¼ˆ4 - 11ï¼‰</th>
<th align="left">æ•°æ®åŒ…ä½“é•¿åº¦ï¼ˆ12 - 15ï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">å ç”¨ 2 å­—èŠ‚</td>
<td align="left">å ç”¨ 1 å­—èŠ‚</td>
<td align="left">å ç”¨ 1 å­—èŠ‚</td>
<td align="left">å ç”¨ 8 å­—èŠ‚</td>
<td align="left">å ç”¨ 4 å­—èŠ‚</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">requestEncode</span><span class="params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) msg;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Encode request message of &quot;</span> + request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ„å»ºè¯·æ±‚å¤´</span></span><br><span class="line">    <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[HEADER_LENGTH];</span><br><span class="line">    <span class="comment">// å¡«å……é­”å¹»æ•°å­—</span></span><br><span class="line">    ByteUtils.fillShort(MAGIC, header, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// å¡«å……è¯·æ±‚å¤´çš„æ ‡å¿—å­—èŠ‚</span></span><br><span class="line">    header[<span class="number">2</span>] = (<span class="type">byte</span>) (REQUEST_FLAG | extensionSelector.getSerializerId(url));</span><br><span class="line">    <span class="comment">// å¡«å……è¯·æ±‚ id</span></span><br><span class="line">    ByteUtils.fillLong(request.getId(), header, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// è¿™æ˜¯ header çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">headerIndex</span> <span class="operator">=</span> out.writerIndex();</span><br><span class="line">    <span class="comment">// å°† writer æŒ‡é’ˆå®šä½åˆ° body å†™å…¥çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">bodyIndex</span> <span class="operator">=</span> headerIndex + HEADER_LENGTH;</span><br><span class="line">    out.writerIndex(bodyIndex);</span><br><span class="line">    <span class="comment">// å¯¹äº rpc è¯·æ±‚çš„ç¼–ç å’Œäº‹ä»¶æ¶ˆæ¯çš„ç¼–ç æ˜¯ä¸ä¸€æ ·çš„</span></span><br><span class="line">    <span class="keyword">if</span> (request.isEvent()) &#123;</span><br><span class="line">        header[<span class="number">2</span>] = (<span class="type">byte</span>) (header[<span class="number">2</span>] | EVENT_FLAG);</span><br><span class="line">        encodeEventRequest(request.getData());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        encodeRpcRequest(request.getData());</span><br><span class="line">    &#125;</span><br><span class="line">    serializer.flushBuffer();</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> out.writerIndex() - bodyIndex;</span><br><span class="line">    <span class="comment">// å¡«å…… header çš„é•¿åº¦ä¿¡æ¯</span></span><br><span class="line">    ByteUtils.fillInt(len, header, <span class="number">12</span>);</span><br><span class="line">    <span class="comment">// å°†ä½ç½®å®šä½åˆ° header èµ·å§‹ä½ç½®</span></span><br><span class="line">    out.writerIndex(headerIndex);</span><br><span class="line">    <span class="comment">// å†™å…¥å¤´ä¿¡æ¯</span></span><br><span class="line">    out.writeBytes(header);</span><br><span class="line">    <span class="comment">// å°†æŒ‡é’ˆå®šä½åˆ°å…¨éƒ¨æ•°æ®å†™å…¥ååº”è¯¥åœ¨çš„ä½ç½®</span></span><br><span class="line">    out.writerIndex(bodyIndex + len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å°† rpc ç›¸å…³çš„ä¿¡æ¯å†™å…¥ï¼Œä¸é‡‡ç”¨ç›´æ¥å†™å…¥ object çš„æ–¹å¼æ˜¯ä¸ºäº†æœ€å¤§çš„é™ä½æ•°æ®ä¼ è¾“çš„é‡</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">encodeRpcRequest</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">RpcInfo</span> <span class="variable">info</span> <span class="operator">=</span> (RpcInfo) msg;</span><br><span class="line">    <span class="comment">// è¯·æ±‚çš„æœåŠ¡çš„åå­—</span></span><br><span class="line">    serializer.writeUTF(info.getServiceName());</span><br><span class="line">    <span class="comment">// è¯·æ±‚çš„æ–¹æ³•å</span></span><br><span class="line">    serializer.writeUTF(info.getMethodName());</span><br><span class="line">    <span class="comment">// è¯·æ±‚çš„æ–¹æ³•å‚æ•°ç±»å‹ï¼ˆç”¨ç­¾åçš„æ–¹å¼è¡¨ç¤ºï¼‰</span></span><br><span class="line">    serializer.writeUTF(ReflectUtils.getDesc(info.getPts()));</span><br><span class="line">    <span class="comment">// æ–¹æ³•è°ƒç”¨çš„å‚æ•°å€¼</span></span><br><span class="line">    Object[] pvs = info.getPvs();</span><br><span class="line">    <span class="keyword">if</span> (pvs != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object pv : pvs) &#123;</span><br><span class="line">            serializer.writeObject(pv);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†ç¼–ç åçš„ç»“æœå‘é€ç»™æœåŠ¡ç«¯åï¼ŒæœåŠ¡ç«¯ä¼šè¿›è¡Œè§£ç ï¼Œç„¶åæ ¹æ®è§£ç çš„ç»“æœå®Œæˆå¯¹åº”çš„æœåŠ¡æ¥å£å®ç°ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªç¨åè¿›è¡Œè¯´æ˜ï¼Œæ–¹æ³•è°ƒç”¨çš„ç»“æœï¼ŒæœåŠ¡ç«¯ä¹Ÿæ˜¯é€šè¿‡ netty å‘é€å›æ¥ï¼ŒåŒæ ·çš„æ•°æ®åŒ…ä¹Ÿæ˜¯ç»è¿‡ç¼–ç çš„ï¼Œå®¢æˆ·ç«¯éœ€è¦å¯¹å…¶è¿›è¡Œè§£ç ï¼Œæ‰èƒ½å¾—åˆ°å…·ä½“çš„ç»“æœï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨ <code>NettyDecoderHandler#decode</code> æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆåˆéœ€è¦æ¶‰åŠåˆ° netty çš„æºç å®ç°äº†ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæ ¸å¿ƒå°±æ˜¯è°ƒç”¨ <code>NettyDecoderHandler#prepareDecode</code> æ–¹æ³•ï¼Œå¦‚æœèƒ½å¤Ÿç†è§£ç¼–ç çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆè§£ç å°±æ˜¯ä¸€ä¸ªé€†å‘è¿‡ç¨‹ï¼Œç»“åˆæˆ‘åœ¨ä»£ç ä¸­çš„æ³¨é‡Šåº”è¯¥å°±èƒ½ç†è§£ï¼Œè¿™é‡Œä¹Ÿä¸å†èµ˜è¿°.éœ€è¦æ³¨æ„çš„æ˜¯ <code>NettyDecoderHandler#prepareDecode</code> æ–¹æ³•è§£ç å‡ºæ¥çš„ç»“æœä¼šåœ¨ <code>NettyDecoderHandler#decode</code> ä¸­æ·»åŠ åˆ° List&lt;Object&gt; out é›†åˆä¸­ï¼Œç„¶ååœ¨çˆ¶ç±»ä¸­ä¼šé€ä¸ªçš„å°†é‡Œè¾¹çš„å…ƒç´ å–å‡ºå¹¶äº¤ç”±ä¸‹ä¸€ä¸ª ChannelHandler å¤„ç†ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»º NettyClient æ—¶æŒ‡å®šçš„ ClientFinalChannelHandlerã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (in.isReadable()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">readerIndex</span> <span class="operator">=</span> in.readerIndex();</span><br><span class="line">        serializer = extensionSelector.deserializer(url, in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">pre</span> <span class="operator">=</span> count;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> prepareDecode(ctx, in, out);</span><br><span class="line">        <span class="keyword">if</span> (result == EMPTY_RESULT) &#123;</span><br><span class="line">            in.readerIndex(readerIndex);</span><br><span class="line">            count = pre;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> count - pre;</span><br><span class="line">            in.readerIndex(readerIndex + len);</span><br><span class="line">            out.add(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">prepareDecode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">readable</span> <span class="operator">=</span> in.readableBytes();</span><br><span class="line">    <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[Math.min(readable, HEADER_LENGTH)];</span><br><span class="line">    in.readBytes(header);</span><br><span class="line">    <span class="comment">// å¦‚æœé­”å¹»å¤´ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡æ–°å®šä½åˆ°æ–°çš„é­”å¹»å¤´</span></span><br><span class="line">    <span class="keyword">if</span> ((readable &gt; <span class="number">0</span> &amp;&amp; header[<span class="number">0</span>] != MAGIC_LOW) || (readable &gt; <span class="number">1</span> &amp;&amp; header[<span class="number">1</span>] != MAGIC_HIGH)) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> header.length;</span><br><span class="line">        <span class="keyword">if</span> (header.length &lt; readable) &#123; <span class="comment">// è¿™é‡Œè¯´æ˜å¤Ÿå¤´éƒ¨çš„é•¿åº¦</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œå°±è¯´æ˜ï¼Œé™¤äº† header çš„å­—èŠ‚éƒ¨åˆ†ï¼Œè¿˜æœ‰çœŸæ­£çš„æ•°æ®éƒ¨åˆ†</span></span><br><span class="line">            header = ByteUtils.copyOf(header, readable);</span><br><span class="line">            <span class="comment">// è¿™æ ·å°±æ˜¯å°†å…¨éƒ¨æ•°æ®è¯»åˆ°äº† header ä¸­ï¼Œå‰ 16 ä¸ªä¸º header éƒ¨åˆ†ï¼Œåè¾¹çš„ä¸ºå‰©ä½™æ•°æ®</span></span><br><span class="line">            in.readBytes(header, length, readable - length);    <span class="comment">// å…¨éƒ¨çš„æ•°æ®éƒ½åˆ°äº† header ä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; header.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (header[i] == MAGIC_LOW &amp;&amp; header[i + <span class="number">1</span>] == MAGIC_HIGH) &#123;    <span class="comment">// è¿™é‡Œæ˜¯é‡æ–°ç¡®å®šé­”å¹»å¤´çš„ä½ç½®</span></span><br><span class="line">                <span class="comment">// è¿™é‡Œå°±è¯´æ˜åˆæ£€æµ‹åˆ°äº†ä¸€ä¸ªæ•°æ®åŒ…ï¼Œé‚£ä¹ˆå°±å°†ç¬¬ä¸€ä¸ªæ•°æ®åŒ…çš„å†…å®¹æ”¾åˆ° header ä¸­</span></span><br><span class="line">                in.readerIndex(in.readerIndex() - header.length + i);   <span class="comment">// å°† readerIndex é‡æ–°å®šä½åˆ°æ–°çš„é­”å¹»å¤´ä½ç½®</span></span><br><span class="line">                readable = in.readableBytes();</span><br><span class="line">                header = <span class="keyword">new</span> <span class="title class_">byte</span>[Math.min(readable, HEADER_LENGTH)];</span><br><span class="line">                in.readBytes(header);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸€æ¬¡åªè§£æä¸€ä¸ªæ•°æ®åŒ…</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check length.</span></span><br><span class="line">    <span class="keyword">if</span> (readable &lt; HEADER_LENGTH) &#123; <span class="comment">// æ¥æ”¶åˆ°çš„æ•°æ®è¿˜ä¸è¶³ä»¥è§£æå‡ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…</span></span><br><span class="line">        <span class="keyword">return</span> EMPTY_RESULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get data length. æ ¹æ® header è·å– len ä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> ByteUtils.readInt(header, <span class="number">12</span>);</span><br><span class="line">    <span class="comment">// æ€»é•¿åº¦ä¸º header + æ•°æ®é•¿åº¦ï¼ˆheader åå››ä½è¿›è¡Œè®°å½•ï¼‰</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">tt</span> <span class="operator">=</span> len + HEADER_LENGTH;</span><br><span class="line">    <span class="keyword">if</span> (readable &lt; tt) &#123;    <span class="comment">// ä¹Ÿå°±æ˜¯è¯´ç›®å‰æ¥å—åˆ°çš„æ•°æ®è¿˜ä¸å¤Ÿ header + åŒ…é•¿åº¦å¾—åˆ°çš„æ€»é•¿åº¦</span></span><br><span class="line">        <span class="keyword">return</span> EMPTY_RESULT;</span><br><span class="line">    &#125;</span><br><span class="line">    count += tt;</span><br><span class="line">    <span class="comment">// limit input stream.é€šè¿‡ ChannelBufferInputStream å¯¹ buffer è¿›è¡Œå°è£…ï¼Œè®°å½•äº†å†…å®¹è¯»å–çš„ä¸Šä¸‹ç•Œ</span></span><br><span class="line">    <span class="comment">// ChannelBufferInputStream -&gt; NettyBackedCahnnelBuffer -&gt; Netty åŸç”Ÿ buf</span></span><br><span class="line">    <span class="keyword">return</span> doDecode(header); <span class="comment">// è§£ç é™¤å¼€ header ä»¥å¤–çš„ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">doDecode</span><span class="params">(<span class="type">byte</span>[] header)</span> &#123;</span><br><span class="line">    <span class="type">byte</span> <span class="variable">flag</span> <span class="operator">=</span> header[<span class="number">2</span>], proto = (<span class="type">byte</span>) (flag &amp; SERIALIZER_MASK);</span><br><span class="line">    <span class="comment">// get request id.</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> ByteUtils.readLong(header, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœæ ‡å¿—ä½æ˜¯ä¸æ˜¯ requestï¼Œé‚£å°±è¯´æ˜æ˜¯æ”¶åˆ°çš„ response</span></span><br><span class="line">    <span class="keyword">if</span> ((flag &amp; REQUEST_FLAG) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// decode response.</span></span><br><span class="line">        <span class="type">Response</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Response</span>(id);</span><br><span class="line">        <span class="comment">// get status.</span></span><br><span class="line">        <span class="type">byte</span> <span class="variable">status</span> <span class="operator">=</span> header[<span class="number">3</span>];</span><br><span class="line">        res.setStatus(status);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å½“å‰ç›¸åº”æ˜¯å¦ä¸ºäº‹ä»¶å“åº”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((flag &amp; EVENT_FLAG) == <span class="number">0</span>) &#123;</span><br><span class="line">                    res.setType(MessageType.RESPONSE);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> serializer.readObject();</span><br><span class="line">                    res.setData(msg);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    res.setType(MessageType.HEARTBEAT_RESPONSE);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> serializer.readObject();</span><br><span class="line">                    res.setData(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Decode message error, please check provider and consumer use the same serializer&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¸…é™¤ netty åŸç†çš„è¯å°±ä¼šçŸ¥é“åœ¨ ClientFinalChannelHandler ä¸­æ¥æ”¶ä¸Šä¸ª ChannelHandler çš„å¤„ç†ç»“æœçš„æ–¹æ³•æ˜¯ <code>ClientFinalChannelHandler#channelRead</code>ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œå°±åªæ˜¯å‘çº¿ç¨‹æ± ä¸­æäº¤äº†ä¸€ä¸ª EventHandleThread ä»»åŠ¡ï¼Œå®ƒæŒæœ‰äº†è§£ç å‡ºæ¥çš„ç»“æœï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯çœ‹è¿™ä¸ª Task å¯¹æˆ‘ä»¬çš„è§£ç ç»“æœåšäº†ä»€ä¹ˆå¤„ç†ã€‚ç›´æ¥æŸ¥çœ‹å®ƒçš„ run æ–¹æ³•ã€‚å¯ä»¥çŸ¥é“å®ƒå°±æ˜¯ç›´æ¥è°ƒç”¨ <code>handleMsg();</code>æ–¹æ³•ã€‚å› ä¸ºæˆ‘ä»¬æ”¶åˆ°çš„æ˜¯æœåŠ¡ç«¯çš„ Response æ•°æ®åŒ…ï¼Œæ‰€ä»¥åªå…³æ³¨è¯¥æ–¹æ³•çš„ <code>else if (msg instanceof Response)</code> åˆ†æ”¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ­¤å¤„çš„å¤„ç†æ€ä¹ˆçœ‹éƒ½ä¸å¤Ÿä¼˜é›…</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IllegalAccessException</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> InstantiationException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleMsg</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯å¯¹äºéäº‹ä»¶ request çš„å¤„ç†æ–¹å¼</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> Response) &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) msg;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Received response message of &quot;</span> + response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">status</span> <span class="operator">=</span> response.getStatus();</span><br><span class="line">        <span class="comment">// åªå¯¹ç›¸åº”çŠ¶æ€ä¸º ok çš„ response è¿›è¡Œå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (Response.OK == status) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">data</span> <span class="operator">=</span> response.getData();</span><br><span class="line">            <span class="type">RpcResult</span> <span class="variable">result</span> <span class="operator">=</span> getRpcResult(response);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å®Œæˆç›¸åº”ç»“æœçš„å¡«å……</span></span><br><span class="line">                result.fillData(data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ‰€åšçš„äº‹æƒ…å°±æ˜¯ä» Response ä¸­æ‹¿åˆ°å“åº”çš„æ•°æ®ï¼Œç„¶åå°†å…¶å¡«å……åˆ° RpcResult ä¸­ï¼Œç‰¹åˆ«æ³¨æ„ï¼Œè¿™ä¸ª RpcResult æ˜¯å’Œ rpc Request çš„ id å¯¹åº”çš„ï¼Œæ‰€ä»¥å¡«å……çš„ç»“æœä¹Ÿæ˜¯é’ˆå¯¹å¯¹åº”çš„ RpcResultï¼Œè€Œåœ¨ <code>RpcResult#fillData</code> æ–¹æ³•ä¸­ï¼Œå°±æ˜¯å®Œæˆäº†ç»“æœçš„å¡«å……ï¼Œå¹¶å”¤é†’äº†é˜»å¡åœ¨å½“å‰ rpc è¯·æ±‚å¯¹åº”çš„çº¿ç¨‹ï¼Œè¿™æ · rpc è¯·æ±‚çš„ç»“æœå°±è¢«æœåŠ¡æ¥å£å®¢æˆ·ç«¯ä»£ç†è¿”å›ç»™æ¥å£çš„æ–¹æ³•è°ƒç”¨è€…ã€‚</p>
<h3 id="netty-é€šä¿¡æœåŠ¡ç«¯"><a href="#netty-é€šä¿¡æœåŠ¡ç«¯" class="headerlink" title="netty é€šä¿¡æœåŠ¡ç«¯"></a>netty é€šä¿¡æœåŠ¡ç«¯</h3><p>åœ¨æœåŠ¡ç«¯çš„å¯åŠ¨ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿåªæ˜¯è¯´äº†åˆ›å»ºäº† NettyServerï¼Œä½†æ˜¯å…·ä½“çš„ç»†èŠ‚æ²¡æœ‰è¿›è¡Œè¯´æ˜ï¼Œç°åœ¨å°±å®Œæˆè¿™ä¸€éƒ¨åˆ†çš„è§£é‡Šã€‚å’Œå®¢æˆ·ç«¯ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ ChannelInitializer å¯¹äº NioSocketChannel çš„åˆå§‹åŒ–ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ä» url ä¸­è·å– idleTimeout æ—¶é•¿ï¼Œå¦‚æœ url å‚æ•°ä¸­æ²¡æœ‰æŒ‡å®šï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨ä¸‰å€çš„ heartBeat æ—¶é•¿</span></span><br><span class="line">        ch.pipeline()<span class="comment">//.addLast(&quot;logging&quot;,new LoggingHandler(LogLevel.INFO))//for debug</span></span><br><span class="line">                .addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">NettyDecoderHandler</span>(getUrl()))   <span class="comment">// InternalDecoder</span></span><br><span class="line">                .addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">NettyEncoderHandler</span>(getUrl()))   <span class="comment">// InternalEncoder</span></span><br><span class="line">                <span class="comment">// ç”¨äºæ£€æµ‹ channel ç©ºé—²çŠ¶æ€ï¼Œæ¡ä»¶æˆç«‹æ—¶å…³é—­å¯¹åº”çš„ channelï¼Œç›¸å¯¹çš„å®¢æˆ·ç«¯çš„ Idle å¤„ç†å™¨åˆ™ç”¨äºå‘é€å¿ƒè·³æ¶ˆæ¯</span></span><br><span class="line">                .addLast(<span class="string">&quot;server-idle-handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">0</span>, IDLE_TIMEOUT, MILLISECONDS))</span><br><span class="line">                .addLast(<span class="string">&quot;heartbeat-handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">HeartbeatHandler</span>())</span><br><span class="line">                .addLast(<span class="string">&quot;final-handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">ServerFinalChannelHandler</span>(getUrl()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ä¸Šæ–‡å·²ç»è¯´è¿‡äº†å‰å››ä¸ª ChannelHandler çš„ä½œç”¨åŠä½¿ç”¨äº†ï¼ŒæœåŠ¡ç«¯å¯¹äºä»–ä»¬çš„ä½¿ç”¨åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥ä¹Ÿä¸å†èµ˜è¿°ï¼Œæœ€åä¸€ä¸ª ChannelHandler å’Œ NettyClient çš„æœ€åä¸€ä¸ª ChannelHandler çš„ä½œç”¨åŸºæœ¬ä¸€è‡´ï¼Œéƒ½æ˜¯å‘çº¿ç¨‹æ± ä¸­æäº¤äº†ä¸€ä¸ª EventHandleThreadï¼Œé‡Œè¾¹çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å› ä¸ºå¤„ç†çš„æ˜¯æ¥è‡ªå®¢æˆ·ç«¯çš„ Request åŒ…ï¼Œæ‰€ä»¥èµ°çš„æ˜¯ <code>EventHandleThread#handleMsg</code> æ–¹æ³•çš„ <code>if (msg instanceof Request)</code> åˆ†æ”¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹äºéäº‹ä»¶ request çš„å¤„ç†æ–¹å¼</span></span><br><span class="line"><span class="keyword">if</span> (msg <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) msg;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Received request message of &quot;</span> + request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!request.isEvent()) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ® request ç›¸å…³çš„å†…å®¹æ„å»º response</span></span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> buildResponse(request);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">data</span> <span class="operator">=</span> request.getData();</span><br><span class="line">        <span class="comment">// å¦‚æœ request æºå¸¦çš„æ•°æ®ä¸º RpcInfoï¼Œé‚£ä¹ˆå°±æ ¹æ®å…¶è¿›è¡Œç›¸åº”çš„ invoker è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">if</span> (data <span class="keyword">instanceof</span> RpcInfo) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> doInvoke((RpcInfo) data);</span><br><span class="line">            <span class="comment">// å°† invoke çš„ç»“æœå¡«å……åˆ° response ä¸­</span></span><br><span class="line">            response.setData(result);</span><br><span class="line">            <span class="comment">// å°†å“åº”ç»“æœå†™å›</span></span><br><span class="line">            ctx.writeAndFlush(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ ¹æ® RpcInfo è¿›è¡Œé€»è¾‘è°ƒç”¨ï¼Œè·å–è°ƒç”¨çš„ç»“æœ</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> InstantiationException</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IllegalAccessException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">doInvoke</span><span class="params">(RpcInfo data)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">RpcInfo</span> <span class="variable">info</span> <span class="operator">=</span> data;</span><br><span class="line">    <span class="comment">// å°è¯•ä» BeehiveContext ä¸­è·å– invoker å®ä¾‹</span></span><br><span class="line">    <span class="type">Invoker</span> <span class="variable">invoker</span> <span class="operator">=</span> BeehiveContext.unsafeGet(info.getServiceName(), Invoker.class);</span><br><span class="line">    <span class="comment">// æ ¹æ® url ä¿¡æ¯è·å– invoke target å®ä¾‹</span></span><br><span class="line">    <span class="type">ServiceConfigBean</span> <span class="variable">serviceConfigBean</span> <span class="operator">=</span> BeehiveContext.unsafeGet(UrlConstants.PROVIDER_MODEL, ServiceConfigBean.class);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> serviceConfigBean.getRef();</span><br><span class="line">    <span class="comment">// è¿›è¡ŒçœŸæ­£çš„ invoke æ“ä½œ</span></span><br><span class="line">    <span class="keyword">return</span> invoker.invoke(info.createInvokeInfo(target));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¯¥åˆ†æ”¯ä¸­ï¼Œé¦–å…ˆæ˜¯æ„å»ºäº†ä¸€ä¸ª Response å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹çš„ id æ˜¯å’Œ Request ä¸€è‡´çš„ï¼Œè¿™æ ·å®¢æˆ·ç«¯æ”¶åˆ°è¯¥ Response æ•°æ®åŒ…åæ‰çŸ¥é“å¯¹åº”å“ªä¸ª RpcResult å®ä¾‹ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ä»æ”¶åˆ°çš„ Request ä¸­æ‹¿åˆ°æ•°æ® RpcInfoï¼Œé‡Œè¾¹åŒ…å«äº† rpc çš„æœåŠ¡åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ç­¾åã€å‚æ•°å€¼ã€‚<code>EventHandleThread#doInvoke</code> æ–¹æ³•å°±æ˜¯æ ¹æ®ä»¥ä¸Šè¿™äº›è¿›è¡ŒæœåŠ¡æ¥å£å®ç°ç±»æ–¹æ³•çš„è°ƒç”¨ã€‚å¯ä»¥çœ‹åˆ°å®ƒå…ˆä» BeehiveContext ä¸­æ‹¿åˆ°äº†ä¸€ä¸ª Invoker å®ä¾‹ï¼Œå…¶å®å®ƒå°±æ˜¯åœ¨æœåŠ¡ç«¯å¯åŠ¨æ—¶åˆ›å»ºçš„ Invoker é“¾ã€‚å…¶æœ€åä¸€ä¸ªèŠ‚ç‚¹å°±å°è£…äº†æœåŠ¡æ¥å£çš„å®ç°ç±»ã€‚å½“æˆ‘ä»¬è¿›è¡Œ invoker é“¾çš„ invoke æ–¹æ³•è°ƒç”¨æ—¶ï¼Œæœ€ç»ˆå°±ä¼šè§¦å‘æœåŠ¡æ¥å£çš„å®ç°ç±»å¯¹åº”æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿”å›çš„å°±æ˜¯è¯¥æ–¹æ³•çš„æ‰§è¡Œç»“æœã€‚æ‹¿åˆ°è¯¥ç»“æœåï¼Œå°±æ˜¯å°†å®ƒå¡«å……åˆ° Response å®ä¾‹ä¸­ï¼Œè°ƒç”¨ <code>tx.writeAndFlush(response);</code> å°†å“åº”ç»“æœè¿”å›ï¼Œè¿™æ ·ä¸€ä¸ªå®Œæˆçš„ rpc è¿‡ç¨‹å°±ç®—å®Œæˆäº†ã€‚</p>
<h2 id="TODO-LIST"><a href="#TODO-LIST" class="headerlink" title="TODO-LIST"></a>TODO-LIST</h2><ul>
<li><p>åº•å±‚é€šä¿¡æ¡†æ¶çš„æ”¯æŒæœ‰å¾…å®Œå–„ï¼Œæ¯”å¦‚ Minaï¼ˆæˆ‘æ²¡æ¥è§¦è¿‡ï¼‰</p>
</li>
<li><p>ç¼ºå°‘ä¸€ä¸ªæœåŠ¡çš„ç®¡ç†æ¨¡å—ï¼Œæ¡†æ¶å½“å‰æä¾›äº†ç›¸åº”çš„ filter æ¥å£ï¼Œé€šè¿‡å®ç°è¯¥æ¥å£å³å¯å¯¹ rpc è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç”±æ­¤æ¥è·å–éƒ¨åˆ†ç›‘æ§ä¿¡æ¯</p>
</li>
<li><p>SPI æ‹“å±•æœºåˆ¶æ²¡æœ‰å®Œæˆç›¸åº”çš„ç»„ä»¶ç­›é€‰åŠŸèƒ½ï¼Œæ¯”å¦‚ filter æ¥å£å®ç°ç±»ï¼Œæ¡†æ¶æ²¡æœ‰æä¾›åŸºç¡€çš„é€‰æ‹©æ€§è·å–æ–¹å¼</p>
</li>
<li><p>å¼‚æ­¥æ¶ˆæ¯å¤„ç†çš„çº¿ç¨‹æ± çš„æ„å»ºåº”è¯¥æ›´åŠ çµæ´»ï¼Œç›¸åº”çš„æ‹’ç»æ‰§è¡Œç­–ç•¥æœ‰å¾…å®Œå–„</p>
</li>
<li><p>è´Ÿè½½å‡è¡¡ç­–ç•¥ç¼ºé™·ä¸¥é‡ï¼Œåº”è¯¥éœ€è¦æ ¹æ®å®é™…çš„ provider è´Ÿè½½æƒ…å†µæ¥åŠ¨æ€çš„è°ƒæ•´</p>
</li>
</ul>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/RPC/">#RPC</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2019/07/21/2019-07-21-Spring-AOP-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Spring AOP å®ç°åŸç†åˆ†æ</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2019/07/17/2019-07-17-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%9F%E4%B8%80id%E7%94%9F%E6%88%90%E5%99%A8snowflake%E4%BB%8B%E7%BB%8D/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">åˆ†å¸ƒå¼ç»Ÿä¸€idç”Ÿæˆå™¨snowflakeä»‹ç»</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">å°æ©˜å­ğŸŠ</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">ç®€ä»‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7"><span class="nav-number">2.</span> <span class="nav-text">åŠŸèƒ½ç‰¹æ€§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">3.</span> <span class="nav-text">ä½¿ç”¨æ–¹å¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">4.</span> <span class="nav-text">å‚æ•°è®¾ç½®è¯´æ˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lt-beehive-service-x2F-gt-%E6%A0%87%E7%AD%BE"><span class="nav-number">4.1.</span> <span class="nav-text">&lt;beehive:service&#x2F;&gt; æ ‡ç­¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lt-beehive-reference-x2F-gt-%E6%A0%87%E7%AD%BE"><span class="nav-number">4.2.</span> <span class="nav-text">&lt;beehive:reference&#x2F;&gt; æ ‡ç­¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lt-beehive-registry-x2F-gt-%E6%A0%87%E7%AD%BE"><span class="nav-number">4.3.</span> <span class="nav-text">&lt;beehive:registry&#x2F;&gt; æ ‡ç­¾</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B7%E4%BE%8B%E6%B5%8B%E8%AF%95"><span class="nav-number">5.</span> <span class="nav-text">æ ·ä¾‹æµ‹è¯•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%B5%8B%E8%AF%95"><span class="nav-number">5.1.</span> <span class="nav-text">åŸºæœ¬æµ‹è¯•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%88%87%E6%8D%A2%E7%9A%84%E6%B5%8B%E8%AF%95"><span class="nav-number">5.2.</span> <span class="nav-text">æœåŠ¡åˆ‡æ¢çš„æµ‹è¯•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">åº•å±‚å®ç°åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90"><span class="nav-number">6.1.</span> <span class="nav-text">æ ‡ç­¾è§£æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8"><span class="nav-number">6.2.</span> <span class="nav-text">æœåŠ¡ç«¯å¯åŠ¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%AF%E5%8A%A8"><span class="nav-number">6.3.</span> <span class="nav-text">å®¢æˆ·ç«¯å¯åŠ¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-RPC-%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="nav-number">6.4.</span> <span class="nav-text">å®¢æˆ·ç«¯ RPC è¯·æ±‚æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netty-%E9%80%9A%E4%BF%A1%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">6.5.</span> <span class="nav-text">netty é€šä¿¡å®¢æˆ·ç«¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netty-%E9%80%9A%E4%BF%A1%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">6.6.</span> <span class="nav-text">netty é€šä¿¡æœåŠ¡ç«¯</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO-LIST"><span class="nav-number">7.</span> <span class="nav-text">TODO-LIST</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
