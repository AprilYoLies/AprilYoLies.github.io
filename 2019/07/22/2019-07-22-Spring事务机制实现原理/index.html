<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Java åç«¯">
    <meta name="description" content="å°æ©˜å­ğŸŠçš„ä¸ªäººä¸»é¡µï¼Œæ¬¢è¿è®¿é—®~~">
    <meta name="author" content="å°æ©˜å­ğŸŠ">
    
    <title>
        
            Springäº‹åŠ¡æœºåˆ¶å®ç°åŸç† |
        
        AprilYoLies
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://img.aprilyolies.top/img/typora/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"aprilyolies.top","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"https://img.aprilyolies.top/img/typora/avatar.jpg","favicon":"https://img.aprilyolies.top/img/typora/avatar.jpg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"å¹²ç‡¥çš„ç©ºæ°”ï¼Œå°˜åŸƒçš„å‘³é“ï¼Œæˆ‘åœ¨å…¶ä¸­â€¦è¸ä¸Šæ—…é€”ï¼"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </a>
            
            <a class="logo-title" href="/">
                AprilYoLies
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Springäº‹åŠ¡æœºåˆ¶å®ç°åŸç†</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">å°æ©˜å­ğŸŠ</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2019-07-22 20:44:44</span>
        <span class="mobile">2019-07-22 20:44</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">æºç åˆ†æ</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Spring/">Spring</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å·²ç»æ¯”è¾ƒè¯¦ç»†çš„å¯¹ Spring çš„ AOP å®ç°åŸç†è¿›è¡Œäº†è¯´æ˜ï¼Œè€Œ Spring çš„äº‹åŠ¡å®ç°åŸç†å‘¢åˆè·Ÿ Spring çš„ AOP å®ç°æœ‰ç€è¾ƒå¤§çš„å…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©æˆçƒ­æ‰“é“ï¼Œå¯¹ Spring çš„äº‹åŠ¡å®ç°æœºåˆ¶è¿›è¡Œä¸€ä¸‹è¯´æ˜ã€‚ä¸Šä¸€ç¯‡æ–‡ç« åœ¨å¯¹ AOP å®ç°è¿›è¡Œè§£é‡Šæ—¶ï¼Œåªåˆ†æäº†å®ƒçš„ cglib ä»£ç†å®ç°ï¼Œå› ä¸ºæä¾›çš„ä¾‹å­ä¸­è¢«ä»£ç†ç±»æ²¡æœ‰å®ç°ç›¸åº”çš„æ¥å£ï¼Œå¯¼è‡´ä¸èƒ½é€šè¿‡ jdk åŸç”Ÿæ–¹å¼è¿›è¡Œä»£ç†ï¼Œè€Œæœ¬æ–‡å°†è¦è§£é‡Šçš„ Spring äº‹åŠ¡å®ç°ä¸­ï¼Œä¾‹å­æ˜¯å®ç°äº†ç”¨æˆ·æœåŠ¡æ¥å£çš„ï¼Œæ‰€ä»¥ä»£ç†æ–¹å¼æ˜¯é‡‡ç”¨çš„ jdk åŸç”Ÿæ–¹å¼ï¼Œæ­£å¥½èƒ½å¤Ÿå¯¹ä¸Šæ–‡è¿›è¡Œè¡¥å……ã€‚åŒæ ·çš„ç¤ºä¾‹ä»£ç æˆ‘å·²ç»æäº¤åˆ°æˆ‘çš„ <a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/spring-framework" >github<i class="fas fa-external-link-alt"></i></a> ä¸Šï¼Œæ¬¢è¿è‡ªå–ã€‚åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œååˆ†çš„å»ºè®®å…ˆçœ‹æˆ‘çš„ä¸Šä¸€ç¯‡ <a class="link"   target="_blank" rel="noopener" href="https://www.aprilyolies.top/2019/07/21/Spring-AOP-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" >Spring AOP å®ç°åŸç†<i class="fas fa-external-link-alt"></i></a>æ–‡ç« ï¼Œå› ä¸ºåˆ†æ Spring äº‹åŠ¡å®ç°åŸç†çš„æ–¹å¼å’Œåˆ†æ Spring AOP å®ç°åŸç†çš„æ–¹å¼ååˆ†ç›¸ä¼¼ï¼Œå¦‚æœå¯¹ä¸Šä¸€ç¯‡æ–‡ç« ç†è§£å¾—å¥½ï¼ŒSpring çš„äº‹åŠ¡å®ç°å®Œå…¨å¯ä»¥æŒ‰ç…§åŒæ ·çš„æ–¹å¼æ¥è¿›è¡Œåˆ†æã€‚</p>
<h2 id="ç¤ºä¾‹ç¨‹åº"><a href="#ç¤ºä¾‹ç¨‹åº" class="headerlink" title="ç¤ºä¾‹ç¨‹åº"></a>ç¤ºä¾‹ç¨‹åº</h2><p>å®ä¾‹ç¨‹åºå¾ˆç®€å•ï¼Œå·²ç»åŒæ­¥åˆ°ä¸Šæ–‡ github é“¾æ¥ä¸Šäº†ï¼Œåœ¨ spring-example æ¨¡å—çš„ <code>top.aprilyolies.example.tx</code> åŒ…ä¹‹ä¸‹ï¼Œæ‰§è¡Œå‰è¿˜éœ€è¦å…ˆåœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ•°æ®è¡¨ï¼Œsql æ–‡ä»¶åœ¨å½“å‰æ¨¡å—ä¸‹çš„ db æ–‡ä»¶å¤¹ä¸‹ã€‚</p>
<blockquote>
<p>ä¸»å‡½æ•° top.aprilyolies.example.tx.TxApp</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TxApp</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-tx.xml&quot;</span>);</span><br><span class="line">		<span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) context.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">		<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">		user.setSex(<span class="string">&quot;man&quot;</span>);</span><br><span class="line">		user.setName(<span class="string">&quot;eva&quot;</span>);</span><br><span class="line">		user.setAge(<span class="number">23</span>);</span><br><span class="line">		userService.save(user);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>pojo ç±»çœç•¥ getter å’Œ setter æ–¹æ³• top.aprilyolies.example.tx.User</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">	<span class="keyword">private</span> String sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>top.aprilyolies.example.tx.UserRowMapper</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRowMapper</span> <span class="keyword">implements</span> <span class="title class_">RowMapper</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">mapRow</span><span class="params">(ResultSet rs, <span class="type">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">		<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">		user.setAge(rs.getInt(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">		user.setId(rs.getInt(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">		user.setName(rs.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">		user.setSex(rs.getString(<span class="string">&quot;sex&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> user;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>top.aprilyolies.example.tx.UserService</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>top.aprilyolies.example.tx.UserServiceImpl</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">JdbcTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDataSource</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.template.setDataSource(dataSource);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">		template.update(<span class="string">&quot;insert into user(name,age,sex) values (?,?,?)&quot;</span>, user.getName(), user.getAge(), user.getSex());</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Test tx&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>top.aprilyolies.example.tx.UserService</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>spring-tx.xml</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">	   xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">	   xmlns:tx=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span><br><span class="line">	   xsi:schemaLocation=<span class="string">&quot;</span></span><br><span class="line"><span class="string">       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">	&lt;tx:annotation-driven/&gt;</span><br><span class="line"></span><br><span class="line">	&lt;bean id=<span class="string">&quot;transactionManager&quot;</span> class=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br><span class="line">		&lt;!-- å…³è”æ•°æ®æº --&gt;</span><br><span class="line">		&lt;property name=<span class="string">&quot;dataSource&quot;</span> ref=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;!-- åŸºäºDruidæ•°æ®åº“é“¾æ¥æ± çš„æ•°æ®æºé…ç½® --&gt;</span><br><span class="line">	&lt;bean id=<span class="string">&quot;dataSource&quot;</span> class=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> init-method=<span class="string">&quot;init&quot;</span> destroy-method=<span class="string">&quot;clone&quot;</span>&gt;</span><br><span class="line">		&lt;!-- åŸºæœ¬å±æ€§driverClassNameã€ urlã€userã€password --&gt;</span><br><span class="line">		&lt;property name=<span class="string">&quot;driverClassName&quot;</span> value=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span><br><span class="line">		&lt;property name=<span class="string">&quot;url&quot;</span> value=<span class="string">&quot;jdbc:mysql://localhost:3306/common&quot;</span>/&gt;</span><br><span class="line">		&lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;root&quot;</span>/&gt;</span><br><span class="line">		&lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;kuaile1..&quot;</span>/&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">	&lt;bean id=<span class="string">&quot;userService&quot;</span> class=<span class="string">&quot;top.aprilyolies.example.tx.UserServiceImpl&quot;</span>&gt;</span><br><span class="line">		&lt;property name=<span class="string">&quot;dataSource&quot;</span> ref=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸»å‡½æ•°ï¼Œä¼šå‘ç°ç¨‹åºæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ•°æ®åº“å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å‡†å¤‡æ’å…¥çš„æ•°æ®æ²¡æœ‰å‡ºç°ã€‚å¦‚æœæˆ‘ä»¬å°† <code>top.aprilyolies.example.tx.UserServiceImpl</code> ç±»çš„ @Transactional æ³¨è§£å»æ‰ï¼Œå†æ‰§è¡Œä¸»å‡½æ•°ï¼Œè¿™æ—¶å¯ä»¥çœ‹åˆ°ç¨‹åºåŒæ ·æ˜¯æŠ›å‡ºäº†è¿è¡Œæ—¶å¼‚å¸¸ï¼Œä½†æ˜¯å½“å‰è¿™æ¡è®°å½•å´è¢«æ’å…¥äº†æ•°æ®åº“ä¸­ã€‚</p>
<p>è§£é‡Šå°±æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨ @Transactional æ³¨è§£æ—¶ï¼Œé‚£ä¹ˆ spring åœ¨æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•æ—¶ä¼šå¼€å¯äº‹åŠ¡ï¼Œè¿™æ ·å¦‚æœåœ¨äº‹åŠ¡ä¸­ java ç¨‹åºå‡ºç°å¼‚å¸¸ï¼Œspring å°±ä¼šè‡ªåŠ¨å®Œæˆäº‹åŠ¡çš„å›æ»šã€‚å½“æŠŠ @Transactional æ³¨è§£å»æ‰åï¼Œæˆ‘ä»¬å°±æ˜¯æ‰§è¡Œçš„æ™®é€šæ–¹æ³•ï¼Œè¿™æ ·é»˜è®¤çš„äº‹åŠ¡æœºåˆ¶æ˜¯è‡ªåŠ¨æäº¤ï¼Œå½“æ‰§è¡Œå®Œ <code>template.update</code> æ–¹æ³•æ—¶ï¼Œè®°å½•å·²ç»è¿›å…¥æ•°æ®åº“ï¼Œæ­¤æ—¶å†æŠ›å‡ºå¼‚å¸¸ï¼Œå°†ä¸ä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“ã€‚å½“ç„¶è¿™åªæ˜¯ç›´è§‚çš„æ„Ÿå—ï¼Œå…·ä½“çš„å®ç°è¿˜æ˜¯è¦çœ‹æºç ï¼Œæœ¬æ–‡çš„ä¸»è¦å†…å®¹ä¹Ÿå°±æ˜¯è¿™ä¸ªã€‚</p>
<h2 id="æ ‡ç­¾è§£æ"><a href="#æ ‡ç­¾è§£æ" class="headerlink" title="æ ‡ç­¾è§£æ"></a>æ ‡ç­¾è§£æ</h2><p>åœ¨æˆ‘ä»¬çš„ spring é…ç½®æ–‡ä»¶ä¸­åªæœ‰ä¸€ä¸ªç‰¹æ®Šæ ‡ç­¾ &lt;tx:annotation-driven&#x2F;&gt;ï¼Œæ ¹æ®ä¸Šæ–‡ä¸­çš„ä»‹ç»ï¼Œæˆ‘ä»¬ç›´æ¥å®šä½åˆ° <code>TxNamespaceHandler#init</code> æ–¹æ³•å¦‚ä¸‹ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œåº”è¯¥å…³æ³¨ &lt;tx:annotation-driven&#x2F;&gt; æ ‡ç­¾å¯¹åº”çš„ AnnotationDrivenBeanDefinitionParserã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    registerBeanDefinitionParser(<span class="string">&quot;advice&quot;</span>, <span class="keyword">new</span> <span class="title class_">TxAdviceBeanDefinitionParser</span>());</span><br><span class="line">    registerBeanDefinitionParser(<span class="string">&quot;annotation-driven&quot;</span>, <span class="keyword">new</span> <span class="title class_">AnnotationDrivenBeanDefinitionParser</span>());</span><br><span class="line">    registerBeanDefinitionParser(<span class="string">&quot;jta-transaction-manager&quot;</span>, <span class="keyword">new</span> <span class="title class_">JtaTransactionManagerBeanDefinitionParser</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AnnotationDrivenBeanDefinitionParser ç±»å®ç°äº† BeanDefinitionParser æ¥å£ï¼Œç›´æ¥çœ‹æ¥å£çš„ parse æ–¹æ³•å®ç°ã€‚ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯å‘ spring å®¹å™¨æ³¨å†Œäº†ä¸€ä¸ª TransactionalEventListenerFactory ç›¸å…³çš„ beanï¼Œè¿™ä¸ª bean çš„ä½œç”¨æš‚æ—¶æ²¡æœ‰æ·±ç©¶ã€‚æ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ª if-else åˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯è¯´ spring çš„äº‹åŠ¡å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼Œå¦‚æœåœ¨ &lt;tx:annotation-driven&#x2F;&gt; æ ‡ç­¾ä¸­æŒ‡å®šäº† mode å±æ€§ä¸º â€œaspectjâ€ï¼Œé‚£ä¹ˆå°±ä¼šå®ç° aspectj æ¨¡å¼çš„äº‹åŠ¡æœºåˆ¶ï¼Œå¦åˆ™å°±æ˜¯é€šè¿‡ä»£ç†çš„æ–¹å¼å®ç°äº‹åŠ¡ï¼Œå½“ç„¶ spring é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯é‡‡ç”¨çš„ä»£ç†æ–¹å¼æ¥å®ç°äº‹åŠ¡å¤„ç†ï¼Œè¿™ä¹Ÿå°±æ˜¯å¼€ç¯‡è¯´ Spring äº‹åŠ¡æœºåˆ¶è·Ÿ Spring AOP å®ç°åŸç†æœ‰å…³çš„åŸå› ã€‚aspectj æ¨¡å¼è¿™é‡Œæ²¡åšæ·±å…¥çš„äº†è§£ï¼Œä»¥åå¦‚æœç”¨ä¸Šäº†å°±å†çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> BeanDefinition <span class="title function_">parse</span><span class="params">(Element element, ParserContext parserContext)</span> &#123;</span><br><span class="line">    registerTransactionalEventListenerFactory(parserContext);	<span class="comment">// æ ¹æœ¬å°±æ˜¯å‘ spring å®¹å™¨æ³¨å†Œäº†ä¸€ä¸ª TransactionalEventListenerFactory ç›¸å…³çš„ bean</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mode</span> <span class="operator">=</span> element.getAttribute(<span class="string">&quot;mode&quot;</span>);	<span class="comment">// é»˜è®¤æ˜¯é€šè¿‡ proxy çš„æ–¹å¼</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;aspectj&quot;</span>.equals(mode)) &#123;	<span class="comment">// è¿™é‡Œè¯´æ˜äº‹åŠ¡æ”¯æŒçš„å®ç°æœ‰ä¸¤ç§æ–¹å¼ï¼Œaspectj å’Œ proxy çš„æ–¹å¼</span></span><br><span class="line">        <span class="comment">// mode=&quot;aspectj&quot;	// è¿™ç§æ¨¡å¼æ²¡æ¥è§¦è¿‡ï¼Œæš‚ä¸äº†è§£</span></span><br><span class="line">        registerTransactionAspect(element, parserContext);</span><br><span class="line">        <span class="keyword">if</span> (ClassUtils.isPresent(<span class="string">&quot;javax.transaction.Transactional&quot;</span>, getClass().getClassLoader())) &#123;</span><br><span class="line">            registerJtaTransactionAspect(element, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;<span class="comment">// ä¸»è¦æ˜¯å‘ spring å®¹å™¨æ³¨å†Œäº†å››ä¸ª BeanDefinitionï¼ŒåŒ…æ‹¬ AnnotationTransactionAttributeSourceã€TransactionInterceptorã€BeanFactoryTransactionAttributeSourceAdvisor</span></span><br><span class="line">        <span class="comment">// mode=&quot;proxy&quot; ä»¥åŠ CompositeComponentDefinitionï¼Œéƒ½å®Œæˆäº†ä¸€äº›å±æ€§çš„è®¾ç½®</span></span><br><span class="line">        AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥çœ‹ else åˆ†æ”¯ï¼Œå®ƒå°±æ˜¯è°ƒç”¨äº† <code>AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext);</code> æ–¹æ³•ï¼Œé‡Œè¾¹çš„å®ç°å…¶å®å°±æ˜¯è·Ÿ Spring AOP çš„å®ç°ä¸€æ ·çš„å¥—è·¯ï¼Œä»£ç å¦‚ä¸‹ï¼Œä¸è¿‡è¿™é‡Œæ³¨å†Œçš„ bean ç¨å¤šï¼Œæœ‰äº”ä¸ªåŒ…æ‹¬ InfrastructureAdvisorAutoProxyCreator(å®ç°äº† SmartInstantiationAwareBeanPostProcessor æ¥å£ï¼Œè´Ÿè´£ä»£ç†ç±»çš„ç”Ÿæˆ)ã€AnnotationTransactionAttributeSourceï¼ˆä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨ä¸€äº›äº‹åŠ¡ç›¸å…³çš„å±æ€§ä¿¡æ¯ï¼‰ã€TransactionInterceptorï¼ˆäº‹åŠ¡å®ç°çš„æ ¸å¿ƒæ‹¦æˆªå™¨ï¼Œäº‹åŠ¡çš„å›æ»šéƒ½æ˜¯åœ¨å…¶ä¸­å®Œæˆï¼‰ã€BeanFactoryTransactionAttributeSourceAdvisorï¼ˆå¢å¼ºå™¨ï¼‰<br>ä»¥åŠ CompositeComponentDefinitionï¼ˆä¸Šè¿°ä¸‰ç§ bean çš„ç»„åˆï¼‰ã€‚è¯·ç•™æ„è¿™äº› beanï¼Œå› ä¸ºåœ¨åè¾¹çš„äº‹åŠ¡å®ç°ä¸­ï¼Œé™¤äº†æœ€åä¸€ä¸ªç»„åˆ beanï¼Œå‡æœ‰æ¶‰åŠåˆ°ã€‚è¿˜æœ‰å°±æ˜¯è¦æ³¨æ„è¿™å¥ä»£ç  <code>advisorDef.getPropertyValues().add(&quot;adviceBeanName&quot;, interceptorName);</code>ï¼ŒadvisorDef ä»£è¡¨çš„å°±æ˜¯ BeanFactoryTransactionAttributeSourceAdvisor ç±»å¯¹åº”çš„ BeanDefinitionï¼Œè€Œ interceptorName å°±æ˜¯ TransactionInterceptor å®ä¾‹åœ¨ spring å®¹å™¨ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå½“æ‰§è¡Œå®Œè¿™æ¡ä»£ç åï¼Œé‚£ä¹ˆ advisor å°±ç®—æ˜¯æŒæœ‰äº† TransactionInterceptor çš„å”¯ä¸€æ ‡è¯†ç¬¦äº†ï¼Œä¹Ÿå°±èƒ½å¤Ÿé—´æ¥çš„è·å–åˆ° spring å®¹å™¨ä¸­çš„ TransactionInterceptor å®ä¾‹äº†ã€‚<br><code>interceptorDef.getPropertyValues().add(&quot;transactionAttributeSource&quot;, new RuntimeBeanReference(sourceName));</code> è¿™å¥ä»£ç çš„ä½œç”¨åŒç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureAutoProxyCreator</span><span class="params">(Element element, ParserContext parserContext)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¸å¿ƒå°±æ˜¯æ³¨å†Œäº† InfrastructureAdvisorAutoProxyCreator å¯¹åº”çš„ beanï¼Œå¹¶è®¾ç½®äº†å®ƒåˆ›å»ºä»£ç†çš„æ–¹å¼</span></span><br><span class="line">    AopNamespaceUtils.registerAutoProxyCreatorIfNecessary(parserContext, element);</span><br><span class="line">    <span class="type">String</span> <span class="variable">txAdvisorBeanName</span> <span class="operator">=</span> TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME;	<span class="comment">// å’Œäº‹åŠ¡ç›¸å…³çš„å¢å¼ºå™¨å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="keyword">if</span> (!parserContext.getRegistry().containsBeanDefinition(txAdvisorBeanName)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">eleSource</span> <span class="operator">=</span> parserContext.extractSource(element);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the TransactionAttributeSource definition.</span></span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">sourceDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(	<span class="comment">// è¿™ä¸€éƒ¨åˆ†å°±æ˜¯åˆ›å»ºä¸€ä¸ª RootBeanDefinitionï¼ŒæŒæœ‰äº† eleSourceï¼Œè§’è‰²ä¸º ROLE_INFRASTRUCTUREï¼Œå¹¶è¿›è¡Œäº†æ³¨å†Œ</span></span><br><span class="line">                <span class="string">&quot;org.springframework.transaction.annotation.AnnotationTransactionAttributeSource&quot;</span>);</span><br><span class="line">        sourceDef.setSource(eleSource);</span><br><span class="line">        sourceDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceName</span> <span class="operator">=</span> parserContext.getReaderContext().registerWithGeneratedName(sourceDef);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the TransactionInterceptor definition.	// TransactionInterceptor å®ç°äº† MethodInterceptor æ¥å£ï¼Œè¯´æ˜å®ƒå¯ä»¥è¢«å½“åšæ–¹æ³•æ‹¦æˆªå™¨ä½¿ç”¨</span></span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">interceptorDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(TransactionInterceptor.class);	<span class="comment">// è¿™ä¸€éƒ¨åˆ†å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª TransactionInterceptor å¯¹åº”çš„ RootBeanDefinition</span></span><br><span class="line">        interceptorDef.setSource(eleSource);	<span class="comment">// æŒæœ‰äº† eleSourceï¼Œè§’è‰²ä¸º ROLE_INFRASTRUCTURE</span></span><br><span class="line">        interceptorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        registerTransactionManager(element, interceptorDef);	<span class="comment">// ä¸ºå½“å‰ BeanDefinition æ·»åŠ äº†ä¸€ä¸ª transactionManagerBeanName å±æ€§</span></span><br><span class="line">        interceptorDef.getPropertyValues().add(<span class="string">&quot;transactionAttributeSource&quot;</span>, <span class="keyword">new</span> <span class="title class_">RuntimeBeanReference</span>(sourceName));	<span class="comment">// ä¸ºå½“å‰ BeanDefinition æ·»åŠ äº†ä¸€ä¸ª transactionAttributeSource å±æ€§</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">interceptorName</span> <span class="operator">=</span> parserContext.getReaderContext().registerWithGeneratedName(interceptorDef);	<span class="comment">// æ³¨å†Œå½“å‰çš„ RootBeanDefinition</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the TransactionAttributeSourceAdvisor definition.	// Advisor åç¼€ï¼ŒçŒœæµ‹å®ƒèƒ½å½“åšå¢å¼ºä½¿ç”¨</span></span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">advisorDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(BeanFactoryTransactionAttributeSourceAdvisor.class);	<span class="comment">// æ„å»º BeanFactoryTransactionAttributeSourceAdvisor å¯¹åº”çš„ RootBeanDefinition</span></span><br><span class="line">        advisorDef.setSource(eleSource);</span><br><span class="line">        advisorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        advisorDef.getPropertyValues().add(<span class="string">&quot;transactionAttributeSource&quot;</span>, <span class="keyword">new</span> <span class="title class_">RuntimeBeanReference</span>(sourceName));	<span class="comment">// æŒ‡å®šäº† transactionAttributeSource å’Œ adviceBeanName å±æ€§</span></span><br><span class="line">        advisorDef.getPropertyValues().add(<span class="string">&quot;adviceBeanName&quot;</span>, interceptorName);</span><br><span class="line">        <span class="keyword">if</span> (element.hasAttribute(<span class="string">&quot;order&quot;</span>)) &#123;</span><br><span class="line">            advisorDef.getPropertyValues().add(<span class="string">&quot;order&quot;</span>, element.getAttribute(<span class="string">&quot;order&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        parserContext.getRegistry().registerBeanDefinition(txAdvisorBeanName, advisorDef);</span><br><span class="line"></span><br><span class="line">        <span class="type">CompositeComponentDefinition</span> <span class="variable">compositeDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompositeComponentDefinition</span>(element.getTagName(), eleSource);</span><br><span class="line">        compositeDef.addNestedComponent(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(sourceDef, sourceName));</span><br><span class="line">        compositeDef.addNestedComponent(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(interceptorDef, interceptorName));</span><br><span class="line">        compositeDef.addNestedComponent(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(advisorDef, txAdvisorBeanName));</span><br><span class="line">        parserContext.registerComponent(compositeDef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œ &lt;tx:annotation-driven&#x2F;&gt; æ ‡ç­¾çš„è§£æè¿‡ç¨‹å°±ç®—å®Œæˆäº†ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯æ³¨å†Œäº†ä¸€ä¸ª TransactionalEventListenerFactoryï¼Œç„¶åæ ¹æ®æ ‡ç­¾å±æ€§æ¥ç¡®å®šäº‹åŠ¡çš„å®ç°æ¨¡å¼æ˜¯ aspectj è¿˜æ˜¯ proxyï¼Œå¦‚æœæ˜¯ proxy æ–¹å¼ï¼Œé‚£ä¹ˆå°±æ˜¯å‘ spring å®¹å™¨ä¸­æ³¨å†Œäº†ä¸Šè¿°çš„äº”ä¸ª beanã€‚</p>
<h2 id="æ„å»ºäº‹åŠ¡ä»£ç†ç±»"><a href="#æ„å»ºäº‹åŠ¡ä»£ç†ç±»" class="headerlink" title="æ„å»ºäº‹åŠ¡ä»£ç†ç±»"></a>æ„å»ºäº‹åŠ¡ä»£ç†ç±»</h2><p>ä¸Šæ–‡å·²ç»æåˆ°äº†åœ¨ &lt;tx:annotation-driven&#x2F;&gt; æ ‡ç­¾çš„è§£æè¿‡ç¨‹ä¸­ä¼šå‘ spring å®¹å™¨æ³¨å†Œäº”ä¸ªç±»å‹çš„ beanï¼Œæˆ‘è¿™é‡Œå†ç½—åˆ—ä¸€ä¸‹ï¼Œå› ä¸ºäº‹åŠ¡ä»£ç†ç±»çš„æ„å»ºå’Œäº‹åŠ¡æœºåˆ¶çš„å®ç°éƒ½å’Œå‰å››ä¸ªç±»å‹çš„ bean æ¯æ¯ç›¸å…³ï¼Œå…³äºä»–ä»¬çš„ä½œç”¨æˆ‘éƒ½è¿›è¡Œäº†è¯´æ˜ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª bean å°±æ˜¯ç”¨æ¥æ„å»ºäº‹åŠ¡ä»£ç†ç±»çš„ï¼Œå®ƒçš„å®ç°æ¨¡å¼è·Ÿ spring aop åŸºæœ¬ä¸€è‡´ã€‚</p>
<ul>
<li><p>InfrastructureAdvisorAutoProxyCreator(å®ç°äº† SmartInstantiationAwareBeanPostProcessor æ¥å£ï¼Œè´Ÿè´£ä»£ç†ç±»çš„ç”Ÿæˆ)</p>
</li>
<li><p>AnnotationTransactionAttributeSourceï¼ˆä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨ä¸€äº›äº‹åŠ¡ç›¸å…³çš„å±æ€§ä¿¡æ¯ï¼‰</p>
</li>
<li><p>TransactionInterceptorï¼ˆäº‹åŠ¡å®ç°çš„æ ¸å¿ƒæ‹¦æˆªå™¨ï¼Œäº‹åŠ¡çš„å›æ»šéƒ½æ˜¯åœ¨å…¶ä¸­å®Œæˆï¼‰</p>
</li>
<li><p>BeanFactoryTransactionAttributeSourceAdvisorï¼ˆå¢å¼ºå™¨ï¼‰</p>
</li>
<li><p>CompositeComponentDefinitionï¼ˆä¸Šè¿°ä¸‰ç§ bean çš„ç»„åˆï¼‰</p>
</li>
</ul>
<p>InfrastructureAdvisorAutoProxyCreator å®ç°äº† SmartInstantiationAwareBeanPostProcessor æ¥å£ï¼ŒæŒ‰ç…§ä¸Šä¸€ç¯‡æ–‡ç« æ‰€è¯´çš„ï¼Œæˆ‘ä»¬ç›´æ¥å…³æ³¨åˆ°äº‹åŠ¡ä»£ç†ç±»åˆ›å»ºçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessAfterInitialization</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// å°è¯•ä»ç¼“å­˜ä¸­è·å–ä»£ç† beanï¼Œæ²¡æœ‰çš„è¯è¿›è¡Œæ„å»ºï¼Œæ ¸å¿ƒå°±æ˜¯æ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(<span class="meta">@Nullable</span> Object bean, String beanName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">cacheKey</span> <span class="operator">=</span> getCacheKey(bean.getClass(), beanName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;</span><br><span class="line">            <span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);	<span class="comment">// æ ¸å¿ƒå°±æ˜¯æ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†ä»£ç åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å·²ç»è¯´è¿‡äº†ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ï¼Œä½†æ˜¯åœ¨ wrapIfNecessary æ–¹æ³•çš„å®ç°ä¸­ï¼Œå’Œ spring aop åŸç†åˆ†æä¸­çš„æ ·ä¾‹ä»£ç ä¸ä¸€æ ·ï¼Œè¿™é‡Œé€šè¿‡ <code>getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</code> è·å–åˆ°çš„ specificInterceptors åªæœ‰ä¸€ä¸ªå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™ä¸ªè·Ÿ spring aop åŸç†åˆ†ææ–‡ç« ä¸­å¾—åˆ°çš„å’Œ @Beforeã€@Afterã€@Around ä¸‰ä¸ªæ³¨è§£ä»£è¡¨çš„ Advisor ç›¸å¯¹åº”ã€‚å¥½äº†è‡ªå·±çœ‹çœ‹ç°åœ¨è·å–åˆ°çš„è¿™ä¸ª Advisor çš„ç±»å‹ï¼Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰å‘¢ï¼Ÿï¼Ÿæ²¡é”™è¿™ä¸ª advisor å°±æ˜¯ä¸Šæ–‡ä¸­æå‡ºçš„é‚£ä¸ªäº”ä¸ª bean å½“ä¸­çš„ä¸€ä¸ªã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/0c36424c3dd178707b5f7641852de18c.jpg" width=600 /></div>

<center>æœ¬ä¾‹ä¸­å”¯ä¸€çš„ Advisor</center>

<p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦ä»£ç†ï¼Œå¦‚æœæ˜¯ï¼Œè·å–æ»¡è¶³ beanClass çš„ advisorï¼Œç„¶åæ„å»ºä»£ç†ç±»ï¼šéªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Boolean.FALSE.equals(<span class="built_in">this</span>.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;	<span class="comment">// æ— éœ€ä»£ç†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        <span class="keyword">return</span> bean;	<span class="comment">// åŸºç¡€ç±»å’Œåº”è·³è¿‡çš„ç±»ç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create proxy if we have advice.	// è·å–æ»¡è¶³ beanClass çš„ advisorï¼Œè¿›è¡Œè¿‡æ’åº</span></span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        <span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);	<span class="comment">// æ‰€ä»¥è¿™ä¸ªé›†åˆå­˜æ”¾çš„æ˜¯å¯¹åº”çš„ bean æ˜¯å¦å¢å¼ºçš„ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> createProxy(	<span class="comment">// éªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line">                bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> <span class="title class_">SingletonTargetSource</span>(bean));</span><br><span class="line">        <span class="built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿™ä¸ªé›†åˆå­˜æ”¾çš„æ˜¯å¯¹åº”çš„ bean æ˜¯å¦å¢å¼ºçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‹¿åˆ°è¿™ä¸ª advisor åå°±æ˜¯æ„å»ºä»£ç†ç±»ï¼Œä¸Šç¯‡æ–‡ç« ä¸­èµ°çš„æ˜¯ cglib ä»£ç†åˆ†æ”¯ï¼Œè€Œç°åœ¨èµ°çš„æ˜¯ jdk ä»£ç†æ–¹å¼çš„åˆ†æ”¯ï¼Œåˆ¤æ–­çš„é€»è¾‘æ˜¯ç”±ä¸‹è¾¹ä»£ç çš„ <code>evaluateProxyInterfaces(beanClass, proxyFactory);</code> è¿™ä¸€è¡Œæ‰€å†³å®šçš„ï¼Œè¯¥è¡Œä»£ç ä¼šçœ‹ç›®æ ‡ class æ˜¯å¦æœ‰å¯ä»¥ä»£ç†çš„æ¥å£ï¼Œæœ‰çš„è¯å°†æ¥å£ class æ·»åŠ åˆ° proxyFactory ä¸­ï¼Œå¦åˆ™è®¾ç½®ä»£ç†æ–¹å¼ä¸ºä»£ç†ç›®æ ‡ç±»å³ cglib çš„æ–¹å¼ã€‚å› ä¸ºæˆ‘ä»¬çš„ç›®æ ‡ç±»æ˜¯ UserServiceImplï¼Œå®ƒå®ç°äº† UserService æ¥å£ï¼Œå› æ­¤æ˜¯æ»¡è¶³ jdk åŠ¨æ€ä»£ç†æ¡ä»¶çš„ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ä¸‹è¾¹çš„æ–¹æ³•é€šè¿‡å‚æ•°ä¼ å…¥çš„ specificInterceptors è¢«è½¬æ¢ä¸ºäº† Advisorï¼Œå®ƒåˆè¢«ä¼ å…¥äº† proxyFactory ä¸­ï¼Œæ‰€ä»¥ proxyFactory æ˜¯æŒæœ‰äº†æˆ‘ä»¬ Advisor çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createProxy</span><span class="params">(Class&lt;?&gt; beanClass, <span class="meta">@Nullable</span> String beanName,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> Object[] specificInterceptors, TargetSource targetSource)</span> &#123;	<span class="comment">// TargetSource å°è£…äº†æˆ‘ä»¬çš„ç›®æ ‡å®ä¾‹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;</span><br><span class="line">        AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) <span class="built_in">this</span>.beanFactory, beanName, beanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ProxyFactory</span> <span class="variable">proxyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyFactory</span>();</span><br><span class="line">    proxyFactory.copyFrom(<span class="built_in">this</span>);	<span class="comment">// å½“å‰ç±»çš„å±æ€§å¤åˆ¶åˆ° ProxyFactory ä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!proxyFactory.isProxyTargetClass()) &#123;	<span class="comment">// è¿™é‡Œå°±æ˜¯åˆ¤æ–­ä»£ç†ç›®æ ‡ç±»è¿˜æ˜¯æ¥å£åˆ†åˆ«å¯¹åº” cglib å’Œ jdk ä»£ç†æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (shouldProxyTargetClass(beanClass, beanName)) &#123;	<span class="comment">// çœ‹æ˜¯å¦å±æ€§å€¼æŒ‡å®šäº† org.springframework.aop.framework.autoproxy.AutoProxyUtils.preserveTargetClassï¼Œè¿™ç§æƒ…å†µé‡‡ç”¨ç›®æ ‡ç±»ä»£ç†æ–¹å¼ cglib</span></span><br><span class="line">            proxyFactory.setProxyTargetClass(<span class="literal">true</span>);	<span class="comment">// è¿™é‡Œè®¾ç½®ä»£ç†æ–¹å¼ä¸º cglib</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;	<span class="comment">// çœ‹ç›®æ ‡ class æ˜¯å¦æœ‰å¯ä»¥ä»£ç†çš„æ¥å£ï¼Œæœ‰çš„è¯å°†æ¥å£ class æ·»åŠ åˆ° proxyFactory ä¸­ï¼Œå¦åˆ™è®¾ç½®ä»£ç†æ–¹å¼ä¸ºä»£ç†ç›®æ ‡ç±»</span></span><br><span class="line">            evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å…¬æœ‰çš„ interceptorsï¼Œç„¶åå’Œ specificInterceptors ä¸€èµ·æ„å»ºä¸º advisors è¿”å›</span></span><br><span class="line">    Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">    proxyFactory.addAdvisors(advisors);</span><br><span class="line">    proxyFactory.setTargetSource(targetSource);	<span class="comment">// è¿™ä¸ªå‚æ•°æŒæœ‰äº†ä»£ç†ç›®æ ‡</span></span><br><span class="line">    customizeProxyFactory(proxyFactory);</span><br><span class="line"></span><br><span class="line">    proxyFactory.setFrozen(<span class="built_in">this</span>.freezeProxy);</span><br><span class="line">    <span class="keyword">if</span> (advisorsPreFiltered()) &#123;	<span class="comment">// advisors é¢„è¿‡æ»¤</span></span><br><span class="line">        proxyFactory.setPreFiltered(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br><span class="line">    <span class="keyword">return</span> proxyFactory.getProxy(getProxyClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çŸ¥é“è¦é‡‡ç”¨ jdk åŠ¨æ€ä»£ç†çš„æ–¹å¼åï¼Œæˆ‘ä»¬å°±ç»†çœ‹è¿™ä¸ªä»£ç†ç±»æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Œå¯¹åº”çš„ InvocationHandler åˆæ˜¯æ€æ ·çš„ï¼Œä¹‹æ‰€ä»¥å…³æ³¨ InvocationHandlerï¼Œæ˜¯å› ä¸º jdk ä»£ç†ç±»çš„æ ¹æœ¬é€»è¾‘è¿˜æ˜¯è°ƒç”¨ InvocationHandler å®ä¾‹çš„ invoke æ–¹æ³•ã€‚æˆ‘ä»¬ç›´æ¥çœ‹ä¸Šè¾¹ä»£ç å—çš„æœ€åä¸€å¥å³ <code>return proxyFactory.getProxy(getProxyClassLoader());</code> ã€‚å®ƒçš„å®ç°å¦‚ä¸‹ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä»£ç†ç±»</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> createAopProxy().getProxy(classLoader);	<span class="comment">// jdkï¼šè·å–å¿…é¡»çš„æ¥å£ä¿¡æ¯ï¼Œæ„å»ºä»£ç†ç±»ï¼Œinvocation handler å°±æ˜¯ JdkDynamicAopProxy å®ä¾‹</span></span><br><span class="line">&#125;	<span class="comment">// cglibï¼šéªŒè¯ä»£ç†å·¥å‚é•¿æŒæœ‰çš„ç›®æ ‡ç±»ï¼Œç„¶åæ„å»º enhancerï¼Œæ ¹æ® enhancer æ„å»ºä»£ç†ç±» classï¼Œç„¶åé€šè¿‡ class æ„å»ºä»£ç†ç±»å®ä¾‹ï¼Œæœ€åå°† callbacks è®¾ç½®åˆ°å…¶ä¸­</span></span><br></pre></td></tr></table></figure>

<p>é€»è¾‘è·Ÿ aop å®ç°çš„åˆ†ææ˜¯ä¸€æ ·çš„ï¼Œç¬¬ä¸€æ®µä»£ç æ‰§è¡Œçš„ç»“æœå¯ä»¥ç®—ä½œæ˜¯ä¸€ä¸ªå·¥å‚ç±»ï¼Œé€šè¿‡ä¸‹è¾¹çš„ä»£ç æˆ‘ä»¬çŸ¥é“æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ª JdkDynamicAopProxy å®ä¾‹ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨å®ƒçš„ getProxy æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AopProxy <span class="title function_">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException &#123;</span><br><span class="line">    <span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">        Class&lt;?&gt; targetClass = config.getTargetClass();	<span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜é‡‡ç”¨ cglib ä»£ç†æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (targetClass == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AopConfigException</span>(<span class="string">&quot;TargetSource cannot determine target class: &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;Either an interface or a target is required for proxy creation.&quot;</span>);</span><br><span class="line">        &#125;	<span class="comment">// ç›®æ ‡ç±»æ˜¯æ¥å£æˆ–è€…æ˜¯ Proxy æ¥å£å®ç°ç±»ï¼Œé‚£ä¹ˆè¿›è¡Œ jdk ä»£ç†</span></span><br><span class="line">        <span class="keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdkDynamicAopProxy</span>(config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjenesisCglibAopProxy</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdkDynamicAopProxy</span>(config);	<span class="comment">// è¿™é‡Œå°±æ˜¯è¿›è¡Œ jdk ä»£ç†æ–¹å¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹è¾¹å°±æ˜¯ <code>JdkDynamicAopProxy#getProxy(java.lang.ClassLoader)</code> æ–¹æ³•çš„å®ç°ï¼Œç†Ÿæ‚‰ jdk åŠ¨æ€ä»£ç†çš„å°ä¼™ä¼´åº”è¯¥ç«‹å³å°±èƒ½çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„é€šè¿‡ Proxy ç±»åˆ›å»º jdk ä»£ç†ç±»çš„è¿‡ç¨‹ã€‚å…¶ä¸­ proxiedInterfaces å‚æ•°ä»£è¡¨ç€åˆ›å»ºçš„ä»£ç†ç±»éœ€è¦å®ç°çš„æ¥å£ç±»å‹ã€‚è€Œç´§è·Ÿçš„é‚£ä¸ªå‚æ•° this å…¶å®å°±æ˜¯ InvocationHandler å®ä¾‹äº†ã€‚å¦‚æœæˆ‘ä»¬æ‰§è¡Œä»£ç†ç±»çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥å®ä¾‹çš„ invoke æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨ï¼Œè¿™æ˜¯æœ¬æ–‡ä¸‹ä¸€éƒ¨åˆ†å°†è¦åˆ†æçš„å†…å®¹ã€‚</p>
<p>è®°ä½è¿™é‡Œçš„ this ä»£è¡¨ç€ JdkDynamicAopProxy ç±»ï¼Œå¯ä»¥è‚¯å®šå®ƒå®ç°äº† InvocationHandler æ¥å£ï¼Œè€Œä¸”å®ƒæŒæœ‰äº† ProxyFactory å®ä¾‹ï¼Œä¸Šæ–‡æˆ‘ä»¬æŒ‡å‡ºè¿‡ ProxyFactory åˆæŒæœ‰äº†æœ¬ä¾‹ä¸­å”¯ä¸€çš„ Advisorï¼Œæ‰€ä»¥å¯ä»¥è¯´æˆ‘ä»¬çš„ InvocationHandler ä¹Ÿæ˜¯é—´æ¥çš„æŒæœ‰äº†è¿™ä¸ªå”¯ä¸€çš„ Advisorã€‚</p>
<p>proxiedInterfaces æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œè¿™å°±è¯´æ˜æˆ‘ä»¬çš„ä»£ç†ç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œå°±æ‹¿æœ¬ä¾‹æ¥è¯´ï¼Œæˆ‘æŠŠæ‰€æœ‰çš„æ¥å£ç±»å‹è´´åœ¨ä¸‹è¾¹ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ€å…³å¿ƒçš„ UserService æ¥å£å°±åœ¨å…¶ä¸­ï¼Œè‡³äºå…¶å®ƒçš„å‡ ä¸ªæ¥å£æ€ä¹ˆæ¥çš„è¯·è‡ªè¡ŒæŸ¥çœ‹ <code>AopProxyUtils.completeProxiedInterfaces(this.advised, true);</code> æ–¹æ³•çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// è·å–å¿…é¡»çš„æ¥å£ä¿¡æ¯ï¼Œæ„å»ºä»£ç†ç±»ï¼Œinvocation handler å°±æ˜¯ JdkDynamicAopProxy å®ä¾‹</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Creating JDK dynamic proxy: &quot;</span> + <span class="built_in">this</span>.advised.getTargetSource());</span><br><span class="line">    &#125;	<span class="comment">// è·å–å…¨éƒ¨çš„ä»£ç†æ¥å£é›†åˆï¼ŒåŒ…æ‹¬ advised ä¸­è·å–çš„å…¨éƒ¨æ¥å£é›†åˆä»¥åŠåˆ¶å®šçš„ä¸‰ä¸ªæ¥å£</span></span><br><span class="line">    Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(<span class="built_in">this</span>.advised, <span class="literal">true</span>);</span><br><span class="line">    findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);	<span class="comment">// çœ‹æ¥å£ä¸­æ˜¯å¦å®šä¹‰äº† equals å’Œ hashcode æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(classLoader, proxiedInterfaces, <span class="built_in">this</span>);	<span class="comment">// æ„å»ºä»£ç†ç±»ï¼Œinvocation handler å°±æ˜¯å½“å‰å®ä¾‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/78484ac56ecacdb392d82c6c39fe7e8e.jpg" width=600 /></div>

<center>æœ¬ä¾‹äº‹åŠ¡ä»£ç†ç±»å®ç°çš„æ¥å£</center>

<p>

<p>å¯¹ä»£ç†ç±»çš„åˆ›å»ºè¿‡ç¨‹è¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼Œæˆ‘ä»¬é¦–å…ˆæ˜¯ä»ç¯å¢ƒä¸­è·å–åˆ°äº†æœ¬ä¾‹ä¸­å”¯ä¸€çš„ä¸€ä¸ª advisorï¼Œå°†å…¶æ³¨å…¥åˆ°äº† ProxyFactory ä¸­ï¼Œç„¶åå°±æ˜¯é€šè¿‡ ProxyFactory æ¥æ„å»º JdkDynamicAopProxy å®ä¾‹ï¼Œå®ƒå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå·¥å‚ç±»ï¼Œæœ€åå°±æ˜¯é€šè¿‡å®ƒæ¥æ„å»ºæˆ‘ä»¬çš„ä»£ç†ç±»ï¼Œä»£ç†ç±»å®ç°äº†ä¸Šå›¾ä¸­çš„å››ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æœ¬ä¾‹å…³å¿ƒçš„ UserService æ¥å£å°±åœ¨å…¶ä¸­ï¼Œä¼ å…¥çš„ InvocationHandler å°±æ˜¯ JdkDynamicAopProxy å®ä¾‹ï¼Œä¸‹ä¸€éƒ¨åˆ†çš„å†…å®¹å°±æ˜¯çœ‹è¯¥å®ä¾‹çš„ invoke æ–¹æ³•å®ç°ã€‚</p>
<h2 id="äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹"><a href="#äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹"></a>äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹</h2><p>ä¸Šæ–‡å·²ç»æŒ‡å‡ºäº†ä»£ç†ç±»åœ¨æ‰§è¡Œç›®æ ‡æ–¹æ³•æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨ InvocationHandler çš„ invoke æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åˆ†æ invoke æ–¹æ³•çš„å®ç°æ˜¯æ€æ ·çš„ã€‚æˆ‘å·²ç»å°† invoke æ–¹æ³•çš„å®ç°ä»£ç è´´å‡ºæ¥äº†ï¼Œå†…å®¹æ¯”è¾ƒé•¿ï¼Œä½†æˆ‘ä»¬çœŸæ­£éœ€è¦å…³å¿ƒçš„å°±æ˜¯ååŠéƒ¨åˆ†ï¼Œå‰è¾¹çš„ä»£ç åªæ˜¯é’ˆå¯¹ç‰¹æ®Šæ–¹æ³•è°ƒç”¨çš„å¤„ç†ï¼Œæˆ‘æš‚æ—¶æ²¡æœ‰å»æ·±å…¥äº†è§£ï¼ŒåŒæ ·çš„ä¸å½±å“æˆ‘ä»¬å¯¹äº spring äº‹åŠ¡æœºåˆ¶å®ç°åŸç†çš„ç†è§£ã€‚è·Ÿ cglib ä»£ç†æ–¹å¼ä¸€æ ·ï¼Œæœ¬æ®µä»£ç ä¸­ <code>if (this.advised.exposeProxy)</code> è¿™ä¸ªä»£ç å—ä¹Ÿå¯¹ä»£ç†ç±»çš„æš´éœ²è¿›è¡Œäº†å¤„ç†ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨æˆ‘ä»¬çš„ç”¨æˆ·ä»£ç ä¸­æ‹¿åˆ°å½“å‰ä»£ç†ç±»ï¼Œè¯¦ç»†çš„ä½¿ç”¨æ–¹å¼å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« çš„ç¤ºä¾‹ä»£ç äºŒã€‚</p>
<blockquote>
<p>org.springframework.aop.framework.JdkDynamicAopProxy#invoke</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">oldProxy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">setProxyContext</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">TargetSource</span> <span class="variable">targetSource</span> <span class="operator">=</span> <span class="built_in">this</span>.advised.targetSource;	<span class="comment">// è¿™é‡Œæ˜¯ç›®æ ‡ç±»</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;	<span class="comment">// å¯¹äº equals æ–¹æ³•çš„å¤„ç†</span></span><br><span class="line">            <span class="comment">// The target does not implement the equals(Object) method itself.</span></span><br><span class="line">            <span class="keyword">return</span> equals(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;	<span class="comment">// å¯¹äº hashcode æ–¹æ³•çš„å¤„ç†</span></span><br><span class="line">            <span class="comment">// The target does not implement the hashCode() method itself.</span></span><br><span class="line">            <span class="keyword">return</span> hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (method.getDeclaringClass() == DecoratingProxy.class) &#123;	<span class="comment">// å¯¹äº DecoratingProxy æ¥å£æ–¹æ³•çš„å¤„ç†</span></span><br><span class="line">            <span class="comment">// There is only getDecoratedClass() declared -&gt; dispatch to proxy config.</span></span><br><span class="line">            <span class="keyword">return</span> AopProxyUtils.ultimateTargetClass(<span class="built_in">this</span>.advised);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;	<span class="comment">// å¯¹äº Advised æ¥å£å®ç°ç±»æ–¹æ³•çš„å¤„ç†</span></span><br><span class="line">                method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">            <span class="comment">// Service invocations on ProxyConfig with the proxy config...</span></span><br><span class="line">            <span class="keyword">return</span> AopUtils.invokeJoinpointUsingReflection(<span class="built_in">this</span>.advised, method, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object retVal;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.advised.exposeProxy) &#123;	<span class="comment">// çœ‹æ˜¯å¦éœ€è¦æš´éœ²ä»£ç†ç±»</span></span><br><span class="line">            <span class="comment">// Make invocation available if necessary.</span></span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get as late as possible to minimize the time we &quot;own&quot; the target,</span></span><br><span class="line">        <span class="comment">// in case it comes from a pool.</span></span><br><span class="line">        target = targetSource.getTarget();	<span class="comment">// è·å–ç›®æ ‡å®ä¾‹</span></span><br><span class="line">        Class&lt;?&gt; targetClass = (target != <span class="literal">null</span> ? target.getClass() : <span class="literal">null</span>);	<span class="comment">// è·å–ç›®æ ‡å®ä¾‹ç±»</span></span><br><span class="line">        <span class="comment">// å°è¯•ä»ç¼“å­˜ä¸­è·å– interceptorListï¼Œæ²¡æœ‰çš„è¯å°±ä»å½“å‰å®ä¾‹ä¸­è·å–ï¼ˆè·å– Advised çš„å…¨éƒ¨ advisorsï¼Œçœ‹ advisor æ˜¯å¦é€‚é…å½“å‰æ–¹æ³•ï¼Œé€‚é…çš„è¯ä» advisor ä¸­è·å–åˆ° Adviceï¼Œç„¶åå°†å…¶æ·»åŠ åˆ° interceptorList é›†åˆè¿”å›ï¼‰</span></span><br><span class="line">        <span class="comment">// Get the interception chain for this method.</span></span><br><span class="line">        List&lt;Object&gt; chain = <span class="built_in">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check whether we have any advice. If we don&#x27;t, we can fallback on direct</span></span><br><span class="line">        <span class="comment">// reflective invocation of the target, and avoid creating a MethodInvocation.</span></span><br><span class="line">        <span class="keyword">if</span> (chain.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// We can skip creating a MethodInvocation: just invoke the target directly</span></span><br><span class="line">            <span class="comment">// Note that the final invoker must be an InvokerInterceptor so we know it does</span></span><br><span class="line">            <span class="comment">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span></span><br><span class="line">            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// We need to create a method invocation...</span></span><br><span class="line">            <span class="type">MethodInvocation</span> <span class="variable">invocation</span> <span class="operator">=</span>	<span class="comment">// æ„å»º ReflectiveMethodInvocation æ¥æ§åˆ¶ interceptor é“¾çš„è°ƒç”¨</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ReflectiveMethodInvocation</span>(proxy, target, method, args, targetClass, chain);</span><br><span class="line">            <span class="comment">// Proceed to the joinpoint through the interceptor chain.</span></span><br><span class="line">            retVal = invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Massage return value if necessary.</span></span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        <span class="keyword">if</span> (retVal != <span class="literal">null</span> &amp;&amp; retVal == target &amp;&amp;</span><br><span class="line">                returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp;</span><br><span class="line">                !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">            <span class="comment">// Special case: it returned &quot;this&quot; and the return type of the method</span></span><br><span class="line">            <span class="comment">// is type-compatible. Note that we can&#x27;t help if the target sets</span></span><br><span class="line">            <span class="comment">// a reference to itself in another returned object.</span></span><br><span class="line">            retVal = proxy;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (retVal == <span class="literal">null</span> &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AopInvocationException</span>(</span><br><span class="line">                    <span class="string">&quot;Null return value from advice does not match primitive return type for: &quot;</span> + method);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">            <span class="comment">// Must have come from TargetSource.</span></span><br><span class="line">            targetSource.releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">            <span class="comment">// Restore old proxy.</span></span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹è¾¹ä»£ç çš„ååŠéƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬åº”è¯¥å…³æ³¨çš„ç‚¹äº†ï¼Œé¦–å…ˆæ˜¯æ‹¦æˆªå™¨é“¾çš„è·å–ï¼Œé€šè¿‡ <code>this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</code> è¿™æ®µä»£ç è¿›è¡Œï¼Œä¸Šæ–‡æˆ‘ä»¬å·²ç»æŒ‡å‡ºäº† InvocationHandler æŒæœ‰äº† ProxyFactoryï¼Œè€Œè¿™å¥ä»£ç çš„ advised å®ä¾‹å…¶å®å°±æ˜¯ ProxyFactoryï¼Œå®ƒæŒæœ‰äº†æˆ‘ä»¬å¼€ç¯‡ä¸­æŒ‡å‡ºçš„äº”ä¸ª bean ä¸­çš„ BeanFactoryTransactionAttributeSourceAdvisorï¼ˆå¢å¼ºå™¨ï¼‰å¯¹å—ï¼Ÿå¥½äº†é‚£ä¹ˆè¿™é‡Œçš„æ‹¦æˆªå™¨é“¾å°±æ˜¯é€šè¿‡å®ƒæ¥è·å–çš„ï¼Œè¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œæˆ‘ä¹Ÿä¸æƒ³ç»†ç©¶å®ƒæ¯ä¸€è¡Œä»£ç æ˜¯æ€æ ·çš„ï¼Œåªéœ€è¦äº†è§£ä¸Šæ–‡ä¸­æŒ‡å‡ºçš„ï¼Œåœ¨è¿›è¡Œæ ‡ç­¾çš„è§£ææ—¶ï¼ŒBeanFactoryTransactionAttributeSourceAdvisor å¯¹åº”çš„ BeanDefinition æ˜¯æŒæœ‰äº† TransactionInterceptor å®ä¾‹çš„å”¯ä¸€æ ‡è¯†ç¬¦çš„ï¼Œå°±å‡­è¿™ä¸€ç‚¹ï¼Œå†é€šè¿‡ BeanFactoryTransactionAttributeSourceAdvisor æ‹¿åˆ° TransactionInterceptor å°±ä¸æ˜¯ä»€ä¹ˆéš¾ä»¥ç†è§£çš„äº‹äº†ï¼Œæ‰€ä»¥è¿™é‡Œåªç»™å‡ºæœ€ç»ˆçš„è·å–ç»“æœå°±å¥½ã€‚ç‰¹åˆ«æ³¨æ„å“¦è¿™ä¸ªå”¯ä¸€çš„æ‹¦æˆªå™¨æ˜¯ä¸æ˜¯ä¹Ÿå¾ˆç†Ÿæ‚‰å•Šï¼Ÿï¼Ÿæ²¡é”™ï¼Œæ­£å¥½å°±æ˜¯æœ¬æ–‡å¼€ç¯‡æŒ‡å‡ºçš„é‚£ä¸ªäº”ä¸ª bean ä¸­çš„ TransactionInterceptorï¼ˆäº‹åŠ¡å®ç°çš„æ ¸å¿ƒæ‹¦æˆªå™¨ï¼Œäº‹åŠ¡çš„å›æ»šéƒ½æ˜¯åœ¨å…¶ä¸­å®Œæˆï¼‰å¯¹å—ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„æ‹¦æˆªå™¨ï¼Œäº‹åŠ¡çš„å®ç°å°±æ˜¯é å®ƒã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/b2be9904065f81a1b47dca8b0f998b0e.jpg" width=600 /></div>

<center>æ‹¦æˆªå™¨é“¾å†…å®¹</center>

<p>

<p>å†å›åˆ°æˆ‘ä»¬çš„åˆ†æç‚¹ï¼Œå°±æ˜¯ <code>JdkDynamicAopProxy#invoke</code> æ–¹æ³•ä¸­è·å–æ‹¦æˆªå™¨é“¾çš„é‚£å¥ï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†å¿…è¦çš„æ‹¦æˆªå™¨é“¾ï¼Œé‡Œè¾¹å°±åªæœ‰ä¸€ä¸ªæ‹¦æˆªå™¨ TransactionInterceptorã€‚æ¥ç€å°±æ˜¯ä¸€ä¸ª if-else åˆ†æ”¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„æ‹¦æˆªå™¨é“¾æ˜¯æœ‰å†…å®¹çš„ï¼Œæ‰€ä»¥èµ° else åˆ†æ”¯å¦‚ä¸‹ï¼Œé‡Œè¾¹çš„é€»è¾‘åˆè·Ÿ cglib çš„æ‹¦æˆªå™¨é“¾è°ƒç”¨è¿‡ç¨‹ä¸€æ ·äº†ï¼Œæ–°æ„å»ºå‡ºæ¥çš„ ReflectiveMethodInvocation ç±»æŒæœ‰äº†ä»£ç†ç›¸å…³çš„å¤§éƒ¨åˆ†ä¿¡æ¯ï¼Œå®ƒè¿˜è´Ÿè´£ç€æ‹¦æˆªå™¨é“¾çš„è°ƒç”¨æµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// We need to create a method invocation...</span></span><br><span class="line"><span class="type">MethodInvocation</span> <span class="variable">invocation</span> <span class="operator">=</span>	<span class="comment">// æ„å»º ReflectiveMethodInvocation æ¥æ§åˆ¶ interceptor é“¾çš„è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ReflectiveMethodInvocation</span>(proxy, target, method, args, targetClass, chain);</span><br><span class="line"><span class="comment">// Proceed to the joinpoint through the interceptor chain.</span></span><br><span class="line">retVal = invocation.proceed();</span><br></pre></td></tr></table></figure>

<p>æƒ³éƒ½ä¸ç”¨æƒ³ï¼Œ<code>invocation.proceed();</code> æ–¹æ³•å°†ä¼šè§¦å‘æ‹¦æˆªå™¨é“¾ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ TransactionInterceptor æ–¹æ³•ï¼Œå°½ç®¡å·²ç»çŒœåˆ°äº†ï¼Œæˆ‘è¿˜æ˜¯è¦è´´å‡º <code>invocation.proceed();</code> ä»£ç å®ç°å¦‚ä¸‹ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œæ‰€ä»¥è¿™é‡Œçš„ currentInterceptorIndex å€¼ä¸º -1ï¼ŒinterceptorsAndDynamicMethodMatchers å…¶å®å°±æ˜¯æˆ‘ä»¬çš„æ‹¦æˆªå™¨é“¾ï¼Œå®ƒæ˜¯åœ¨æ„é€ å‡½æ•°ä¸­è¢«åˆå§‹åŒ–çš„ï¼Œé‡Œè¾¹å°±åªæœ‰ä¸€ä¸ªå…ƒç´ ä¸º TransactionInterceptor å®ä¾‹ï¼Œæ ¹æ®ä»¥ä¸Šæ¡ä»¶ï¼Œç¨‹åºå°†ä¼šæ‰§è¡Œæœ€åä¸€è¡Œä»£ç  <code>return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</code>ï¼Œå³ TransactionInterceptor å®ä¾‹çš„ invoke æ–¹æ³•äº†ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">//	We start with an index of -1 and increment early.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.currentInterceptorIndex == <span class="built_in">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokeJoinpoint();	<span class="comment">// è¿™é‡Œå°±æ˜¯è§¦å‘è¿æ¥ç‚¹æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">interceptorOrInterceptionAdvice</span> <span class="operator">=</span>	<span class="comment">// é€ä¸ªè·å– interceptorOrInterceptionAdvice</span></span><br><span class="line">            <span class="built_in">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="built_in">this</span>.currentInterceptorIndex);</span><br><span class="line">    <span class="keyword">if</span> (interceptorOrInterceptionAdvice <span class="keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">        <span class="comment">// Evaluate dynamic method matcher here: static part will already have</span></span><br><span class="line">        <span class="comment">// been evaluated and found to match.</span></span><br><span class="line">        <span class="type">InterceptorAndDynamicMethodMatcher</span> <span class="variable">dm</span> <span class="operator">=</span></span><br><span class="line">                (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">        Class&lt;?&gt; targetClass = (<span class="built_in">this</span>.targetClass != <span class="literal">null</span> ? <span class="built_in">this</span>.targetClass : <span class="built_in">this</span>.method.getDeclaringClass());</span><br><span class="line">        <span class="keyword">if</span> (dm.methodMatcher.matches(<span class="built_in">this</span>.method, targetClass, <span class="built_in">this</span>.arguments)) &#123;</span><br><span class="line">            <span class="keyword">return</span> dm.interceptor.invoke(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Dynamic matching failed.</span></span><br><span class="line">            <span class="comment">// Skip this interceptor and invoke the next in the chain.</span></span><br><span class="line">            <span class="keyword">return</span> proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s an interceptor, so we just invoke it: The pointcut will have</span></span><br><span class="line">        <span class="comment">// been evaluated statically before this object was constructed.	// å¯¹é€ä¸ªè·å–çš„ interceptorOrInterceptionAdvice è¿›è¡Œ invoke è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span class="built_in">this</span>);	<span class="comment">// å‚æ•°ä¸ºé€šè¿‡ä»£ç†å„é¡¹å‚æ•°æ„å»ºçš„ CglibMethodInvocation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°å¦‚ä¸‹ï¼Œå¸¸è§„æ“ä½œï¼Œåªæœ‰è¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„ä¼ å‚æ–¹å¼ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ–¹æ³•å¼•ç”¨ï¼Œäº†è§£å°±å¥½ï¼Œç»§ç»­å¾€ä¸‹è·Ÿã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// Work out the target class: may be &#123;@code null&#125;.</span></span><br><span class="line">    <span class="comment">// The TransactionAttributeSource should be passed the target class</span></span><br><span class="line">    <span class="comment">// as well as the method, which may be from an interface.	è·å–ç›®æ ‡ç±»çš„ç±»å‹</span></span><br><span class="line">    Class&lt;?&gt; targetClass = (invocation.getThis() != <span class="literal">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Adapt to TransactionAspectSupport&#x27;s invokeWithinTransaction...</span></span><br><span class="line">    <span class="keyword">return</span> invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»ˆäºåˆ°äº†æˆ‘ä»¬æœŸå¾…å·²ä¹…çš„äº‹åŠ¡å®ç°é€»è¾‘ä»£ç äº†ï¼Œèµ¶ç´§çš„è´´å‡ºæºç å¼€å¿ƒä¸€ä¸‹ï¼Œä»£ç ä¸»å¹²åˆ†ä¸ºä¸¤ä¸ªåˆ†æ”¯ï¼Œå°±æœ¬ä¾‹è€Œè¨€ï¼Œæˆ‘ä»¬åªä½¿ç”¨åˆ°äº† if åˆ†æ”¯ï¼Œæ‰€ä»¥å°±åªæˆªå–è¿™ä¸€éƒ¨åˆ†å±•ç¤ºã€‚è€Œæ²¡ç”¨åˆ°çš„é‚£ä¸€éƒ¨åˆ†ï¼Œæˆ‘å°±æ²¡æœ‰åšæ·±å…¥äº†è§£äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span>	<span class="comment">// è§¦å‘çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸å°±è¿›è¡Œå›æ»šï¼Œå¦åˆ™è¿›è¡Œäº‹åŠ¡çš„æäº¤</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">invokeWithinTransaction</span><span class="params">(Method method, <span class="meta">@Nullable</span> Class&lt;?&gt; targetClass,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> InvocationCallback invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.reactiveAdapterRegistry != <span class="literal">null</span>) &#123;	<span class="comment">// æš‚ä¸åšäº†è§£</span></span><br><span class="line">        <span class="type">ReactiveAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="built_in">this</span>.reactiveAdapterRegistry.getAdapter(method.getReturnType());</span><br><span class="line">        <span class="keyword">if</span> (adapter != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactiveTransactionSupport</span>(adapter).invokeWithinTransaction(method, targetClass, invocation);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the transaction attribute is null, the method is non-transactional.</span></span><br><span class="line">    <span class="type">TransactionAttributeSource</span> <span class="variable">tas</span> <span class="operator">=</span> getTransactionAttributeSource();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">TransactionAttribute</span> <span class="variable">txAttr</span> <span class="operator">=</span> (tas != <span class="literal">null</span> ? tas.getTransactionAttribute(method, targetClass) : <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">PlatformTransactionManager</span> <span class="variable">tm</span> <span class="operator">=</span> determineTransactionManager(txAttr);	<span class="comment">// è·å–äº‹åŠ¡ç®¡ç†å™¨ï¼Œå°è¯•ä»ç¼“å­˜ä¸­è·å– PlatformTransactionManagerï¼Œæ²¡æœ‰çš„è¯å°±ä» BeanFactory ä¸­è·å–ï¼Œç¼“å­˜åè¿›è¡Œè¿”å›</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">joinpointIdentification</span> <span class="operator">=</span> methodIdentification(method, targetClass, txAttr);	<span class="comment">// è·å–æ–¹æ³•çš„å…¨é™å®šåï¼Œæ²¡æœ‰çš„è¯é€šè¿‡ TransactionAttribute çš„æè¿°ç¬¦ä»£æ›¿</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (txAttr == <span class="literal">null</span> || !(tm <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">        <span class="comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.	// å°† TransactionAttribute å°è£…ä¸º DelegatingTransactionAttributeï¼Œä» PlatformTransactionManager ä¸­è·å– TransactionStatus</span></span><br><span class="line">        <span class="type">TransactionInfo</span> <span class="variable">txInfo</span> <span class="operator">=</span> createTransactionIfNecessary(tm, txAttr, joinpointIdentification);	<span class="comment">// æœ€åæ„å»º TransactionInfoï¼ˆé€šè¿‡å‚æ•°æ„å»º TransactionInfoï¼Œè®¾ç½®äº†çŠ¶æ€ä¿¡æ¯ï¼Œ å°†äº‹åŠ¡ä¿¡å¿ƒä¿å­˜åˆ°çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­ï¼ŒåŒæ—¶ä¿ç•™äº†åŸå…ˆçš„äº‹åŠ¡ä¿¡æ¯ï¼Œè¿”å›ï¼‰</span></span><br><span class="line"></span><br><span class="line">        Object retVal;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// This is an around advice: Invoke the next interceptor in the chain.</span></span><br><span class="line">            <span class="comment">// This will normally result in a target object being invoked.</span></span><br><span class="line">            retVal = invocation.proceedWithInvocation();	<span class="comment">// ç»§ç»­ä¸‹ä¸€ä¸ª advice çš„è°ƒç”¨ï¼Œå¦‚æœæ²¡æœ‰åç»­çš„ adviceï¼Œç›´æ¥è¿›è¡Œç›®æ ‡æ–¹æ³•çš„çš„è°ƒç”¨</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// target invocation exception</span></span><br><span class="line">            completeTransactionAfterThrowing(txInfo, ex);	<span class="comment">// å¯¹äºå¼‚å¸¸å‘ç”Ÿåï¼Œäº‹ç‰©çš„å¤„ç†æ–¹å¼ï¼Œæäº¤æˆ–è€…å›æ»š</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;	<span class="comment">// æ¢å¤çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­çš„ TransactionInfo</span></span><br><span class="line">            cleanupTransactionInfo(txInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123;</span><br><span class="line">            <span class="comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span></span><br><span class="line">            <span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> txInfo.getTransactionStatus();</span><br><span class="line">            <span class="keyword">if</span> (status != <span class="literal">null</span> &amp;&amp; txAttr != <span class="literal">null</span>) &#123;</span><br><span class="line">                retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿›è¡Œäº‹åŠ¡çš„æäº¤</span></span><br><span class="line">        commitTransactionAfterReturning(txInfo);</span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹ <code>TransactionAttributeSource tas = getTransactionAttributeSource();</code> è¿™å¥ï¼Œå®ƒåšçš„äº‹æƒ…å°±æ˜¯è·å–å®ƒæŒæœ‰çš„ TransactionAttributeSource å®ä¾‹ï¼Œä¸çŸ¥é“å®ƒå…·ä½“æ˜¯ä»€ä¹ˆå—ï¼Ÿï¼Ÿç›´æ¥ç»™å‡ºç»“æœå°±çŸ¥é“äº†ï¼Œåˆæ˜¯ä¸€ä¸ªç†Ÿæ‚‰çš„ç±»ï¼Œæ²¡é”™å°±æ˜¯æœ¬æ–‡å¼€ç¯‡ä¸­é‚£äº”ä¸ª bean ä¸­çš„ AnnotationTransactionAttributeSourceï¼ˆä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨ä¸€äº›äº‹åŠ¡ç›¸å…³çš„å±æ€§ä¿¡æ¯ï¼‰ã€‚å®ƒæœ‰ä¸€ä¸ªå±æ€§ attributeCacheï¼Œæ˜¯ä¸€ä¸ª ConcurrentHashMap å®ä¾‹ï¼Œæœ¬ä¾‹ä¸­é‡Œè¾¹æœ‰ 528 é¡¹è®°å½•ã€‚ä¸è¦æ…Œï¼Œå…¶å®è¿™äº›è®°å½•ä¸­åªæœ‰ä¸¤é¡¹çš„å€¼ä¸ä¸ºç©ºã€‚å…¶ä»–çš„éƒ½æ˜¯ç©ºå€¼ï¼Œæˆ‘ä»¬æ‰€è¦å…³æ³¨çš„ä¹Ÿå°±åªæœ‰è¿™ä¸ä¸ºç©ºçš„ä¸¤é¡¹ï¼Œä»–ä»¬çš„ key å°±æ˜¯æœ¬ä¾‹ä¸­ä½äº UserService æ¥å£å’Œ UserServiceImpl å®ç°ç±»ä¸­ä¸¤ä¸ª save æ–¹æ³•å¯¹åº”çš„ MethodClassKey å®ä¾‹ï¼Œè€Œå¯¹åº”çš„å€¼å‘¢ï¼Œå°±æ˜¯å¯¹è¿™ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œè°ƒç”¨æ—¶äº‹åŠ¡ç›¸å…³çš„ä¸€äº›å±æ€§å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ 528 é¡¹ä¸­ï¼Œåªæœ‰å€¼ä¸ä¸ºç©ºçš„ä¸¤é¡¹ä»–ä»¬å¯¹åº”çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶ï¼Œå¦åˆ™æ˜¯ä¸ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶çš„ã€‚å¦‚æœè§‰å¾—æ¯”è¾ƒç»•ï¼Œé‚£å°±è¿˜æ˜¯è¯·ç»§ç»­çœ‹åè¾¹çš„åˆ†æå§ã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/46aada5933fc013fafa4087f30b6a5db.jpg" width=600 /></div>

<center>TransactionAttributeSource å®ä¾‹å†…å®¹</center>

<p>

<p>æ¥ç€å°±æ˜¯ä» TransactionAttributeSource ä¸­è·å–äº‹åŠ¡ç›¸å…³çš„å±æ€§ TransactionAttributeï¼Œæˆ‘ä»¬è¿™é‡Œè°ƒç”¨çš„æ˜¯ UserServiceImpl ç±»çš„ save æ–¹æ³•ï¼Œä¸Šè¾¹å·²ç»æŒ‡å‡ºäº†åœ¨ attributeCache ç¼“å­˜ä¸­ï¼Œè¯¥æ–¹æ³•å¯¹åº”çš„å€¼ä¸ä¸ºç©ºï¼Œè¿™æ ·æˆ‘ä»¬è·å–çš„ TransactionAttribute å°±ä¸æ˜¯ç©ºï¼Œå†è°ƒç”¨ <code>determineTransactionManager(txAttr);</code> è¿™ä¸ªæ–¹æ³•è·å–äº‹åŠ¡ç®¡ç†å™¨ï¼Œå…¶å®å°±æœ¬ä¾‹è€Œè¨€ï¼Œè·å–çš„è¿‡ç¨‹è·Ÿå‚æ•°æ²¡å•¥å…³ç³»ï¼Œå› ä¸ºå‚æ•° txAttr ä¸­çš„ qualifier å±æ€§ä¸ºç©ºä¸²ï¼Œæ‰€ä»¥è·å–äº‹åŠ¡ç®¡ç†å™¨æ—¶å°±æ˜¯ä¾æ® <code>TransactionAspectSupport#transactionManagerBeanName</code> å­—æ®µæ¥è·å–çš„ï¼Œå…·ä½“çš„ä»£ç å°±ä¸è´´äº†ï¼Œå°±æœ¬ä¾‹è€Œè¨€ï¼Œæ ¹æœ¬æ‹¿åˆ°çš„å°±æ˜¯æˆ‘ä»¬åœ¨ spring é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„é‚£ä¸ª â€œtransactionManagerâ€ï¼Œå®ƒæŒæœ‰äº†é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ dataSource å¦‚ä¸‹å›¾ï¼Œäº†è§£è¿™ä¸ªå°±å®Œäº‹ã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/d96e301db24ca4df82ad35126e852806.jpg" width=600 /></div>

<center>transactionManager å®ä¾‹å†…å®¹</center>

<p>


<p>å†å¾€ä¸‹å°±æ˜¯ <code>final String joinpointIdentification = methodIdentification(method, targetClass, txAttr);</code> è¿™è¡Œä»£ç ï¼Œä»æ–¹æ³•åå°±çŸ¥é“è¿™æ˜¯ä¸€ä¸ªæ–¹æ³•çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ€ä¹ˆæ¥çš„ä¸ç”¨æ·±ç©¶ï¼Œç›´æ¥ç»™å‡ºç»“æœã€‚</p>
<div style="text-align:center;"><img src="https://image.aprilyolies.top/static/images/common/6860bb9123349188e587b933d57d6b24.jpg" width=600 /></div>

<center>æ–¹æ³•çš„å”¯ä¸€æ ‡è¯†ç¬¦</center>

<p>

<p>å†å¾€ä¸‹å°±æ˜¯æ„å»º TransactionInfo å®ä¾‹ï¼Œå’Œäº‹åŠ¡æ“ä½œç›¸å…³çš„ä¿¡æ¯éƒ½å°è£…åœ¨å…¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆè¦æ³¨æ„çš„åœ°æ–¹ï¼Œæ³¨é‡Šä¸­å·²ç»å¯¹ä»£ç è¿›è¡Œäº†è§£é‡Šï¼Œåæ­£æœ€ç»ˆè¿”å›çš„å°±æ˜¯æ„å»ºå‡ºæ¥çš„ TransactionInfoï¼Œå®ƒæŒæœ‰äº† TransactionManagerã€TransactionAttributeã€æ–¹æ³•çš„å”¯ä¸€æ ‡è¯†ç¬¦ä¿¡æ¯ï¼ŒçŸ¥é“è¿™äº›å°±è¡Œäº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† TransactionAttribute å°è£…ä¸º DelegatingTransactionAttributeï¼Œä» PlatformTransactionManager ä¸­è·å– TransactionStatus</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;serial&quot;)</span>	<span class="comment">// æœ€åæ„å»º TransactionInfoï¼ˆé€šè¿‡å‚æ•°æ„å»º TransactionInfoï¼Œè®¾ç½®äº†çŠ¶æ€ä¿¡æ¯ï¼Œ å°†äº‹åŠ¡ä¿¡å¿ƒä¿å­˜åˆ°çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­ï¼ŒåŒæ—¶ä¿ç•™äº†åŸå…ˆçš„äº‹åŠ¡ä¿¡æ¯ï¼Œè¿”å›ï¼‰</span></span><br><span class="line"><span class="keyword">protected</span> TransactionInfo <span class="title function_">createTransactionIfNecessary</span><span class="params">(<span class="meta">@Nullable</span> PlatformTransactionManager tm,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> TransactionAttribute txAttr, <span class="keyword">final</span> String joinpointIdentification)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If no name specified, apply method identification as transaction name.</span></span><br><span class="line">    <span class="keyword">if</span> (txAttr != <span class="literal">null</span> &amp;&amp; txAttr.getName() == <span class="literal">null</span>) &#123;	<span class="comment">// å°† TransactionAttribute å°è£…ä¸º DelegatingTransactionAttribute</span></span><br><span class="line">        txAttr = <span class="keyword">new</span> <span class="title class_">DelegatingTransactionAttribute</span>(txAttr) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> joinpointIdentification;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (txAttr != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tm != <span class="literal">null</span>) &#123;</span><br><span class="line">            status = tm.getTransaction(txAttr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Skipping transactional joinpoint [&quot;</span> + joinpointIdentification +</span><br><span class="line">                        <span class="string">&quot;] because no transaction manager has been configured&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;	<span class="comment">// é€šè¿‡å‚æ•°æ„å»º TransactionInfoï¼Œè®¾ç½®äº†çŠ¶æ€ä¿¡æ¯ï¼Œ å°†äº‹åŠ¡ä¿¡å¿ƒä¿å­˜åˆ°çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­ï¼ŒåŒæ—¶ä¿ç•™äº†åŸå…ˆçš„äº‹åŠ¡ä¿¡æ¯ï¼Œè¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†å¾€ä¸‹èµ°å°±æ˜¯æ‰§è¡Œ <code>retVal = invocation.proceedWithInvocation();</code> ï¼Œè¿™é‡Œçš„ invocation å°±æ˜¯ç”¨æ¥æ§åˆ¶æ‹¦æˆªå™¨é“¾æ‰§è¡Œçš„å®ä¾‹çš„ proceed æ–¹æ³•ï¼Œæ˜¯é€šè¿‡å‡½æ•°å¼•ç”¨çš„æ–¹å¼ä¼ è¿›æ¥çš„ï¼Œè¿™ä¸€ç‚¹ä¸Šæ–‡å·²ç»è¯´è¿‡äº†ï¼Œæˆ‘ä»¬å·²ç»æ‰§è¡Œè¿‡ä¸€æ¬¡å®ƒçš„ proceed æ–¹æ³•äº†ï¼Œè¢«è°ƒç”¨çš„æ˜¯ TransactionInterceptor æ‹¦æˆªå™¨ï¼Œå› ä¸ºä¸€å…±å°±åªæœ‰åªæœ‰ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‰€ä»¥æœ¬æ¬¡ <code>ReflectiveMethodInvocation#proceed</code> æ–¹æ³•çš„è°ƒç”¨å°±ä¼šæ»¡è¶³ <code>if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1)</code> åˆ¤æ–­æ¡ä»¶ï¼Œæ ¹æ®ä¸Šä¸€ç¯‡æ–‡ç« çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“è¿™å°†ä¼šå¯¼è‡´ç”¨æˆ·ä»£ç çš„è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯ä¸šåŠ¡é€»è¾‘ä¸­è¿›è¡Œæ•°æ®åº“çš„æ’å…¥æ“ä½œã€‚å› ä¸ºè¿™ä¸ªä¸šåŠ¡é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬äººä¸ºçš„æŠ›å‡ºäº†ä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ï¼Œæ‰€ä»¥è¿™ä¸ªå¼‚å¸¸å°±ä¼šè¢«ä¸Šå±‚ä»£ç æ‰€æ•è·ï¼Œè€Œæ•è·ç‚¹å°±æ˜¯ <code>TransactionAspectSupport#invokeWithinTransaction</code> æ–¹æ³•çš„ <code>catch (Throwable ex)</code> å¤„ï¼Œäº‹åŠ¡çš„å›æ»šæ“ä½œä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚</p>
<p>åœ¨è¯¥ catch ä»£ç å—ä¸­æ ¸å¿ƒå°±æ˜¯è°ƒç”¨äº† completeTransactionAfterThrowing æ–¹æ³•ï¼Œä»æ–¹æ³•åå°±çŸ¥é“å…¶ä¸­çš„æ ¸å¿ƒå®ç°å°±æ˜¯å®Œæˆå¼‚å¸¸æ•è·åçš„äº‹åŠ¡å¤„ç†ï¼Œå®Œæ•´çš„æ–¹æ³•å®ç°å¦‚ä¸‹ï¼Œæ ¹æ® if-else çš„åˆ†æ”¯ç»“æ„ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“å°±ç®—æ˜¯å¼‚å¸¸å‡ºç°ï¼Œé‚£ä¹ˆå¯¹äºäº‹åŠ¡çš„å¤„ç†ä¹Ÿæ˜¯æœ‰ä¸¤ç§æ¨¡å¼çš„ï¼Œif ä»£ç å—ä¸­çš„ rollback æ–¹æ³•åæˆ‘ä»¬å°±èƒ½çŸ¥é“è¿™é‡Œè¿›è¡Œçš„æ˜¯å›æ»šæ“ä½œï¼Œè€Œ else ä»£ç å—ä¸­çš„ commit æ–¹æ³•åï¼Œæˆ‘ä»¬çŸ¥é“æ˜¯æäº¤æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ä¸è¿›è¡Œå›æ»šã€‚é‚£ä¹ˆ if åˆ¤æ–­æˆç«‹çš„æ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿç¬¬ä¸€æ¡å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯äº‹åŠ¡ä¿¡æ¯ TransactionInfo æŒæœ‰çš„äº‹åŠ¡å±æ€§ transactionAttribute ä¸èƒ½ä¸ºç©ºï¼Œå…¶æ¬¡å°±æ˜¯äº‹åŠ¡å±æ€§ transactionAttribute çš„ rollbackOn æ–¹æ³•çš„è¿”å›ç»“æœäº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹äºå¼‚å¸¸å‘ç”Ÿåï¼Œäº‹ç‰©çš„å¤„ç†æ–¹å¼ï¼Œæäº¤æˆ–è€…å›æ»š</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">completeTransactionAfterThrowing</span><span class="params">(<span class="meta">@Nullable</span> TransactionInfo txInfo, Throwable ex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (txInfo != <span class="literal">null</span> &amp;&amp; txInfo.getTransactionStatus() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Completing transaction for [&quot;</span> + txInfo.getJoinpointIdentification() +</span><br><span class="line">                    <span class="string">&quot;] after exception: &quot;</span> + ex);</span><br><span class="line">        &#125;	<span class="comment">// ç¬¬äºŒä¸ªæ¡ä»¶ä¸»è¦æ˜¯åˆ¤æ–­å›æ»šè§„åˆ™ï¼Œæœ€åŸºæœ¬çš„å°±æ˜¯åœ¨å‘ç”Ÿè¿è¡Œæ—¶å¼‚å¸¸å’Œé”™è¯¯æ—¶å‘ç”Ÿå›æ»š</span></span><br><span class="line">        <span class="keyword">if</span> (txInfo.transactionAttribute != <span class="literal">null</span> &amp;&amp; txInfo.transactionAttribute.rollbackOn(ex)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus());	<span class="comment">// äº‹åŠ¡å›æ»š</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (TransactionSystemException ex2) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Application exception overridden by rollback exception&quot;</span>, ex);</span><br><span class="line">                ex2.initApplicationException(ex);</span><br><span class="line">                <span class="keyword">throw</span> ex2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (RuntimeException | Error ex2) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Application exception overridden by rollback exception&quot;</span>, ex);</span><br><span class="line">                <span class="keyword">throw</span> ex2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// We don&#x27;t roll back on this exception.</span></span><br><span class="line">            <span class="comment">// Will still roll back if TransactionStatus.isRollbackOnly() is true.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;	<span class="comment">// å¦‚æœæ•è·åˆ°çš„å¼‚å¸¸ä¸æ»¡è¶³å›æ»šè§„åˆ™ï¼Œç›´æ¥è¿›è¡Œæäº¤</span></span><br><span class="line">                txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (TransactionSystemException ex2) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Application exception overridden by commit exception&quot;</span>, ex);</span><br><span class="line">                ex2.initApplicationException(ex);</span><br><span class="line">                <span class="keyword">throw</span> ex2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (RuntimeException | Error ex2) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Application exception overridden by commit exception&quot;</span>, ex);</span><br><span class="line">                <span class="keyword">throw</span> ex2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹ rollbackOn æ–¹æ³•çš„æ ¹æœ¬å®ç°å¦‚ä¸‹ï¼Œä¸ŠåŠéƒ¨åˆ†çš„ rollbackRules çš„å¤„ç†éƒ¨åˆ†æˆ‘æ²¡æœ‰çœ‹æ‡‚å®ƒçš„æ„æ€ï¼Œå› ä¸ºå°±æœ¬ä¾‹è€Œè¨€ï¼Œä¸Šè¾¹çš„åˆ¤æ–­æ¡ä»¶ç¡®å®æ²¡ç”¨ä¸Šï¼Œæ‰€ä»¥ä¸å¤ªå¥½ç†è§£å®ƒçš„æ„æ€ã€‚ç´§æ¥ç€ä¸‹è¾¹åˆæœ‰ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå³ <code>return super.rollbackOn(ex);</code> è¿™å¥ä»£ç ï¼Œå®ƒæ˜¯åœ¨çˆ¶ç±»ä¸­å®ç°çš„ï¼Œæˆ‘ä»¬ç‚¹è¿›å»å°±èƒ½çŸ¥é“ï¼Œå®ƒä¼šå¯¹æ•è·åˆ°çš„å¼‚å¸¸è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯è¿è¡Œæ—¶å¼‚å¸¸æˆ–è€…æ˜¯ Error é”™è¯¯ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</p>
<blockquote>
<p>org.springframework.transaction.interceptor.RuleBasedTransactionAttribute#rollbackOn</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// è¿™é‡Œä¸»è¦æ˜¯åˆ¤æ–­å›æ»šè§„åˆ™ï¼Œæœ€åŸºæœ¬çš„å°±æ˜¯åœ¨å‘ç”Ÿè¿è¡Œæ—¶å¼‚å¸¸å’Œé”™è¯¯æ—¶å‘ç”Ÿå›æ»š</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">rollbackOn</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Applying rules to determine whether transaction should rollback on &quot;</span> + ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">RollbackRuleAttribute</span> <span class="variable">winner</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">deepest</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.rollbackRules != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (RollbackRuleAttribute rule : <span class="built_in">this</span>.rollbackRules) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">depth</span> <span class="operator">=</span> rule.getDepth(ex);</span><br><span class="line">            <span class="keyword">if</span> (depth &gt;= <span class="number">0</span> &amp;&amp; depth &lt; deepest) &#123;</span><br><span class="line">                deepest = depth;</span><br><span class="line">                winner = rule;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Winning rollback rule is: &quot;</span> + winner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// User superclass behavior (rollback on unchecked) if no rule matches.</span></span><br><span class="line">    <span class="keyword">if</span> (winner == <span class="literal">null</span>) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;No relevant rollback rule found: applying default rules&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.rollbackOn(ex);	<span class="comment">// è¿™é‡Œè¯´æ˜åªæœ‰åœ¨å‘ç”Ÿè¿è¡Œæ—¶å¼‚å¸¸å’Œé”™è¯¯æ—¶æ‰ä¼šè§¦å‘å›æ»š</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !(winner <span class="keyword">instanceof</span> NoRollbackRuleAttribute);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†å›åˆ°æˆ‘ä»¬ if åˆ†æ”¯é‚£é‡Œï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸šåŠ¡ä»£ç ä¸­æŠ›å‡ºçš„å¼‚å¸¸æ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼Œæ‰€ä»¥ if åˆ¤æ–­çš„ç¬¬äºŒä¸ªæ¡ä»¶ä¹Ÿæ˜¯æˆç«‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å°†è¦è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†ä¸šåŠ¡ä»£ç ä¸­çš„å¼‚å¸¸ä¿®æ”¹ä¸ºéè¿è¡Œå¼‚å¸¸ï¼Œé‚£ä¹ˆæ­¤æ—¶äº‹åŠ¡å°±ä¼šæ­£å¸¸æäº¤ã€‚è¿™æ ·å¸¦æ¥çš„ç»“æœå°±æ˜¯æ•°æ®å…¥åº“äº†ã€‚è¿˜æ˜¯çœ‹çœ‹äº‹åŠ¡å›æ»šçš„ä»£ç å®ç°å§ï¼Œæ ¹æœ¬çš„å°±æ˜¯è°ƒç”¨çš„ä¸‹è¾¹çš„ä»£ç ï¼Œæ›´åŠ ç»†èŠ‚çš„éƒ¨åˆ†æˆ‘å·²ç»æ²¡æœ‰å»æ·±ç©¶äº†ï¼Œå› ä¸ºåˆ°è¿™é‡Œå¯¹äºç†è§£äº‹åŠ¡æœºåˆ¶çš„å®ç°å·²ç»è¶³å¤Ÿäº†ï¼Œæˆ‘è¿™é‡Œå°±ä»…ä»…æ˜¯å°†ä»£ç æ®µçš„ä½œç”¨ç»™è¿›è¡Œæ ‡æ³¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°è¯•è°ƒç”¨äº‹åŠ¡åŒæ­¥å™¨çš„å‰ç½®å¤„ç†æ–¹æ³•,è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œ,é€ä¸ªè§¦å‘åŒæ­¥å™¨é“¾æ¯ä¸ªå…ƒç´ çš„ afterCompletion æ–¹æ³•ï¼Œæœ€åäº‹åŠ¡å›æ»šåçš„æ‰«å°¾å·¥ä½œï¼Œè®¾ç½®äº‹åŠ¡çš„çŠ¶æ€ï¼Œ çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­ç§»é™¤èµ„æºä¿¡æ¯ï¼ˆè¿æ¥ä¿¡æ¯ï¼‰ï¼Œè®¾ç½®è¿æ¥çš„è‡ªåŠ¨æäº¤ï¼Œæ¢å¤éš”ç¦»çº§åˆ«ï¼Œé‡Šæ”¾è¿æ¥ï¼Œæ¢å¤ connection holder çš„çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processRollback</span><span class="params">(DefaultTransactionStatus status, <span class="type">boolean</span> unexpected)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">unexpectedRollback</span> <span class="operator">=</span> unexpected;	<span class="comment">// é¢„æœŸå¤–çš„å›æ»š</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;	<span class="comment">// å°è¯•è°ƒç”¨äº‹åŠ¡åŒæ­¥å™¨çš„å‰ç½®å¤„ç†æ–¹æ³•</span></span><br><span class="line">            triggerBeforeCompletion(status);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (status.hasSavepoint()) &#123;	<span class="comment">// çœ‹äº‹åŠ¡çŠ¶æ€æ˜¯å¦æœ‰ä¿å­˜ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">&quot;Rolling back transaction to savepoint&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                status.rollbackToHeldSavepoint();	<span class="comment">// å›æ»šåˆ°ä¿å­˜ç‚¹</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (status.isNewTransaction()) &#123;	<span class="comment">// æ˜¯å¦æ˜¯æ–°äº‹åŠ¡å‘¢ï¼Ÿ</span></span><br><span class="line">                <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">&quot;Initiating transaction rollback&quot;</span>);</span><br><span class="line">                &#125;	<span class="comment">// ç›´æ¥è¿›è¡Œå›æ»š</span></span><br><span class="line">                doRollback(status);	<span class="comment">// è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œ</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;	<span class="comment">// ä¸æ˜¯æ–°äº‹åŠ¡çš„å¤„ç†æ–¹å¼ï¼Œå­˜åœ¨ç°æœ‰çš„äº‹åŠ¡å¤„ç†æ–¹å¼</span></span><br><span class="line">                <span class="comment">// Participating in larger transaction</span></span><br><span class="line">                <span class="keyword">if</span> (status.hasTransaction()) &#123;	<span class="comment">// æ£€æŸ¥å›æ»šæ¡ä»¶</span></span><br><span class="line">                    <span class="keyword">if</span> (status.isLocalRollbackOnly() || isGlobalRollbackOnParticipationFailure()) &#123;	<span class="comment">// å¦‚æœå±€éƒ¨çš„äº‹åŠ¡å¤±è´¥ï¼Œæ˜¯å¦è®¾ç½®å…¨å±€çš„äº‹åŠ¡å›æ»šçŠ¶æ€</span></span><br><span class="line">                        <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">                            logger.debug(<span class="string">&quot;Participating transaction failed - marking existing transaction as rollback-only&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        doSetRollbackOnly(status);	<span class="comment">// ä»…ä»…æ˜¯è®¾ç½®å›æ»šçš„æ ‡å¿—</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">                            logger.debug(<span class="string">&quot;Participating transaction failed - letting transaction originator decide on rollback&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.debug(<span class="string">&quot;Should roll back transaction but cannot - no transaction available&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Unexpected rollback only matters here if we&#x27;re asked to fail early</span></span><br><span class="line">                <span class="keyword">if</span> (!isFailEarlyOnGlobalRollbackOnly()) &#123;</span><br><span class="line">                    unexpectedRollback = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException | Error ex) &#123;	<span class="comment">// è§¦å‘</span></span><br><span class="line">            triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€ä¸ªè§¦å‘åŒæ­¥å™¨é“¾æ¯ä¸ªå…ƒç´ çš„ afterCompletion æ–¹æ³•</span></span><br><span class="line">        triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Raise UnexpectedRollbackException if we had a global rollback-only marker</span></span><br><span class="line">        <span class="keyword">if</span> (unexpectedRollback) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnexpectedRollbackException</span>(</span><br><span class="line">                    <span class="string">&quot;Transaction rolled back because it has been marked as rollback-only&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;	<span class="comment">// äº‹åŠ¡å›æ»šåçš„æ‰«å°¾å·¥ä½œï¼Œè®¾ç½®äº‹åŠ¡çš„çŠ¶æ€ï¼Œ çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­ç§»é™¤èµ„æºä¿¡æ¯ï¼ˆè¿æ¥ä¿¡æ¯ï¼‰ï¼Œè®¾ç½®è¿æ¥çš„è‡ªåŠ¨æäº¤ï¼Œæ¢å¤éš”ç¦»çº§åˆ«ï¼Œé‡Šæ”¾è¿æ¥ï¼Œæ¢å¤ connection holder çš„çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">        cleanupAfterCompletion(status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªè¦æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯çœŸæ­£çš„äº‹åŠ¡å›æ»šæ˜¯åœ¨ä¸Šè¾¹ä»£ç ä¸­çš„ <code>doRollback(status);</code> è¯­å¥ä¸­å®Œæˆçš„ï¼Œè€Œå…¶ä»–éƒ¨åˆ†å°±åªæ˜¯ä¸€äº›äº‹åŠ¡å›æ»šç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„å¤„ç†ï¼Œæˆ–è€…æ˜¯å¯¹äºäº‹åŠ¡å›æ»šåçš„ä¸€äº›å–„åå·¥ä½œã€‚å…³äº <code>doRollback(status);</code> çš„å®ç°ï¼Œæˆ‘ä»¬ä¸å¦¨çœ‹çœ‹ï¼Œå…¶å®å°±æ˜¯è·Ÿæˆ‘ä»¬è‡ªå·±è¿›è¡Œäº‹åŠ¡å›æ»šçš„æ“ä½œä¸€æ ·ï¼Œæ ¹æœ¬è¿˜æ˜¯è°ƒç”¨çš„ <code>java.sql.Connection#rollback()</code> çœ‹åˆ°è¿™é‡Œæˆ‘æƒ³å°ä¼™ä¼´å·²ç»å¯¹ spring çš„äº‹åŠ¡å®ç°æœ‰æ¯”è¾ƒæ¸…æ™°çš„ç†è§£äº†ï¼Œè‡³äºä¸€äº›å…¶ä»–çš„ç»†èŠ‚éƒ¨åˆ†ï¼Œå¦‚æœæœ‰ç²¾åŠ›å°±å¯ä»¥å»çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	<span class="comment">// è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œ</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRollback</span><span class="params">(DefaultTransactionStatus status)</span> &#123;</span><br><span class="line">    <span class="type">DataSourceTransactionObject</span> <span class="variable">txObject</span> <span class="operator">=</span> (DataSourceTransactionObject) status.getTransaction();	<span class="comment">// æ•°æ®æºäº‹åŠ¡å¯¹è±¡</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> txObject.getConnectionHolder().getConnection();	<span class="comment">// ä¹Ÿå°±æ˜¯è¯´å’Œæ•°æ®åº“äº¤äº’ç›¸å…³çš„ä¿¡æ¯éƒ½ä¿å­˜åœ¨ DataSourceTransactionObject å®ä¾‹ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Rolling back JDBC transaction on Connection [&quot;</span> + con + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        con.rollback();	<span class="comment">// è°ƒç”¨çœŸæ­£çš„å›æ»šæ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionSystemException</span>(<span class="string">&quot;Could not roll back JDBC transaction&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åå¯¹ spring äº‹åŠ¡ä»£ç†ç±»çš„æ‰§è¡Œè¿‡ç¨‹è¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼Œæˆ‘ä»¬ä¼šä»ç¯å¢ƒä¸­è·å–åˆ° Advisors ä¿¡æ¯ï¼Œç„¶åæ ¹æ®å®ƒæ¥å¾—åˆ°æ‹¦æˆªå™¨é“¾ï¼Œè€Œæ‹¦æˆªå™¨é“¾çš„æ‰§è¡Œæ˜¯ç”± ReflectiveMethodInvocation å®ä¾‹æ§åˆ¶çš„ï¼Œå°±æˆ‘ä»¬æœ¬ä¾‹è€Œè¨€ï¼Œè¿™é‡Œæ‹¦æˆªå™¨é“¾åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå°±æ˜¯ TransactionInterceptor å®ä¾‹ï¼Œæˆ‘ä»¬å°†è¦è°ƒç”¨å®ƒçš„ invoke æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šç»§ç»­ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„æ‰§è¡Œï¼Œå½“æ‰€æœ‰æ‹¦æˆªå™¨æ‰§è¡Œå®Œåï¼Œå°±ä¼šè§¦å‘ç”¨æˆ·ä»£ç ï¼Œå¦‚æœæ­¤æ—¶ç”¨æˆ·ä»£ç ä¸­æŠ›å‡ºäº†è¿è¡Œæ—¶å¼‚å¸¸ï¼Œåªè¦è¯¥å¼‚å¸¸åˆ°è¾¾ TransactionInterceptor è¢«æ•è·ï¼Œé‚£ä¹ˆè¯¥æ‹¦æˆªå™¨å°±ä¼šæ ¹æ®å¿…è¦çš„æ¡ä»¶æ¥è¿›è¡Œäº‹åŠ¡çš„å›æ»šæˆ–è€…æäº¤æ“ä½œã€‚</p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Spring/">#Spring</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2019/07/25/2019-07-25-SpringMVC%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">SpringMVCåŸºæœ¬åŸç†åˆ†æ</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2019/07/21/2019-07-21-Spring-AOP-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Spring AOP å®ç°åŸç†åˆ†æ</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">å°æ©˜å­ğŸŠ</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F"><span class="nav-text">ç¤ºä¾‹ç¨‹åº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90"><span class="nav-text">æ ‡ç­¾è§£æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%BA%8B%E5%8A%A1%E4%BB%A3%E7%90%86%E7%B1%BB"><span class="nav-text">æ„å»ºäº‹åŠ¡ä»£ç†ç±»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
