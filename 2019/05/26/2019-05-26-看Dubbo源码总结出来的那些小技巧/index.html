<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Java 后端">
    <meta name="description" content="小橘子🍊的个人主页，欢迎访问~~">
    <meta name="author" content="小橘子🍊">
    
    <title>
        
            看Dubbo源码总结出来的那些小技巧 |
        
        AprilYoLies
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://img.aprilyolies.top/img/typora/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"aprilyolies.top","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"https://img.aprilyolies.top/img/typora/avatar.jpg","favicon":"https://img.aprilyolies.top/img/typora/avatar.jpg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"干燥的空气，尘埃的味道，我在其中…踏上旅途！"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </a>
            
            <a class="logo-title" href="/">
                AprilYoLies
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">看Dubbo源码总结出来的那些小技巧</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://img.aprilyolies.top/img/typora/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">小橘子🍊</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2019-05-26 15:04:12</span>
        <span class="mobile">2019-05-26 15:04</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/">后台开发</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Dubbo/">Dubbo</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>好久没有更新 Blog 了，一个重要的原因是抽不出时间呐，因为在看 Dubbo 的源码，到今天总算是把服务发布者和服务调用者的部分给看完了，而这篇文章就是在看 Dubbo 源码中学到的一些小技巧，不是很系统，但是很干货，如果自己看过源码就会更加的印象深刻。在看源码的过程中我还根据自己的理解添加了较为详细的注释，因为个人能力问题，不能保证全部正确，但也还是有一定的参考意义，如果你也是在看 Dubbo 源码的话可以参考一下我的代码注释，<a class="link"   target="_blank" rel="noopener" href="https://github.com/AprilYoLies/dubbo-with-comment" >地址<i class="fas fa-external-link-alt"></i></a>奉上。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="Stream-组合方法"><a href="#Stream-组合方法" class="headerlink" title="Stream 组合方法"></a>Stream 组合方法</h3><blockquote>
<p>org.apache.dubbo.common.extension.AdaptiveClassCodeGenerator.hasInvocationArgument</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasInvocationArgument</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    Class&lt;?&gt;[] pts = method.getParameterTypes();</span><br><span class="line">    <span class="comment">// 查看 method 是否有 org.apache.dubbo.rpc.Invocation 类型的参数</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.stream(pts).anyMatch(p -&gt; CLASSNAME_INVOCATION.equals(p.getName()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>return Arrays.stream(pts).anyMatch(p -&gt; CLASSNAME_INVOCATION.equals(p.getName()));</code> 这条语句中，借用了 Arrays 工具类的 stream 方法得到 <code>java.util.stream.Stream</code> 实例，利用这个实例就可以进行类似于 scala 语法的一些函数式编程了。这里的 anyMatch 表示任一匹配的方式，如果找到了任意符合条件的 p，就返回 true，否则返回 false。</p>
<blockquote>
<p>org.apache.dubbo.common.extension.AdaptiveClassCodeGenerator#generateInvocationArgumentNullCheck</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">generateInvocationArgumentNullCheck</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    Class&lt;?&gt;[] pts = method.getParameterTypes();</span><br><span class="line">    <span class="keyword">return</span> IntStream.range(<span class="number">0</span>, pts.length).filter(i -&gt; CLASSNAME_INVOCATION.equals(pts[i].getName()))</span><br><span class="line">            .mapToObj(i -&gt; String.format(CODE_INVOCATION_ARGUMENT_NULL_CHECK, i, i))</span><br><span class="line">            .findFirst().orElse(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>return IntStream.range(0, pts.length).filter(i -&gt; CLASSNAME_INVOCATION.equals(pts[i].getName())).mapToObj(i -&gt; String.format(CODE_INVOCATION_ARGUMENT_NULL_CHECK, i, i)).findFirst().orElse(&quot;&quot;);</code> 这条代码中，借用了 Arrays 工具类的 stream 方法得到 <code>java.util.stream.Stream</code> 实例，利用这个实例就可以进行类似于 scala 语法的一些函数式编程了。这里的 filter 表示过滤，即找到满足 <code>CLASSNAME_INVOCATION.equals(pts[i].getName())</code> 的 i，mapToObj 函数表示映射，即将过滤出来的 i 通过映射转换为 <code>String.format(CODE_INVOCATION_ARGUMENT_NULL_CHECK, i, i)</code>，findFirst 表示映射的终止条件，即找到任意 i 即返回，而 orElse 则是没有找到符合条件的 i 的处理方式，直接返回 “”。</p>
<blockquote>
<p>org.apache.dubbo.common.extension.AdaptiveClassCodeGenerator#generateReturnAndInvocation</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">generateReturnAndInvocation</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果方法的返回类型为 void，拼接 return</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">returnStatement</span> <span class="operator">=</span> method.getReturnType().equals(<span class="keyword">void</span>.class) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;return &quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">args</span> <span class="operator">=</span> Arrays.stream(method.getParameters()).map(Parameter::getName).collect(Collectors.joining(<span class="string">&quot;, &quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnStatement + String.format(<span class="string">&quot;extension.%s(%s);\n&quot;</span>, method.getName(), args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>String args = Arrays.stream(method.getParameters()).map(Parameter::getName).collect(Collectors.joining(&quot;, &quot;));</code> 这条代码中，借用了 Arrays 工具类的 stream 方法得到 <code>java.util.stream.Stream</code> 实例，利用这个实例就可以进行类似于 scala 语法的一些函数式编程了。这里的 map 为映射函数，即将 stream 中的每一个元素调用 <code>Parameter::getName</code> 函数进行处理，这里的 <code>Parameter::getName</code> 代表函数引用，最后的 collect 表示将所有的处理结果进行搜集，collect 的参数表示搜集的方式。</p>
<h3 id="一种获取-ClassLoader-的方式"><a href="#一种获取-ClassLoader-的方式" class="headerlink" title="一种获取 ClassLoader 的方式"></a>一种获取 ClassLoader 的方式</h3><blockquote>
<p>org.apache.dubbo.common.utils.ClassUtils#getClassLoader(java.lang.Class&lt;?&gt;)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title function_">getClassLoader</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 返回 Thread 的 contextClassLoader</span></span><br><span class="line">        cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="comment">// Cannot access thread context ClassLoader - falling back to system class loader...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No thread context class loader -&gt; use class loader of this class.</span></span><br><span class="line">        <span class="comment">// 返回 class 的类加载器，如果是 bootstrap 类加载器，将会返回 null</span></span><br><span class="line">        cl = clazz.getClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// getClassLoader() returning null indicates the bootstrap ClassLoader</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                cl = ClassLoader.getSystemClassLoader();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// Cannot access system ClassLoader - oh well, maybe the caller can live with null...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个获取类加载器的方式，有三个优先级，先是获取当前线程的 contextClassLoader，如果没有获取到，尝试获取加载该类 clazz 的类加载器，注意如果加载 clazz 的类加载器是 bootstrap 类加载器，那么返回值为 null，因为这个类加载器是通过 c++ 语言实现，通过 java 进行获取都是为 null。最后便是获取 SystemClassLoader，这里已经可以确定是获取的 bootstrap 类加载器了。</p>
<h3 id="增强版的-isPrimitives-方法"><a href="#增强版的-isPrimitives-方法" class="headerlink" title="增强版的 isPrimitives 方法"></a>增强版的 isPrimitives 方法</h3><blockquote>
<p>org.apache.dubbo.common.utils.ReflectUtils#isPrimitives</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isPrimitives</span><span class="params">(Class&lt;?&gt; cls)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cls.isArray()) &#123;</span><br><span class="line">        <span class="keyword">return</span> isPrimitive(cls.getComponentType());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isPrimitive(cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isPrimitive</span><span class="params">(Class&lt;?&gt; cls)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cls.isPrimitive() || cls == String.class || cls == Boolean.class || cls == Character.class</span><br><span class="line">            || Number.class.isAssignableFrom(cls) || Date.class.isAssignableFrom(cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>isPrimitives 一个增强版本的判断 class 是否是原始类型的函数，在 jdk 类库中，直接有一个函数 <code>java.lang.Class#isPrimitive</code> 就可以直接判断一个 class 实例是否是九种原始基本类型中的一种。在 isPrimitives 中增加了对 Array、String、Boolean、Charater、Number、Date 几种类型的判断支持。这里 Array 的判断是通过获取 <code>java.lang.Class#getComponentType</code> 来进行的。</p>
<h3 id="Curator-框架的使用"><a href="#Curator-框架的使用" class="headerlink" title="Curator 框架的使用"></a>Curator 框架的使用</h3><blockquote>
<p>org.apache.dubbo.remoting.zookeeper.curator.CuratorZookeeperClient</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CuratorZookeeperClient</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存 url 地址</span></span><br><span class="line">    <span class="built_in">super</span>(url);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> url.getParameter(TIMEOUT_KEY, <span class="number">5000</span>);</span><br><span class="line">        CuratorFrameworkFactory.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> CuratorFrameworkFactory.builder()</span><br><span class="line">                <span class="comment">// 备用地址</span></span><br><span class="line">                .connectString(url.getBackupAddress())</span><br><span class="line">                <span class="comment">// 重试策略</span></span><br><span class="line">                .retryPolicy(<span class="keyword">new</span> <span class="title class_">RetryNTimes</span>(<span class="number">1</span>, <span class="number">1000</span>))</span><br><span class="line">                <span class="comment">// 连接超时策略</span></span><br><span class="line">                .connectionTimeoutMs(timeout);</span><br><span class="line">        <span class="comment">// 获取授权信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authority</span> <span class="operator">=</span> url.getAuthority();</span><br><span class="line">        <span class="keyword">if</span> (authority != <span class="literal">null</span> &amp;&amp; authority.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            builder = builder.authorization(<span class="string">&quot;digest&quot;</span>, authority.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 就是根据 builder 获取一个 CuratorFrameworkImpl</span></span><br><span class="line">        client = builder.build();</span><br><span class="line">        <span class="comment">// 添加一个连接监听器</span></span><br><span class="line">        client.getConnectionStateListenable().addListener(<span class="keyword">new</span> <span class="title class_">ConnectionStateListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="comment">// 如果连接状态发生改变，就会执行此方法</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState state)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (state == ConnectionState.LOST) &#123;</span><br><span class="line">                    <span class="comment">// 断开连接</span></span><br><span class="line">                    CuratorZookeeperClient.<span class="built_in">this</span>.stateChanged(StateListener.DISCONNECTED);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == ConnectionState.CONNECTED) &#123;</span><br><span class="line">                    <span class="comment">// 连接成功</span></span><br><span class="line">                    CuratorZookeeperClient.<span class="built_in">this</span>.stateChanged(StateListener.CONNECTED);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == ConnectionState.RECONNECTED) &#123;</span><br><span class="line">                    <span class="comment">// 重连</span></span><br><span class="line">                    CuratorZookeeperClient.<span class="built_in">this</span>.stateChanged(StateListener.RECONNECTED);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        client.start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们重点关注 <code>client = builder.build();</code> 这一条语句，返回值 client 其实就是 CuratorFrameworkImpl 实例，CuratorFramework 提供了一套高级的API，简化了 ZooKeeper 的操作，它增加了很多使用ZooKeeper开发的特性，可以处理 ZooKeeper 集群复杂的连接管理和重试机制。这些特性包括：</p>
<p><em>1、</em> 自动化的连接管理: 重新建立到 ZooKeeper 的连接和重试机制存在一些潜在的错误 case。 Curator 帮助你处理这些事情，对你来说是透明的。</p>
<p><em>2、</em> 简化了原生的ZooKeeper的方法，提供了一个现代的流式接口。</p>
<p><em>3、</em> 提供了Recipes实现： 如前面的文章介绍的那样，基于这些Recipes可以创建很多复杂的分布式应用。</p>
<p>Curator 框架通过 CuratorFrameworkFactory 以工厂模式和 builder 模式创建 CuratorFramework 实例。 CuratorFramework 实例都是线程安全的，你应该在你的应用中共享同一个 CuratorFramework 实例。</p>
<p>工厂方法 newClient() 提供了一个简单方式创建实例。而 Builder 提供了更多的参数控制。一旦你创建了一个 CuratorFramework 实例，你必须调用它的 start() 启动，在应用退出时调用 close() 方法关闭。上边的代码便是 dubbo 对 实例，CuratorFramework 的一个使用示例。</p>
<h3 id="一种可用端口的获取方式"><a href="#一种可用端口的获取方式" class="headerlink" title="一种可用端口的获取方式"></a>一种可用端口的获取方式</h3><blockquote>
<p>org.apache.dubbo.common.utils.NetUtils#getAvailablePort(int)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getAvailablePort</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>()) &#123;</span><br><span class="line">        <span class="comment">// 这种情况就会产生一个随机的端口</span></span><br><span class="line">        ss.bind(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> ss.getLocalPort();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> getRandomPort();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getAvailablePort</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (port &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里是传入的 default 端口小于等于 0 的情况</span></span><br><span class="line">        <span class="keyword">return</span> getAvailablePort();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> port; i &lt; MAX_PORT; i++) &#123;</span><br><span class="line">        <span class="comment">// 从 port 端口逐个向上找可以使用的端口</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(i)) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// continue</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里获取可用端口使用了两种策略，根据传入参数的不同情况分别采用不同策略，首先是传入端口小于等于 0 的情况，通过新建一个 ServerSocket 实例 <code>ServerSocket ss = new ServerSocket()</code>，再将它绑定到一个 null endPoint，这时通过 <code>ss.getLocalPort()</code> 便能获取到一个系统随机指定的端口了。如果传入的端口是大于 0 的，那么采用的策略就是逐次递增端口号，通过 <code>ServerSocket ss = new ServerSocket(i)</code> 来判定当前端口是否可用。</p>
<h3 id="Future-和-Map-的组合操作"><a href="#Future-和-Map-的组合操作" class="headerlink" title="Future 和 Map 的组合操作"></a>Future 和 Map 的组合操作</h3><blockquote>
<p>org.apache.dubbo.rpc.filter.AccessLogFilter#log</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String accessLog, AccessLogData accessLogData)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果 LOG_ENTRIES 中没有键为 accessLog 的记录，就新建一个记录，以 accessLog 为键存入 LOG_ENTRIES 中</span></span><br><span class="line">    Set&lt;AccessLogData&gt; logSet = LOG_ENTRIES.computeIfAbsent(accessLog, k -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentHashSet</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logSet.size() &lt; LOG_MAX_BUFFER) &#123;</span><br><span class="line">        <span class="comment">// accessLog 所对应的 AccessLogData 不应该超过 5000 条</span></span><br><span class="line">        logSet.add(accessLogData);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//TODO we needs use force writing to file so that buffer gets clear and new log can be written.</span></span><br><span class="line">        logger.warn(<span class="string">&quot;AccessLog buffer is full skipping buffer &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Set&lt;AccessLogData&gt; logSet = LOG_ENTRIES.computeIfAbsent(accessLog, k -&gt; new ConcurrentHashSet&lt;&gt;());</code> 这条代码的逻辑很简单，但是它利用了 java 的新特性，通过传入函数参数，简化了操作。computeIfAbsent 这个函数，先判断 map 中是否有 accessLog 这条记录，如果没有就新建一条记录，以 accessLog 为键进行存储，等价的就是一个 if-else 操作。</p>
<blockquote>
<p>org.apache.dubbo.rpc.AsyncRpcResult#thenApplyWithContext</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">thenApplyWithContext</span><span class="params">(Function&lt;Result, Result&gt; fn)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resultFuture = resultFuture.thenApply(fn.compose(beforeContext).andThen(afterContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这条代码看起来很简单对吧，但是实现的功能却比较复杂，传入的参数是一个 Function 实例，需要注意的是它的 compose 方法，这个方法意思是说构建出一个复合函数，以 <code>fn.compose(beforeContext)</code> 为例，那么它的意思是对于调用者来说，先使用 beforeContext 函数来处理传入的参数（即调用者本身），然后使用 fn 函数对 beforeContext 函数处理的结果进行处理。后边的 andThen 意思基本一致，只不过是先调用 andThen 方法的调用者对参数进行处理，而后再将处理的结果交由 afterContext 函数进行处理。结合上述的例子来看，那么基本的调用顺序就是：resultFuture -&gt; beforeContext &#x3D; result1，result1 -&gt; fn &#x3D; result2，result2 -&gt; afterContext &#x3D; result3，result3 就是最终要返回的结果。</p>
<h3 id="Optional-的使用"><a href="#Optional-的使用" class="headerlink" title="Optional 的使用"></a>Optional 的使用</h3><blockquote>
<p>org.apache.dubbo.config.AbstractInterfaceConfig#startConfigCenter</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">startConfigCenter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 这里对应 config-center 标签，存储在 ServiceBean 中</span></span><br><span class="line">    <span class="keyword">if</span> (configCenter == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// java.util.Optional.ifPresent 如果值存在，就调用函数，否则什么都不干</span></span><br><span class="line">        ConfigManager.getInstance().getConfigCenter().ifPresent(cc -&gt; <span class="built_in">this</span>.configCenter = cc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初次调用时，如果没有配置 config-center 标签，则这里是为 null 的</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.configCenter != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// TODO there may have duplicate refresh</span></span><br><span class="line">        <span class="built_in">this</span>.configCenter.refresh();</span><br><span class="line">        <span class="comment">// 准备运行环境</span></span><br><span class="line">        prepareEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 单例获取 ConfigManager，依据具体的配置信息对相应的 config 进行属性的更新</span></span><br><span class="line">    ConfigManager.getInstance().refreshAll();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Optional&lt;ConfigCenterConfig&gt; <span class="title function_">getConfigCenter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(configCenter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里关注 <code>ConfigManager.getInstance().getConfigCenter().ifPresent(cc -&gt; this.configCenter = cc);</code> 这条代码，getConfigCenter 方法返回的是一个 Optional<ConfigCenterConfig> 实例，它有一个 ifPresent 方法，参数是一个 @FunctionalInterface 注解标注的函数式接口，这样我们在 ifPresent 只需要传入一个函数进去，返回的 Optional 就能根据它自身的状态来决定是否要应用这个函数，这个过程其实就是简化了我们自己手写 if-else 判断代码的过程。</p>
<h3 id="Version-的获取方式"><a href="#Version-的获取方式" class="headerlink" title="Version 的获取方式"></a>Version 的获取方式</h3><blockquote>
<p>org.apache.dubbo.common.Version#getVersion(java.lang.Class&lt;?&gt;, java.lang.String)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getVersion</span><span class="params">(Class&lt;?&gt; cls, String defaultVersion)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// find version info from MANIFEST.MF first</span></span><br><span class="line">        <span class="comment">// 根据 cls 查找 version 信息，存储在 MANIFEST.MF 文件中</span></span><br><span class="line">        <span class="type">Package</span> <span class="variable">pkg</span> <span class="operator">=</span> cls.getPackage();</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="literal">null</span>) &#123;</span><br><span class="line">            version = pkg.getImplementationVersion();   <span class="comment">// 此为获取 MANIFEST.MF 文件中版本信息的函数，比如 Implementation-Version:</span></span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(version)) &#123;</span><br><span class="line">                <span class="keyword">return</span> version;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            version = pkg.getSpecificationVersion();    <span class="comment">// 此为获取 MANIFEST.MF 文件中版本信息的函数，比如 Specification-Version</span></span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(version)) &#123;</span><br><span class="line">                <span class="keyword">return</span> version;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// guess version fro jar file name if nothing&#x27;s found from MANIFEST.MF</span></span><br><span class="line">        <span class="comment">// 没能从 MANIFEST.MF 文件中获取到 version 信息</span></span><br><span class="line">        <span class="type">CodeSource</span> <span class="variable">codeSource</span> <span class="operator">=</span> cls.getProtectionDomain().getCodeSource();</span><br><span class="line">        <span class="comment">// 估计是由于某种原因，没能获取到 codeSource，那就使用参数传递的 defaultVersion 信息</span></span><br><span class="line">        <span class="keyword">if</span> (codeSource == <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;No codeSource for class &quot;</span> + cls.getName() + <span class="string">&quot; when getVersion, use default version &quot;</span> + defaultVersion);</span><br><span class="line">            <span class="keyword">return</span> defaultVersion;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 那就根据 jar 包推测版本信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> codeSource.getLocation().getFile();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(file) &amp;&amp; file.endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">            version = getFromFile(file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// return default version if no version info is found</span></span><br><span class="line">        <span class="keyword">return</span> StringUtils.isEmpty(version) ? defaultVersion : version;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">// return default version when any exception is thrown</span></span><br><span class="line">        logger.error(<span class="string">&quot;return default version, ignore exception &quot;</span> + e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> defaultVersion;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是 dubbo 公共包中用于获取版本信息的函数，该函数优先从 cls 所在 package 中的 MANIFEST.MF 文件中获取版本信息，有 Implementation-Version 和 Specification-Version 两种情况，分别对应 getImplementationVersion 和 getSpecificationVersion 函数，如果在 MANIFEST.MF 文件中没有能获取到版本信息，那么该函数就会根据该 cls 所在的 jar 包来获取相应的版本信息，如果还是没有获取到的话，那么就会直接使用函数的默认版本参数值。</p>
<h3 id="动态代码和字节码的生成"><a href="#动态代码和字节码的生成" class="headerlink" title="动态代码和字节码的生成"></a>动态代码和字节码的生成</h3><blockquote>
<p>org.apache.dubbo.common.bytecode.Wrapper#makeWrapper</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Wrapper <span class="title function_">makeWrapper</span><span class="params">(Class&lt;?&gt; c)</span> &#123;</span><br><span class="line">    <span class="comment">// 不能对 9 中基本类型的包装类型构建 Wrapper</span></span><br><span class="line">    <span class="keyword">if</span> (c.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Can not create wrapper for primitive type: &quot;</span> + c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> c.getName();</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> ClassUtils.getClassLoader(c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主要是对三个函数进行拼接</span></span><br><span class="line">    <span class="comment">// setPropertyValue</span></span><br><span class="line">    <span class="comment">// getPropertyValue</span></span><br><span class="line">    <span class="comment">// invokeMethod</span></span><br><span class="line">    <span class="comment">// public void setPropertyValue (Object o, String n, Object v)&#123;</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;public void setPropertyValue(Object o, String n, Object v)&#123; &quot;</span>);</span><br><span class="line">    <span class="comment">// public Object getPropertyValue(Object o, String n)&#123;</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;public Object getPropertyValue(Object o, String n)&#123; &quot;</span>);</span><br><span class="line">    <span class="comment">// public Object invokeMethod(Object o, String n, Class[] p, Object[] v) throws java.lang.reflect.InvocationTargetException&#123;</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;public Object invokeMethod(Object o, String n, Class[] p, Object[] v) throws &quot;</span> + InvocationTargetException.class.getName() + <span class="string">&quot;&#123; &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 name 构造出这样的代码</span></span><br><span class="line">    <span class="comment">// public void setPropertyValue (Object o, String n, Object v)&#123;</span></span><br><span class="line">    <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">    <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">    <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    c1.append(name).append(<span class="string">&quot; w; try&#123; w = ((&quot;</span>).append(name).append(<span class="string">&quot;)$1); &#125;catch(Throwable e)&#123; throw new IllegalArgumentException(e); &#125;&quot;</span>);</span><br><span class="line">    <span class="comment">// public Object getPropertyValue (Object o, String n)&#123;</span></span><br><span class="line">    <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">    <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">    <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    c2.append(name).append(<span class="string">&quot; w; try&#123; w = ((&quot;</span>).append(name).append(<span class="string">&quot;)$1); &#125;catch(Throwable e)&#123; throw new IllegalArgumentException(e); &#125;&quot;</span>);</span><br><span class="line">    <span class="comment">// public Object invokeMethod (Object o, String n, Class[]p, Object[]v) throws</span></span><br><span class="line">    <span class="comment">// java.lang.reflect.InvocationTargetException &#123;</span></span><br><span class="line">    <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">    <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">    <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    c3.append(name).append(<span class="string">&quot; w; try&#123; w = ((&quot;</span>).append(name).append(<span class="string">&quot;)$1); &#125;catch(Throwable e)&#123; throw new IllegalArgumentException(e); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存字段的 name 和 type</span></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; pts = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">// &lt;property name, property types&gt;</span></span><br><span class="line">    <span class="comment">// 保存方法的 desc（签名） 和 instance</span></span><br><span class="line">    <span class="comment">// get method desc.</span></span><br><span class="line">    <span class="comment">// int do(int arg1) =&gt; &quot;do(I)I&quot;</span></span><br><span class="line">    <span class="comment">// void do(String arg1,boolean arg2) =&gt; &quot;do(Ljava/lang/String;Z)V&quot;</span></span><br><span class="line">    Map&lt;String, Method&gt; ms = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(); <span class="comment">// &lt;method desc, Method instance&gt;</span></span><br><span class="line">    <span class="comment">// 保存方法名</span></span><br><span class="line">    List&lt;String&gt; mns = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// method names.</span></span><br><span class="line">    <span class="comment">// 保存声明方法的类名</span></span><br><span class="line">    List&lt;String&gt; dmns = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// declaring method names.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// get all public field.</span></span><br><span class="line">    <span class="keyword">for</span> (Field f : c.getFields()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fn</span> <span class="operator">=</span> f.getName();</span><br><span class="line">        Class&lt;?&gt; ft = f.getType();</span><br><span class="line">        <span class="comment">// 避开 static 和 transient 修饰的字段</span></span><br><span class="line">        <span class="keyword">if</span> (Modifier.isStatic(f.getModifiers()) || Modifier.isTransient(f.getModifiers())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据 field 进行构建</span></span><br><span class="line">        <span class="comment">// public void setPropertyValue (Object o, String n, Object v)&#123;</span></span><br><span class="line">        <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">        <span class="comment">//     try &#123;</span></span><br><span class="line">        <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">        <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">        <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">//     if( $2.equals(&quot;serviceName&quot;))&#123;</span></span><br><span class="line">        <span class="comment">//         w.serviceName=(org.apache.dubbo.demo.DemoService) $3;</span></span><br><span class="line">        <span class="comment">//         return;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        c1.append(<span class="string">&quot; if( $2.equals(\&quot;&quot;</span>).append(fn).append(<span class="string">&quot;\&quot;) )&#123; w.&quot;</span>).append(fn).append(<span class="string">&quot;=&quot;</span>).append(arg(ft, <span class="string">&quot;$3&quot;</span>)).append(<span class="string">&quot;; return; &#125;&quot;</span>);</span><br><span class="line">        <span class="comment">// public Object getPropertyValue (Object o, String n)&#123;</span></span><br><span class="line">        <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">        <span class="comment">//     try &#123;</span></span><br><span class="line">        <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">        <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">        <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">//     if( $2.equals(&quot;serviceName&quot;))&#123;</span></span><br><span class="line">        <span class="comment">//         return ($w)w.serviceName;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        c2.append(<span class="string">&quot; if( $2.equals(\&quot;&quot;</span>).append(fn).append(<span class="string">&quot;\&quot;) )&#123; return ($w)w.&quot;</span>).append(fn).append(<span class="string">&quot;; &#125;&quot;</span>);</span><br><span class="line">        <span class="comment">// 保存字段的 name 和 type</span></span><br><span class="line">        pts.put(fn, ft);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method[] methods = c.getMethods();</span><br><span class="line">    <span class="comment">// get all public method.</span></span><br><span class="line">    <span class="comment">// methods 方法不为空，且不全为 Object 声明的方法</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasMethod</span> <span class="operator">=</span> hasMethods(methods);</span><br><span class="line">    <span class="keyword">if</span> (hasMethod) &#123;</span><br><span class="line">        <span class="comment">// 通过 methods 对 c3 进行构造</span></span><br><span class="line">        c3.append(<span class="string">&quot; try&#123;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Method m : methods) &#123;</span><br><span class="line">            <span class="comment">//ignore Object&#x27;s method.</span></span><br><span class="line">            <span class="keyword">if</span> (m.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过方法名进行构造</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">mn</span> <span class="operator">=</span> m.getName();</span><br><span class="line">            c3.append(<span class="string">&quot; if( \&quot;&quot;</span>).append(mn).append(<span class="string">&quot;\&quot;.equals( $2 ) &quot;</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> m.getParameterTypes().length;</span><br><span class="line">            <span class="comment">// 补上方法参数信息</span></span><br><span class="line">            <span class="comment">// public Object invokeMethod (Object o, String n, Class[]p, Object[]v) throws java.lang.reflect.InvocationTargetException &#123;</span></span><br><span class="line">            <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">            <span class="comment">//     try &#123;</span></span><br><span class="line">            <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">            <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">            <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">            <span class="comment">//     &#125;</span></span><br><span class="line">            <span class="comment">//     try &#123;</span></span><br><span class="line">            <span class="comment">//         if (&quot;sayHello&quot;.equals($2) &amp;&amp; $3.length == 1</span></span><br><span class="line">            c3.append(<span class="string">&quot; &amp;&amp; &quot;</span>).append(<span class="string">&quot; $3.length == &quot;</span>).append(len);</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">override</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (Method m2 : methods) &#123;</span><br><span class="line">                <span class="comment">// 如果有跟当前方法同名的其它方法，即存在重写（overwrite）</span></span><br><span class="line">                <span class="keyword">if</span> (m != m2 &amp;&amp; m.getName().equals(m2.getName())) &#123;</span><br><span class="line">                    override = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (override) &#123;</span><br><span class="line">                <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>; l &lt; len; l++) &#123;</span><br><span class="line">                        <span class="comment">// 补上方法参数信息</span></span><br><span class="line">                        <span class="comment">// public Object invokeMethod (Object o, String n, Class[]p, Object[]v) throws java.lang.reflect.InvocationTargetException &#123;</span></span><br><span class="line">                        <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">                        <span class="comment">//     try &#123;</span></span><br><span class="line">                        <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">                        <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">                        <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">                        <span class="comment">//     &#125;</span></span><br><span class="line">                        <span class="comment">//     try &#123;</span></span><br><span class="line">                        <span class="comment">//         if (&quot;sayHello&quot;.equals($2) &amp;&amp; $3.length == 1 &amp;&amp; $3[l].getName().equals(&quot;java.lang.String&quot;))&#123;;</span></span><br><span class="line"></span><br><span class="line">                        c3.append(<span class="string">&quot; &amp;&amp; &quot;</span>).append(<span class="string">&quot; $3[&quot;</span>).append(l).append(<span class="string">&quot;].getName().equals(\&quot;&quot;</span>)</span><br><span class="line">                                .append(m.getParameterTypes()[l].getName()).append(<span class="string">&quot;\&quot;)&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// public Object invokeMethod (Object o, String n, Class[]p, Object[]v) throws java.lang.reflect.InvocationTargetException &#123;</span></span><br><span class="line">            <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">            <span class="comment">//     try &#123;</span></span><br><span class="line">            <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">            <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">            <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">            <span class="comment">//     &#125;</span></span><br><span class="line">            <span class="comment">//     try &#123;</span></span><br><span class="line">            <span class="comment">//         if (&quot;sayHello&quot;.equals($2) &amp;&amp; $3.length == 1) &#123;</span></span><br><span class="line">            c3.append(<span class="string">&quot; ) &#123; &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拼接方法的返回值</span></span><br><span class="line">            <span class="keyword">if</span> (m.getReturnType() == Void.TYPE) &#123;</span><br><span class="line">                c3.append(<span class="string">&quot; w.&quot;</span>).append(mn).append(<span class="string">&#x27;(&#x27;</span>).append(args(m.getParameterTypes(), <span class="string">&quot;$4&quot;</span>)).append(<span class="string">&quot;);&quot;</span>).append(<span class="string">&quot; return null;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                c3.append(<span class="string">&quot; return ($w)w.&quot;</span>).append(mn).append(<span class="string">&#x27;(&#x27;</span>).append(args(m.getParameterTypes(), <span class="string">&quot;$4&quot;</span>)).append(<span class="string">&quot;);&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拼接完返回值后</span></span><br><span class="line">            <span class="comment">// public Object invokeMethod (Object o, String n, Class[]p, Object[]v) throws java.lang.reflect.InvocationTargetException &#123;</span></span><br><span class="line">            <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">            <span class="comment">//     try &#123;</span></span><br><span class="line">            <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">            <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">            <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">            <span class="comment">//     &#125;</span></span><br><span class="line">            <span class="comment">//     try &#123;</span></span><br><span class="line">            <span class="comment">//         if (&quot;sayHello&quot;.equals($2) &amp;&amp; $3.length == 1) &#123;</span></span><br><span class="line">            <span class="comment">//             return ($w) w.sayHello((java.lang.String) $4[0]);</span></span><br><span class="line">            <span class="comment">//         &#125;</span></span><br><span class="line">            c3.append(<span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存拼接的方法名</span></span><br><span class="line">            mns.add(mn);</span><br><span class="line">            <span class="keyword">if</span> (m.getDeclaringClass() == c) &#123;</span><br><span class="line">                <span class="comment">// 保存声明方法的类名</span></span><br><span class="line">                dmns.add(mn);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 保存方法的签名和方法实例</span></span><br><span class="line">            <span class="comment">// get method desc.</span></span><br><span class="line">            <span class="comment">// int do(int arg1) =&gt; &quot;do(I)I&quot;</span></span><br><span class="line">            <span class="comment">// void do(String arg1,boolean arg2) =&gt; &quot;do(Ljava/lang/String;Z)V&quot;</span></span><br><span class="line">            ms.put(ReflectUtils.getDesc(m), m);</span><br><span class="line">        &#125;</span><br><span class="line">        c3.append(<span class="string">&quot; &#125; catch(Throwable e) &#123; &quot;</span>);</span><br><span class="line">        c3.append(<span class="string">&quot;     throw new java.lang.reflect.InvocationTargetException(e); &quot;</span>);</span><br><span class="line">        c3.append(<span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 补全括号即剩余信息</span></span><br><span class="line">    <span class="comment">// o 方法调用的目标对象，n 方法名，p 方法的参数类型，v 方法的参数</span></span><br><span class="line">    <span class="comment">// public Object invokeMethod (Object o, String n, Class[]p, Object[]v) throws java.lang.reflect.InvocationTargetException &#123;</span></span><br><span class="line">    <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">    <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">    <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         if (&quot;sayHello&quot;.equals($2) &amp;&amp; $3.length == 1) &#123;</span></span><br><span class="line">    <span class="comment">//             return ($w) w.sayHello((java.lang.String) $4[0]);</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">    <span class="comment">//         throw new java.lang.reflect.InvocationTargetException(e);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     throw new org.apache.dubbo.common.bytecode.NoSuchMethodException(&quot;Not found method \&quot;&quot; + $2 + &quot;\&quot; in class org.apache.dubbo.demo.DemoService.&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    c3.append(<span class="string">&quot; throw new &quot;</span> + NoSuchMethodException.class.getName() + <span class="string">&quot;(\&quot;Not found method \\\&quot;\&quot;+$2+\&quot;\\\&quot; in class &quot;</span> + c.getName() + <span class="string">&quot;.\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deal with get/set method.</span></span><br><span class="line">    Matcher matcher;</span><br><span class="line">    <span class="comment">// 这里 ms 保存的是接口中非 Object 类方法的签名和方法实例</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Method&gt; entry : ms.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// 方法签名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">md</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="comment">// 方法实例</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">        <span class="comment">// 匹配 getter 方法</span></span><br><span class="line">        <span class="keyword">if</span> ((matcher = ReflectUtils.GETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">pn</span> <span class="operator">=</span> propertyName(matcher.group(<span class="number">1</span>));</span><br><span class="line">            c2.append(<span class="string">&quot; if( $2.equals(\&quot;&quot;</span>).append(pn).append(<span class="string">&quot;\&quot;) )&#123; return ($w)w.&quot;</span>).append(method.getName()).append(<span class="string">&quot;(); &#125;&quot;</span>);</span><br><span class="line">            pts.put(pn, method.getReturnType());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((matcher = ReflectUtils.IS_HAS_CAN_METHOD_DESC_PATTERN.matcher(md)).matches()) &#123;</span><br><span class="line">            <span class="comment">// 匹配 is、has、can 方法</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">pn</span> <span class="operator">=</span> propertyName(matcher.group(<span class="number">1</span>));</span><br><span class="line">            c2.append(<span class="string">&quot; if( $2.equals(\&quot;&quot;</span>).append(pn).append(<span class="string">&quot;\&quot;) )&#123; return ($w)w.&quot;</span>).append(method.getName()).append(<span class="string">&quot;(); &#125;&quot;</span>);</span><br><span class="line">            pts.put(pn, method.getReturnType());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((matcher = ReflectUtils.SETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) &#123;</span><br><span class="line">            <span class="comment">// 匹配 setter 方法</span></span><br><span class="line">            Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">pn</span> <span class="operator">=</span> propertyName(matcher.group(<span class="number">1</span>));</span><br><span class="line">            c1.append(<span class="string">&quot; if( $2.equals(\&quot;&quot;</span>).append(pn).append(<span class="string">&quot;\&quot;) )&#123; w.&quot;</span>).append(method.getName()).append(<span class="string">&quot;(&quot;</span>).append(arg(pt, <span class="string">&quot;$3&quot;</span>)).append(<span class="string">&quot;); return; &#125;&quot;</span>);</span><br><span class="line">            pts.put(pn, pt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// c1 的拼接结果</span></span><br><span class="line">    <span class="comment">// public void setPropertyValue (Object o, String n, Object v)&#123;</span></span><br><span class="line">    <span class="comment">//     org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">    <span class="comment">//     try &#123;</span></span><br><span class="line">    <span class="comment">//         w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">    <span class="comment">//     &#125; catch (Throwable e) &#123;</span></span><br><span class="line">    <span class="comment">//         throw new IllegalArgumentException(e);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     throw new org.apache.dubbo.common.bytecode.NoSuchPropertyException(&quot;Not found property \&quot;&quot; + $2 + &quot;\&quot; field or setter method in class org.apache.dubbo.demo.DemoService.&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    c1.append(<span class="string">&quot; throw new &quot;</span> + NoSuchPropertyException.class.getName() + <span class="string">&quot;(\&quot;Not found property \\\&quot;\&quot;+$2+\&quot;\\\&quot; field or setter method in class &quot;</span> + c.getName() + <span class="string">&quot;.\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// c2 的拼接结果</span></span><br><span class="line">    <span class="comment">//  public Object getPropertyValue (Object o, String n)&#123;</span></span><br><span class="line">    <span class="comment">//      org.apache.dubbo.demo.DemoService w;</span></span><br><span class="line">    <span class="comment">//      try &#123;</span></span><br><span class="line">    <span class="comment">//          w = ((org.apache.dubbo.demo.DemoService) $1);</span></span><br><span class="line">    <span class="comment">//      &#125; catch (Throwable e) &#123;</span></span><br><span class="line">    <span class="comment">//          throw new IllegalArgumentException(e);</span></span><br><span class="line">    <span class="comment">//      &#125;</span></span><br><span class="line">    <span class="comment">//      throw new org.apache.dubbo.common.bytecode.NoSuchPropertyException(&quot;Not found property \&quot;&quot; + $2 + &quot;\&quot; field or setter method in class org.apache.dubbo.demo.DemoService.&quot;);</span></span><br><span class="line">    <span class="comment">//  &#125;</span></span><br><span class="line">    c2.append(<span class="string">&quot; throw new &quot;</span> + NoSuchPropertyException.class.getName() + <span class="string">&quot;(\&quot;Not found property \\\&quot;\&quot;+$2+\&quot;\\\&quot; field or setter method in class &quot;</span> + c.getName() + <span class="string">&quot;.\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make class</span></span><br><span class="line">    <span class="comment">// 对构建的 wrapper 类进行计数</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> WRAPPER_CLASS_COUNTER.getAndIncrement();</span><br><span class="line">    <span class="comment">// 根据 classLoader 构建 ClassGenerator</span></span><br><span class="line">    <span class="type">ClassGenerator</span> <span class="variable">cc</span> <span class="operator">=</span> ClassGenerator.newInstance(cl);</span><br><span class="line">    <span class="comment">// 补全一些类信息</span></span><br><span class="line">    cc.setClassName((Modifier.isPublic(c.getModifiers()) ? Wrapper.class.getName() : c.getName() + <span class="string">&quot;$sw&quot;</span>) + id);</span><br><span class="line">    cc.setSuperClass(Wrapper.class);</span><br><span class="line"></span><br><span class="line">    cc.addDefaultConstructor();</span><br><span class="line">    cc.addField(<span class="string">&quot;public static String[] pns;&quot;</span>); <span class="comment">// property name array.</span></span><br><span class="line">    cc.addField(<span class="string">&quot;public static &quot;</span> + Map.class.getName() + <span class="string">&quot; pts;&quot;</span>); <span class="comment">// property type map.</span></span><br><span class="line">    cc.addField(<span class="string">&quot;public static String[] mns;&quot;</span>); <span class="comment">// all method name array.</span></span><br><span class="line">    cc.addField(<span class="string">&quot;public static String[] dmns;&quot;</span>); <span class="comment">// declared method name array.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, len = ms.size(); i &lt; len; i++) &#123;    <span class="comment">// 方法的参数类型数组，有几个函数就会有几个数组</span></span><br><span class="line">        cc.addField(<span class="string">&quot;public static Class[] mts&quot;</span> + i + <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cc.addMethod(<span class="string">&quot;public String[] getPropertyNames()&#123; return pns; &#125;&quot;</span>);</span><br><span class="line">    cc.addMethod(<span class="string">&quot;public boolean hasProperty(String n)&#123; return pts.containsKey($1); &#125;&quot;</span>);</span><br><span class="line">    cc.addMethod(<span class="string">&quot;public Class getPropertyType(String n)&#123; return (Class)pts.get($1); &#125;&quot;</span>);</span><br><span class="line">    cc.addMethod(<span class="string">&quot;public String[] getMethodNames()&#123; return mns; &#125;&quot;</span>);</span><br><span class="line">    cc.addMethod(<span class="string">&quot;public String[] getDeclaredMethodNames()&#123; return dmns; &#125;&quot;</span>);</span><br><span class="line">    cc.addMethod(c1.toString());</span><br><span class="line">    cc.addMethod(c2.toString());</span><br><span class="line">    cc.addMethod(c3.toString());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 根据 ClassGenerator 生成真正的 Class 对象</span></span><br><span class="line">        Class&lt;?&gt; wc = cc.toClass();</span><br><span class="line">        <span class="comment">// setup static field.</span></span><br><span class="line">        <span class="comment">// 根据上边获取的信息对 Class 对象的某些属性进行填充</span></span><br><span class="line">        <span class="comment">// 字段的 name 和 type</span></span><br><span class="line">        wc.getField(<span class="string">&quot;pts&quot;</span>).set(<span class="literal">null</span>, pts);</span><br><span class="line">        <span class="comment">// pns 集合专门用来保存字段的名字</span></span><br><span class="line">        wc.getField(<span class="string">&quot;pns&quot;</span>).set(<span class="literal">null</span>, pts.keySet().toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]));</span><br><span class="line">        <span class="comment">// mns 集合专门用来保存方法名</span></span><br><span class="line">        wc.getField(<span class="string">&quot;mns&quot;</span>).set(<span class="literal">null</span>, mns.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]));</span><br><span class="line">        <span class="comment">// dmns 集合专门用来保存方法的声明类</span></span><br><span class="line">        wc.getField(<span class="string">&quot;dmns&quot;</span>).set(<span class="literal">null</span>, dmns.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]));</span><br><span class="line">        <span class="type">int</span> <span class="variable">ix</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// ms 保存的是方法签名和方法实例</span></span><br><span class="line">        <span class="comment">// 遍历方法实例</span></span><br><span class="line">        <span class="keyword">for</span> (Method m : ms.values()) &#123;</span><br><span class="line">            <span class="comment">// mts 字段用来保存方法的参数类型</span></span><br><span class="line">            wc.getField(<span class="string">&quot;mts&quot;</span> + ix++).set(<span class="literal">null</span>, m.getParameterTypes());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回构建的 Wrapper 实例</span></span><br><span class="line">        <span class="keyword">return</span> (Wrapper) wc.newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e.getMessage(), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 对相关资源进行释放</span></span><br><span class="line">        cc.release();</span><br><span class="line">        ms.clear();</span><br><span class="line">        mns.clear();</span><br><span class="line">        dmns.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是 dubbo 用于根据服务接口生成对应 Wrapper 实例的代码，是一个动态代码生成的例子，过程非常的冗长，但是它所要实现的目的很简单，主要是三个方法 <code>setPropertyValue</code>、<code>getPropertyValue</code>、<code>invokeMethod</code>，当然还有几个和服务接口类相关的字段，比如说 <code>public static String[] pns;</code> 用于存储字段的类型名、<code>public static java.util.Map pts;</code> 用于保存字段的名字和类型对、<code>public static String[] mns;</code> 用于保存方法名、<code>public static String[] dmns;</code> 用于保存方法声明的类名、<code>public static Class[] mts0;</code> 用于保存方法的参数类型，这个数字 0 代表方法的序列。再有就是用于获取这些字段的 getter 方法，内容比较多，在下边的代码框中统一贴出。以上这些都是生成的 Wrapper 实例的代码，属于动态生成的代码，除此之外，代码还根据相应的接口信息，对相关的字段内容进行了统计和填充比如 <code>wc.getField(&quot;pts&quot;).set(null, pts);</code>、<code> wc.getField(&quot;pns&quot;).set(null, pts.keySet().toArray(new String[0]));</code> 等代码都是将统计的内容添加到将要生成的 Wrapper 类的字段中去。至于是如何通过动态代码生成相应的 Class 类，就要靠 <code>org.apache.dubbo.common.bytecode.ClassGenerator</code> 这个类了，底层的原理暂时没有了解，大致猜测是使用的 Javassit 相关的字节码生成技术，这是属于 java 中比较靠底层的技术了，暂时是没有精力去深入了解了，暂且挖个坑吧。在通过 ClassGenerator 生成了对应的 Class 对象后，就是构建 Wrapper 实例，这个就跟使用普通的 Class 对象一样了，所以这里的技术难点就是在于如何生成动态代码，和如何根据动态代码来生成相应的 Class 对象了。</p>
<h3 id="一种特殊的静态字段的初始化方式"><a href="#一种特殊的静态字段的初始化方式" class="headerlink" title="一种特殊的静态字段的初始化方式"></a>一种特殊的静态字段的初始化方式</h3><blockquote>
<p>org.apache.dubbo.rpc.protocol.injvm.InjvmProtocol#getInjvmProtocol</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> InjvmProtocol INSTANCE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">InjvmProtocol</span><span class="params">()</span> &#123;</span><br><span class="line">    INSTANCE = <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> InjvmProtocol <span class="title function_">getInjvmProtocol</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123; <span class="comment">// 加载的过程会调用对应 class 的 newInstance 方法，就会对 INSTANCE 进行初始化</span></span><br><span class="line">        ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(InjvmProtocol.NAME); <span class="comment">// load</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是 dubbo 获取 InjvmProtocol 的方法，获取的方式是先从 INSTANCE 缓存中获取，如果为空的话，就会执行 <code>ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(InjvmProtocol.NAME);</code> 这条语句，然后再返回 INSTANCE，需要注意的是这里好像并么有对 INSTANCE 进行赋值，如果 INSTANCE 为空，那么执行上述代码后 INSTANCE 也一定为空不是吗？但是通过代码调试，可以发现执行完 if 中的代码后 INSTANCE 就已经是被赋值为 InjvmProtocol 了，而就 INSTANCE 本身来说，它只有在 InjvmProtocol 类的构造函数中会有一个写操作，那就是说一定是在上述代码语句中执行了 InjvmProtocol 的构造函数，通过代码跟踪可以发现在如下代码中调用了它的构造方法。</p>
<blockquote>
<p>org.apache.dubbo.common.extension.ExtensionLoader#createExtension</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> T <span class="title function_">createExtension</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="comment">// 先尝试从 cachedClasses 获取别名为 name 的 class</span></span><br><span class="line">    Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> findException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 尝试从 EXTENSION_INSTANCES 获取 Extension 实例</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">instance</span> <span class="operator">=</span> (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 没有获取到，那就直接通过 class 创建即可</span></span><br><span class="line">            EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span><br><span class="line">            instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据 setter 方法，为 instance 实例填充 extension 属性</span></span><br><span class="line">        injectExtension(instance);</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(wrapperClasses)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">                <span class="comment">// 根据 setter 方法，为 wrapper 实例填充 extension 属性</span></span><br><span class="line">                instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Extension instance (name: &quot;</span> + name + <span class="string">&quot;, class: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;) couldn&#x27;t be instantiated: &quot;</span> + t.getMessage(), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这里的 <code>Class&lt;?&gt; clazz = getExtensionClasses().get(name);</code> 语句获取的就是 InjvmProtocol 对应的 class 了，然后执行了 <code>EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</code> 语句来完成对 INSTANCE 的初始化。还有一点需要注意的是，InjvmProtocol 和它的构造函数都是属于 public 关键字修饰，也就是说任何代码都可以调用 InjvmProtocol 的构造函数，这样就会使得 INSTANCE 并非单例了，因为每一次 new InjvmProtocol 都会使得 INSTANCE 引用新的实例。</p>
<h3 id="资源加载的方式"><a href="#资源加载的方式" class="headerlink" title="资源加载的方式"></a>资源加载的方式</h3><blockquote>
<p>org.apache.dubbo.common.extension.ExtensionLoader#loadDirectory</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadDirectory</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir, String type)</span> &#123;</span><br><span class="line">    <span class="comment">// META-INF/dubbo/internal/com.alibaba.dubbo.common.extension.ExtensionFactory</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> dir + type;   <span class="comment">// META-INF/dubbo/internal/org.apache.dubbo.configcenter.DynamicConfigurationFactory</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;java.net.URL&gt; urls;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> findClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 通过 classloader 获取 filename 资源的全部 urls</span></span><br><span class="line">            urls = classLoader.getResources(fileName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            urls = ClassLoader.getSystemResources(fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (urls != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                <span class="comment">// /Users/eva/IdeaProjects/dubbo-with-comment/dubbo-common/target/classes/META-INF/dubbo/internal/org.apache.dubbo.common.extension.ExtensionFactory</span></span><br><span class="line">                <span class="comment">// /Users/eva/IdeaProjects/dubbo-with-comment/dubbo-config/dubbo-config-spring/target/classes/META-INF/dubbo/internal/org.apache.dubbo.common.extension.ExtensionFactory</span></span><br><span class="line">                java.net.<span class="type">URL</span> <span class="variable">resourceURL</span> <span class="operator">=</span> urls.nextElement();</span><br><span class="line">                <span class="comment">// 将 resourceURL 所对应的文件中的 class 进行加载，然后保存到 extensionClasses</span></span><br><span class="line">                loadResource(extensionClasses, classLoader, resourceURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Exception occurred when loading extension class (interface: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;, description file: &quot;</span> + fileName + <span class="string">&quot;).&quot;</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是 Dubbo 在进行 ExtensionClass 获取的代码，核心的就是 <code>urls = classLoader.getResources(fileName);</code> 这条代码，它会将资源路径下所有的 fileName 资源作为 Enumeration&lt;java.net.URL&gt; 返回，然后我们就可以针对每一个资源文件进行处理了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文的篇幅算是比较长了，总结就尽量短吧，因为内容都是一些零散的技巧性总结，所以看起来不会觉得很系统，其中的一些要点可能还是要通过自己在阅读源码中领会了，看源码确实很枯燥乏味，但是如果不去看一些好的东西，只管自己折腾的话，那么可以说自己写出来的东西就是一坨 Shit。</p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Dubbo/">#Dubbo</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2019/07/17/2019-07-17-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%9F%E4%B8%80id%E7%94%9F%E6%88%90%E5%99%A8snowflake%E4%BB%8B%E7%BB%8D/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">分布式统一id生成器snowflake介绍</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2019/05/15/2019-05-15-Dubbo%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Dubbo自定义标签解析过程的源码分析</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">小橘子🍊</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Stream-%E7%BB%84%E5%90%88%E6%96%B9%E6%B3%95"><span class="nav-text">Stream 组合方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E7%A7%8D%E8%8E%B7%E5%8F%96-ClassLoader-%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">一种获取 ClassLoader 的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%BC%BA%E7%89%88%E7%9A%84-isPrimitives-%E6%96%B9%E6%B3%95"><span class="nav-text">增强版的 isPrimitives 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Curator-%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Curator 框架的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E7%A7%8D%E5%8F%AF%E7%94%A8%E7%AB%AF%E5%8F%A3%E7%9A%84%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="nav-text">一种可用端口的获取方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Future-%E5%92%8C-Map-%E7%9A%84%E7%BB%84%E5%90%88%E6%93%8D%E4%BD%9C"><span class="nav-text">Future 和 Map 的组合操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Optional-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">Optional 的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Version-%E7%9A%84%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="nav-text">Version 的获取方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%A0%81%E5%92%8C%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E7%94%9F%E6%88%90"><span class="nav-text">动态代码和字节码的生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E7%A7%8D%E7%89%B9%E6%AE%8A%E7%9A%84%E9%9D%99%E6%80%81%E5%AD%97%E6%AE%B5%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E5%BC%8F"><span class="nav-text">一种特殊的静态字段的初始化方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">资源加载的方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
